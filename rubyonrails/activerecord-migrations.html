<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ruby on Rails - ActiveRecord Migrations</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Adding multiple columns to a table, Add a reference column to a table, Rollback migrations, Add a new column with an index, Run specific migration, Redo migrations, Add a new column to a table, Remove an existing column from a table, Running migrations in different environments, Create a new table, Running migrations, Change an existing column’s type, Add column with default value, Create a join table, Create a hstore column, Add a self reference, Create an array column, Changing Tables, Add an unique column to a table, Checking migration status, Forbid null values, Adding a NOT NULL constraint to existing data">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="Ruby on Rails - ActiveRecord Migrations">
    <meta property="og:description" content="Adding multiple columns to a table, Add a reference column to a table, Rollback migrations, Add a new column with an index, Run specific migration, Redo migrations, Add a new column to a table, Remove an existing column from a table, Running migrations in different environments, Create a new table, Running migrations, Change an existing column’s type, Add column with default value, Create a join table, Create a hstore column, Add a self reference, Create an array column, Changing Tables, Add an unique column to a table, Checking migration status, Forbid null values, Adding a NOT NULL constraint to existing data">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/rubyonrails/activerecord-migrations.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="Ruby on Rails - ActiveRecord Migrations">
    <meta name="twitter:description" content="Adding multiple columns to a table, Add a reference column to a table, Rollback migrations, Add a new column with an index, Run specific migration, Redo migrations, Add a new column to a table, Remove an existing column from a table, Running migrations in different environments, Create a new table, Running migrations, Change an existing column’s type, Add column with default value, Create a join table, Create a hstore column, Add a self reference, Create an array column, Changing Tables, Add an unique column to a table, Checking migration status, Forbid null values, Adding a NOT NULL constraint to existing data">
    <meta name="twitter:url" content="/rubyonrails/activerecord-migrations.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/3131.f2aed990.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Ruby on Rails</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rubyonrails/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/rubyonrails/getting-started-with-ruby-on-rails.html" class="sidebar-link">Getting started with Ruby on Rails</a></li><li><a href="/rubyonrails/routing.html" class="sidebar-link">Routing</a></li><li><a href="/rubyonrails/activerecord.html" class="sidebar-link">ActiveRecord</a></li><li><a href="/rubyonrails/views.html" class="sidebar-link">Views</a></li><li><a href="/rubyonrails/activerecord-migrations.html" aria-current="page" class="active sidebar-link">ActiveRecord Migrations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#adding-multiple-columns-to-a-table" class="sidebar-link">Adding multiple columns to a table</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#add-a-reference-column-to-a-table" class="sidebar-link">Add a reference column to a table</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#rollback-migrations" class="sidebar-link">Rollback migrations</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#add-a-new-column-with-an-index" class="sidebar-link">Add a new column with an index</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#run-specific-migration" class="sidebar-link">Run specific migration</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#redo-migrations" class="sidebar-link">Redo migrations</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#add-a-new-column-to-a-table" class="sidebar-link">Add a new column to a table</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#remove-an-existing-column-from-a-table" class="sidebar-link">Remove an existing column from a table</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#running-migrations-in-different-environments" class="sidebar-link">Running migrations in different environments</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#create-a-new-table" class="sidebar-link">Create a new table</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#running-migrations" class="sidebar-link">Running migrations</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#change-an-existing-column-s-type" class="sidebar-link">Change an existing column’s type</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#add-column-with-default-value" class="sidebar-link">Add column with default value</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#create-a-join-table" class="sidebar-link">Create a join table</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#create-a-hstore-column" class="sidebar-link">Create a hstore column</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#add-a-self-reference" class="sidebar-link">Add a self reference</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#create-an-array-column" class="sidebar-link">Create an array column</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#changing-tables" class="sidebar-link">Changing Tables</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#add-an-unique-column-to-a-table" class="sidebar-link">Add an unique column to a table</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#checking-migration-status" class="sidebar-link">Checking migration status</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#forbid-null-values" class="sidebar-link">Forbid null values</a></li><li class="sidebar-sub-header"><a href="/rubyonrails/activerecord-migrations.html#adding-a-not-null-constraint-to-existing-data" class="sidebar-link">Adding a NOT NULL constraint to existing data</a></li></ul></li><li><a href="/rubyonrails/rails-best-practices.html" class="sidebar-link">Rails Best Practices</a></li><li><a href="/rubyonrails/naming-conventions.html" class="sidebar-link">Naming Conventions</a></li><li><a href="/rubyonrails/actioncable.html" class="sidebar-link">ActionCable</a></li><li><a href="/rubyonrails/activemodel.html" class="sidebar-link">ActiveModel</a></li><li><a href="/rubyonrails/user-authentication-in-rails.html" class="sidebar-link">User Authentication in Rails</a></li><li><a href="/rubyonrails/activerecord-associations.html" class="sidebar-link">ActiveRecord Associations</a></li><li><a href="/rubyonrails/activerecord-validations.html" class="sidebar-link">ActiveRecord Validations</a></li><li><a href="/rubyonrails/activerecord-query-interface.html" class="sidebar-link">ActiveRecord Query Interface</a></li><li><a href="/rubyonrails/actionmailer.html" class="sidebar-link">ActionMailer</a></li><li><a href="/rubyonrails/rails-generate-commands.html" class="sidebar-link">Rails generate commands</a></li><li><a href="/rubyonrails/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/rubyonrails/i18n-internationalization.html" class="sidebar-link">I18n - Internationalization</a></li><li><a href="/rubyonrails/using-googlemaps-with-rails.html" class="sidebar-link">Using GoogleMaps with Rails</a></li><li><a href="/rubyonrails/file-uploads.html" class="sidebar-link">File Uploads</a></li><li><a href="/rubyonrails/caching.html" class="sidebar-link">Caching</a></li><li><a href="/rubyonrails/actioncontroller.html" class="sidebar-link">ActionController</a></li><li><a href="/rubyonrails/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/rubyonrails/safe-constantize.html" class="sidebar-link">Safe Constantize</a></li><li><a href="/rubyonrails/rails-5.html" class="sidebar-link">Rails 5</a></li><li><a href="/rubyonrails/authorization-with-cancan.html" class="sidebar-link">Authorization with CanCan</a></li><li><a href="/rubyonrails/mongoid.html" class="sidebar-link">Mongoid</a></li><li><a href="/rubyonrails/gems.html" class="sidebar-link">Gems</a></li><li><a href="/rubyonrails/change-default-timezone.html" class="sidebar-link">Change default timezone</a></li><li><a href="/rubyonrails/asset-pipeline.html" class="sidebar-link">Asset Pipeline</a></li><li><a href="/rubyonrails/upgrading-rails.html" class="sidebar-link">Upgrading Rails</a></li><li><a href="/rubyonrails/activerecord-locking.html" class="sidebar-link">ActiveRecord Locking</a></li><li><a href="/rubyonrails/debugging.html" class="sidebar-link">Debugging</a></li><li><a href="/rubyonrails/configure-angular-with-rails.html" class="sidebar-link">Configure Angular with Rails</a></li><li><a href="/rubyonrails/rails-logger.html" class="sidebar-link">Rails logger</a></li><li><a href="/rubyonrails/prawn-pdf.html" class="sidebar-link">Prawn PDF</a></li><li><a href="/rubyonrails/rails-api.html" class="sidebar-link">Rails API</a></li><li><a href="/rubyonrails/deploying-a-rails-app-on-heroku.html" class="sidebar-link">Deploying a Rails app on Heroku</a></li><li><a href="/rubyonrails/activesupport.html" class="sidebar-link">ActiveSupport</a></li><li><a href="/rubyonrails/form-helpers.html" class="sidebar-link">Form Helpers</a></li><li><a href="/rubyonrails/activerecord-transactions.html" class="sidebar-link">ActiveRecord Transactions</a></li><li><a href="/rubyonrails/rspec-and-ruby-on-rails.html" class="sidebar-link">RSpec and Ruby on Rails</a></li><li><a href="/rubyonrails/decorator-pattern.html" class="sidebar-link">Decorator pattern</a></li><li><a href="/rubyonrails/elasticsearch.html" class="sidebar-link">Elasticsearch</a></li><li><a href="/rubyonrails/react-with-rails-using-react-rails-gem.html" class="sidebar-link">React with Rails using react-rails gem</a></li><li><a href="/rubyonrails/rails-cookbook-advanced-rails-recipes-learnings-and-coding-techniques.html" class="sidebar-link">Rails Cookbook - Advanced rails recipes/learnings and coding techniques</a></li><li><a href="/rubyonrails/multipurpose-activerecord-columns.html" class="sidebar-link">Multipurpose ActiveRecord columns</a></li><li><a href="/rubyonrails/class-organization.html" class="sidebar-link">Class Organization</a></li><li><a href="/rubyonrails/shallow-routing.html" class="sidebar-link">Shallow Routing</a></li><li><a href="/rubyonrails/model-states-aasm.html" class="sidebar-link">Model states: AASM</a></li><li><a href="/rubyonrails/rails-5-api-authetication.html" class="sidebar-link">Rails 5 API Authetication</a></li><li><a href="/rubyonrails/testing-rails-applications.html" class="sidebar-link">Testing Rails Applications</a></li><li><a href="/rubyonrails/active-jobs.html" class="sidebar-link">Active Jobs</a></li><li><a href="/rubyonrails/rails-frameworks-over-the-years.html" class="sidebar-link">Rails frameworks over the years</a></li><li><a href="/rubyonrails/nested-form-in-ruby-on-rails.html" class="sidebar-link">Nested form in Ruby on Rails</a></li><li><a href="/rubyonrails/factory-girl.html" class="sidebar-link">Factory Girl</a></li><li><a href="/rubyonrails/import-whole-csv-files-from-specific-folder.html" class="sidebar-link">Import whole CSV files from specific folder</a></li><li><a href="/rubyonrails/tools-for-ruby-on-rails-code-optimization-and-cleanup.html" class="sidebar-link">Tools for Ruby on Rails code optimization and cleanup</a></li><li><a href="/rubyonrails/activejob.html" class="sidebar-link">ActiveJob</a></li><li><a href="/rubyonrails/active-model-serializers.html" class="sidebar-link">Active Model Serializers</a></li><li><a href="/rubyonrails/rails-engine-modular-rails.html" class="sidebar-link">Rails Engine -  Modular Rails</a></li><li><a href="/rubyonrails/single-table-inheritance.html" class="sidebar-link">Single Table Inheritance</a></li><li><a href="/rubyonrails/activerecord-transactions.html" class="sidebar-link">ActiveRecord Transactions</a></li><li><a href="/rubyonrails/turbolinks.html" class="sidebar-link">Turbolinks</a></li><li><a href="/rubyonrails/friendly-id.html" class="sidebar-link">Friendly ID</a></li><li><a href="/rubyonrails/securely-storing-authentication-keys.html" class="sidebar-link">Securely storing authentication keys</a></li><li><a href="/rubyonrails/authenticate-api-using-devise.html" class="sidebar-link">Authenticate Api using Devise</a></li><li><a href="/rubyonrails/integrating-react-js-with-rails-using-hyperloop.html" class="sidebar-link">Integrating React.js with Rails Using Hyperloop</a></li><li><a href="/rubyonrails/change-a-default-rails-application-enviornment.html" class="sidebar-link">Change a default Rails application enviornment</a></li><li><a href="/rubyonrails/rails-engines.html" class="sidebar-link">Rails -Engines</a></li><li><a href="/rubyonrails/adding-an-amazon-rds-to-your-rails-application.html" class="sidebar-link">Adding an Amazon RDS to your rails application</a></li><li><a href="/rubyonrails/payment-feature-in-rails.html" class="sidebar-link">Payment feature in rails</a></li><li><a href="/rubyonrails/rails-on-docker.html" class="sidebar-link">Rails on docker</a></li><li><a href="/rubyonrails/reserved-words.html" class="sidebar-link">Reserved Words</a></li><li><a href="/rubyonrails/add-admin-panel.html" class="sidebar-link">Add Admin Panel</a></li><li><a href="/rubyonrails/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="activerecord-migrations"><a href="#activerecord-migrations" class="header-anchor">#</a> ActiveRecord Migrations</h1> <h2 id="adding-multiple-columns-to-a-table"><a href="#adding-multiple-columns-to-a-table" class="header-anchor">#</a> Adding multiple columns to a table</h2> <p>To add multiple columns to a table, separate <code>field:type</code> pairs with spaces when using <code>rails generate migration</code> command.</p> <p>The general syntax is:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails generate migration <span class="token constant">NAME</span> <span class="token punctuation">[</span>field<span class="token punctuation">[</span><span class="token symbol">:type</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token symbol">:index</span><span class="token punctuation">]</span> field<span class="token punctuation">[</span><span class="token symbol">:type</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token symbol">:index</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

</code></pre></div><p>For example, the following will add <code>name</code>, <code>salary</code> and <code>email</code> fields to the <code>users</code> table:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails generate migration <span class="token constant">AddDetailsToUsers</span> name<span class="token symbol">:string</span> salary<span class="token symbol">:decimal</span> email<span class="token symbol">:string</span>

</code></pre></div><p>Which generates the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddDetailsToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:string</span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:salary</span><span class="token punctuation">,</span> <span class="token symbol">:decimal</span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:email</span><span class="token punctuation">,</span> <span class="token symbol">:string</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="add-a-reference-column-to-a-table"><a href="#add-a-reference-column-to-a-table" class="header-anchor">#</a> Add a reference column to a table</h2> <p>To add a reference to a <code>team</code> to the <code>users</code> table, run this command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>$ rails generate migration <span class="token constant">AddTeamRefToUsers</span> team<span class="token symbol">:references</span>

</code></pre></div><p>This generates the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddTeamRefToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_reference <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:team</span><span class="token punctuation">,</span> foreign_key<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><p>That migration will create a <code>team_id</code> column in the <code>users</code> table.</p> <p>If you want to add an appropriate <code>index</code> and <code>foreign_key</code> on the added column, change the command to <code>rails generate migration AddTeamRefToUsers team:references:index</code>. This will generate the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddTeamRefToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_reference <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:team</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token boolean">true</span>
    add_foreign_key <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:teams</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><p>If you want to name your reference column other than what Rails auto generates, add the following to your migration: (E.g.: You might want to call the <code>User</code> who created the <code>Post</code> as <code>Author</code> in the <code>Post</code> table)</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddAuthorRefToPosts</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_reference <span class="token symbol">:posts</span><span class="token punctuation">,</span> <span class="token symbol">:author</span><span class="token punctuation">,</span> references<span class="token punctuation">:</span> <span class="token symbol">:users</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="rollback-migrations"><a href="#rollback-migrations" class="header-anchor">#</a> Rollback migrations</h2> <p>To <code>rollback</code> the latest migration, either by reverting the <code>change</code> method or by running the <code>down</code> method. Run command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:rollback</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:rollback</span>

</code></pre></div><h3 id="rollback-the-last-3-migrations"><a href="#rollback-the-last-3-migrations" class="header-anchor">#</a> Rollback the last 3 migrations</h3> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:rollback</span> <span class="token constant">STEP</span><span class="token operator">=</span><span class="token number">3</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:rollback</span> <span class="token constant">STEP</span><span class="token operator">=</span><span class="token number">3</span>

</code></pre></div><p><code>STEP</code> provide the number of migrations to revert.</p> <h3 id="rollback-all-migrations"><a href="#rollback-all-migrations" class="header-anchor">#</a> Rollback all migrations</h3> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:rollback</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">0</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:rollback</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">0</span>

</code></pre></div><h2 id="add-a-new-column-with-an-index"><a href="#add-a-new-column-with-an-index" class="header-anchor">#</a> Add a new column with an index</h2> <p>To add a new <strong>indexed</strong> column <code>email</code> to the <code>users</code> table, run the command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails generate migration <span class="token constant">AddEmailToUsers</span> email<span class="token symbol">:string</span><span class="token symbol">:index</span>

</code></pre></div><p>This will generate the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddEmailToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:email</span><span class="token punctuation">,</span> <span class="token symbol">:string</span>
    add_index <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:email</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="run-specific-migration"><a href="#run-specific-migration" class="header-anchor">#</a> Run specific migration</h2> <p>To run a specific migration up or down, use <code>db:migrate:up</code> or <code>db:migrate:down</code>.</p> <p>Up a specific migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span><span class="token symbol">:up</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">20090408054555</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span><span class="token symbol">:up</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">20090408054555</span> 

</code></pre></div><p>Down a specific migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span><span class="token symbol">:down</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">20090408054555</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span><span class="token symbol">:down</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">20090408054555</span>

</code></pre></div><p>The version number in the above commands is the numeric prefix in the migration’s filename. For example, to migrate to the migration <code>20160515085959_add_name_to_users.rb</code>, you would use <code>20160515085959</code> as the version number.</p> <h2 id="redo-migrations"><a href="#redo-migrations" class="header-anchor">#</a> Redo migrations</h2> <p>You can rollback and then migrate again using the <code>redo</code> command. This is basically a shortcut that combines <code>rollback</code> and <code>migrate</code> tasks.</p> <p>Run command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span><span class="token symbol">:redo</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span><span class="token symbol">:redo</span>

</code></pre></div><p>You can use the <code>STEP</code> parameter to go back more than one version.</p> <p>For example, to go back 3 migrations:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span><span class="token symbol">:redo</span> <span class="token constant">STEP</span><span class="token operator">=</span><span class="token number">3</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span><span class="token symbol">:redo</span> <span class="token constant">STEP</span><span class="token operator">=</span><span class="token number">3</span>

</code></pre></div><h2 id="add-a-new-column-to-a-table"><a href="#add-a-new-column-to-a-table" class="header-anchor">#</a> Add a new column to a table</h2> <p>To add a new column <code>name</code> to the <code>users</code> table, run the command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails generate migration <span class="token constant">AddNameToUsers</span> name

</code></pre></div><p>This generates the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddNameToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:string</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><p>When the migration name is of the form <code>AddXXXToTABLE_NAME</code> followed by list of columns with data types, the generated migration will contain the appropriate <code>add_column</code> statements.</p> <h2 id="remove-an-existing-column-from-a-table"><a href="#remove-an-existing-column-from-a-table" class="header-anchor">#</a> Remove an existing column from a table</h2> <p>To remove existing column <code>name</code> from <code>users</code> table, run the command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails generate migration <span class="token constant">RemoveNameFromUsers</span> name<span class="token symbol">:string</span>

</code></pre></div><p>This will generate the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">RemoveNameFromUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    remove_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:string</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><p>When the migration name is of the form <code>RemoveXXXFromYYY</code> followed by list of columns with data types then the generated migration will contain the appropriate <code>remove_column</code> statements.</p> <p>While it’s not required to specify the data type (e.g. <code>:string</code>) as a parameter to <code>remove_column</code>, it is highly recommended. If the data type is <strong>not</strong> specified, then the migration will not be reversible.</p> <h2 id="running-migrations-in-different-environments"><a href="#running-migrations-in-different-environments" class="header-anchor">#</a> Running migrations in different environments</h2> <p>To run migrations in the <code>test</code> environment, run this shell command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span> <span class="token constant">RAILS_ENV</span><span class="token operator">=</span>test

</code></pre></div><p>Starting in Rails 5.0, you can use <code>rails</code> instead of <code>rake</code>:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span> <span class="token constant">RAILS_ENV</span><span class="token operator">=</span>test

</code></pre></div><h2 id="create-a-new-table"><a href="#create-a-new-table" class="header-anchor">#</a> Create a new table</h2> <p>To create a new <code>users</code> table with the columns <code>name</code> and <code>salary</code>, run the command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails generate migration <span class="token constant">CreateUsers</span> name<span class="token symbol">:string</span> salary<span class="token symbol">:decimal</span>

</code></pre></div><p>This will generate the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">CreateUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    create_table <span class="token symbol">:users</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
      t<span class="token punctuation">.</span>string <span class="token symbol">:name</span>
      t<span class="token punctuation">.</span>decimal <span class="token symbol">:salary</span>  
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><p>When the migration name is of the form <code>CreateXXX</code> followed by list of columns with data types, then a migration will be generated that creates the table <code>XXX</code> with the listed columns.</p> <h2 id="running-migrations"><a href="#running-migrations" class="header-anchor">#</a> Running migrations</h2> <p>Run command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span>

</code></pre></div><p>Specifying target version will run the required migrations (up, down, change) until it has reached the specified version. Here, <code>version number</code> is the numerical prefix on the migration's filename.</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">20080906120000</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span> <span class="token constant">VERSION</span><span class="token operator">=</span><span class="token number">20080906120000</span>

</code></pre></div><h2 id="change-an-existing-column-s-type"><a href="#change-an-existing-column-s-type" class="header-anchor">#</a> Change an existing column’s type</h2> <p>To modify an existing column in Rails with a migration, run the following command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails g migration change_column_in_table

</code></pre></div><p>This will create a new migration file in <code>db/migration</code> directory (if it doesn’t exist already), which will contain the file prefixed with timestamp and migration file name which contains the below content:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
  change_column<span class="token punctuation">(</span><span class="token symbol">:table_name</span><span class="token punctuation">,</span> <span class="token symbol">:column_name</span><span class="token punctuation">,</span> <span class="token symbol">:new_type</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

</code></pre></div><p><a href="http://guides.rubyonrails.org/active_record_migrations.html#changing-columns" target="_blank" rel="noopener noreferrer">Rails Guide – Changing Columns<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="a-longer-but-safer-method"><a href="#a-longer-but-safer-method" class="header-anchor">#</a> A longer but safer method</h3> <p>The above code prevents the user from ever rolling back the migration. You can avoid this problem by splitting the <code>change</code> method into separate <code>up</code> and <code>down</code> methods:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">up</span></span>
  change_column <span class="token symbol">:my_table</span><span class="token punctuation">,</span> <span class="token symbol">:my_column</span><span class="token punctuation">,</span> <span class="token symbol">:new_type</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">down</span></span>
  change_column <span class="token symbol">:my_table</span><span class="token punctuation">,</span> <span class="token symbol">:my_column</span><span class="token punctuation">,</span> <span class="token symbol">:old_type</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="add-column-with-default-value"><a href="#add-column-with-default-value" class="header-anchor">#</a> Add column with default value</h2> <p>The following example adds a column <code>admin</code> to the <code>users</code> table, and gives that column the default value <code>false</code>.</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddDetailsToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:admin</span><span class="token punctuation">,</span> <span class="token symbol">:boolean</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><p>Migrations with defaults might take a long time in large tables with for example PostgreSQL. This is because each row will have to be updated with the default value for the newly added column. To circumvent this (and reduce downtime during deployments), you can split your migration into three steps:</p> <ol><li>Add a <code>add_column</code>-migration similar to the one above, but set no default</li> <li>Deploy and update the column in a rake task or on the console while your app is running. Make sure your application already writes data to that colum for new/updated rows.</li> <li>Add another <code>change_column</code> migration, which then changes the default of that column to the desired default value</li></ol> <h2 id="create-a-join-table"><a href="#create-a-join-table" class="header-anchor">#</a> Create a join table</h2> <p>To create a join table between <code>students</code> and <code>courses</code>, run the command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>$ rails g migration <span class="token constant">CreateJoinTableStudentCourse</span> student course

</code></pre></div><p>This will generate the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">CreateJoinTableStudentCourse</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    create_join_table <span class="token symbol">:students</span><span class="token punctuation">,</span> <span class="token symbol">:courses</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
      <span class="token comment"># t.index [:student_id, :course_id]</span>
      <span class="token comment"># t.index [:course_id, :student_id]</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="create-a-hstore-column"><a href="#create-a-hstore-column" class="header-anchor">#</a> Create a hstore column</h2> <p><code>Hstore</code> columns can be useful to store settings. They are available in PostgreSQL databases after you enabled the extension.</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">CreatePages</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    create_table <span class="token symbol">:pages</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
      enable_extension <span class="token string">'hstore'</span> <span class="token keyword">unless</span> extension_enabled<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">'hstore'</span><span class="token punctuation">)</span>
      t<span class="token punctuation">.</span>hstore <span class="token symbol">:settings</span>
      t<span class="token punctuation">.</span>timestamps
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="add-a-self-reference"><a href="#add-a-self-reference" class="header-anchor">#</a> Add a self reference</h2> <p>A self reference can be useful to build a hierarchical tree. This can be achieved with <code>add_reference</code> in a migration.</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddParentPages</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_reference <span class="token symbol">:pages</span><span class="token punctuation">,</span> <span class="token symbol">:pages</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><p>The foreign key column will be <code>pages_id</code>. If you want to decide about the foreign key column name, you have to create the column first and add the reference after.</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddParentPages</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:pages</span><span class="token punctuation">,</span> <span class="token symbol">:parent_id</span><span class="token punctuation">,</span> <span class="token symbol">:integer</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token boolean">true</span>
    add_foreign_key <span class="token symbol">:pages</span><span class="token punctuation">,</span> <span class="token symbol">:pages</span><span class="token punctuation">,</span> column<span class="token punctuation">:</span> <span class="token symbol">:parent_id</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="create-an-array-column"><a href="#create-an-array-column" class="header-anchor">#</a> Create an array column</h2> <p>An <code>array</code> column is supported by PostgreSQL. Rails will automatically convert a PostgreSQL array to a Ruby array, and vice-versa.</p> <p>Create a table with an <code>array</code> column:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>create_table <span class="token symbol">:products</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
  t<span class="token punctuation">.</span>string <span class="token symbol">:name</span>
  t<span class="token punctuation">.</span>text <span class="token symbol">:colors</span><span class="token punctuation">,</span> array<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>

</code></pre></div><p>Add an <code>array</code> column to an existing table:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>add_column <span class="token symbol">:products</span><span class="token punctuation">,</span> <span class="token symbol">:colors</span><span class="token punctuation">,</span> array<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

</code></pre></div><p>Add an index for an <code>array</code> column:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>add_index <span class="token symbol">:products</span><span class="token punctuation">,</span> <span class="token symbol">:colors</span><span class="token punctuation">,</span> using<span class="token punctuation">:</span> <span class="token string">'gin'</span>

</code></pre></div><h2 id="changing-tables"><a href="#changing-tables" class="header-anchor">#</a> Changing Tables</h2> <p>If you have created a table with some wrong schema, then the easiest way to change the columns and their properties is <code>change_table</code>. Review the following example:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>change_table <span class="token symbol">:orders</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
  t<span class="token punctuation">.</span>remove <span class="token symbol">:ordered_at</span> <span class="token comment"># removes column ordered_at</span>
  t<span class="token punctuation">.</span>string <span class="token symbol">:skew_number</span> <span class="token comment"># adds a new column </span>
  t<span class="token punctuation">.</span>index  <span class="token symbol">:skew_number</span> <span class="token comment">#creates an index</span>
  t<span class="token punctuation">.</span>rename <span class="token symbol">:location</span><span class="token punctuation">,</span> <span class="token symbol">:state</span> <span class="token comment">#renames location column to state</span>
<span class="token keyword">end</span>

</code></pre></div><p>The above migration changes a table <code>orders</code>. Here is a line-by-line description of the changes:</p> <ol><li><code>t.remove :ordered_at</code> removes the column <code>ordered_at</code> from the table <code>orders</code>.</li> <li><code>t.string :skew_number</code> adds a new string-type column named <code>skew_number</code> in the <code>orders</code> table.</li> <li><code>t.index :skew_number</code> adds an index on the <code>skew_number</code> column in the <code>orders</code> table.</li> <li><code>t.rename :location, :state</code> renames the <code>location</code> column in the <code>orders</code> table to <code>state</code>.</li></ol> <h2 id="add-an-unique-column-to-a-table"><a href="#add-an-unique-column-to-a-table" class="header-anchor">#</a> Add an unique column to a table</h2> <p>To add a new <strong>unique</strong> column <code>email</code> to <code>users</code>, run the following command:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rails generate migration <span class="token constant">AddEmailToUsers</span> email<span class="token symbol">:string</span><span class="token symbol">:uniq</span>

</code></pre></div><p>This will create the following migration:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddEmailToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">5.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:email</span><span class="token punctuation">,</span> <span class="token symbol">:string</span>
    add_index <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:email</span><span class="token punctuation">,</span> unique<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="checking-migration-status"><a href="#checking-migration-status" class="header-anchor">#</a> Checking migration status</h2> <p>We can check the status of migrations by running</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>rake db<span class="token symbol">:migrate</span><span class="token symbol">:status</span>

</code></pre></div><div class="language-ruby extra-class"><pre class="language-ruby"><code>rails db<span class="token symbol">:migrate</span><span class="token symbol">:status</span>

</code></pre></div><p>The output will look like this:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token constant">Status</span>   <span class="token constant">Migration</span> <span class="token constant">ID</span>    <span class="token constant">Migration</span> <span class="token constant">Name</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
up     <span class="token number">20140711185212</span>  <span class="token constant">Create</span> documentation pages
up     <span class="token number">20140724111844</span>  <span class="token constant">Create</span> nifty attachments table
up     <span class="token number">20140724114255</span>  <span class="token constant">Create</span> documentation screenshots
up     <span class="token number">20160213170731</span>  <span class="token constant">Create</span> owners
up     <span class="token number">20160218214551</span>  <span class="token constant">Create</span> users
up     <span class="token number">20160221162159</span>  <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token constant">NO</span> <span class="token constant">FILE</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
up     <span class="token number">20160222231219</span>  <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token constant">NO</span> <span class="token constant">FILE</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>

</code></pre></div><p>Under the status field, <code>up</code> means the migration has been run and <code>down</code> means that we need to run the migration.</p> <h2 id="forbid-null-values"><a href="#forbid-null-values" class="header-anchor">#</a> Forbid null values</h2> <p>To forbid <code>null</code> values in your table columns, add the <code>:null</code> parameter to your migration, like this:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddPriceToProducts</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:products</span><span class="token punctuation">,</span> <span class="token symbol">:float</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h2 id="adding-a-not-null-constraint-to-existing-data"><a href="#adding-a-not-null-constraint-to-existing-data" class="header-anchor">#</a> Adding a NOT NULL constraint to existing data</h2> <p>Say you want to add a foreign key <code>company_id</code> to the <code>users</code> table, and you want to have a <code>NOT NULL</code> constraint on it. If you already have data in <code>users</code>, you will have to do this in multiple steps.</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">AddCompanyIdToUsers</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">up</span></span>
    <span class="token comment"># add the column with NULL allowed</span>
    add_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:company_id</span><span class="token punctuation">,</span> <span class="token symbol">:integer</span>

    <span class="token comment"># make sure every row has a value</span>
    <span class="token constant">User</span><span class="token punctuation">.</span>find_each <span class="token keyword">do</span> <span class="token operator">|</span>user<span class="token operator">|</span>
      <span class="token comment"># find the appropriate company record for the user</span>
      <span class="token comment"># according to your business logic</span>
      company <span class="token operator">=</span> <span class="token constant">Company</span><span class="token punctuation">.</span>first
      user<span class="token punctuation">.</span>update<span class="token operator">!</span><span class="token punctuation">(</span>company_id<span class="token punctuation">:</span> company<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token comment"># add NOT NULL constraint</span>
    change_column_null <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:company_id</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
  <span class="token keyword">end</span>

  <span class="token comment"># Migrations that manipulate data must use up/down instead of change</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">down</span></span>
    remove_column <span class="token symbol">:users</span><span class="token punctuation">,</span> <span class="token symbol">:company_id</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</code></pre></div><h4 id="parameters"><a href="#parameters" class="header-anchor">#</a> Parameters</h4> <table><thead><tr><th>Column type</th> <th>Description</th></tr></thead> <tbody><tr><td><code>:primary_key</code></td> <td>Primary key</td></tr> <tr><td><code>:string</code></td> <td>Shorter string datatype. Allows <code>limit</code> option for maximum number of characters.</td></tr> <tr><td><code>:text</code></td> <td>Longer amount of text. Allows <code>limit</code> option for maximum number of bytes.</td></tr> <tr><td><code>:integer</code></td> <td>Integer. Allows <code>limit</code> option for maximum number of bytes.</td></tr> <tr><td><code>:bigint</code></td> <td>Larger integer</td></tr> <tr><td><code>:float</code></td> <td>Float</td></tr> <tr><td><code>:decimal</code></td> <td>Decimal number with variable precision. Allows <code>precision</code> and <code>scale</code> options.</td></tr> <tr><td><code>:numeric</code></td> <td>Allows <code>precision</code> and <code>scale</code> options.</td></tr> <tr><td><code>:datetime</code></td> <td>DateTime object for dates/times.</td></tr> <tr><td><code>:time</code></td> <td>Time object for times.</td></tr> <tr><td><code>:date</code></td> <td>Date object for dates.</td></tr> <tr><td><code>:binary</code></td> <td>Binary data. Allows <code>limit</code> option for maximum number of bytes.</td></tr> <tr><td><code>:boolean</code></td> <td>Boolean</td></tr></tbody></table> <h4 id="remarks"><a href="#remarks" class="header-anchor">#</a> Remarks</h4> <li>
Most migration files live in `db/migrate/` directory. They’re identified by a UTC timestamp at the beginning of their file name: `YYYYMMDDHHMMSS_create_products.rb`.
</li> <li>
The `rails generate` command can be shortened to `rails g`.
</li> <li>
If a `:type` is not passed to a field, it defaults to a string.
</li></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/rubyonrails/activerecord-migrations.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rubyonrails/views.html" class="prev">
        Views
      </a></span> <span class="next"><a href="/rubyonrails/rails-best-practices.html">
        Rails Best Practices
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/3131.f2aed990.js" defer></script>
  </body>
</html>
