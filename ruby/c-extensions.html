<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ruby - C Extensions</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Your first extension, Working with C Structs, Writing Inline C  - RubyInLine">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="Ruby - C Extensions">
    <meta property="og:description" content="Your first extension, Working with C Structs, Writing Inline C  - RubyInLine">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/ruby/c-extensions.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="Ruby - C Extensions">
    <meta name="twitter:description" content="Your first extension, Working with C Structs, Writing Inline C  - RubyInLine">
    <meta name="twitter:url" content="/ruby/c-extensions.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    <link rel="preload" href="/assets/css/0.styles.8b877eb8.css" as="style"><link rel="preload" href="/assets/js/app.ced448ab.js" as="script"><link rel="preload" href="/assets/js/3.f1d73125.js" as="script"><link rel="preload" href="/assets/js/3051.47120c31.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8b877eb8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Ruby</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ruby/" class="sidebar-link">Disclaimer</a></li><li><a href="/ruby/installation.html" class="sidebar-link">Installation</a></li><li><a href="/ruby/getting-started-with-ruby-language.html" class="sidebar-link">Getting started with Ruby Language</a></li><li><a href="/ruby/casting-type-conversion.html" class="sidebar-link">Casting (type conversion)</a></li><li><a href="/ruby/operators.html" class="sidebar-link">Operators</a></li><li><a href="/ruby/variable-scope-and-visibility.html" class="sidebar-link">Variable Scope and Visibility</a></li><li><a href="/ruby/environment-variables.html" class="sidebar-link">Environment Variables</a></li><li><a href="/ruby/constants.html" class="sidebar-link">Constants</a></li><li><a href="/ruby/special-constants-in-ruby.html" class="sidebar-link">Special Constants in Ruby</a></li><li><a href="/ruby/comments.html" class="sidebar-link">Comments</a></li><li><a href="/ruby/arrays.html" class="sidebar-link">Arrays</a></li><li><a href="/ruby/multidimensional-arrays.html" class="sidebar-link">Multidimensional Arrays</a></li><li><a href="/ruby/strings.html" class="sidebar-link">Strings</a></li><li><a href="/ruby/datetime.html" class="sidebar-link">DateTime</a></li><li><a href="/ruby/time.html" class="sidebar-link">Time</a></li><li><a href="/ruby/numbers.html" class="sidebar-link">Numbers</a></li><li><a href="/ruby/symbols.html" class="sidebar-link">Symbols</a></li><li><a href="/ruby/comparable.html" class="sidebar-link">Comparable</a></li><li><a href="/ruby/control-flow.html" class="sidebar-link">Control Flow</a></li><li><a href="/ruby/methods.html" class="sidebar-link">Methods</a></li><li><a href="/ruby/hashes.html" class="sidebar-link">Hashes</a></li><li><a href="/ruby/blocks-and-procs-and-lambdas.html" class="sidebar-link">Blocks and Procs and Lambdas</a></li><li><a href="/ruby/iteration.html" class="sidebar-link">Iteration</a></li><li><a href="/ruby/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/ruby/enumerators.html" class="sidebar-link">Enumerators</a></li><li><a href="/ruby/enumerable-in-ruby.html" class="sidebar-link">Enumerable in Ruby</a></li><li><a href="/ruby/classes.html" class="sidebar-link">Classes</a></li><li><a href="/ruby/inheritance.html" class="sidebar-link">Inheritance</a></li><li><a href="/ruby/method-missing.html" class="sidebar-link">method_missing</a></li><li><a href="/ruby/regular-expressions-and-regex-based-operations.html" class="sidebar-link">Regular Expressions and Regex Based Operations</a></li><li><a href="/ruby/file-and-i-o-operations.html" class="sidebar-link">File and I/O Operations</a></li><li><a href="/ruby/ruby-access-modifiers.html" class="sidebar-link">Ruby Access Modifiers</a></li><li><a href="/ruby/design-patterns-and-idioms-in-ruby.html" class="sidebar-link">Design Patterns and Idioms in Ruby</a></li><li><a href="/ruby/loading-source-files.html" class="sidebar-link">Loading Source Files</a></li><li><a href="/ruby/thread.html" class="sidebar-link">Thread</a></li><li><a href="/ruby/range.html" class="sidebar-link">Range</a></li><li><a href="/ruby/modules.html" class="sidebar-link">Modules</a></li><li><a href="/ruby/introspection-in-ruby.html" class="sidebar-link">Introspection in Ruby</a></li><li><a href="/ruby/monkey-patching-in-ruby.html" class="sidebar-link">Monkey Patching in Ruby</a></li><li><a href="/ruby/recursion-in-ruby.html" class="sidebar-link">Recursion in Ruby</a></li><li><a href="/ruby/splat-operator.html" class="sidebar-link">Splat operator (*)</a></li><li><a href="/ruby/json-with-ruby.html" class="sidebar-link">JSON with Ruby</a></li><li><a href="/ruby/pure-rspec-json-api-testing.html" class="sidebar-link">Pure RSpec JSON API testing</a></li><li><a href="/ruby/gem-creation-management.html" class="sidebar-link">Gem Creation/Management</a></li><li><a href="/ruby/rbenv.html" class="sidebar-link">rbenv</a></li><li><a href="/ruby/gem-usage.html" class="sidebar-link">Gem Usage</a></li><li><a href="/ruby/singleton-class.html" class="sidebar-link">Singleton Class</a></li><li><a href="/ruby/queue.html" class="sidebar-link">Queue</a></li><li><a href="/ruby/destructuring.html" class="sidebar-link">Destructuring</a></li><li><a href="/ruby/struct.html" class="sidebar-link">Struct</a></li><li><a href="/ruby/metaprogramming.html" class="sidebar-link">Metaprogramming</a></li><li><a href="/ruby/dynamic-evaluation.html" class="sidebar-link">Dynamic Evaluation</a></li><li><a href="/ruby/instance-eval.html" class="sidebar-link">instance_eval</a></li><li><a href="/ruby/message-passing.html" class="sidebar-link">Message Passing</a></li><li><a href="/ruby/keyword-arguments.html" class="sidebar-link">Keyword Arguments</a></li><li><a href="/ruby/truthiness.html" class="sidebar-link">Truthiness</a></li><li><a href="/ruby/implicit-receivers-and-understanding-self.html" class="sidebar-link">Implicit Receivers and Understanding Self</a></li><li><a href="/ruby/introspection.html" class="sidebar-link">Introspection</a></li><li><a href="/ruby/refinements.html" class="sidebar-link">Refinements</a></li><li><a href="/ruby/catching-exceptions-with-begin-rescue.html" class="sidebar-link">Catching Exceptions with Begin / Rescue</a></li><li><a href="/ruby/command-line-apps.html" class="sidebar-link">Command Line Apps</a></li><li><a href="/ruby/irb.html" class="sidebar-link">IRB</a></li><li><a href="/ruby/erb.html" class="sidebar-link">ERB</a></li><li><a href="/ruby/generate-a-random-number.html" class="sidebar-link">Generate a random number</a></li><li><a href="/ruby/getting-started-with-hanami.html" class="sidebar-link">Getting started with Hanami</a></li><li><a href="/ruby/optionparser.html" class="sidebar-link">OptionParser</a></li><li><a href="/ruby/operating-system-or-shell-commands.html" class="sidebar-link">Operating System or Shell commands</a></li><li><a href="/ruby/c-extensions.html" class="active sidebar-link">C Extensions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ruby/c-extensions.html#your-first-extension" class="sidebar-link">Your first extension</a></li><li class="sidebar-sub-header"><a href="/ruby/c-extensions.html#working-with-c-structs" class="sidebar-link">Working with C Structs</a></li><li class="sidebar-sub-header"><a href="/ruby/c-extensions.html#writing-inline-c-rubyinline" class="sidebar-link">Writing Inline C  - RubyInLine</a></li></ul></li><li><a href="/ruby/debugging.html" class="sidebar-link">Debugging</a></li><li><a href="/ruby/ruby-version-manager.html" class="sidebar-link">Ruby Version Manager</a></li><li><a href="/ruby/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="c-extensions"><a href="#c-extensions" class="header-anchor">#</a> C Extensions</h1> <h2 id="your-first-extension"><a href="#your-first-extension" class="header-anchor">#</a> Your first extension</h2> <p>C extensions are comprised of two general pieces:</p> <ol><li>The C Code itself.</li> <li>The extension configuration file.</li></ol> <p>To get started with your first extension put the following in a file named <code>extconf.rb</code>:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">require</span> <span class="token string">'mkmf'</span>

create_makefile<span class="token punctuation">(</span><span class="token string">'hello_c'</span><span class="token punctuation">)</span>

</code></pre></div><p>A couple of things to point out:</p> <p>First, the name <code>hello_c</code> is what the output of your compiled extension is going to be named. It will be what you use in conjunction with <code>require</code>.</p> <p>Second, the <code>extconf.rb</code> file can actually be named anything, it's just traditionally what is used to build gems that have native code, the file that is actually going to compile the extension is the Makefile generated when running <code>ruby extconf.rb</code>. The default Makefile that is generated compiles all <code>.c</code> files in the current directory.</p> <p>Put the following in a file named <code>hello.c</code> and run <code>ruby extconf.rb &amp;&amp; make</code></p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment">#include &lt;stdio.h&gt;</span>
<span class="token comment">#include &quot;ruby.h&quot;</span>

<span class="token constant">VALUE</span> world<span class="token punctuation">(</span><span class="token constant">VALUE</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  printf<span class="token punctuation">(</span><span class="token string">&quot;Hello World!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">Qnil</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">/</span><span class="token operator">/</span> <span class="token constant">The</span> initialization method <span class="token keyword">for</span> this <span class="token keyword">module</span>
void <span class="token constant">Init_hello_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token constant">VALUE</span> <span class="token constant">HelloC</span> <span class="token operator">=</span> rb_define_module<span class="token punctuation">(</span><span class="token string">&quot;HelloC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rb_define_singleton_method<span class="token punctuation">(</span><span class="token constant">HelloC</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span> world<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>A breakdown of the code:</p> <p>The name <code>Init_hello_c</code> must match the name defined in your <code>extconf.rb</code> file, otherwise when dynamically loading the extension, Ruby won't be able to find the symbol to bootstrap your extension.</p> <p>The call to <code>rb_define_module</code> is creating a Ruby module named <code>HelloC</code> which we're going to namespace our C functions under.</p> <p>Finally, the call to <code>rb_define_singleton_method</code> makes a module level method tied directly to the <code>HelloC</code> module which we can invoke from ruby with <code>HelloC.world</code>.</p> <p>After having compiled the extension with the call to <code>make</code> we can run the code in our C extension.</p> <p>Fire up a console!</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">001</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token keyword">require</span> <span class="token string">'./hello_c'</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">002</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token constant">HelloC</span><span class="token punctuation">.</span>world
<span class="token constant">Hello</span> <span class="token constant">World!</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>

</code></pre></div><h2 id="working-with-c-structs"><a href="#working-with-c-structs" class="header-anchor">#</a> Working with C Structs</h2> <p>In order to be able to work with C structs as Ruby objects, you need to wrap them with calls to <code>Data_Wrap_Struct</code> and <code>Data_Get_Struct</code>.</p> <p><code>Data_Wrap_Struct</code> wraps a C data structure in a Ruby object. It takes a pointer to your data structure, along with a few pointers to callback functions, and returns a VALUE. The <code>Data_Get_Struct</code> macro takes that VALUE and gives you back a pointer to your C data structure.</p> <p>Here's a simple example:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment">#include &lt;stdio.h&gt;</span>
<span class="token comment">#include &lt;ruby.h&gt;</span>

typedef struct example_struct <span class="token punctuation">{</span>
  char <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span> example_struct<span class="token punctuation">;</span>

void example_struct_free<span class="token punctuation">(</span>example_struct <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token operator">-</span><span class="token operator">&gt;</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    free<span class="token punctuation">(</span><span class="token keyword">self</span><span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ruby_xfree<span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

static <span class="token constant">VALUE</span> rb_example_struct_alloc<span class="token punctuation">(</span><span class="token constant">VALUE</span> klass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">Data_Wrap_Struct</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> example_struct_free<span class="token punctuation">,</span> ruby_xmalloc<span class="token punctuation">(</span>sizeof<span class="token punctuation">(</span>example_struct<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

static <span class="token constant">VALUE</span> rb_example_struct_init<span class="token punctuation">(</span><span class="token constant">VALUE</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token constant">VALUE</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  example_struct<span class="token operator">*</span> p<span class="token punctuation">;</span>

  <span class="token constant">Check_Type</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token constant">T_STRING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token constant">Data_Get_Struct</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> example_struct<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">-</span><span class="token operator">&gt;</span>name <span class="token operator">=</span> <span class="token punctuation">(</span>char <span class="token operator">*</span><span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token constant">RSTRING_LEN</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  memcpy<span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">,</span> <span class="token constant">StringValuePtr</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">RSTRING_LEN</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

static <span class="token constant">VALUE</span> rb_example_struct_name<span class="token punctuation">(</span><span class="token constant">VALUE</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  example_struct<span class="token operator">*</span> p<span class="token punctuation">;</span>
  <span class="token constant">Data_Get_Struct</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> example_struct<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  printf<span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> p<span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token constant">Qnil</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

void <span class="token constant">Init_example</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token constant">VALUE</span> mExample <span class="token operator">=</span> rb_define_module<span class="token punctuation">(</span><span class="token string">&quot;Example&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">VALUE</span> cStruct <span class="token operator">=</span> rb_define_class_under<span class="token punctuation">(</span>mExample<span class="token punctuation">,</span> <span class="token string">&quot;Struct&quot;</span><span class="token punctuation">,</span> rb_cObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

  rb_define_alloc_func<span class="token punctuation">(</span>cStruct<span class="token punctuation">,</span> rb_example_struct_alloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rb_define_method<span class="token punctuation">(</span>cStruct<span class="token punctuation">,</span> <span class="token string">&quot;initialize&quot;</span><span class="token punctuation">,</span> rb_example_struct_init<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rb_define_method<span class="token punctuation">(</span>cStruct<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> rb_example_struct_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>And the <code>extconf.rb</code>:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">require</span> <span class="token string">'mkmf'</span>

create_makefile<span class="token punctuation">(</span><span class="token string">'example'</span><span class="token punctuation">)</span>

</code></pre></div><p>After compiling the extension:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">001</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token keyword">require</span> <span class="token string">'./example'</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">002</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> test_struct <span class="token operator">=</span> <span class="token constant">Example</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">&quot;Test Struct&quot;</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Example::Struct:0x007fc741965068&gt;</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">003</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">&gt;</span> test_struct<span class="token punctuation">.</span>name
<span class="token constant">Test</span> <span class="token builtin">Struct</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>

</code></pre></div><h2 id="writing-inline-c-rubyinline"><a href="#writing-inline-c-rubyinline" class="header-anchor">#</a> Writing Inline C  - RubyInLine</h2> <p>RubyInline is a framework that lets you embed other languages inside your Ruby code. It defines the Module# inline method, which returns a builder object. You pass the builder a string containing code written in a language other than Ruby, and the builder transforms it into something that you can call from Ruby.</p> <p>When given C or C++ code (the two languages supported in the default RubyInline install), the builder objects writes a small extension to disk, compiles it, and loads it. You don't have to deal with the compilation yourself, but you can see the generated code and compiled extensions in the .ruby_inline subdirectory of your home directory.</p> <p><strong>Embed C code right in your Ruby program:</strong></p> <ul><li>RubyInline (available as the <a href="https://rubygems.org/gems/RubyInline/versions/3.12.4" target="_blank" rel="noopener noreferrer">rubyinline<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> gem) create an extension automatically</li></ul> <blockquote></blockquote> <p>RubyInline won't work from within irb</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment">#!/usr/bin/ruby -w</span>
    <span class="token comment"># copy.rb</span>
    <span class="token keyword">require</span> <span class="token string">'rubygems'</span>
    <span class="token keyword">require</span> <span class="token string">'inline'</span>

    <span class="token keyword">class</span> <span class="token class-name">Copier</span>
    inline <span class="token keyword">do</span> <span class="token operator">|</span>builder<span class="token operator">|</span>
      builder<span class="token punctuation">.</span>c <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token keyword">END</span>
    void copy_file<span class="token punctuation">(</span>const char <span class="token operator">*</span>source<span class="token punctuation">,</span> const char <span class="token operator">*</span>dest<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token constant">FILE</span> <span class="token operator">*</span>source_f <span class="token operator">=</span> fopen<span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>source_f<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        rb_raise<span class="token punctuation">(</span>rb_eIOError<span class="token punctuation">,</span> <span class="token string">&quot;Could not open source : '%s'&quot;</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token constant">FILE</span> <span class="token operator">*</span>dest_f <span class="token operator">=</span> fopen<span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token string">&quot;w+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dest_f<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        rb_raise<span class="token punctuation">(</span>rb_eIOError<span class="token punctuation">,</span> <span class="token string">&quot;Could not open destination : '%s'&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      char buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      int nread <span class="token operator">=</span> fread<span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> source_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>nread <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        fwrite<span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nread<span class="token punctuation">,</span> dest_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nread <span class="token operator">=</span> fread<span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> source_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">END</span>
     <span class="token keyword">end</span>
    <span class="token keyword">end</span>

</code></pre></div><p>C function <code>copy_file</code> now exists as an instance method of <code>Copier</code>:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>open<span class="token punctuation">(</span><span class="token string">'source.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>f<span class="token operator">|</span> f <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token string">'Some text.'</span> <span class="token punctuation">}</span>
<span class="token constant">Copier</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">.</span>copy_file<span class="token punctuation">(</span><span class="token string">'source.txt'</span><span class="token punctuation">,</span> <span class="token string">'dest.txt'</span><span class="token punctuation">)</span>
puts open<span class="token punctuation">(</span><span class="token string">'dest.txt'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>f<span class="token operator">|</span> f<span class="token punctuation">.</span>read <span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/ruby/c-extensions.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ruby/operating-system-or-shell-commands.html" class="prev">
        Operating System or Shell commands
      </a></span> <span class="next"><a href="/ruby/debugging.html">
        Debugging
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ced448ab.js" defer></script><script src="/assets/js/3.f1d73125.js" defer></script><script src="/assets/js/3051.47120c31.js" defer></script>
  </body>
</html>
