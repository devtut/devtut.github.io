<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Entity Framework - Optimization Techniques in EF</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Using AsNoTracking, Loading Only Required Data, Execute queries in the database when possible, not in memory., Execute multiple queries async and in parallel, Working with stub entities, Disable change tracking and proxy generation">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="Entity Framework - Optimization Techniques in EF">
    <meta property="og:description" content="Using AsNoTracking, Loading Only Required Data, Execute queries in the database when possible, not in memory., Execute multiple queries async and in parallel, Working with stub entities, Disable change tracking and proxy generation">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/entityframework/optimization-techniques-in-ef.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="Entity Framework - Optimization Techniques in EF">
    <meta name="twitter:description" content="Using AsNoTracking, Loading Only Required Data, Execute queries in the database when possible, not in memory., Execute multiple queries async and in parallel, Working with stub entities, Disable change tracking and proxy generation">
    <meta name="twitter:url" content="/entityframework/optimization-techniques-in-ef.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    <link rel="preload" href="/assets/css/0.styles.8b877eb8.css" as="style"><link rel="preload" href="/assets/js/app.ced448ab.js" as="script"><link rel="preload" href="/assets/js/3.f1d73125.js" as="script"><link rel="preload" href="/assets/js/1061.7f00cd92.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8b877eb8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Entity Framework</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/entityframework/" class="sidebar-link">Disclaimer</a></li><li><a href="/entityframework/getting-started-with-entity-framework.html" class="sidebar-link">Getting started with Entity Framework</a></li><li><a href="/entityframework/code-first-conventions.html" class="sidebar-link">Code First Conventions</a></li><li><a href="/entityframework/code-first-dataannotations.html" class="sidebar-link">Code First DataAnnotations</a></li><li><a href="/entityframework/entity-framework-code-first.html" class="sidebar-link">Entity Framework Code First</a></li><li><a href="/entityframework/entity-framework-code-first-migrations.html" class="sidebar-link">Entity-framework Code First Migrations</a></li><li><a href="/entityframework/inheritance-with-entityframework-code-first.html" class="sidebar-link">Inheritance with EntityFramework (Code First)</a></li><li><a href="/entityframework/code-first-fluent-api.html" class="sidebar-link">Code First - Fluent API</a></li><li><a href="/entityframework/mapping-relationship-with-entity-framework-code-first-one-to-one-and-variations.html" class="sidebar-link">Mapping relationship with Entity Framework Code First: One-to-one and variations</a></li><li><a href="/entityframework/mapping-relationship-with-entity-framework-code-first-one-to-many-and-many-to-many.html" class="sidebar-link">Mapping relationship with Entity Framework Code First: One-to-many and Many-to-many</a></li><li><a href="/entityframework/database-first-model-generation.html" class="sidebar-link">Database first model generation</a></li><li><a href="/entityframework/complex-types.html" class="sidebar-link">Complex Types</a></li><li><a href="/entityframework/database-initialisers.html" class="sidebar-link">Database Initialisers</a></li><li><a href="/entityframework/tracking-vs-no-tracking.html" class="sidebar-link">Tracking vs. No-Tracking</a></li><li><a href="/entityframework/transactions.html" class="sidebar-link">Transactions</a></li><li><a href="/entityframework/managing-entity-state.html" class="sidebar-link">Managing entity state</a></li><li><a href="/entityframework/loading-related-entities.html" class="sidebar-link">Loading related entities</a></li><li><a href="/entityframework/model-restraints.html" class="sidebar-link">Model Restraints</a></li><li><a href="/entityframework/entity-framework-with-postgresql.html" class="sidebar-link">Entity-Framework  with Postgresql</a></li><li><a href="/entityframework/entity-framework-with-sqlite.html" class="sidebar-link">Entity Framework with SQLite</a></li><li><a href="/entityframework/t4-templates-in-entity-framework.html" class="sidebar-link">.t4 templates in entity-framework</a></li><li><a href="/entityframework/advanced-mapping-scenarios-entity-splitting-table-splitting.html" class="sidebar-link">Advanced mapping scenarios: entity splitting, table splitting</a></li><li><a href="/entityframework/best-practices-for-entity-framework-simple-professional.html" class="sidebar-link">Best Practices For Entity Framework (Simple &amp; Professional)</a></li><li><a href="/entityframework/optimization-techniques-in-ef.html" class="active sidebar-link">Optimization Techniques in EF</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/entityframework/optimization-techniques-in-ef.html#using-asnotracking" class="sidebar-link">Using AsNoTracking</a></li><li class="sidebar-sub-header"><a href="/entityframework/optimization-techniques-in-ef.html#loading-only-required-data" class="sidebar-link">Loading Only Required Data</a></li><li class="sidebar-sub-header"><a href="/entityframework/optimization-techniques-in-ef.html#execute-queries-in-the-database-when-possible-not-in-memory" class="sidebar-link">Execute queries in the database when possible, not in memory.</a></li><li class="sidebar-sub-header"><a href="/entityframework/optimization-techniques-in-ef.html#execute-multiple-queries-async-and-in-parallel" class="sidebar-link">Execute multiple queries async and in parallel</a></li><li class="sidebar-sub-header"><a href="/entityframework/optimization-techniques-in-ef.html#working-with-stub-entities" class="sidebar-link">Working with stub entities</a></li><li class="sidebar-sub-header"><a href="/entityframework/optimization-techniques-in-ef.html#disable-change-tracking-and-proxy-generation" class="sidebar-link">Disable change tracking and proxy generation</a></li></ul></li><li><a href="/entityframework/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="optimization-techniques-in-ef"><a href="#optimization-techniques-in-ef" class="header-anchor">#</a> Optimization Techniques in EF</h1> <h2 id="using-asnotracking"><a href="#using-asnotracking" class="header-anchor">#</a> Using AsNoTracking</h2> <p><strong>Bad Example:</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> location <span class="token operator">=</span>  dbContext<span class="token punctuation">.</span>Location
                     <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> l<span class="token punctuation">.</span>Location<span class="token punctuation">.</span>ID <span class="token operator">==</span> location_ID<span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> location<span class="token punctuation">;</span>

</code></pre></div><p>Since the above code is simply returning an entity without modifying or adding it, we can avoid tracking cost.</p> <p><strong>Good Example:</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> location <span class="token operator">=</span>  dbContext<span class="token punctuation">.</span>Location<span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> l<span class="token punctuation">.</span>Location<span class="token punctuation">.</span>ID <span class="token operator">==</span> location_ID<span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> location<span class="token punctuation">;</span>

</code></pre></div><p>When we use function <code>AsNoTracking()</code> we are explicitly telling Entity Framework that the entities are not tracked by the context. This can be especially useful when retrieving large amounts of data from your data store. If you want to make changes to un-tracked entities however, you must remember to attach them before calling <code>SaveChanges</code>.</p> <h2 id="loading-only-required-data"><a href="#loading-only-required-data" class="header-anchor">#</a> Loading Only Required Data</h2> <p>One problem often seen in code is loading all the data. This will  greatly increase the load on the server.</p> <p>Let's say I have a model called &quot;location&quot; that has 10 fields in it, but not all the fields are required at the same time. Let's say I only want the 'LocationName' parameter of that model.</p> <p><strong>Bad Example</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> location <span class="token operator">=</span>  dbContext<span class="token punctuation">.</span>Location<span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> l<span class="token punctuation">.</span>Location<span class="token punctuation">.</span>ID <span class="token operator">==</span> location_ID<span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> location<span class="token punctuation">.</span>Name<span class="token punctuation">;</span>

</code></pre></div><p><strong>Good Example</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> location <span class="token operator">=</span>  dbContext<span class="token punctuation">.</span>Location
                          <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> l<span class="token punctuation">.</span>Location<span class="token punctuation">.</span>ID <span class="token operator">==</span> location_ID<span class="token punctuation">)</span>
                          <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> l<span class="token punctuation">.</span>LocationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          <span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> location<span class="token punctuation">;</span>

</code></pre></div><p>The code in the &quot;good example&quot; will only fetch 'LocationName' and nothing else.</p> <p>Note that since no entity is materialized in this example, <code>AsNoTracking()</code> isn't necessary. There's nothing to be tracked anyway.</p> <p><strong>Fetching more fields with Anonymous Types</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> location <span class="token operator">=</span> dbContext<span class="token punctuation">.</span>Location
                    <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> l<span class="token punctuation">.</span>Location<span class="token punctuation">.</span>ID <span class="token operator">==</span> location_ID<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> l<span class="token punctuation">.</span>LocationName<span class="token punctuation">,</span> Area <span class="token operator">=</span> l<span class="token punctuation">.</span>LocationArea <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> location<span class="token punctuation">.</span>Name <span class="token operator">+</span> <span class="token string">&quot; has an area of &quot;</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>Area<span class="token punctuation">;</span>

</code></pre></div><p>Same as the example before, only the fields 'LocationName' and 'LocationArea' will be retrieved from the database, the Anonymous Type can hold as many values you want.</p> <h2 id="execute-queries-in-the-database-when-possible-not-in-memory"><a href="#execute-queries-in-the-database-when-possible-not-in-memory" class="header-anchor">#</a> Execute queries in the database when possible, not in memory.</h2> <p>Suppose we want to count how many counties are there in Texas:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> counties <span class="token operator">=</span> dbContext<span class="token punctuation">.</span>States<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Code <span class="token operator">==</span> <span class="token string">&quot;tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Counties<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>The query is correct, but inefficient. <code>States.Single(…)</code> loads a state from the database. Next, <code>Counties</code> loads all 254 counties with all of their fields in a second query. <code>.Count()</code> is then performed <strong>in memory</strong> on the loaded <code>Counties</code> collection.<br>
We've loaded a lot of data we don't need, and we can do better:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> counties <span class="token operator">=</span> dbContext<span class="token punctuation">.</span>Counties<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Code <span class="token operator">==</span> <span class="token string">&quot;tx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Here we only do one query, which in SQL translates to a count and a join. We return only the count from the database - we've saved returning rows, fields, and creation of objects.</p> <p>It is easy to see where the query is made by looking at the collection type: <code>IQueryable&lt;T&gt;</code> vs. <code>IEnumerable&lt;T&gt;</code>.</p> <h2 id="execute-multiple-queries-async-and-in-parallel"><a href="#execute-multiple-queries-async-and-in-parallel" class="header-anchor">#</a> Execute multiple queries async and in parallel</h2> <p>When using async queries, you can execute multiple queries at the same time, but not on the same context. If the execution time of one query is 10s, the time for the bad example will be 20s, while the time for the good example will be 10s.</p> <h3 id="bad-example"><a href="#bad-example" class="header-anchor">#</a> Bad Example</h3> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>TResult1<span class="token punctuation">&gt;</span></span> result1<span class="token punctuation">;</span>
<span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>TResult2<span class="token punctuation">&gt;</span></span> result2<span class="token punctuation">;</span>

<span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    result1 <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult1<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result2 <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult1<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="good-example"><a href="#good-example" class="header-anchor">#</a> Good Example</h3> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult1<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>TResult1<span class="token punctuation">&gt;</span></span> result1<span class="token punctuation">;</span>
<span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>TResult2<span class="token punctuation">&gt;</span></span> result2<span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> result1Task <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult1<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> result2Task <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult2<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>result1Task<span class="token punctuation">,</span> result2Task<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> result1 <span class="token operator">=</span> result1Task<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> result2 <span class="token operator">=</span> result2Task<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>

</code></pre></div><h2 id="working-with-stub-entities"><a href="#working-with-stub-entities" class="header-anchor">#</a> Working with stub entities</h2> <p>Say we have <code>Product</code>s and <code>Category</code>s in a many-to-many relationship:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Categories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HashSet<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ProductId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ProductName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Category<span class="token punctuation">&gt;</span></span> Categories <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Category</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">Category</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Products <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HashSet<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> CategoryId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CategoryName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Product<span class="token punctuation">&gt;</span></span> Products <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>If we want to add a <code>Category</code> to a <code>Product</code>, we have to load the product and add the category to its <code>Categories</code>, for example:</p> <p><strong>Bad Example:</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> product <span class="token operator">=</span> db<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> category <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
product<span class="token punctuation">.</span>Categories<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>(where <code>db</code> is a <code>DbContext</code> subclass).</p> <p>This creates one record in the junction table between <code>Product</code> and <code>Category</code>. However, this table only contains two <code>Id</code> values. It's a waste of resources to load two full entities in order to create one tiny record.</p> <p>A more efficient way is to use <strong>stub entities</strong>, i.e. entity objects, created in memory, containing only the bare minimum of data, usually only an <code>Id</code> value. This is what it looks like:</p> <p><strong>Good example:</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token comment">// Create two stub entities</span>
<span class="token class-name"><span class="token keyword">var</span></span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Product</span> <span class="token punctuation">{</span> ProductId <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> category <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Category</span> <span class="token punctuation">{</span> CategoryId <span class="token operator">=</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Attach the stub entities to the context</span>
db<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> System<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>EntityState<span class="token punctuation">.</span>Unchanged<span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> System<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>EntityState<span class="token punctuation">.</span>Unchanged<span class="token punctuation">;</span>

product<span class="token punctuation">.</span>Categories<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>The end result is the same, but it avoids two roundtrips to the database.</p> <p><strong>Prevent duplicates</strong></p> <p>It you want to check if the association already exists, a cheap query suffices. For example:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token class-name"><span class="token keyword">var</span></span> exists <span class="token operator">=</span> db<span class="token punctuation">.</span>Categories<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Id <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>Products<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Id <span class="token operator">==</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Again, this won't load full entities into memory. It effectively queries the junction table and only returns a boolean.</p> <h2 id="disable-change-tracking-and-proxy-generation"><a href="#disable-change-tracking-and-proxy-generation" class="header-anchor">#</a> Disable change tracking and proxy generation</h2> <p>If you just want to get data, but not modify anything, you can turn off change tracking and proxy creation. This will improve your performance and also prevent lazy loading.</p> <p><strong>Bad Example:</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>Good Example:</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>AutoDetectChangesEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>ProxyCreationEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>It is particularly common to turn these off from within the constructor of your context, especially if you wish these to be set across your solution:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token string">&quot;MyContext&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Configuration<span class="token punctuation">.</span>AutoDetectChangesEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        Configuration<span class="token punctuation">.</span>ProxyCreationEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//snip</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/entityframework/optimization-techniques-in-ef.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/entityframework/best-practices-for-entity-framework-simple-professional.html" class="prev">
        Best Practices For Entity Framework (Simple &amp; Professional)
      </a></span> <span class="next"><a href="/entityframework/contributors.html">
        The Contributors
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ced448ab.js" defer></script><script src="/assets/js/3.f1d73125.js" defer></script><script src="/assets/js/1061.7f00cd92.js" defer></script>
  </body>
</html>
