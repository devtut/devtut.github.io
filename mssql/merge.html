<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Microsoft SQL Server - MERGE</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="MERGE to Insert / Update / Delete, Merge Using CTE Source, MERGE using Derived Source Table, Merge Example - Synchronize Source And Target Table, Merge using EXCEPT">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="Microsoft SQL Server - MERGE">
    <meta property="og:description" content="MERGE to Insert / Update / Delete, Merge Using CTE Source, MERGE using Derived Source Table, Merge Example - Synchronize Source And Target Table, Merge using EXCEPT">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/mssql/merge.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="Microsoft SQL Server - MERGE">
    <meta name="twitter:description" content="MERGE to Insert / Update / Delete, Merge Using CTE Source, MERGE using Derived Source Table, Merge Example - Synchronize Source And Target Table, Merge using EXCEPT">
    <meta name="twitter:url" content="/mssql/merge.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    <link rel="preload" href="/assets/css/0.styles.8b877eb8.css" as="style"><link rel="preload" href="/assets/js/app.ced448ab.js" as="script"><link rel="preload" href="/assets/js/3.f1d73125.js" as="script"><link rel="preload" href="/assets/js/2024.ce8db0d5.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8b877eb8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MS SQL Server</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mssql/" class="sidebar-link">Disclaimer</a></li><li><a href="/mssql/getting-started-with-microsoft-sql-server.html" class="sidebar-link">Getting started with Microsoft SQL Server</a></li><li><a href="/mssql/data-types.html" class="sidebar-link">Data Types</a></li><li><a href="/mssql/converting-data-types.html" class="sidebar-link">Converting data types</a></li><li><a href="/mssql/user-defined-table-types.html" class="sidebar-link">User Defined Table Types</a></li><li><a href="/mssql/select-statement.html" class="sidebar-link">SELECT statement</a></li><li><a href="/mssql/alias-names-in-sql-server.html" class="sidebar-link">Alias Names in Sql Server</a></li><li><a href="/mssql/nulls.html" class="sidebar-link">NULLs</a></li><li><a href="/mssql/variables.html" class="sidebar-link">Variables</a></li><li><a href="/mssql/dates.html" class="sidebar-link">Dates</a></li><li><a href="/mssql/generating-a-range-of-dates.html" class="sidebar-link">Generating a range of dates</a></li><li><a href="/mssql/database-snapshots.html" class="sidebar-link">Database Snapshots</a></li><li><a href="/mssql/coalesce.html" class="sidebar-link">COALESCE</a></li><li><a href="/mssql/if-else.html" class="sidebar-link">IF...ELSE</a></li><li><a href="/mssql/case-statement.html" class="sidebar-link">CASE Statement</a></li><li><a href="/mssql/insert-into.html" class="sidebar-link">INSERT INTO</a></li><li><a href="/mssql/drop-keyword.html" class="sidebar-link">Drop Keyword</a></li><li><a href="/mssql/merge.html" class="active sidebar-link">MERGE</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mssql/merge.html#merge-to-insert-update-delete" class="sidebar-link">MERGE to Insert / Update / Delete</a></li><li class="sidebar-sub-header"><a href="/mssql/merge.html#merge-using-cte-source" class="sidebar-link">Merge Using CTE Source</a></li><li class="sidebar-sub-header"><a href="/mssql/merge.html#merge-using-derived-source-table" class="sidebar-link">MERGE using Derived Source Table</a></li><li class="sidebar-sub-header"><a href="/mssql/merge.html#merge-example-synchronize-source-and-target-table" class="sidebar-link">Merge Example - Synchronize Source And Target Table</a></li><li class="sidebar-sub-header"><a href="/mssql/merge.html#merge-using-except" class="sidebar-link">Merge using EXCEPT</a></li></ul></li><li><a href="/mssql/create-view.html" class="sidebar-link">CREATE VIEW</a></li><li><a href="/mssql/views.html" class="sidebar-link">Views</a></li><li><a href="/mssql/union.html" class="sidebar-link">UNION</a></li><li><a href="/mssql/try-catch.html" class="sidebar-link">TRY/CATCH</a></li><li><a href="/mssql/while-loop.html" class="sidebar-link">WHILE loop</a></li><li><a href="/mssql/over-clause.html" class="sidebar-link">OVER Clause</a></li><li><a href="/mssql/group-by.html" class="sidebar-link">GROUP BY</a></li><li><a href="/mssql/order-by.html" class="sidebar-link">ORDER BY</a></li><li><a href="/mssql/the-stuff-function.html" class="sidebar-link">The STUFF Function</a></li><li><a href="/mssql/json-in-sql-server.html" class="sidebar-link">JSON in Sql Server</a></li><li><a href="/mssql/openjson.html" class="sidebar-link">OPENJSON</a></li><li><a href="/mssql/for-json.html" class="sidebar-link">FOR JSON</a></li><li><a href="/mssql/queries-with-json-data.html" class="sidebar-link">Queries with JSON data</a></li><li><a href="/mssql/storing-json-in-sql-tables.html" class="sidebar-link">Storing JSON in SQL tables</a></li><li><a href="/mssql/modify-json-text.html" class="sidebar-link">Modify JSON text</a></li><li><a href="/mssql/for-xml-path.html" class="sidebar-link">FOR XML PATH</a></li><li><a href="/mssql/join.html" class="sidebar-link">Join</a></li><li><a href="/mssql/cross-apply.html" class="sidebar-link">cross apply</a></li><li><a href="/mssql/computed-columns.html" class="sidebar-link">Computed Columns</a></li><li><a href="/mssql/common-table-expressions.html" class="sidebar-link">Common Table Expressions</a></li><li><a href="/mssql/move-and-copy-data-around-tables.html" class="sidebar-link">Move and copy data around tables</a></li><li><a href="/mssql/limit-result-set.html" class="sidebar-link">Limit Result Set</a></li><li><a href="/mssql/retrieve-information-about-your-instance.html" class="sidebar-link">Retrieve Information about your Instance</a></li><li><a href="/mssql/with-ties-option.html" class="sidebar-link">With Ties Option</a></li><li><a href="/mssql/string-functions.html" class="sidebar-link">String Functions</a></li><li><a href="/mssql/logical-functions.html" class="sidebar-link">Logical Functions</a></li><li><a href="/mssql/aggregate-functions.html" class="sidebar-link">Aggregate Functions</a></li><li><a href="/mssql/string-aggregate-functions-in-sql-server.html" class="sidebar-link">String Aggregate functions in SQL Server</a></li><li><a href="/mssql/ranking-functions.html" class="sidebar-link">Ranking Functions</a></li><li><a href="/mssql/window-functions.html" class="sidebar-link">Window functions</a></li><li><a href="/mssql/pivot-unpivot.html" class="sidebar-link">PIVOT / UNPIVOT</a></li><li><a href="/mssql/dynamic-sql-pivot.html" class="sidebar-link">Dynamic SQL Pivot</a></li><li><a href="/mssql/partitioning.html" class="sidebar-link">Partitioning</a></li><li><a href="/mssql/stored-procedures.html" class="sidebar-link">Stored Procedures</a></li><li><a href="/mssql/retrieve-information-about-the-database.html" class="sidebar-link">Retrieve information about the database</a></li><li><a href="/mssql/split-string-function-in-sql-server.html" class="sidebar-link">Split String function in Sql Server</a></li><li><a href="/mssql/insert.html" class="sidebar-link">Insert</a></li><li><a href="/mssql/primary-keys.html" class="sidebar-link">Primary Keys</a></li><li><a href="/mssql/foreign-keys.html" class="sidebar-link">Foreign Keys</a></li><li><a href="/mssql/last-inserted-identity.html" class="sidebar-link">Last Inserted Identity</a></li><li><a href="/mssql/scope-identity.html" class="sidebar-link">SCOPE_IDENTITY()</a></li><li><a href="/mssql/sequences.html" class="sidebar-link">Sequences</a></li><li><a href="/mssql/indexing.html" class="sidebar-link">Indexing</a></li><li><a href="/mssql/full-text-indexing.html" class="sidebar-link">Full-Text Indexing</a></li><li><a href="/mssql/trigger.html" class="sidebar-link">Trigger</a></li><li><a href="/mssql/cursors.html" class="sidebar-link">Cursors</a></li><li><a href="/mssql/transaction-isolation-levels.html" class="sidebar-link">Transaction isolation levels</a></li><li><a href="/mssql/advanced-options.html" class="sidebar-link">Advanced options</a></li><li><a href="/mssql/migration.html" class="sidebar-link">Migration</a></li><li><a href="/mssql/table-valued-parameters.html" class="sidebar-link">Table Valued Parameters</a></li><li><a href="/mssql/dbmail.html" class="sidebar-link">DBMAIL</a></li><li><a href="/mssql/in-memory-oltp-hekaton.html" class="sidebar-link">In-Memory OLTP (Hekaton)</a></li><li><a href="/mssql/temporal-tables.html" class="sidebar-link">Temporal Tables</a></li><li><a href="/mssql/use-of-temp-table.html" class="sidebar-link">Use of TEMP Table</a></li><li><a href="/mssql/scheduled-task-or-job.html" class="sidebar-link">Scheduled Task or Job</a></li><li><a href="/mssql/isolation-levels-and-locking.html" class="sidebar-link">Isolation levels and locking</a></li><li><a href="/mssql/sorting-ordering-rows.html" class="sidebar-link">Sorting/ordering rows</a></li><li><a href="/mssql/privileges-or-permissions.html" class="sidebar-link">Privileges or Permissions</a></li><li><a href="/mssql/sqlcmd.html" class="sidebar-link">SQLCMD</a></li><li><a href="/mssql/resource-governor.html" class="sidebar-link">Resource Governor</a></li><li><a href="/mssql/file-group.html" class="sidebar-link">File Group</a></li><li><a href="/mssql/basic-ddl-operations-in-ms-sql-server.html" class="sidebar-link">Basic DDL Operations in MS SQL Server</a></li><li><a href="/mssql/subqueries.html" class="sidebar-link">Subqueries</a></li><li><a href="/mssql/pagination.html" class="sidebar-link">Pagination</a></li><li><a href="/mssql/clustered-columnstore.html" class="sidebar-link">CLUSTERED COLUMNSTORE</a></li><li><a href="/mssql/parsename.html" class="sidebar-link">Parsename</a></li><li><a href="/mssql/installing-sql-server-on-windows.html" class="sidebar-link">Installing SQL Server on Windows</a></li><li><a href="/mssql/analyzing-a-query.html" class="sidebar-link">Analyzing a Query</a></li><li><a href="/mssql/query-hints.html" class="sidebar-link">Query Hints</a></li><li><a href="/mssql/query-store.html" class="sidebar-link">Query Store</a></li><li><a href="/mssql/querying-results-by-page.html" class="sidebar-link">Querying results by page</a></li><li><a href="/mssql/schemas.html" class="sidebar-link">Schemas</a></li><li><a href="/mssql/backup-and-restore-database.html" class="sidebar-link">Backup and Restore Database</a></li><li><a href="/mssql/transaction-handling.html" class="sidebar-link">Transaction handling</a></li><li><a href="/mssql/natively-compiled-modules-hekaton.html" class="sidebar-link">Natively compiled modules (Hekaton)</a></li><li><a href="/mssql/spatial-data.html" class="sidebar-link">Spatial Data</a></li><li><a href="/mssql/dynamic-sql.html" class="sidebar-link">Dynamic SQL</a></li><li><a href="/mssql/dynamic-data-masking.html" class="sidebar-link">Dynamic data masking</a></li><li><a href="/mssql/export-data-in-txt-file-by-using-sqlcmd.html" class="sidebar-link">Export data in txt file by using SQLCMD</a></li><li><a href="/mssql/common-language-runtime-integration.html" class="sidebar-link">Common Language Runtime Integration</a></li><li><a href="/mssql/delimiting-special-characters-and-reserved-words.html" class="sidebar-link">Delimiting special characters and reserved words</a></li><li><a href="/mssql/dbcc.html" class="sidebar-link">DBCC</a></li><li><a href="/mssql/bulk-import.html" class="sidebar-link">BULK Import</a></li><li><a href="/mssql/service-broker.html" class="sidebar-link">Service broker</a></li><li><a href="/mssql/permissions-and-security.html" class="sidebar-link">Permissions and Security</a></li><li><a href="/mssql/database-permissions.html" class="sidebar-link">Database permissions</a></li><li><a href="/mssql/row-level-security.html" class="sidebar-link">Row-level security</a></li><li><a href="/mssql/encryption.html" class="sidebar-link">Encryption</a></li><li><a href="/mssql/phantom-read.html" class="sidebar-link">PHANTOM read</a></li><li><a href="/mssql/filestream.html" class="sidebar-link">Filestream</a></li><li><a href="/mssql/bcp-bulk-copy-program-utility.html" class="sidebar-link">bcp (bulk copy program) Utility</a></li><li><a href="/mssql/sql-server-evolution-through-different-versions-2000-2016.html" class="sidebar-link">SQL Server Evolution through different versions (2000 - 2016)</a></li><li><a href="/mssql/sql-server-management-studio-ssms.html" class="sidebar-link">SQL Server Management Studio (SSMS)</a></li><li><a href="/mssql/managing-azure-sql-database.html" class="sidebar-link">Managing Azure SQL Database</a></li><li><a href="/mssql/system-database-tempdb.html" class="sidebar-link">System database - TempDb</a></li><li><a href="/mssql/microsoft-sql-server-management-studio-shortcut-keys.html" class="sidebar-link">Microsoft SQL Server Management Studio Shortcut Keys</a></li><li><a href="/mssql/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="merge"><a href="#merge" class="header-anchor">#</a> MERGE</h1> <p>Starting with SQL Server 2008, it is possible to perform insert, update, or delete operations in a single statement using the MERGE statement.</p> <p>The MERGE statement allows you to join a data source with a target table or view, and then perform multiple actions against the target based on the results of that join.</p> <h2 id="merge-to-insert-update-delete"><a href="#merge-to-insert-update-delete" class="header-anchor">#</a> MERGE to Insert / Update / Delete</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> targetTable

<span class="token keyword">USING</span> sourceTable 
<span class="token keyword">ON</span> <span class="token punctuation">(</span>targetTable<span class="token punctuation">.</span>PKID <span class="token operator">=</span> sourceTable<span class="token punctuation">.</span>PKID<span class="token punctuation">)</span>

<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>targetTable<span class="token punctuation">.</span>PKID <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
    <span class="token keyword">DELETE</span>

<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>targetTable<span class="token punctuation">.</span>PKID <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> 
    <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span> 
        targetTable<span class="token punctuation">.</span>ColumnA <span class="token operator">=</span> sourceTable<span class="token punctuation">.</span>ColumnA<span class="token punctuation">,</span> 
        targetTable<span class="token punctuation">.</span>ColumnB <span class="token operator">=</span> sourceTable<span class="token punctuation">.</span>ColumnB

<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span>
    <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>ColumnA<span class="token punctuation">,</span> ColumnB<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>sourceTable<span class="token punctuation">.</span>ColumnA<span class="token punctuation">,</span> sourceTable<span class="token punctuation">.</span>ColumnB<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> SOURCE <span class="token keyword">THEN</span>
    <span class="token keyword">DELETE</span>
<span class="token punctuation">;</span> <span class="token comment">--&lt; Required</span>

</code></pre></div><p>Description:</p> <ul><li><code>MERGE INTO targetTable</code> - table to be modified</li> <li><code>USING sourceTable</code> - source of data (can be table or view or table valued function)</li> <li><code>ON ...</code> - join condition between <code>targetTable</code> and <code>sourceTable</code>.</li> <li><code>WHEN MATCHED</code> - actions to take when a match is found
</li><li><ul></ul></li> <li><code>AND (targetTable.PKID &gt; 100)</code> - additional condition(s) that must be satisfied in order for the action to be taken</li></ul> <p>Comments:</p> <p>If a specific action is not needed then omit the condition e.g. removing <code>WHEN NOT MATCHED THEN INSERT</code> will prevent records from being inserted</p> <p>Merge statement requires a terminating semicolon.</p> <p>Restrictions:</p> <ul><li><code>WHEN MATCHED</code> does not allow <code>INSERT</code> action</li> <li><code>UPDATE</code> action can update a row only once. This implies that the join condition must produce unique matches.</li></ul> <h2 id="merge-using-cte-source"><a href="#merge-using-cte-source" class="header-anchor">#</a> Merge Using CTE Source</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WITH</span> SourceTableCTE <span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> SourceTable
<span class="token punctuation">)</span>
<span class="token keyword">MERGE</span>  
 TargetTable <span class="token keyword">AS</span> target
<span class="token keyword">USING</span> SourceTableCTE <span class="token keyword">AS</span> source  
<span class="token keyword">ON</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>PKID <span class="token operator">=</span> source<span class="token punctuation">.</span>PKID<span class="token punctuation">)</span>
<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span>     
    <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span> target<span class="token punctuation">.</span>ColumnA <span class="token operator">=</span> source<span class="token punctuation">.</span>ColumnA
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span>
    <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>ColumnA<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>Source<span class="token punctuation">.</span>ColumnA<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="merge-using-derived-source-table"><a href="#merge-using-derived-source-table" class="header-anchor">#</a> MERGE using Derived Source Table</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> TargetTable  <span class="token keyword">AS</span> Target  
<span class="token keyword">USING</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Value1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Value2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Value3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
       <span class="token keyword">AS</span> Source <span class="token punctuation">(</span>PKID<span class="token punctuation">,</span> ColumnA<span class="token punctuation">)</span>  
<span class="token keyword">ON</span> Target<span class="token punctuation">.</span>PKID <span class="token operator">=</span> Source<span class="token punctuation">.</span>PKID 
<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span> 
    <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span> target<span class="token punctuation">.</span>ColumnA<span class="token operator">=</span> source<span class="token punctuation">.</span>ColumnA
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span>
    <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>PKID<span class="token punctuation">,</span> ColumnA<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>Source<span class="token punctuation">.</span>PKID<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>ColumnA<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="merge-example-synchronize-source-and-target-table"><a href="#merge-example-synchronize-source-and-target-table" class="header-anchor">#</a> Merge Example - Synchronize Source And Target Table</h2> <p>To Illustrate the MERGE Statement, consider the following two tables -</p> <li>
**dbo.Product** : This table contains information about the product that company is currently selling
</li> <li>
**dbo.ProductNew**: This table contains information about the product that the company will sell in the future.
</li> <p>The following T-SQL will create and populate these two tables</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">IF</span> OBJECT_id<span class="token punctuation">(</span>N<span class="token string">'dbo.Product'</span><span class="token punctuation">,</span>N<span class="token string">'U'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> 
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> dbo<span class="token punctuation">.</span>Product
GO

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dbo<span class="token punctuation">.</span>Product <span class="token punctuation">(</span>
ProductID <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
ProductName NVARCHAR<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
PRICE MONEY
<span class="token punctuation">)</span>

<span class="token keyword">IF</span> OBJECT_id<span class="token punctuation">(</span>N<span class="token string">'dbo.ProductNew'</span><span class="token punctuation">,</span>N<span class="token string">'U'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> 
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> dbo<span class="token punctuation">.</span>ProductNew
GO

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dbo<span class="token punctuation">.</span>ProductNew <span class="token punctuation">(</span>
ProductID <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
ProductName NVARCHAR<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
PRICE MONEY
<span class="token punctuation">)</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dbo<span class="token punctuation">.</span>Product <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'IPod'</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'IPhone'</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'ChromeCast'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'raspberry pi'</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dbo<span class="token punctuation">.</span>ProductNew <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Asus Notebook'</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Hp Notebook'</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Dell Notebook'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'raspberry pi'</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span>

</code></pre></div><p>Now, Suppose we want to synchoronize the dbo.Product Target Table with the dbo.ProductNew table. Here is the criterion for this task:</p> <li>
Product that exist in both the dbo.ProductNew source table and the dbo.Product target table are updated in the dbo.Product target table with new new Products.
</li> <li>
Any product in the dbo.ProductNew source table that do not exist in the dob.Product target table are inserted into the dbo.Product  target table.
</li> <li><p>Any Product in the dbo.Product target table that do not exist in the dbo.ProductNew source table must be deleted from the dbo.Product target table.
Here is the MERGE statement to perform this task.</p></li> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">MERGE</span> dbo<span class="token punctuation">.</span>Product <span class="token keyword">AS</span> SourceTbl 
<span class="token keyword">USING</span> dbo<span class="token punctuation">.</span>ProductNew <span class="token keyword">AS</span> TargetTbl <span class="token keyword">ON</span> <span class="token punctuation">(</span>SourceTbl<span class="token punctuation">.</span>ProductID <span class="token operator">=</span> TargetTbl<span class="token punctuation">.</span>ProductID<span class="token punctuation">)</span>
<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> 
            <span class="token operator">AND</span> SourceTbl<span class="token punctuation">.</span>ProductName <span class="token operator">&lt;&gt;</span> TargetTbl<span class="token punctuation">.</span>ProductName
            <span class="token operator">OR</span> SourceTbl<span class="token punctuation">.</span>Price <span class="token operator">&lt;&gt;</span> TargetTbl<span class="token punctuation">.</span>Price
    <span class="token keyword">THEN</span> <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span> SourceTbl<span class="token punctuation">.</span>ProductName <span class="token operator">=</span> TargetTbl<span class="token punctuation">.</span>ProductName<span class="token punctuation">,</span>
                SourceTbl<span class="token punctuation">.</span>Price <span class="token operator">=</span> TargetTbl<span class="token punctuation">.</span>Price
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> 
    <span class="token keyword">THEN</span> <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>ProductID<span class="token punctuation">,</span> ProductName<span class="token punctuation">,</span> Price<span class="token punctuation">)</span>
         <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>TargetTbl<span class="token punctuation">.</span>ProductID<span class="token punctuation">,</span> TargetTbl<span class="token punctuation">.</span>ProductName<span class="token punctuation">,</span> TargetTbl<span class="token punctuation">.</span>Price<span class="token punctuation">)</span>
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> SOURCE 
    <span class="token keyword">THEN</span> <span class="token keyword">DELETE</span>
OUTPUT $<span class="token keyword">action</span><span class="token punctuation">,</span> INSERTED<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> DELETED<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">;</span>

</code></pre></div><p>Note:Semicolon must be present in the end of MERGE statement.
<a href="https://i.stack.imgur.com/GULoi.jpg" target="_blank" rel="noopener noreferrer"><img src="https://i.stack.imgur.com/GULoi.jpg" alt="enter image description here"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="merge-using-except"><a href="#merge-using-except" class="header-anchor">#</a> Merge using EXCEPT</h2> <p>Use EXCEPT to prevent updates to unchanged records</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">MERGE</span> TargetTable targ
<span class="token keyword">USING</span> SourceTable <span class="token keyword">AS</span> src
    <span class="token keyword">ON</span> src<span class="token punctuation">.</span>id <span class="token operator">=</span> targ<span class="token punctuation">.</span>id
<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span>
    <span class="token operator">AND</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> src<span class="token punctuation">.</span>field
        <span class="token keyword">EXCEPT</span>
        <span class="token keyword">SELECT</span> targ<span class="token punctuation">.</span>field
        <span class="token punctuation">)</span>
    <span class="token keyword">THEN</span>
        <span class="token keyword">UPDATE</span>
        <span class="token keyword">SET</span> field <span class="token operator">=</span> src<span class="token punctuation">.</span>field
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> TARGET
    <span class="token keyword">THEN</span>
        <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>
            id
            <span class="token punctuation">,</span>field
            <span class="token punctuation">)</span>
        <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>
            src<span class="token punctuation">.</span>id
            <span class="token punctuation">,</span>src<span class="token punctuation">.</span>field
            <span class="token punctuation">)</span>
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> SOURCE
    <span class="token keyword">THEN</span>
        <span class="token keyword">DELETE</span><span class="token punctuation">;</span>

</code></pre></div><h4 id="syntax"><a href="#syntax" class="header-anchor">#</a> Syntax</h4> <li>As per MSDN - [https://msdn.microsoft.com/en-us/library/bb510625.aspx](https://msdn.microsoft.com/en-us/library/bb510625.aspx)
[ WITH <common_table_expression> [,...n] ] MERGE [ TOP ( expression )
[ PERCENT ] ] [ INTO ] <target_table> [ WITH ( <merge_hint> ) ] [ [
AS ] table_alias ] USING <table_source> ON <merge_search_condition> [
WHEN MATCHED [ AND <clause_search_condition> ] THEN <merge_matched> ]
[ ...n ] [ WHEN NOT MATCHED [ BY TARGET ] [ AND
<clause_search_condition> ] THEN <merge_not_matched> ] [ WHEN NOT
MATCHED BY SOURCE [ AND <clause_search_condition> ] THEN
<merge_matched> ] [ ...n ] [ <output_clause> ] [ OPTION (
<query_hint> [ ,...n ] ) ] ; <target_table> ::= { [ database_name .
schema_name . | schema_name . ] target_table } <merge_hint>::= { { [
<table_hint_limited> [ ,...n ] ] [ [ , ] INDEX ( index_val [ ,...n ]
) ] } } <table_source> ::= { table_or_view_name [ [ AS ] table_alias
] [ <tablesample_clause> ] [ WITH ( table_hint [ [ , ]...n ] ) ] |
rowset_function [ [ AS ] table_alias ] [ ( bulk_column_alias [ ,...n
] ) ] | user_defined_function [ [ AS ] table_alias ] | OPENXML
<openxml_clause> | derived_table [ AS ] table_alias [ ( column_alias
[ ,...n ] ) ] | <joined_table> | <pivoted_table> | <unpivoted_table>
} <merge_search_condition> ::= <search_condition><merge_matched>::=
{ UPDATE SET <set_clause> | DELETE } <set_clause>::= SET {
column_name = { expression | DEFAULT | NULL } | { udt_column_name.{ {
property_name = expression | field_name = expression } | method_name
( argument [ ,...n ] ) } } | column_name { .WRITE ( expression ,
@Offset , @Length ) } | @variable = expression | @variable = column =
expression | column_name { += | -= | *= | /= | %= | &amp;= | ^= | |= }
expression | @variable { += | -= | *= | /= | %= | &amp;= | ^= | |= }
expression | @variable = column { += | -= | *= | /= | %= | &amp;= | ^= |
|= } expression } [ ,...n ] <merge_not_matched>::= { INSERT [ (
column_list ) ] { VALUES ( values_list ) | DEFAULT VALUES } }
<clause_search_condition> ::= <search_condition> ::= { [ NOT ] | (
<search_condition> ) } [ { AND | OR } [ NOT ] { | (
<search_condition> ) } ] [ ,...n ] ::= { expression { = | &lt; &gt; | ! = |
<blockquote><p>| &gt; = | ! &gt; | &lt; | &lt; = | ! &lt; } expression | string_expression [ NOT ] LIKE string_expression [ ESCAPE 'escape_character' ] | expression [
NOT ] BETWEEN expression AND expression | expression IS [ NOT ] NULL
| CONTAINS ( { column | * } , '&lt; contains_search_condition &gt;' ) |
FREETEXT ( { column | * } , 'freetext_string' ) | expression [ NOT ]
IN ( subquery | expression [ ,...n ] ) | expression { = | &lt; &gt; | ! = |
| &gt; = | ! &gt; | &lt; | &lt; = | ! &lt; } { ALL | SOME | ANY} ( subquery ) | EXISTS ( subquery ) } <output_clause>::= { [ OUTPUT <dml_select_list>
INTO { @table_variable | output_table } [ (column_list) ] ] [ OUTPUT
<dml_select_list> ] } <dml_select_list>::= { <column_name> |
scalar_expression } [ [AS] column_alias_identifier ] [ ,...n ]
<column_name> ::= { DELETED | INSERTED | from_table_name } . { * |
column_name } | $action</column_name></column_name></dml_select_list></dml_select_list></dml_select_list></output_clause></p></blockquote></search_condition></search_condition></search_condition></clause_search_condition></merge_not_matched></set_clause></set_clause></merge_matched></search_condition></merge_search_condition></unpivoted_table></pivoted_table></joined_table></openxml_clause></tablesample_clause></table_source></table_hint_limited></merge_hint></target_table></query_hint></output_clause></merge_matched></clause_search_condition></merge_not_matched></clause_search_condition></merge_matched></clause_search_condition></merge_search_condition></table_source></merge_hint></target_table></common_table_expression></li> <h4 id="remarks"><a href="#remarks" class="header-anchor">#</a> Remarks</h4> <p>Performs insert, update, or delete operations on a target table based on the results of a join with a source table. For example, you can synchronize two tables by inserting, updating, or deleting rows in one table based on differences found in the other table.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/mssql/merge.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mssql/drop-keyword.html" class="prev">
        Drop Keyword
      </a></span> <span class="next"><a href="/mssql/create-view.html">
        CREATE VIEW
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ced448ab.js" defer></script><script src="/assets/js/3.f1d73125.js" defer></script><script src="/assets/js/2024.ce8db0d5.js" defer></script>
  </body>
</html>
