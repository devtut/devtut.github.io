<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Microsoft SQL Server - OVER Clause</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Cumulative Sum, Using Aggregation functions with OVER, Using Aggregation funtions to find the most recent records, Dividing Data into equally-partitioned buckets using NTILE">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="Microsoft SQL Server - OVER Clause">
    <meta property="og:description" content="Cumulative Sum, Using Aggregation functions with OVER, Using Aggregation funtions to find the most recent records, Dividing Data into equally-partitioned buckets using NTILE">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/mssql/over-clause.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="Microsoft SQL Server - OVER Clause">
    <meta name="twitter:description" content="Cumulative Sum, Using Aggregation functions with OVER, Using Aggregation funtions to find the most recent records, Dividing Data into equally-partitioned buckets using NTILE">
    <meta name="twitter:url" content="/mssql/over-clause.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    <link rel="preload" href="/assets/css/0.styles.8b877eb8.css" as="style"><link rel="preload" href="/assets/js/app.ced448ab.js" as="script"><link rel="preload" href="/assets/js/3.f1d73125.js" as="script"><link rel="preload" href="/assets/js/2033.f3aa623b.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8b877eb8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MS SQL Server</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mssql/" class="sidebar-link">Disclaimer</a></li><li><a href="/mssql/getting-started-with-microsoft-sql-server.html" class="sidebar-link">Getting started with Microsoft SQL Server</a></li><li><a href="/mssql/data-types.html" class="sidebar-link">Data Types</a></li><li><a href="/mssql/converting-data-types.html" class="sidebar-link">Converting data types</a></li><li><a href="/mssql/user-defined-table-types.html" class="sidebar-link">User Defined Table Types</a></li><li><a href="/mssql/select-statement.html" class="sidebar-link">SELECT statement</a></li><li><a href="/mssql/alias-names-in-sql-server.html" class="sidebar-link">Alias Names in Sql Server</a></li><li><a href="/mssql/nulls.html" class="sidebar-link">NULLs</a></li><li><a href="/mssql/variables.html" class="sidebar-link">Variables</a></li><li><a href="/mssql/dates.html" class="sidebar-link">Dates</a></li><li><a href="/mssql/generating-a-range-of-dates.html" class="sidebar-link">Generating a range of dates</a></li><li><a href="/mssql/database-snapshots.html" class="sidebar-link">Database Snapshots</a></li><li><a href="/mssql/coalesce.html" class="sidebar-link">COALESCE</a></li><li><a href="/mssql/if-else.html" class="sidebar-link">IF...ELSE</a></li><li><a href="/mssql/case-statement.html" class="sidebar-link">CASE Statement</a></li><li><a href="/mssql/insert-into.html" class="sidebar-link">INSERT INTO</a></li><li><a href="/mssql/drop-keyword.html" class="sidebar-link">Drop Keyword</a></li><li><a href="/mssql/merge.html" class="sidebar-link">MERGE</a></li><li><a href="/mssql/create-view.html" class="sidebar-link">CREATE VIEW</a></li><li><a href="/mssql/views.html" class="sidebar-link">Views</a></li><li><a href="/mssql/union.html" class="sidebar-link">UNION</a></li><li><a href="/mssql/try-catch.html" class="sidebar-link">TRY/CATCH</a></li><li><a href="/mssql/while-loop.html" class="sidebar-link">WHILE loop</a></li><li><a href="/mssql/over-clause.html" class="active sidebar-link">OVER Clause</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mssql/over-clause.html#cumulative-sum" class="sidebar-link">Cumulative Sum</a></li><li class="sidebar-sub-header"><a href="/mssql/over-clause.html#using-aggregation-functions-with-over" class="sidebar-link">Using Aggregation functions with OVER</a></li><li class="sidebar-sub-header"><a href="/mssql/over-clause.html#using-aggregation-funtions-to-find-the-most-recent-records" class="sidebar-link">Using Aggregation funtions to find the most recent records</a></li><li class="sidebar-sub-header"><a href="/mssql/over-clause.html#dividing-data-into-equally-partitioned-buckets-using-ntile" class="sidebar-link">Dividing Data into equally-partitioned buckets using NTILE</a></li></ul></li><li><a href="/mssql/group-by.html" class="sidebar-link">GROUP BY</a></li><li><a href="/mssql/order-by.html" class="sidebar-link">ORDER BY</a></li><li><a href="/mssql/the-stuff-function.html" class="sidebar-link">The STUFF Function</a></li><li><a href="/mssql/json-in-sql-server.html" class="sidebar-link">JSON in Sql Server</a></li><li><a href="/mssql/openjson.html" class="sidebar-link">OPENJSON</a></li><li><a href="/mssql/for-json.html" class="sidebar-link">FOR JSON</a></li><li><a href="/mssql/queries-with-json-data.html" class="sidebar-link">Queries with JSON data</a></li><li><a href="/mssql/storing-json-in-sql-tables.html" class="sidebar-link">Storing JSON in SQL tables</a></li><li><a href="/mssql/modify-json-text.html" class="sidebar-link">Modify JSON text</a></li><li><a href="/mssql/for-xml-path.html" class="sidebar-link">FOR XML PATH</a></li><li><a href="/mssql/join.html" class="sidebar-link">Join</a></li><li><a href="/mssql/cross-apply.html" class="sidebar-link">cross apply</a></li><li><a href="/mssql/computed-columns.html" class="sidebar-link">Computed Columns</a></li><li><a href="/mssql/common-table-expressions.html" class="sidebar-link">Common Table Expressions</a></li><li><a href="/mssql/move-and-copy-data-around-tables.html" class="sidebar-link">Move and copy data around tables</a></li><li><a href="/mssql/limit-result-set.html" class="sidebar-link">Limit Result Set</a></li><li><a href="/mssql/retrieve-information-about-your-instance.html" class="sidebar-link">Retrieve Information about your Instance</a></li><li><a href="/mssql/with-ties-option.html" class="sidebar-link">With Ties Option</a></li><li><a href="/mssql/string-functions.html" class="sidebar-link">String Functions</a></li><li><a href="/mssql/logical-functions.html" class="sidebar-link">Logical Functions</a></li><li><a href="/mssql/aggregate-functions.html" class="sidebar-link">Aggregate Functions</a></li><li><a href="/mssql/string-aggregate-functions-in-sql-server.html" class="sidebar-link">String Aggregate functions in SQL Server</a></li><li><a href="/mssql/ranking-functions.html" class="sidebar-link">Ranking Functions</a></li><li><a href="/mssql/window-functions.html" class="sidebar-link">Window functions</a></li><li><a href="/mssql/pivot-unpivot.html" class="sidebar-link">PIVOT / UNPIVOT</a></li><li><a href="/mssql/dynamic-sql-pivot.html" class="sidebar-link">Dynamic SQL Pivot</a></li><li><a href="/mssql/partitioning.html" class="sidebar-link">Partitioning</a></li><li><a href="/mssql/stored-procedures.html" class="sidebar-link">Stored Procedures</a></li><li><a href="/mssql/retrieve-information-about-the-database.html" class="sidebar-link">Retrieve information about the database</a></li><li><a href="/mssql/split-string-function-in-sql-server.html" class="sidebar-link">Split String function in Sql Server</a></li><li><a href="/mssql/insert.html" class="sidebar-link">Insert</a></li><li><a href="/mssql/primary-keys.html" class="sidebar-link">Primary Keys</a></li><li><a href="/mssql/foreign-keys.html" class="sidebar-link">Foreign Keys</a></li><li><a href="/mssql/last-inserted-identity.html" class="sidebar-link">Last Inserted Identity</a></li><li><a href="/mssql/scope-identity.html" class="sidebar-link">SCOPE_IDENTITY()</a></li><li><a href="/mssql/sequences.html" class="sidebar-link">Sequences</a></li><li><a href="/mssql/indexing.html" class="sidebar-link">Indexing</a></li><li><a href="/mssql/full-text-indexing.html" class="sidebar-link">Full-Text Indexing</a></li><li><a href="/mssql/trigger.html" class="sidebar-link">Trigger</a></li><li><a href="/mssql/cursors.html" class="sidebar-link">Cursors</a></li><li><a href="/mssql/transaction-isolation-levels.html" class="sidebar-link">Transaction isolation levels</a></li><li><a href="/mssql/advanced-options.html" class="sidebar-link">Advanced options</a></li><li><a href="/mssql/migration.html" class="sidebar-link">Migration</a></li><li><a href="/mssql/table-valued-parameters.html" class="sidebar-link">Table Valued Parameters</a></li><li><a href="/mssql/dbmail.html" class="sidebar-link">DBMAIL</a></li><li><a href="/mssql/in-memory-oltp-hekaton.html" class="sidebar-link">In-Memory OLTP (Hekaton)</a></li><li><a href="/mssql/temporal-tables.html" class="sidebar-link">Temporal Tables</a></li><li><a href="/mssql/use-of-temp-table.html" class="sidebar-link">Use of TEMP Table</a></li><li><a href="/mssql/scheduled-task-or-job.html" class="sidebar-link">Scheduled Task or Job</a></li><li><a href="/mssql/isolation-levels-and-locking.html" class="sidebar-link">Isolation levels and locking</a></li><li><a href="/mssql/sorting-ordering-rows.html" class="sidebar-link">Sorting/ordering rows</a></li><li><a href="/mssql/privileges-or-permissions.html" class="sidebar-link">Privileges or Permissions</a></li><li><a href="/mssql/sqlcmd.html" class="sidebar-link">SQLCMD</a></li><li><a href="/mssql/resource-governor.html" class="sidebar-link">Resource Governor</a></li><li><a href="/mssql/file-group.html" class="sidebar-link">File Group</a></li><li><a href="/mssql/basic-ddl-operations-in-ms-sql-server.html" class="sidebar-link">Basic DDL Operations in MS SQL Server</a></li><li><a href="/mssql/subqueries.html" class="sidebar-link">Subqueries</a></li><li><a href="/mssql/pagination.html" class="sidebar-link">Pagination</a></li><li><a href="/mssql/clustered-columnstore.html" class="sidebar-link">CLUSTERED COLUMNSTORE</a></li><li><a href="/mssql/parsename.html" class="sidebar-link">Parsename</a></li><li><a href="/mssql/installing-sql-server-on-windows.html" class="sidebar-link">Installing SQL Server on Windows</a></li><li><a href="/mssql/analyzing-a-query.html" class="sidebar-link">Analyzing a Query</a></li><li><a href="/mssql/query-hints.html" class="sidebar-link">Query Hints</a></li><li><a href="/mssql/query-store.html" class="sidebar-link">Query Store</a></li><li><a href="/mssql/querying-results-by-page.html" class="sidebar-link">Querying results by page</a></li><li><a href="/mssql/schemas.html" class="sidebar-link">Schemas</a></li><li><a href="/mssql/backup-and-restore-database.html" class="sidebar-link">Backup and Restore Database</a></li><li><a href="/mssql/transaction-handling.html" class="sidebar-link">Transaction handling</a></li><li><a href="/mssql/natively-compiled-modules-hekaton.html" class="sidebar-link">Natively compiled modules (Hekaton)</a></li><li><a href="/mssql/spatial-data.html" class="sidebar-link">Spatial Data</a></li><li><a href="/mssql/dynamic-sql.html" class="sidebar-link">Dynamic SQL</a></li><li><a href="/mssql/dynamic-data-masking.html" class="sidebar-link">Dynamic data masking</a></li><li><a href="/mssql/export-data-in-txt-file-by-using-sqlcmd.html" class="sidebar-link">Export data in txt file by using SQLCMD</a></li><li><a href="/mssql/common-language-runtime-integration.html" class="sidebar-link">Common Language Runtime Integration</a></li><li><a href="/mssql/delimiting-special-characters-and-reserved-words.html" class="sidebar-link">Delimiting special characters and reserved words</a></li><li><a href="/mssql/dbcc.html" class="sidebar-link">DBCC</a></li><li><a href="/mssql/bulk-import.html" class="sidebar-link">BULK Import</a></li><li><a href="/mssql/service-broker.html" class="sidebar-link">Service broker</a></li><li><a href="/mssql/permissions-and-security.html" class="sidebar-link">Permissions and Security</a></li><li><a href="/mssql/database-permissions.html" class="sidebar-link">Database permissions</a></li><li><a href="/mssql/row-level-security.html" class="sidebar-link">Row-level security</a></li><li><a href="/mssql/encryption.html" class="sidebar-link">Encryption</a></li><li><a href="/mssql/phantom-read.html" class="sidebar-link">PHANTOM read</a></li><li><a href="/mssql/filestream.html" class="sidebar-link">Filestream</a></li><li><a href="/mssql/bcp-bulk-copy-program-utility.html" class="sidebar-link">bcp (bulk copy program) Utility</a></li><li><a href="/mssql/sql-server-evolution-through-different-versions-2000-2016.html" class="sidebar-link">SQL Server Evolution through different versions (2000 - 2016)</a></li><li><a href="/mssql/sql-server-management-studio-ssms.html" class="sidebar-link">SQL Server Management Studio (SSMS)</a></li><li><a href="/mssql/managing-azure-sql-database.html" class="sidebar-link">Managing Azure SQL Database</a></li><li><a href="/mssql/system-database-tempdb.html" class="sidebar-link">System database - TempDb</a></li><li><a href="/mssql/microsoft-sql-server-management-studio-shortcut-keys.html" class="sidebar-link">Microsoft SQL Server Management Studio Shortcut Keys</a></li><li><a href="/mssql/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="over-clause"><a href="#over-clause" class="header-anchor">#</a> OVER Clause</h1> <h2 id="cumulative-sum"><a href="#cumulative-sum" class="header-anchor">#</a> Cumulative Sum</h2> <p>Using the <a href="http://stackoverflow.com/documentation/sql/280/example-database/1016/cars-table#t=201604051713005624555" target="_blank" rel="noopener noreferrer">Item Sales Table<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we will try to find out how the sales of our items are increasing through dates. To do so we will calculate the <strong>Cumulative Sum</strong> of total sales per Item order by the sale date.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> item_id<span class="token punctuation">,</span> sale_Date 
       <span class="token function">SUM</span><span class="token punctuation">(</span>quantity <span class="token operator">*</span> price<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> item_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sale_Date <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token keyword">UNBOUNDED</span> <span class="token keyword">PRECEDING</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> SalesTotal
  <span class="token keyword">FROM</span> SalesTable

</code></pre></div><h2 id="using-aggregation-functions-with-over"><a href="#using-aggregation-functions-with-over" class="header-anchor">#</a> Using Aggregation functions with OVER</h2> <p>Using the <a href="http://stackoverflow.com/documentation/sql/280/example-database/1016/cars-table#t=201604051640186575813" target="_blank" rel="noopener noreferrer">Cars Table<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we will calculate the total, max, min and average amount of money each costumer spent and haw many times (COUNT) she brought a car for repairing.</p> <p>Id    CustomerId    MechanicId    Model    Status    Total Cost</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> CustomerId<span class="token punctuation">,</span>  
       <span class="token function">SUM</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> CustomerId<span class="token punctuation">)</span> <span class="token keyword">AS</span> Total<span class="token punctuation">,</span>
       <span class="token function">AVG</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> CustomerId<span class="token punctuation">)</span> <span class="token keyword">AS</span> Avg<span class="token punctuation">,</span>
       <span class="token function">COUNT</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> CustomerId<span class="token punctuation">)</span> <span class="token keyword">AS</span> Count<span class="token punctuation">,</span>
       <span class="token function">MIN</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> CustomerId<span class="token punctuation">)</span> <span class="token keyword">AS</span> Min<span class="token punctuation">,</span>
       <span class="token function">MAX</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> CustomerId<span class="token punctuation">)</span> <span class="token keyword">AS</span> Max
  <span class="token keyword">FROM</span> CarsTable
 <span class="token keyword">WHERE</span> <span class="token keyword">Status</span> <span class="token operator">=</span> <span class="token string">'READY'</span>

</code></pre></div><p>Beware that using OVER in this fashion will not aggregate the rows returned. The above query will return the following:</p> <table><thead><tr><th>CustomerId</th> <th>Total</th> <th>Avg</th> <th>Count</th> <th>Min</th> <th>Max</th></tr></thead> <tbody><tr><td>1</td> <td>430</td> <td>215</td> <td>2</td> <td>200</td> <td>230</td></tr> <tr><td>1</td> <td>430</td> <td>215</td> <td>2</td> <td>200</td> <td>230</td></tr></tbody></table> <p>The duplicated row(s) may not be that useful for reporting purposes.</p> <p>If you wish to simply aggregate data, you will be better off using the GROUP BY clause along with the appropriate aggregate functions Eg:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> CustomerId<span class="token punctuation">,</span>  
       <span class="token function">SUM</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">AS</span> Total<span class="token punctuation">,</span>
       <span class="token function">AVG</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">AS</span> Avg<span class="token punctuation">,</span>
       <span class="token function">COUNT</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">AS</span> Count<span class="token punctuation">,</span>
       <span class="token function">MIN</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span> <span class="token keyword">AS</span> Min<span class="token punctuation">,</span>
       <span class="token function">MAX</span><span class="token punctuation">(</span>TotalCost<span class="token punctuation">)</span>  <span class="token keyword">AS</span> Max
  <span class="token keyword">FROM</span> CarsTable
 <span class="token keyword">WHERE</span> <span class="token keyword">Status</span> <span class="token operator">=</span> <span class="token string">'READY'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> CustomerId

</code></pre></div><h2 id="using-aggregation-funtions-to-find-the-most-recent-records"><a href="#using-aggregation-funtions-to-find-the-most-recent-records" class="header-anchor">#</a> Using Aggregation funtions to find the most recent records</h2> <p>Using the <a href="http://stackoverflow.com/documentation/sql/280/example-databases/4978/library-database#t=201607221318512510656" target="_blank" rel="noopener noreferrer">Library Database<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we try to find the last book added to the database for each author. For this simple example we assume an always incrementing Id for each record added.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> MostRecentBook<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> MostRecentBook<span class="token punctuation">.</span>Title
<span class="token keyword">FROM</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> Authors<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
              Books<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
              RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> Authors<span class="token punctuation">.</span>Id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Books<span class="token punctuation">.</span>Id <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> NewestRank
       <span class="token keyword">FROM</span> Authors
       <span class="token keyword">JOIN</span> Books <span class="token keyword">ON</span> Books<span class="token punctuation">.</span>AuthorId <span class="token operator">=</span> Authors<span class="token punctuation">.</span>Id
     <span class="token punctuation">)</span> MostRecentBook
<span class="token keyword">WHERE</span> MostRecentBook<span class="token punctuation">.</span>NewestRank <span class="token operator">=</span> <span class="token number">1</span>

</code></pre></div><p>Instead of RANK, two other functions can be used to order. In the previous example the result will be the same, but they give different results when the ordering gives multiple rows for each rank.</p> <ul><li><code>RANK()</code>: duplicates get the same rank, the next rank takes the number of duplicates in the previous rank into account</li> <li><code>DENSE_RANK()</code>: duplicates get the same rank, the next rank is always one higher than the previous</li> <li><code>ROW_NUMBER()</code>: will give each row a unique 'rank', 'ranking' the duplicates randomly</li></ul> <p>For example, if the table had a non-unique column CreationDate and the ordering was done based on that, the following query:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> Authors<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
       Books<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
       Books<span class="token punctuation">.</span>CreationDate<span class="token punctuation">,</span>
       RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> Authors<span class="token punctuation">.</span>Id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Books<span class="token punctuation">.</span>CreationDate <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> RANK<span class="token punctuation">,</span>
       DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> Authors<span class="token punctuation">.</span>Id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Books<span class="token punctuation">.</span>CreationDate <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> DENSE_RANK<span class="token punctuation">,</span>
       ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> Authors<span class="token punctuation">.</span>Id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Books<span class="token punctuation">.</span>CreationDate <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> ROW_NUMBER<span class="token punctuation">,</span>
<span class="token keyword">FROM</span> Authors
<span class="token keyword">JOIN</span> Books <span class="token keyword">ON</span> Books<span class="token punctuation">.</span>AuthorId <span class="token operator">=</span> Authors<span class="token punctuation">.</span>Id

</code></pre></div><p>Could result in:</p> <table><thead><tr><th>Author</th> <th>Title</th> <th>CreationDate</th> <th>RANK</th> <th>DENSE_RANK</th> <th>ROW_NUMBER</th></tr></thead> <tbody><tr><td>Author 1</td> <td>Book 1</td> <td>22/07/2016</td> <td>1</td> <td>1</td> <td>1</td></tr> <tr><td>Author 1</td> <td>Book 2</td> <td>22/07/2016</td> <td>1</td> <td>1</td> <td>2</td></tr> <tr><td>Author 1</td> <td>Book 3</td> <td>21/07/2016</td> <td>3</td> <td>2</td> <td>3</td></tr> <tr><td>Author 1</td> <td>Book 4</td> <td>21/07/2016</td> <td>3</td> <td>2</td> <td>4</td></tr> <tr><td>Author 1</td> <td>Book 5</td> <td>21/07/2016</td> <td>3</td> <td>2</td> <td>5</td></tr> <tr><td>Author 1</td> <td>Book 6</td> <td>04/07/2016</td> <td>6</td> <td>3</td> <td>6</td></tr> <tr><td>Author 2</td> <td>Book 7</td> <td>04/07/2016</td> <td>1</td> <td>1</td> <td>1</td></tr></tbody></table> <h2 id="dividing-data-into-equally-partitioned-buckets-using-ntile"><a href="#dividing-data-into-equally-partitioned-buckets-using-ntile" class="header-anchor">#</a> Dividing Data into equally-partitioned buckets using NTILE</h2> <p>Let's say that you have exam scores for several exams and you want to divide them into quartiles per exam.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- Setup data:</span>
<span class="token keyword">declare</span> <span class="token variable">@values</span> <span class="token keyword">table</span><span class="token punctuation">(</span>Id <span class="token keyword">int</span> <span class="token keyword">identity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">Value</span><span class="token punctuation">]</span> <span class="token keyword">float</span><span class="token punctuation">,</span> ExamId <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token variable">@values</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">Value</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ExamId<span class="token punctuation">)</span> <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- Exam 1 Scores</span>
<span class="token punctuation">(</span><span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">83</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- Exam 2 Scores</span>

<span class="token comment">-- Separate into four buckets per exam:</span>
<span class="token keyword">select</span> ExamId<span class="token punctuation">,</span> 
       ntile<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> ExamId <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">[</span><span class="token keyword">Value</span><span class="token punctuation">]</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Quartile<span class="token punctuation">,</span> 
       <span class="token keyword">Value</span><span class="token punctuation">,</span> Id 
<span class="token keyword">from</span> <span class="token variable">@values</span> 
<span class="token keyword">order</span> <span class="token keyword">by</span> ExamId<span class="token punctuation">,</span> Quartile

</code></pre></div><p><a href="https://i.stack.imgur.com/jJfx2.png" target="_blank" rel="noopener noreferrer"><img src="https://i.stack.imgur.com/jJfx2.png" alt="Our exam data divided into quartiles per exam"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><code>ntile</code> works great when you really need a set number of buckets and each filled to approximately the same level.  Notice that it would be trivial to separate these scores into percentiles by simply using <code>ntile(100)</code>.</p> <h4 id="parameters"><a href="#parameters" class="header-anchor">#</a> Parameters</h4> <table><thead><tr><th>Parameter</th> <th>Details</th></tr></thead> <tbody><tr><td>PARTITION BY</td> <td>The field(s) that follows PARTITION BY is the one that the 'grouping' will be based on</td></tr></tbody></table> <h4 id="remarks"><a href="#remarks" class="header-anchor">#</a> Remarks</h4> <p>The OVER clause determines a windows or a subset of row within a query result set. A window function can be applied to set and compute a value for each row in the set. The OVER clause can be used with:</p> <ul><li>Ranking functions</li> <li>Aggregate functions</li></ul> <p>so someone can compute aggregated values such as moving averages, cumulative aggregates, running totals, or a top N per group results.</p> <p>In a very abstract way we can say that OVER behaves like GROUP BY. However OVER is applied per field / column and not to the query as whole as GROUP BY does.</p> <p><strong>Note#1:</strong> In SQL Server 2008 (R2) ORDER BY Clause cannot be used with aggregate window functions (<a href="https://msdn.microsoft.com/en-us/library/ms189461(v=sql.105).aspx" target="_blank" rel="noopener noreferrer">link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/mssql/over-clause.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mssql/while-loop.html" class="prev">
        WHILE loop
      </a></span> <span class="next"><a href="/mssql/group-by.html">
        GROUP BY
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ced448ab.js" defer></script><script src="/assets/js/3.f1d73125.js" defer></script><script src="/assets/js/2033.f3aa623b.js" defer></script>
  </body>
</html>
