<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Microsoft SQL Server - Common Table Expressions</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Generate a table of dates using CTE, Employee Hierarchy, Delete duplicate rows using CTE, Recursive CTE, Find nth highest salary using CTE, CTE with multiple AS statements">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="Microsoft SQL Server - Common Table Expressions">
    <meta property="og:description" content="Generate a table of dates using CTE, Employee Hierarchy, Delete duplicate rows using CTE, Recursive CTE, Find nth highest salary using CTE, CTE with multiple AS statements">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/mssql/common-table-expressions.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="Microsoft SQL Server - Common Table Expressions">
    <meta name="twitter:description" content="Generate a table of dates using CTE, Employee Hierarchy, Delete duplicate rows using CTE, Recursive CTE, Find nth highest salary using CTE, CTE with multiple AS statements">
    <meta name="twitter:url" content="/mssql/common-table-expressions.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/1984.2b058627.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MS SQL Server</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mssql/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/mssql/getting-started-with-microsoft-sql-server.html" class="sidebar-link">Getting started with Microsoft SQL Server</a></li><li><a href="/mssql/data-types.html" class="sidebar-link">Data Types</a></li><li><a href="/mssql/converting-data-types.html" class="sidebar-link">Converting data types</a></li><li><a href="/mssql/user-defined-table-types.html" class="sidebar-link">User Defined Table Types</a></li><li><a href="/mssql/select-statement.html" class="sidebar-link">SELECT statement</a></li><li><a href="/mssql/alias-names-in-sql-server.html" class="sidebar-link">Alias Names in Sql Server</a></li><li><a href="/mssql/nulls.html" class="sidebar-link">NULLs</a></li><li><a href="/mssql/variables.html" class="sidebar-link">Variables</a></li><li><a href="/mssql/dates.html" class="sidebar-link">Dates</a></li><li><a href="/mssql/generating-a-range-of-dates.html" class="sidebar-link">Generating a range of dates</a></li><li><a href="/mssql/database-snapshots.html" class="sidebar-link">Database Snapshots</a></li><li><a href="/mssql/coalesce.html" class="sidebar-link">COALESCE</a></li><li><a href="/mssql/if-else.html" class="sidebar-link">IF...ELSE</a></li><li><a href="/mssql/case-statement.html" class="sidebar-link">CASE Statement</a></li><li><a href="/mssql/insert-into.html" class="sidebar-link">INSERT INTO</a></li><li><a href="/mssql/drop-keyword.html" class="sidebar-link">Drop Keyword</a></li><li><a href="/mssql/merge.html" class="sidebar-link">MERGE</a></li><li><a href="/mssql/create-view.html" class="sidebar-link">CREATE VIEW</a></li><li><a href="/mssql/views.html" class="sidebar-link">Views</a></li><li><a href="/mssql/union.html" class="sidebar-link">UNION</a></li><li><a href="/mssql/try-catch.html" class="sidebar-link">TRY/CATCH</a></li><li><a href="/mssql/while-loop.html" class="sidebar-link">WHILE loop</a></li><li><a href="/mssql/over-clause.html" class="sidebar-link">OVER Clause</a></li><li><a href="/mssql/group-by.html" class="sidebar-link">GROUP BY</a></li><li><a href="/mssql/order-by.html" class="sidebar-link">ORDER BY</a></li><li><a href="/mssql/the-stuff-function.html" class="sidebar-link">The STUFF Function</a></li><li><a href="/mssql/json-in-sql-server.html" class="sidebar-link">JSON in Sql Server</a></li><li><a href="/mssql/openjson.html" class="sidebar-link">OPENJSON</a></li><li><a href="/mssql/for-json.html" class="sidebar-link">FOR JSON</a></li><li><a href="/mssql/queries-with-json-data.html" class="sidebar-link">Queries with JSON data</a></li><li><a href="/mssql/storing-json-in-sql-tables.html" class="sidebar-link">Storing JSON in SQL tables</a></li><li><a href="/mssql/modify-json-text.html" class="sidebar-link">Modify JSON text</a></li><li><a href="/mssql/for-xml-path.html" class="sidebar-link">FOR XML PATH</a></li><li><a href="/mssql/join.html" class="sidebar-link">Join</a></li><li><a href="/mssql/cross-apply.html" class="sidebar-link">cross apply</a></li><li><a href="/mssql/computed-columns.html" class="sidebar-link">Computed Columns</a></li><li><a href="/mssql/common-table-expressions.html" aria-current="page" class="active sidebar-link">Common Table Expressions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mssql/common-table-expressions.html#generate-a-table-of-dates-using-cte" class="sidebar-link">Generate a table of dates using CTE</a></li><li class="sidebar-sub-header"><a href="/mssql/common-table-expressions.html#employee-hierarchy" class="sidebar-link">Employee Hierarchy</a></li><li class="sidebar-sub-header"><a href="/mssql/common-table-expressions.html#delete-duplicate-rows-using-cte" class="sidebar-link">Delete duplicate rows using CTE</a></li><li class="sidebar-sub-header"><a href="/mssql/common-table-expressions.html#recursive-cte" class="sidebar-link">Recursive CTE</a></li><li class="sidebar-sub-header"><a href="/mssql/common-table-expressions.html#find-nth-highest-salary-using-cte" class="sidebar-link">Find nth highest salary using CTE</a></li><li class="sidebar-sub-header"><a href="/mssql/common-table-expressions.html#cte-with-multiple-as-statements" class="sidebar-link">CTE with multiple AS statements</a></li></ul></li><li><a href="/mssql/move-and-copy-data-around-tables.html" class="sidebar-link">Move and copy data around tables</a></li><li><a href="/mssql/limit-result-set.html" class="sidebar-link">Limit Result Set</a></li><li><a href="/mssql/retrieve-information-about-your-instance.html" class="sidebar-link">Retrieve Information about your Instance</a></li><li><a href="/mssql/with-ties-option.html" class="sidebar-link">With Ties Option</a></li><li><a href="/mssql/string-functions.html" class="sidebar-link">String Functions</a></li><li><a href="/mssql/logical-functions.html" class="sidebar-link">Logical Functions</a></li><li><a href="/mssql/aggregate-functions.html" class="sidebar-link">Aggregate Functions</a></li><li><a href="/mssql/string-aggregate-functions-in-sql-server.html" class="sidebar-link">String Aggregate functions in SQL Server</a></li><li><a href="/mssql/ranking-functions.html" class="sidebar-link">Ranking Functions</a></li><li><a href="/mssql/window-functions.html" class="sidebar-link">Window functions</a></li><li><a href="/mssql/pivot-unpivot.html" class="sidebar-link">PIVOT / UNPIVOT</a></li><li><a href="/mssql/dynamic-sql-pivot.html" class="sidebar-link">Dynamic SQL Pivot</a></li><li><a href="/mssql/partitioning.html" class="sidebar-link">Partitioning</a></li><li><a href="/mssql/stored-procedures.html" class="sidebar-link">Stored Procedures</a></li><li><a href="/mssql/retrieve-information-about-the-database.html" class="sidebar-link">Retrieve information about the database</a></li><li><a href="/mssql/split-string-function-in-sql-server.html" class="sidebar-link">Split String function in Sql Server</a></li><li><a href="/mssql/insert.html" class="sidebar-link">Insert</a></li><li><a href="/mssql/primary-keys.html" class="sidebar-link">Primary Keys</a></li><li><a href="/mssql/foreign-keys.html" class="sidebar-link">Foreign Keys</a></li><li><a href="/mssql/last-inserted-identity.html" class="sidebar-link">Last Inserted Identity</a></li><li><a href="/mssql/scope-identity.html" class="sidebar-link">SCOPE_IDENTITY()</a></li><li><a href="/mssql/sequences.html" class="sidebar-link">Sequences</a></li><li><a href="/mssql/indexing.html" class="sidebar-link">Indexing</a></li><li><a href="/mssql/full-text-indexing.html" class="sidebar-link">Full-Text Indexing</a></li><li><a href="/mssql/trigger.html" class="sidebar-link">Trigger</a></li><li><a href="/mssql/cursors.html" class="sidebar-link">Cursors</a></li><li><a href="/mssql/transaction-isolation-levels.html" class="sidebar-link">Transaction isolation levels</a></li><li><a href="/mssql/advanced-options.html" class="sidebar-link">Advanced options</a></li><li><a href="/mssql/migration.html" class="sidebar-link">Migration</a></li><li><a href="/mssql/table-valued-parameters.html" class="sidebar-link">Table Valued Parameters</a></li><li><a href="/mssql/dbmail.html" class="sidebar-link">DBMAIL</a></li><li><a href="/mssql/in-memory-oltp-hekaton.html" class="sidebar-link">In-Memory OLTP (Hekaton)</a></li><li><a href="/mssql/temporal-tables.html" class="sidebar-link">Temporal Tables</a></li><li><a href="/mssql/use-of-temp-table.html" class="sidebar-link">Use of TEMP Table</a></li><li><a href="/mssql/scheduled-task-or-job.html" class="sidebar-link">Scheduled Task or Job</a></li><li><a href="/mssql/isolation-levels-and-locking.html" class="sidebar-link">Isolation levels and locking</a></li><li><a href="/mssql/sorting-ordering-rows.html" class="sidebar-link">Sorting/ordering rows</a></li><li><a href="/mssql/privileges-or-permissions.html" class="sidebar-link">Privileges or Permissions</a></li><li><a href="/mssql/sqlcmd.html" class="sidebar-link">SQLCMD</a></li><li><a href="/mssql/resource-governor.html" class="sidebar-link">Resource Governor</a></li><li><a href="/mssql/file-group.html" class="sidebar-link">File Group</a></li><li><a href="/mssql/basic-ddl-operations-in-ms-sql-server.html" class="sidebar-link">Basic DDL Operations in MS SQL Server</a></li><li><a href="/mssql/subqueries.html" class="sidebar-link">Subqueries</a></li><li><a href="/mssql/pagination.html" class="sidebar-link">Pagination</a></li><li><a href="/mssql/clustered-columnstore.html" class="sidebar-link">CLUSTERED COLUMNSTORE</a></li><li><a href="/mssql/parsename.html" class="sidebar-link">Parsename</a></li><li><a href="/mssql/installing-sql-server-on-windows.html" class="sidebar-link">Installing SQL Server on Windows</a></li><li><a href="/mssql/analyzing-a-query.html" class="sidebar-link">Analyzing a Query</a></li><li><a href="/mssql/query-hints.html" class="sidebar-link">Query Hints</a></li><li><a href="/mssql/query-store.html" class="sidebar-link">Query Store</a></li><li><a href="/mssql/querying-results-by-page.html" class="sidebar-link">Querying results by page</a></li><li><a href="/mssql/schemas.html" class="sidebar-link">Schemas</a></li><li><a href="/mssql/backup-and-restore-database.html" class="sidebar-link">Backup and Restore Database</a></li><li><a href="/mssql/transaction-handling.html" class="sidebar-link">Transaction handling</a></li><li><a href="/mssql/natively-compiled-modules-hekaton.html" class="sidebar-link">Natively compiled modules (Hekaton)</a></li><li><a href="/mssql/spatial-data.html" class="sidebar-link">Spatial Data</a></li><li><a href="/mssql/dynamic-sql.html" class="sidebar-link">Dynamic SQL</a></li><li><a href="/mssql/dynamic-data-masking.html" class="sidebar-link">Dynamic data masking</a></li><li><a href="/mssql/export-data-in-txt-file-by-using-sqlcmd.html" class="sidebar-link">Export data in txt file by using SQLCMD</a></li><li><a href="/mssql/common-language-runtime-integration.html" class="sidebar-link">Common Language Runtime Integration</a></li><li><a href="/mssql/delimiting-special-characters-and-reserved-words.html" class="sidebar-link">Delimiting special characters and reserved words</a></li><li><a href="/mssql/dbcc.html" class="sidebar-link">DBCC</a></li><li><a href="/mssql/bulk-import.html" class="sidebar-link">BULK Import</a></li><li><a href="/mssql/service-broker.html" class="sidebar-link">Service broker</a></li><li><a href="/mssql/permissions-and-security.html" class="sidebar-link">Permissions and Security</a></li><li><a href="/mssql/database-permissions.html" class="sidebar-link">Database permissions</a></li><li><a href="/mssql/row-level-security.html" class="sidebar-link">Row-level security</a></li><li><a href="/mssql/encryption.html" class="sidebar-link">Encryption</a></li><li><a href="/mssql/phantom-read.html" class="sidebar-link">PHANTOM read</a></li><li><a href="/mssql/filestream.html" class="sidebar-link">Filestream</a></li><li><a href="/mssql/bcp-bulk-copy-program-utility.html" class="sidebar-link">bcp (bulk copy program) Utility</a></li><li><a href="/mssql/sql-server-evolution-through-different-versions-2000-2016.html" class="sidebar-link">SQL Server Evolution through different versions (2000 - 2016)</a></li><li><a href="/mssql/sql-server-management-studio-ssms.html" class="sidebar-link">SQL Server Management Studio (SSMS)</a></li><li><a href="/mssql/managing-azure-sql-database.html" class="sidebar-link">Managing Azure SQL Database</a></li><li><a href="/mssql/system-database-tempdb.html" class="sidebar-link">System database - TempDb</a></li><li><a href="/mssql/microsoft-sql-server-management-studio-shortcut-keys.html" class="sidebar-link">Microsoft SQL Server Management Studio Shortcut Keys</a></li><li><a href="/mssql/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="common-table-expressions"><a href="#common-table-expressions" class="header-anchor">#</a> Common Table Expressions</h1> <h2 id="generate-a-table-of-dates-using-cte"><a href="#generate-a-table-of-dates-using-cte" class="header-anchor">#</a> Generate a table of dates using CTE</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DECLARE</span> <span class="token variable">@startdate</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@numberDays</span> <span class="token keyword">TINYINT</span>

<span class="token keyword">SET</span> <span class="token variable">@startdate</span> <span class="token operator">=</span> <span class="token string">'20160101'</span>
<span class="token keyword">SET</span> <span class="token variable">@numberDays</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">WITH</span> CTE_DatesTable
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span> CAST<span class="token punctuation">(</span><span class="token variable">@startdate</span> <span class="token keyword">as</span> <span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span><span class="token keyword">date</span><span class="token punctuation">]</span>
  <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
  <span class="token keyword">SELECT</span> DATEADD<span class="token punctuation">(</span>dd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">date</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> CTE_DatesTable
  <span class="token keyword">WHERE</span> DATEADD<span class="token punctuation">(</span>dd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">date</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> DateAdd<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token variable">@numberDays</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">@startdate</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token keyword">date</span><span class="token punctuation">]</span> <span class="token keyword">FROM</span> CTE_DatesTable

<span class="token keyword">OPTION</span> <span class="token punctuation">(</span>MAXRECURSION <span class="token number">0</span><span class="token punctuation">)</span>

</code></pre></div><p>This example returns a single-column table of dates, starting with the date specified in the @startdate variable, and returning the next @numberDays worth of dates.</p> <h2 id="employee-hierarchy"><a href="#employee-hierarchy" class="header-anchor">#</a> Employee Hierarchy</h2> <h3 id="table-setup"><a href="#table-setup" class="header-anchor">#</a> Table Setup</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dbo<span class="token punctuation">.</span>Employees
<span class="token punctuation">(</span>
    EmployeeID <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    FirstName NVARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    LastName NVARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    ManagerID <span class="token keyword">INT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span>

GO

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">'Ken'</span><span class="token punctuation">,</span> <span class="token string">'Sánchez'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token string">'Keith'</span><span class="token punctuation">,</span> <span class="token string">'Hall'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">,</span> <span class="token string">'Fred'</span><span class="token punctuation">,</span> <span class="token string">'Bloggs'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token string">'Joseph'</span><span class="token punctuation">,</span> <span class="token string">'Walker'</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token string">'Žydrė'</span><span class="token punctuation">,</span> <span class="token string">'Klybė'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">106</span><span class="token punctuation">,</span> <span class="token string">'Sam'</span><span class="token punctuation">,</span> <span class="token string">'Jackson'</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">107</span><span class="token punctuation">,</span> <span class="token string">'Peter'</span><span class="token punctuation">,</span> <span class="token string">'Miller'</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">108</span><span class="token punctuation">,</span> <span class="token string">'Chloe'</span><span class="token punctuation">,</span> <span class="token string">'Samuels'</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">109</span><span class="token punctuation">,</span> <span class="token string">'George'</span><span class="token punctuation">,</span> <span class="token string">'Weasley'</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Employees <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token string">'Michael'</span><span class="token punctuation">,</span> <span class="token string">'Kensington'</span><span class="token punctuation">,</span> <span class="token number">106</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="common-table-expression"><a href="#common-table-expression" class="header-anchor">#</a> Common Table Expression</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token punctuation">;</span><span class="token keyword">WITH</span> cteReports <span class="token punctuation">(</span>EmpID<span class="token punctuation">,</span> FirstName<span class="token punctuation">,</span> LastName<span class="token punctuation">,</span> SupervisorID<span class="token punctuation">,</span> EmpLevel<span class="token punctuation">)</span> <span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> EmployeeID<span class="token punctuation">,</span> FirstName<span class="token punctuation">,</span> LastName<span class="token punctuation">,</span> ManagerID<span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token keyword">FROM</span> Employees
    <span class="token keyword">WHERE</span> ManagerID <span class="token operator">IS</span> <span class="token boolean">NULL</span>

    <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>

    <span class="token keyword">SELECT</span> e<span class="token punctuation">.</span>EmployeeID<span class="token punctuation">,</span> e<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span> e<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span> e<span class="token punctuation">.</span>ManagerID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>EmpLevel <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">FROM</span> Employees        <span class="token keyword">AS</span> e
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> cteReports <span class="token keyword">AS</span> r <span class="token keyword">ON</span> e<span class="token punctuation">.</span>ManagerID <span class="token operator">=</span> r<span class="token punctuation">.</span>EmpID
<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span>
    FirstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> LastName <span class="token keyword">AS</span> FullName<span class="token punctuation">,</span>
    EmpLevel<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> FirstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> LastName <span class="token keyword">FROM</span> Employees <span class="token keyword">WHERE</span> EmployeeID <span class="token operator">=</span> cteReports<span class="token punctuation">.</span>SupervisorID<span class="token punctuation">)</span> <span class="token keyword">AS</span> ManagerName
<span class="token keyword">FROM</span> cteReports
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> EmpLevel<span class="token punctuation">,</span> SupervisorID

</code></pre></div><h3 id="output"><a href="#output" class="header-anchor">#</a> Output:</h3> <blockquote></blockquote> <table><p>|FullName|EmpLevel|ManagerName
|Ken Sánchez|1|<em>null</em>
|Keith Hall|2|Ken Sánchez
|Fred Bloggs|2|Ken Sánchez
|Žydre Klybe|2|Ken Sánchez
|Joseph Walker|3|Keith Hall
|Peter Miller|3|Fred Bloggs
|Sam Jackson|3|Žydre Klybe
|Chloe Samuels|3|Žydre Klybe
|George Weasley|3|Žydre Klybe
|Michael Kensington|4|Sam Jackson</p> <h2 id="delete-duplicate-rows-using-cte"><a href="#delete-duplicate-rows-using-cte" class="header-anchor">#</a> Delete duplicate rows using CTE</h2> <p>Employees table :</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">|</span>  ID  <span class="token operator">|</span> FirstName <span class="token operator">|</span> LastName <span class="token operator">|</span> Gender <span class="token operator">|</span> Salary <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+----------+--------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span>   <span class="token operator">|</span> Mark      <span class="token operator">|</span> Hastings <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">60000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span>   <span class="token operator">|</span> Mark      <span class="token operator">|</span> Hastings <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">60000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span>   <span class="token operator">|</span> Mary      <span class="token operator">|</span> Lambeth  <span class="token operator">|</span> Female <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span>   <span class="token operator">|</span> Mary      <span class="token operator">|</span> Lambeth  <span class="token operator">|</span> Female <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span>   <span class="token operator">|</span> Ben       <span class="token operator">|</span> Hoskins  <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span>   <span class="token operator">|</span> Ben       <span class="token operator">|</span> Hoskins  <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span>   <span class="token operator">|</span> Ben       <span class="token operator">|</span> Hoskins  <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+----------+--------+--------+</span>

</code></pre></div><p>CTE (Common Table Expression) :</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WITH</span> EmployeesCTE <span class="token keyword">AS</span>
<span class="token punctuation">(</span>
   <span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> ID <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> ID<span class="token punctuation">)</span> <span class="token keyword">AS</span> RowNumber
   <span class="token keyword">FROM</span> Employees
<span class="token punctuation">)</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> EmployeesCTE <span class="token keyword">WHERE</span> RowNumber <span class="token operator">&gt;</span> <span class="token number">1</span>

</code></pre></div><p>Execution result :</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">|</span>  ID  <span class="token operator">|</span> FirstName <span class="token operator">|</span> LastName <span class="token operator">|</span> Gender <span class="token operator">|</span> Salary <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+----------+--------+--------+</span>
<span class="token operator">|</span>  <span class="token number">1</span>   <span class="token operator">|</span> Mark      <span class="token operator">|</span> Hastings <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">60000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span>   <span class="token operator">|</span> Mary      <span class="token operator">|</span> Lambeth  <span class="token operator">|</span> Female <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span>   <span class="token operator">|</span> Ben       <span class="token operator">|</span> Hoskins  <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+----------+--------+--------+</span>

</code></pre></div><h2 id="recursive-cte"><a href="#recursive-cte" class="header-anchor">#</a> Recursive CTE</h2> <p>This example shows how to get every year from this year to 2011 (2012 - 1).</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WITH</span> yearsAgo
<span class="token punctuation">(</span>
    myYear
<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
     <span class="token comment">-- Base Case: This is where the recursion starts</span>
     <span class="token keyword">SELECT</span> DATEPART<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> myYear

     <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>  <span class="token comment">-- This MUST be UNION ALL (cannot be UNION)</span>

     <span class="token comment">-- Recursive Section: This is what we're doing with the recursive call</span>
     <span class="token keyword">SELECT</span> yearsAgo<span class="token punctuation">.</span>myYear <span class="token operator">-</span> <span class="token number">1</span>
     <span class="token keyword">FROM</span> yearsAgo
     <span class="token keyword">WHERE</span> yearsAgo<span class="token punctuation">.</span>myYear <span class="token operator">&gt;=</span> <span class="token number">2012</span>
<span class="token punctuation">)</span>
     <span class="token keyword">SELECT</span> myYear <span class="token keyword">FROM</span> yearsAgo<span class="token punctuation">;</span>  <span class="token comment">-- A single SELECT, INSERT, UPDATE, or DELETE</span>

</code></pre></div><table><thead><tr><th>myYear</th></tr></thead> <tbody><tr><td>2016</td></tr> <tr><td>2015</td></tr> <tr><td>2014</td></tr> <tr><td>2013</td></tr> <tr><td>2012</td></tr> <tr><td>2011</td></tr></tbody></table> <p>You can control the recursion (think stack overflow in code) with MAXRECURSION as a query option that will limit the number of recursive calls.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WITH</span> yearsAgo
<span class="token punctuation">(</span>
    myYear
<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
     <span class="token comment">-- Base Case</span>
     <span class="token keyword">SELECT</span> DATEPART<span class="token punctuation">(</span><span class="token keyword">year</span> <span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> myYear
     <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
     <span class="token comment">-- Recursive Section</span>
     <span class="token keyword">SELECT</span> yearsAgo<span class="token punctuation">.</span>myYear <span class="token operator">-</span> <span class="token number">1</span>
     <span class="token keyword">FROM</span> yearsAgo
     <span class="token keyword">WHERE</span> yearsAgo<span class="token punctuation">.</span>myYear <span class="token operator">&gt;=</span> <span class="token number">2002</span>
<span class="token punctuation">)</span>
     <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> yearsAgo
     <span class="token keyword">OPTION</span> <span class="token punctuation">(</span>MAXRECURSION <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote></blockquote> <p>Msg 530, Level 16, State 1, Line 2The statement terminated. The
maximum recursion 10 has been exhausted before statement completion.</p> <h2 id="find-nth-highest-salary-using-cte"><a href="#find-nth-highest-salary-using-cte" class="header-anchor">#</a> Find nth highest salary using CTE</h2> <p>Employees table :</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">|</span>  ID  <span class="token operator">|</span> FirstName <span class="token operator">|</span> LastName <span class="token operator">|</span> Gender <span class="token operator">|</span> Salary <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+----------+--------+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> Jahangir  <span class="token operator">|</span> Alam     <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> Arifur    <span class="token operator">|</span> Rahman   <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">60000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> Oli       <span class="token operator">|</span> Ahammed  <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">45000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>    <span class="token operator">|</span> Sima      <span class="token operator">|</span> Sultana  <span class="token operator">|</span> Female <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span> Sudeepta  <span class="token operator">|</span> Roy      <span class="token operator">|</span> Male   <span class="token operator">|</span> <span class="token number">80000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+----------+--------+--------+</span>

</code></pre></div><p>CTE (Common Table Expression) :</p> <div class="language- extra-class"><pre class="language-text"><code>
WITH RESULT AS
(
    SELECT SALARY,
           DENSE_RANK() OVER (ORDER BY SALARY DESC) AS DENSERANK
    FROM EMPLOYEES
)
SELECT TOP 1 SALARY
FROM RESULT
WHERE DENSERANK = 1

</code></pre></div><p>To find 2nd highest salary simply replace N with 2. Similarly, to find 3rd highest salary, simply replace N with 3.</p> <h2 id="cte-with-multiple-as-statements"><a href="#cte-with-multiple-as-statements" class="header-anchor">#</a> CTE with multiple AS statements</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token punctuation">;</span><span class="token keyword">WITH</span> cte_query_1
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span>
    <span class="token keyword">FROM</span> <span class="token keyword">database</span><span class="token punctuation">.</span>table1
<span class="token punctuation">)</span><span class="token punctuation">,</span> 
cte_query_2 
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span>
    <span class="token keyword">FROM</span> <span class="token keyword">database</span><span class="token punctuation">.</span>table2
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> cte_query_1
<span class="token keyword">WHERE</span> cte_query_one<span class="token punctuation">.</span>fk <span class="token operator">IN</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> PK
    <span class="token keyword">FROM</span> cte_query_2
<span class="token punctuation">)</span>

</code></pre></div><p>With common table expressions, it is possible to create multiple queries using comma-separated AS statements. A query can then reference any or all of those queries in many different ways, even joining them.</p> <h4 id="syntax"><a href="#syntax" class="header-anchor">#</a> Syntax</h4> <ul><li>WITH <strong>cte_name</strong> [(<strong>column_name_1</strong>, <strong>column_name_2</strong>, ...)] AS (<strong>cte_expression</strong>)</li></ul> <h4 id="remarks"><a href="#remarks" class="header-anchor">#</a> Remarks</h4> <p>It is necessary to separate a CTE from the previous statement with a semi-colon (<code>;</code>) character.</p> <p>i.e. <code>;WITH CommonTableName (...) SELECT ... FROM CommonTableName ...</code></p> <p>A CTE's scope is a single batch, and only downstream of its definition.  A batch may contain multiple CTEs, and a CTE may reference another CTE defined earlier in the batch, but a CTE may not reference another CTE that is defined later in the batch.</p></table></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/mssql/common-table-expressions.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mssql/computed-columns.html" class="prev">
        Computed Columns
      </a></span> <span class="next"><a href="/mssql/move-and-copy-data-around-tables.html">
        Move and copy data around tables
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/1984.2b058627.js" defer></script>
  </body>
</html>
