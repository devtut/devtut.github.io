<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Microsoft SQL Server - Query Store</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Enable query store on database, Get execution statistics for SQL queries/plans, Remove data from query store, Forcing plan for query">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="Microsoft SQL Server - Query Store">
    <meta property="og:description" content="Enable query store on database, Get execution statistics for SQL queries/plans, Remove data from query store, Forcing plan for query">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/mssql/query-store.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="Microsoft SQL Server - Query Store">
    <meta name="twitter:description" content="Enable query store on database, Get execution statistics for SQL queries/plans, Remove data from query store, Forcing plan for query">
    <meta name="twitter:url" content="/mssql/query-store.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/2046.558e8434.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MS SQL Server</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mssql/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/mssql/getting-started-with-microsoft-sql-server.html" class="sidebar-link">Getting started with Microsoft SQL Server</a></li><li><a href="/mssql/data-types.html" class="sidebar-link">Data Types</a></li><li><a href="/mssql/converting-data-types.html" class="sidebar-link">Converting data types</a></li><li><a href="/mssql/user-defined-table-types.html" class="sidebar-link">User Defined Table Types</a></li><li><a href="/mssql/select-statement.html" class="sidebar-link">SELECT statement</a></li><li><a href="/mssql/alias-names-in-sql-server.html" class="sidebar-link">Alias Names in Sql Server</a></li><li><a href="/mssql/nulls.html" class="sidebar-link">NULLs</a></li><li><a href="/mssql/variables.html" class="sidebar-link">Variables</a></li><li><a href="/mssql/dates.html" class="sidebar-link">Dates</a></li><li><a href="/mssql/generating-a-range-of-dates.html" class="sidebar-link">Generating a range of dates</a></li><li><a href="/mssql/database-snapshots.html" class="sidebar-link">Database Snapshots</a></li><li><a href="/mssql/coalesce.html" class="sidebar-link">COALESCE</a></li><li><a href="/mssql/if-else.html" class="sidebar-link">IF...ELSE</a></li><li><a href="/mssql/case-statement.html" class="sidebar-link">CASE Statement</a></li><li><a href="/mssql/insert-into.html" class="sidebar-link">INSERT INTO</a></li><li><a href="/mssql/drop-keyword.html" class="sidebar-link">Drop Keyword</a></li><li><a href="/mssql/merge.html" class="sidebar-link">MERGE</a></li><li><a href="/mssql/create-view.html" class="sidebar-link">CREATE VIEW</a></li><li><a href="/mssql/views.html" class="sidebar-link">Views</a></li><li><a href="/mssql/union.html" class="sidebar-link">UNION</a></li><li><a href="/mssql/try-catch.html" class="sidebar-link">TRY/CATCH</a></li><li><a href="/mssql/while-loop.html" class="sidebar-link">WHILE loop</a></li><li><a href="/mssql/over-clause.html" class="sidebar-link">OVER Clause</a></li><li><a href="/mssql/group-by.html" class="sidebar-link">GROUP BY</a></li><li><a href="/mssql/order-by.html" class="sidebar-link">ORDER BY</a></li><li><a href="/mssql/the-stuff-function.html" class="sidebar-link">The STUFF Function</a></li><li><a href="/mssql/json-in-sql-server.html" class="sidebar-link">JSON in Sql Server</a></li><li><a href="/mssql/openjson.html" class="sidebar-link">OPENJSON</a></li><li><a href="/mssql/for-json.html" class="sidebar-link">FOR JSON</a></li><li><a href="/mssql/queries-with-json-data.html" class="sidebar-link">Queries with JSON data</a></li><li><a href="/mssql/storing-json-in-sql-tables.html" class="sidebar-link">Storing JSON in SQL tables</a></li><li><a href="/mssql/modify-json-text.html" class="sidebar-link">Modify JSON text</a></li><li><a href="/mssql/for-xml-path.html" class="sidebar-link">FOR XML PATH</a></li><li><a href="/mssql/join.html" class="sidebar-link">Join</a></li><li><a href="/mssql/cross-apply.html" class="sidebar-link">cross apply</a></li><li><a href="/mssql/computed-columns.html" class="sidebar-link">Computed Columns</a></li><li><a href="/mssql/common-table-expressions.html" class="sidebar-link">Common Table Expressions</a></li><li><a href="/mssql/move-and-copy-data-around-tables.html" class="sidebar-link">Move and copy data around tables</a></li><li><a href="/mssql/limit-result-set.html" class="sidebar-link">Limit Result Set</a></li><li><a href="/mssql/retrieve-information-about-your-instance.html" class="sidebar-link">Retrieve Information about your Instance</a></li><li><a href="/mssql/with-ties-option.html" class="sidebar-link">With Ties Option</a></li><li><a href="/mssql/string-functions.html" class="sidebar-link">String Functions</a></li><li><a href="/mssql/logical-functions.html" class="sidebar-link">Logical Functions</a></li><li><a href="/mssql/aggregate-functions.html" class="sidebar-link">Aggregate Functions</a></li><li><a href="/mssql/string-aggregate-functions-in-sql-server.html" class="sidebar-link">String Aggregate functions in SQL Server</a></li><li><a href="/mssql/ranking-functions.html" class="sidebar-link">Ranking Functions</a></li><li><a href="/mssql/window-functions.html" class="sidebar-link">Window functions</a></li><li><a href="/mssql/pivot-unpivot.html" class="sidebar-link">PIVOT / UNPIVOT</a></li><li><a href="/mssql/dynamic-sql-pivot.html" class="sidebar-link">Dynamic SQL Pivot</a></li><li><a href="/mssql/partitioning.html" class="sidebar-link">Partitioning</a></li><li><a href="/mssql/stored-procedures.html" class="sidebar-link">Stored Procedures</a></li><li><a href="/mssql/retrieve-information-about-the-database.html" class="sidebar-link">Retrieve information about the database</a></li><li><a href="/mssql/split-string-function-in-sql-server.html" class="sidebar-link">Split String function in Sql Server</a></li><li><a href="/mssql/insert.html" class="sidebar-link">Insert</a></li><li><a href="/mssql/primary-keys.html" class="sidebar-link">Primary Keys</a></li><li><a href="/mssql/foreign-keys.html" class="sidebar-link">Foreign Keys</a></li><li><a href="/mssql/last-inserted-identity.html" class="sidebar-link">Last Inserted Identity</a></li><li><a href="/mssql/scope-identity.html" class="sidebar-link">SCOPE_IDENTITY()</a></li><li><a href="/mssql/sequences.html" class="sidebar-link">Sequences</a></li><li><a href="/mssql/indexing.html" class="sidebar-link">Indexing</a></li><li><a href="/mssql/full-text-indexing.html" class="sidebar-link">Full-Text Indexing</a></li><li><a href="/mssql/trigger.html" class="sidebar-link">Trigger</a></li><li><a href="/mssql/cursors.html" class="sidebar-link">Cursors</a></li><li><a href="/mssql/transaction-isolation-levels.html" class="sidebar-link">Transaction isolation levels</a></li><li><a href="/mssql/advanced-options.html" class="sidebar-link">Advanced options</a></li><li><a href="/mssql/migration.html" class="sidebar-link">Migration</a></li><li><a href="/mssql/table-valued-parameters.html" class="sidebar-link">Table Valued Parameters</a></li><li><a href="/mssql/dbmail.html" class="sidebar-link">DBMAIL</a></li><li><a href="/mssql/in-memory-oltp-hekaton.html" class="sidebar-link">In-Memory OLTP (Hekaton)</a></li><li><a href="/mssql/temporal-tables.html" class="sidebar-link">Temporal Tables</a></li><li><a href="/mssql/use-of-temp-table.html" class="sidebar-link">Use of TEMP Table</a></li><li><a href="/mssql/scheduled-task-or-job.html" class="sidebar-link">Scheduled Task or Job</a></li><li><a href="/mssql/isolation-levels-and-locking.html" class="sidebar-link">Isolation levels and locking</a></li><li><a href="/mssql/sorting-ordering-rows.html" class="sidebar-link">Sorting/ordering rows</a></li><li><a href="/mssql/privileges-or-permissions.html" class="sidebar-link">Privileges or Permissions</a></li><li><a href="/mssql/sqlcmd.html" class="sidebar-link">SQLCMD</a></li><li><a href="/mssql/resource-governor.html" class="sidebar-link">Resource Governor</a></li><li><a href="/mssql/file-group.html" class="sidebar-link">File Group</a></li><li><a href="/mssql/basic-ddl-operations-in-ms-sql-server.html" class="sidebar-link">Basic DDL Operations in MS SQL Server</a></li><li><a href="/mssql/subqueries.html" class="sidebar-link">Subqueries</a></li><li><a href="/mssql/pagination.html" class="sidebar-link">Pagination</a></li><li><a href="/mssql/clustered-columnstore.html" class="sidebar-link">CLUSTERED COLUMNSTORE</a></li><li><a href="/mssql/parsename.html" class="sidebar-link">Parsename</a></li><li><a href="/mssql/installing-sql-server-on-windows.html" class="sidebar-link">Installing SQL Server on Windows</a></li><li><a href="/mssql/analyzing-a-query.html" class="sidebar-link">Analyzing a Query</a></li><li><a href="/mssql/query-hints.html" class="sidebar-link">Query Hints</a></li><li><a href="/mssql/query-store.html" aria-current="page" class="active sidebar-link">Query Store</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mssql/query-store.html#enable-query-store-on-database" class="sidebar-link">Enable query store on database</a></li><li class="sidebar-sub-header"><a href="/mssql/query-store.html#get-execution-statistics-for-sql-queries-plans" class="sidebar-link">Get execution statistics for SQL queries/plans</a></li><li class="sidebar-sub-header"><a href="/mssql/query-store.html#remove-data-from-query-store" class="sidebar-link">Remove data from query store</a></li><li class="sidebar-sub-header"><a href="/mssql/query-store.html#forcing-plan-for-query" class="sidebar-link">Forcing plan for query</a></li></ul></li><li><a href="/mssql/querying-results-by-page.html" class="sidebar-link">Querying results by page</a></li><li><a href="/mssql/schemas.html" class="sidebar-link">Schemas</a></li><li><a href="/mssql/backup-and-restore-database.html" class="sidebar-link">Backup and Restore Database</a></li><li><a href="/mssql/transaction-handling.html" class="sidebar-link">Transaction handling</a></li><li><a href="/mssql/natively-compiled-modules-hekaton.html" class="sidebar-link">Natively compiled modules (Hekaton)</a></li><li><a href="/mssql/spatial-data.html" class="sidebar-link">Spatial Data</a></li><li><a href="/mssql/dynamic-sql.html" class="sidebar-link">Dynamic SQL</a></li><li><a href="/mssql/dynamic-data-masking.html" class="sidebar-link">Dynamic data masking</a></li><li><a href="/mssql/export-data-in-txt-file-by-using-sqlcmd.html" class="sidebar-link">Export data in txt file by using SQLCMD</a></li><li><a href="/mssql/common-language-runtime-integration.html" class="sidebar-link">Common Language Runtime Integration</a></li><li><a href="/mssql/delimiting-special-characters-and-reserved-words.html" class="sidebar-link">Delimiting special characters and reserved words</a></li><li><a href="/mssql/dbcc.html" class="sidebar-link">DBCC</a></li><li><a href="/mssql/bulk-import.html" class="sidebar-link">BULK Import</a></li><li><a href="/mssql/service-broker.html" class="sidebar-link">Service broker</a></li><li><a href="/mssql/permissions-and-security.html" class="sidebar-link">Permissions and Security</a></li><li><a href="/mssql/database-permissions.html" class="sidebar-link">Database permissions</a></li><li><a href="/mssql/row-level-security.html" class="sidebar-link">Row-level security</a></li><li><a href="/mssql/encryption.html" class="sidebar-link">Encryption</a></li><li><a href="/mssql/phantom-read.html" class="sidebar-link">PHANTOM read</a></li><li><a href="/mssql/filestream.html" class="sidebar-link">Filestream</a></li><li><a href="/mssql/bcp-bulk-copy-program-utility.html" class="sidebar-link">bcp (bulk copy program) Utility</a></li><li><a href="/mssql/sql-server-evolution-through-different-versions-2000-2016.html" class="sidebar-link">SQL Server Evolution through different versions (2000 - 2016)</a></li><li><a href="/mssql/sql-server-management-studio-ssms.html" class="sidebar-link">SQL Server Management Studio (SSMS)</a></li><li><a href="/mssql/managing-azure-sql-database.html" class="sidebar-link">Managing Azure SQL Database</a></li><li><a href="/mssql/system-database-tempdb.html" class="sidebar-link">System database - TempDb</a></li><li><a href="/mssql/microsoft-sql-server-management-studio-shortcut-keys.html" class="sidebar-link">Microsoft SQL Server Management Studio Shortcut Keys</a></li><li><a href="/mssql/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="query-store"><a href="#query-store" class="header-anchor">#</a> Query Store</h1> <h2 id="enable-query-store-on-database"><a href="#enable-query-store-on-database" class="header-anchor">#</a> Enable query store on database</h2> <p>Query store can be enabled on database by using the following command:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> tpch <span class="token keyword">SET</span> QUERY_STORE <span class="token operator">=</span> <span class="token keyword">ON</span>

</code></pre></div><p>SQL Server/Azure SQL Database will collect information about executed queries and provide information in sys.query_store views:</p> <ul><li>sys.query_store_query</li> <li>sys.query_store_query_text</li> <li>sys.query_store_plan</li> <li>sys.query_store_runtime_stats</li> <li>sys.query_store_runtime_stats_interval</li> <li>sys.database_query_store_options</li> <li>sys.query_context_settings</li></ul> <h2 id="get-execution-statistics-for-sql-queries-plans"><a href="#get-execution-statistics-for-sql-queries-plans" class="header-anchor">#</a> Get execution statistics for SQL queries/plans</h2> <p>The following query will return informationa about qeries, their plans and average statistics regarding their duration, CPU time, physical and logical io reads.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> Txt<span class="token punctuation">.</span>query_text_id<span class="token punctuation">,</span> Txt<span class="token punctuation">.</span>query_sql_text<span class="token punctuation">,</span> Pl<span class="token punctuation">.</span>plan_id<span class="token punctuation">,</span>
        avg_duration<span class="token punctuation">,</span> avg_cpu_time<span class="token punctuation">,</span> 
        avg_physical_io_reads<span class="token punctuation">,</span> avg_logical_io_reads
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>query_store_plan <span class="token keyword">AS</span> Pl  
<span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>query_store_query <span class="token keyword">AS</span> Qry  
    <span class="token keyword">ON</span> Pl<span class="token punctuation">.</span>query_id <span class="token operator">=</span> Qry<span class="token punctuation">.</span>query_id  
<span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>query_store_query_text <span class="token keyword">AS</span> Txt  
    <span class="token keyword">ON</span> Qry<span class="token punctuation">.</span>query_text_id <span class="token operator">=</span> Txt<span class="token punctuation">.</span>query_text_id
<span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>query_store_runtime_stats Stats
    <span class="token keyword">ON</span> Pl<span class="token punctuation">.</span>plan_id <span class="token operator">=</span> Stats<span class="token punctuation">.</span>plan_id

</code></pre></div><h2 id="remove-data-from-query-store"><a href="#remove-data-from-query-store" class="header-anchor">#</a> Remove data from query store</h2> <p>If you want to remove some query or query plan from query store, you can use the following commands:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">EXEC</span> sp_query_store_remove_query <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> sp_query_store_remove_plan <span class="token number">3</span><span class="token punctuation">;</span> 

</code></pre></div><p>Parameters for these stored procedures are query/plan id retrieved from system views.</p> <p>You can also just remove execution statistics for particular plan without removing the plan from the store:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">EXEC</span> sp_query_store_reset_exec_stats <span class="token number">3</span><span class="token punctuation">;</span>  

</code></pre></div><p>Parameter provided to this procedure plan id.</p> <h2 id="forcing-plan-for-query"><a href="#forcing-plan-for-query" class="header-anchor">#</a> Forcing plan for query</h2> <p>SQL Query optimizer will choose the baes possible plan that he can find for some query. If you can find some plan that works optimally for some query, you can force QO to always use that plan using the following stored procedure:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">EXEC</span> sp_query_store_unforce_plan <span class="token variable">@query_id</span><span class="token punctuation">,</span> <span class="token variable">@plan_id</span>

</code></pre></div><p>From this point, QO will always use plan provided for the query.</p> <p>If you want to remove this binding, you can use the following stored procedure:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">EXEC</span> sp_query_store_force_plan <span class="token variable">@query_id</span><span class="token punctuation">,</span> <span class="token variable">@plan_id</span>

</code></pre></div><p>From this point, QO will again try to find the best plan.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/mssql/query-store.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mssql/query-hints.html" class="prev">
        Query Hints
      </a></span> <span class="next"><a href="/mssql/querying-results-by-page.html">
        Querying results by page
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/2046.558e8434.js" defer></script>
  </body>
</html>
