<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PostgreSQL - Backup and Restore</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Backing up one database, Restoring backups, Backing up the whole cluster, Using psql to export data, Using Copy to import, Using Copy to export">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="PostgreSQL - Backup and Restore">
    <meta property="og:description" content="Backing up one database, Restoring backups, Backing up the whole cluster, Using psql to export data, Using Copy to import, Using Copy to export">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/postgresql/backup-and-restore.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="PostgreSQL - Backup and Restore">
    <meta name="twitter:description" content="Backing up one database, Restoring backups, Backing up the whole cluster, Using psql to export data, Using Copy to import, Using Copy to export">
    <meta name="twitter:url" content="/postgresql/backup-and-restore.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/2540.0fc20e87.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>PostgreSQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/postgresql/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/postgresql/getting-started-with-postgresql.html" class="sidebar-link">Getting started with postgresql</a></li><li><a href="/postgresql/data-types.html" class="sidebar-link">Data Types</a></li><li><a href="/postgresql/dates-timestamps-and-intervals.html" class="sidebar-link">Dates, Timestamps, and Intervals</a></li><li><a href="/postgresql/table-creation.html" class="sidebar-link">Table Creation</a></li><li><a href="/postgresql/select.html" class="sidebar-link">SELECT</a></li><li><a href="/postgresql/find-string-length-character-length.html" class="sidebar-link">Find String Length / Character Length</a></li><li><a href="/postgresql/coalesce.html" class="sidebar-link">COALESCE</a></li><li><a href="/postgresql/insert.html" class="sidebar-link">INSERT</a></li><li><a href="/postgresql/update.html" class="sidebar-link">UPDATE</a></li><li><a href="/postgresql/json-support.html" class="sidebar-link">JSON Support</a></li><li><a href="/postgresql/aggregate-functions.html" class="sidebar-link">Aggregate Functions</a></li><li><a href="/postgresql/common-table-expressions-with.html" class="sidebar-link">Common Table Expressions (WITH)</a></li><li><a href="/postgresql/window-functions.html" class="sidebar-link">Window Functions</a></li><li><a href="/postgresql/recursive-queries.html" class="sidebar-link">Recursive queries</a></li><li><a href="/postgresql/programming-with-pl-pgsql.html" class="sidebar-link">Programming with PL/pgSQL</a></li><li><a href="/postgresql/inheritance.html" class="sidebar-link">Inheritance</a></li><li><a href="/postgresql/export-postgresql-database-table-header-and-data-to-csv-file.html" class="sidebar-link">Export PostgreSQL database table header and data to CSV file</a></li><li><a href="/postgresql/triggers-and-trigger-functions.html" class="sidebar-link">Triggers and Trigger Functions</a></li><li><a href="/postgresql/event-triggers.html" class="sidebar-link">Event Triggers</a></li><li><a href="/postgresql/role-management.html" class="sidebar-link">Role Management</a></li><li><a href="/postgresql/postgres-cryptographic-functions.html" class="sidebar-link">Postgres cryptographic functions</a></li><li><a href="/postgresql/comments-in-postgresql.html" class="sidebar-link">Comments in postgresql</a></li><li><a href="/postgresql/backup-and-restore.html" aria-current="page" class="active sidebar-link">Backup and Restore</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/postgresql/backup-and-restore.html#backing-up-one-database" class="sidebar-link">Backing up one database</a></li><li class="sidebar-sub-header"><a href="/postgresql/backup-and-restore.html#restoring-backups" class="sidebar-link">Restoring backups</a></li><li class="sidebar-sub-header"><a href="/postgresql/backup-and-restore.html#backing-up-the-whole-cluster" class="sidebar-link">Backing up the whole cluster</a></li><li class="sidebar-sub-header"><a href="/postgresql/backup-and-restore.html#using-psql-to-export-data" class="sidebar-link">Using psql to export data</a></li><li class="sidebar-sub-header"><a href="/postgresql/backup-and-restore.html#using-copy-to-import" class="sidebar-link">Using Copy to import</a></li><li class="sidebar-sub-header"><a href="/postgresql/backup-and-restore.html#using-copy-to-export" class="sidebar-link">Using Copy to export</a></li></ul></li><li><a href="/postgresql/backup-script-for-a-production-db.html" class="sidebar-link">Backup script for a production DB</a></li><li><a href="/postgresql/accessing-data-programmatically.html" class="sidebar-link">Accessing Data Programmatically</a></li><li><a href="/postgresql/connect-to-postgresql-from-java.html" class="sidebar-link">Connect to PostgreSQL from Java</a></li><li><a href="/postgresql/postgresql-high-availability.html" class="sidebar-link">PostgreSQL High Availability</a></li><li><a href="/postgresql/extension-dblink-and-postgres-fdw.html" class="sidebar-link">EXTENSION dblink and postgres_fdw</a></li><li><a href="/postgresql/postgres-tip-and-tricks.html" class="sidebar-link">Postgres Tip and Tricks</a></li><li><a href="/postgresql/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="backup-and-restore"><a href="#backup-and-restore" class="header-anchor">#</a> Backup and Restore</h1> <h2 id="backing-up-one-database"><a href="#backing-up-one-database" class="header-anchor">#</a> Backing up one database</h2> <div class="language-sql extra-class"><pre class="language-sql"><code>pg_dump <span class="token operator">-</span>Fc <span class="token operator">-</span>f <span class="token keyword">DATABASE</span><span class="token punctuation">.</span>pgsql <span class="token keyword">DATABASE</span>

</code></pre></div><p>The <code>-Fc</code> selects the &quot;custom backup format&quot; which gives you more power than raw SQL; see <code>pg_restore</code> for more details. If you want a vanilla SQL file, you can do this instead:</p> <div class="language-sql extra-class"><pre class="language-sql"><code>pg_dump <span class="token operator">-</span>f <span class="token keyword">DATABASE</span><span class="token punctuation">.</span><span class="token keyword">sql</span> <span class="token keyword">DATABASE</span>

</code></pre></div><p>or even</p> <div class="language-sql extra-class"><pre class="language-sql"><code>pg_dump <span class="token keyword">DATABASE</span> <span class="token operator">&gt;</span> <span class="token keyword">DATABASE</span><span class="token punctuation">.</span><span class="token keyword">sql</span>

</code></pre></div><h2 id="restoring-backups"><a href="#restoring-backups" class="header-anchor">#</a> Restoring backups</h2> <div class="language-sql extra-class"><pre class="language-sql"><code>psql <span class="token operator">&lt;</span> <span class="token keyword">backup</span><span class="token punctuation">.</span><span class="token keyword">sql</span>

</code></pre></div><p>A safer alternative uses <code>-1</code> to wrap the restore in a transaction. The <code>-f</code> specifies the filename rather than using shell redirection.</p> <div class="language-sql extra-class"><pre class="language-sql"><code>psql <span class="token operator">-</span><span class="token number">1</span>f <span class="token keyword">backup</span><span class="token punctuation">.</span><span class="token keyword">sql</span>

</code></pre></div><p>Custom format files must be restored using <code>pg_restore</code> with the <code>-d</code> option to specify the database:</p> <div class="language-sql extra-class"><pre class="language-sql"><code>pg_restore <span class="token operator">-</span>d <span class="token keyword">DATABASE</span> <span class="token keyword">DATABASE</span><span class="token punctuation">.</span>pgsql

</code></pre></div><p>The custom format can also be converted back to SQL:</p> <div class="language-sql extra-class"><pre class="language-sql"><code>pg_restore <span class="token keyword">backup</span><span class="token punctuation">.</span>pgsql <span class="token operator">&gt;</span> <span class="token keyword">backup</span><span class="token punctuation">.</span><span class="token keyword">sql</span>

</code></pre></div><p>Usage of the custom format is recommended because you can choose which things to restore and optionally enable parallel processing.</p> <p>You may need to do a pg_dump followed by a pg_restore if you upgrade from one postgresql release to a newer one.</p> <h2 id="backing-up-the-whole-cluster"><a href="#backing-up-the-whole-cluster" class="header-anchor">#</a> Backing up the whole cluster</h2> <div class="language-sql extra-class"><pre class="language-sql"><code>$ pg_dumpall <span class="token operator">-</span>f <span class="token keyword">backup</span><span class="token punctuation">.</span><span class="token keyword">sql</span>

</code></pre></div><p>This works behind the scenes by making multiple connections to the server once for each database and executing <code>pg_dump</code> on it.</p> <p>Sometimes, you might be tempted to set this up as a cron job, so you want to see the date the backup was taken as part of the filename:</p> <div class="language-sql extra-class"><pre class="language-sql"><code>$ postgres<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">-</span>$<span class="token punctuation">(</span><span class="token keyword">date</span> <span class="token operator">+</span><span class="token operator">%</span>Y<span class="token operator">-</span><span class="token operator">%</span>m<span class="token operator">-</span><span class="token operator">%</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">sql</span>

</code></pre></div><p>However, please note that this could produce large files on a daily basis. Postgresql has a much better mechanism for regular backups - <a href="https://www.postgresql.org/docs/9.2/static/continuous-archiving.html" target="_blank" rel="noopener noreferrer">WAL archives<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>The output from pg_dumpall is sufficient to restore to an identically-configured Postgres instance, but the configuration files in <code>$PGDATA</code> (<code>pg_hba.conf</code> and <code>postgresql.conf</code>) are not part of the backup, so you'll have to back them up separately.</p> <div class="language-sql extra-class"><pre class="language-sql"><code>postgres<span class="token operator">=</span><span class="token comment"># SELECT pg_start_backup('my-backup');</span>
postgres<span class="token operator">=</span><span class="token comment"># SELECT pg_stop_backup();</span>

</code></pre></div><p>To take a filesystem backup, you must use these functions to help ensure that Postgres is in a consistent state while the backup is prepared.</p> <h2 id="using-psql-to-export-data"><a href="#using-psql-to-export-data" class="header-anchor">#</a> Using psql to export data</h2> <p>Data can be exported using copy command or by taking use of command line options of psql command.</p> <p><strong>To Export csv data from table user to csv file:</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code>psql <span class="token operator">-</span>p \<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> <span class="token operator">-</span>U \<span class="token operator">&lt;</span>username<span class="token operator">&gt;</span> <span class="token operator">-</span>d \<span class="token operator">&lt;</span><span class="token keyword">database</span><span class="token operator">&gt;</span> <span class="token operator">-</span>A <span class="token operator">-</span>F<span class="token operator">&lt;</span><span class="token keyword">delimiter</span><span class="token operator">&gt;</span> <span class="token operator">-</span>c\<span class="token operator">&lt;</span><span class="token keyword">sql</span> <span class="token keyword">to</span> <span class="token keyword">execute</span><span class="token operator">&gt;</span> \<span class="token operator">&gt;</span> \<span class="token operator">&lt;</span>output filename <span class="token keyword">with</span> path<span class="token operator">&gt;</span>

psql <span class="token operator">-</span>p <span class="token number">5432</span> <span class="token operator">-</span>U postgres <span class="token operator">-</span>d test_database <span class="token operator">-</span>A <span class="token operator">-</span>F<span class="token punctuation">,</span> <span class="token operator">-</span>c <span class="token string">&quot;select * from user&quot;</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>user_data<span class="token punctuation">.</span>csv

</code></pre></div><p>Here combination of -A and -F does the trick.</p> <p><code>-F</code> is to specify delimiter</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">-</span>A <span class="token operator">or</span> <span class="token comment">--no-align</span>

</code></pre></div><p>Switches to unaligned output mode. (The default output mode is otherwise aligned.)</p> <h2 id="using-copy-to-import"><a href="#using-copy-to-import" class="header-anchor">#</a> Using Copy to import</h2> <h3 id="to-copy-data-from-a-csv-file-to-a-table"><a href="#to-copy-data-from-a-csv-file-to-a-table" class="header-anchor">#</a> To Copy Data from a CSV file to a table</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>COPY <span class="token operator">&lt;</span>tablename<span class="token operator">&gt;</span> <span class="token keyword">FROM</span> <span class="token string">'&lt;filename with path&gt;'</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>To insert into table <code>user</code> from a file named <code>user_data.csv</code> placed inside <code>/home/user/</code>:</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code>COPY <span class="token keyword">user</span> <span class="token keyword">FROM</span> <span class="token string">'/home/user/user_data.csv'</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="to-copy-data-from-pipe-separated-file-to-table"><a href="#to-copy-data-from-pipe-separated-file-to-table" class="header-anchor">#</a> To Copy data from pipe separated file to table</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>COPY <span class="token keyword">user</span> <span class="token keyword">FROM</span> <span class="token string">'/home/user/user_data'</span> <span class="token keyword">WITH</span> <span class="token keyword">DELIMITER</span> <span class="token string">'|'</span><span class="token punctuation">;</span>

</code></pre></div><p>Note: In absence of the option <code>with delimiter</code>, the default delimiter is comma <code>,</code></p> <h3 id="to-ignore-header-line-while-importing-file"><a href="#to-ignore-header-line-while-importing-file" class="header-anchor">#</a> To ignore header line while importing file</h3> <p>Use the Header option:</p> <div class="language-sql extra-class"><pre class="language-sql"><code>COPY <span class="token keyword">user</span> <span class="token keyword">FROM</span> <span class="token string">'/home/user/user_data'</span> <span class="token keyword">WITH</span> <span class="token keyword">DELIMITER</span> <span class="token string">'|'</span> HEADER<span class="token punctuation">;</span>

</code></pre></div><p>Note: If data is quoted, by default data quoting characters are double quote. If the data is quoted using any other character use the <code>QUOTE</code> option; however, this option is allowed only when using CSV format.</p> <h2 id="using-copy-to-export"><a href="#using-copy-to-export" class="header-anchor">#</a> Using Copy to export</h2> <h3 id="to-copy-table-to-standard-o-p"><a href="#to-copy-table-to-standard-o-p" class="header-anchor">#</a> To Copy table to standard o/p</h3> <p>COPY <tablename> TO STDOUT (DELIMITER '|');</tablename></p> <p>To export table user to Standard ouput:</p> <p>COPY user TO STDOUT (DELIMITER '|');</p> <h3 id="to-copy-table-to-file"><a href="#to-copy-table-to-file" class="header-anchor">#</a> To Copy table to file</h3> <p>COPY user FROM '/home/user/user_data' WITH DELIMITER '|';</p> <h3 id="to-copy-the-output-of-sql-statement-to-file"><a href="#to-copy-the-output-of-sql-statement-to-file" class="header-anchor">#</a> To Copy the output of SQL statement to file</h3> <p>COPY (sql statement) TO '<filename with="" path="">';</filename></p> <p>COPY (SELECT * FROM user WHERE user_name LIKE 'A%') TO '/home/user/user_data';</p> <h3 id="to-copy-into-a-compressed-file"><a href="#to-copy-into-a-compressed-file" class="header-anchor">#</a> To Copy into a compressed file</h3> <p>COPY user TO PROGRAM 'gzip &gt; /home/user/user_data.gz';</p> <p>Here program gzip is executed to compress user table data.</p> <h4 id="remarks"><a href="#remarks" class="header-anchor">#</a> Remarks</h4> <h3 id="backing-up-the-filesystem-instead-of-using-pg-dumpall-and-pg-dump"><a href="#backing-up-the-filesystem-instead-of-using-pg-dumpall-and-pg-dump" class="header-anchor">#</a> Backing up the filesystem instead of using <code>pg_dumpall</code> and <code>pg_dump</code></h3> <p>It's very important that if you use this, you call the <code>pg_start_backup()</code> function before and <code>pg_stop_backup()</code> function after. Doing filesystem backups is not safe otherwise; even a ZFS or FreeBSD snapshot of the filesystem backed up without those function calls will place the database in recovery mode and may lose transactions.</p> <p>I would avoid doing filesystem backups instead of regular Postgres backups, both for this reason, and because Postgres backup files (especially in the custom format) are extremely versatile in supporting alternate restores. Since they're single files, they're also less hassle to manage.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/postgresql/backup-and-restore.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/postgresql/comments-in-postgresql.html" class="prev">
        Comments in postgresql
      </a></span> <span class="next"><a href="/postgresql/backup-script-for-a-production-db.html">
        Backup script for a production DB
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/2540.0fc20e87.js" defer></script>
  </body>
</html>
