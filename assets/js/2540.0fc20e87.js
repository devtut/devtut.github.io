(window.webpackJsonp=window.webpackJsonp||[]).push([[2540],{2949:function(t,s,a){"use strict";a.r(s);var e=a(31),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"backup-and-restore"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backup-and-restore"}},[t._v("#")]),t._v(" Backup and Restore")]),t._v(" "),a("h2",{attrs:{id:"backing-up-one-database"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backing-up-one-database"}},[t._v("#")]),t._v(" Backing up one database")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("pg_dump "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Fc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("f "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pgsql "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),t._v("\n\n")])])]),a("p",[t._v("The "),a("code",[t._v("-Fc")]),t._v(' selects the "custom backup format" which gives you more power than raw SQL; see '),a("code",[t._v("pg_restore")]),t._v(" for more details. If you want a vanilla SQL file, you can do this instead:")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("pg_dump "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("f "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),t._v("\n\n")])])]),a("p",[t._v("or even")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("pg_dump "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("\n\n")])])]),a("h2",{attrs:{id:"restoring-backups"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#restoring-backups"}},[t._v("#")]),t._v(" Restoring backups")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("psql "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("backup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("\n\n")])])]),a("p",[t._v("A safer alternative uses "),a("code",[t._v("-1")]),t._v(" to wrap the restore in a transaction. The "),a("code",[t._v("-f")]),t._v(" specifies the filename rather than using shell redirection.")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("psql "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("f "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("backup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("\n\n")])])]),a("p",[t._v("Custom format files must be restored using "),a("code",[t._v("pg_restore")]),t._v(" with the "),a("code",[t._v("-d")]),t._v(" option to specify the database:")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("pg_restore "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATABASE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pgsql\n\n")])])]),a("p",[t._v("The custom format can also be converted back to SQL:")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("pg_restore "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("backup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pgsql "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("backup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("\n\n")])])]),a("p",[t._v("Usage of the custom format is recommended because you can choose which things to restore and optionally enable parallel processing.")]),t._v(" "),a("p",[t._v("You may need to do a pg_dump followed by a pg_restore if you upgrade from one postgresql release to a newer one.")]),t._v(" "),a("h2",{attrs:{id:"backing-up-the-whole-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backing-up-the-whole-cluster"}},[t._v("#")]),t._v(" Backing up the whole cluster")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("$ pg_dumpall "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("f "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("backup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("\n\n")])])]),a("p",[t._v("This works behind the scenes by making multiple connections to the server once for each database and executing "),a("code",[t._v("pg_dump")]),t._v(" on it.")]),t._v(" "),a("p",[t._v("Sometimes, you might be tempted to set this up as a cron job, so you want to see the date the backup was taken as part of the filename:")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("$ postgres"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("backup")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("date")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("Y"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("\n\n")])])]),a("p",[t._v("However, please note that this could produce large files on a daily basis. Postgresql has a much better mechanism for regular backups - "),a("a",{attrs:{href:"https://www.postgresql.org/docs/9.2/static/continuous-archiving.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("WAL archives"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("The output from pg_dumpall is sufficient to restore to an identically-configured Postgres instance, but the configuration files in "),a("code",[t._v("$PGDATA")]),t._v(" ("),a("code",[t._v("pg_hba.conf")]),t._v(" and "),a("code",[t._v("postgresql.conf")]),t._v(") are not part of the backup, so you'll have to back them up separately.")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("postgres"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# SELECT pg_start_backup('my-backup');")]),t._v("\npostgres"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# SELECT pg_stop_backup();")]),t._v("\n\n")])])]),a("p",[t._v("To take a filesystem backup, you must use these functions to help ensure that Postgres is in a consistent state while the backup is prepared.")]),t._v(" "),a("h2",{attrs:{id:"using-psql-to-export-data"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-psql-to-export-data"}},[t._v("#")]),t._v(" Using psql to export data")]),t._v(" "),a("p",[t._v("Data can be exported using copy command or by taking use of command line options of psql command.")]),t._v(" "),a("p",[a("strong",[t._v("To Export csv data from table user to csv file:")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("psql "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("p \\"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("U \\"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d \\"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("database")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("A "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("F"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("delimiter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("c\\"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("execute")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \\"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \\"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("output filename "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\npsql "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5432")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("U postgres "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d test_database "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("A "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("F"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"select * from user"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("user_data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("csv\n\n")])])]),a("p",[t._v("Here combination of -A and -F does the trick.")]),t._v(" "),a("p",[a("code",[t._v("-F")]),t._v(" is to specify delimiter")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("A "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("or")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--no-align")]),t._v("\n\n")])])]),a("p",[t._v("Switches to unaligned output mode. (The default output mode is otherwise aligned.)")]),t._v(" "),a("h2",{attrs:{id:"using-copy-to-import"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-copy-to-import"}},[t._v("#")]),t._v(" Using Copy to import")]),t._v(" "),a("h3",{attrs:{id:"to-copy-data-from-a-csv-file-to-a-table"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#to-copy-data-from-a-csv-file-to-a-table"}},[t._v("#")]),t._v(" To Copy Data from a CSV file to a table")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("COPY "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("tablename"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'<filename with path>'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("p",[a("strong",[t._v("To insert into table "),a("code",[t._v("user")]),t._v(" from a file named "),a("code",[t._v("user_data.csv")]),t._v(" placed inside "),a("code",[t._v("/home/user/")]),t._v(":")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("COPY "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/home/user/user_data.csv'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("h3",{attrs:{id:"to-copy-data-from-pipe-separated-file-to-table"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#to-copy-data-from-pipe-separated-file-to-table"}},[t._v("#")]),t._v(" To Copy data from pipe separated file to table")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("COPY "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/home/user/user_data'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WITH")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELIMITER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'|'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("p",[t._v("Note: In absence of the option "),a("code",[t._v("with delimiter")]),t._v(", the default delimiter is comma "),a("code",[t._v(",")])]),t._v(" "),a("h3",{attrs:{id:"to-ignore-header-line-while-importing-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#to-ignore-header-line-while-importing-file"}},[t._v("#")]),t._v(" To ignore header line while importing file")]),t._v(" "),a("p",[t._v("Use the Header option:")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("COPY "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/home/user/user_data'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WITH")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELIMITER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'|'")]),t._v(" HEADER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("p",[t._v("Note: If data is quoted, by default data quoting characters are double quote. If the data is quoted using any other character use the "),a("code",[t._v("QUOTE")]),t._v(" option; however, this option is allowed only when using CSV format.")]),t._v(" "),a("h2",{attrs:{id:"using-copy-to-export"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-copy-to-export"}},[t._v("#")]),t._v(" Using Copy to export")]),t._v(" "),a("h3",{attrs:{id:"to-copy-table-to-standard-o-p"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#to-copy-table-to-standard-o-p"}},[t._v("#")]),t._v(" To Copy table to standard o/p")]),t._v(" "),a("p",[t._v("COPY "),a("tablename",[t._v(" TO STDOUT (DELIMITER '|');")])],1),t._v(" "),a("p",[t._v("To export table user to Standard ouput:")]),t._v(" "),a("p",[t._v("COPY user TO STDOUT (DELIMITER '|');")]),t._v(" "),a("h3",{attrs:{id:"to-copy-table-to-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#to-copy-table-to-file"}},[t._v("#")]),t._v(" To Copy table to file")]),t._v(" "),a("p",[t._v("COPY user FROM '/home/user/user_data' WITH DELIMITER '|';")]),t._v(" "),a("h3",{attrs:{id:"to-copy-the-output-of-sql-statement-to-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#to-copy-the-output-of-sql-statement-to-file"}},[t._v("#")]),t._v(" To Copy the output of SQL statement to file")]),t._v(" "),a("p",[t._v("COPY (sql statement) TO '"),a("filename",{attrs:{with:"",path:""}},[t._v("';")])],1),t._v(" "),a("p",[t._v("COPY (SELECT * FROM user WHERE user_name LIKE 'A%') TO '/home/user/user_data';")]),t._v(" "),a("h3",{attrs:{id:"to-copy-into-a-compressed-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#to-copy-into-a-compressed-file"}},[t._v("#")]),t._v(" To Copy into a compressed file")]),t._v(" "),a("p",[t._v("COPY user TO PROGRAM 'gzip > /home/user/user_data.gz';")]),t._v(" "),a("p",[t._v("Here program gzip is executed to compress user table data.")]),t._v(" "),a("h4",{attrs:{id:"remarks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#remarks"}},[t._v("#")]),t._v(" Remarks")]),t._v(" "),a("h3",{attrs:{id:"backing-up-the-filesystem-instead-of-using-pg-dumpall-and-pg-dump"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backing-up-the-filesystem-instead-of-using-pg-dumpall-and-pg-dump"}},[t._v("#")]),t._v(" Backing up the filesystem instead of using "),a("code",[t._v("pg_dumpall")]),t._v(" and "),a("code",[t._v("pg_dump")])]),t._v(" "),a("p",[t._v("It's very important that if you use this, you call the "),a("code",[t._v("pg_start_backup()")]),t._v(" function before and "),a("code",[t._v("pg_stop_backup()")]),t._v(" function after. Doing filesystem backups is not safe otherwise; even a ZFS or FreeBSD snapshot of the filesystem backed up without those function calls will place the database in recovery mode and may lose transactions.")]),t._v(" "),a("p",[t._v("I would avoid doing filesystem backups instead of regular Postgres backups, both for this reason, and because Postgres backup files (especially in the custom format) are extremely versatile in supporting alternate restores. Since they're single files, they're also less hassle to manage.")])])}),[],!1,null,null,null);s.default=r.exports}}]);