(window.webpackJsonp=window.webpackJsonp||[]).push([[2044],{2388:function(s,t,e){"use strict";e.r(t);var a=e(19),r=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"query-store"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#query-store"}},[s._v("#")]),s._v(" Query Store")]),s._v(" "),e("h2",{attrs:{id:"enable-query-store-on-database"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#enable-query-store-on-database"}},[s._v("#")]),s._v(" Enable query store on database")]),s._v(" "),e("p",[s._v("Query store can be enabled on database by using the following command:")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" tpch "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" QUERY_STORE "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v("\n\n")])])]),e("p",[s._v("SQL Server/Azure SQL Database will collect information about executed queries and provide information in sys.query_store views:")]),s._v(" "),e("ul",[e("li",[s._v("sys.query_store_query")]),s._v(" "),e("li",[s._v("sys.query_store_query_text")]),s._v(" "),e("li",[s._v("sys.query_store_plan")]),s._v(" "),e("li",[s._v("sys.query_store_runtime_stats")]),s._v(" "),e("li",[s._v("sys.query_store_runtime_stats_interval")]),s._v(" "),e("li",[s._v("sys.database_query_store_options")]),s._v(" "),e("li",[s._v("sys.query_context_settings")])]),s._v(" "),e("h2",{attrs:{id:"get-execution-statistics-for-sql-queries-plans"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#get-execution-statistics-for-sql-queries-plans"}},[s._v("#")]),s._v(" Get execution statistics for SQL queries/plans")]),s._v(" "),e("p",[s._v("The following query will return informationa about qeries, their plans and average statistics regarding their duration, CPU time, physical and logical io reads.")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" Txt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_text_id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Txt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_sql_text"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Pl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("plan_id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        avg_duration"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" avg_cpu_time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n        avg_physical_io_reads"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" avg_logical_io_reads\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" sys"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_store_plan "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" Pl  \n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" sys"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_store_query "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" Qry  \n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" Pl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_id "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Qry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_id  \n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" sys"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_store_query_text "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" Txt  \n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" Qry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_text_id "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Txt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_text_id\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" sys"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("query_store_runtime_stats Stats\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" Pl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("plan_id "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Stats"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("plan_id\n\n")])])]),e("h2",{attrs:{id:"remove-data-from-query-store"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#remove-data-from-query-store"}},[s._v("#")]),s._v(" Remove data from query store")]),s._v(" "),e("p",[s._v("If you want to remove some query or query plan from query store, you can use the following commands:")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" sp_query_store_remove_query "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" sp_query_store_remove_plan "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n\n")])])]),e("p",[s._v("Parameters for these stored procedures are query/plan id retrieved from system views.")]),s._v(" "),e("p",[s._v("You can also just remove execution statistics for particular plan without removing the plan from the store:")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" sp_query_store_reset_exec_stats "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n\n")])])]),e("p",[s._v("Parameter provided to this procedure plan id.")]),s._v(" "),e("h2",{attrs:{id:"forcing-plan-for-query"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#forcing-plan-for-query"}},[s._v("#")]),s._v(" Forcing plan for query")]),s._v(" "),e("p",[s._v("SQL Query optimizer will choose the baes possible plan that he can find for some query. If you can find some plan that works optimally for some query, you can force QO to always use that plan using the following stored procedure:")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" sp_query_store_unforce_plan "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@query_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@plan_id")]),s._v("\n\n")])])]),e("p",[s._v("From this point, QO will always use plan provided for the query.")]),s._v(" "),e("p",[s._v("If you want to remove this binding, you can use the following stored procedure:")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXEC")]),s._v(" sp_query_store_force_plan "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@query_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@plan_id")]),s._v("\n\n")])])]),e("p",[s._v("From this point, QO will again try to find the best plan.")])])}),[],!1,null,null,null);t.default=r.exports}}]);