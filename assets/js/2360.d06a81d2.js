(window.webpackJsonp=window.webpackJsonp||[]).push([[2360],{2768:function(s,t,a){"use strict";a.r(t);var e=a(31),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"oracle-advanced-queuing-aq"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#oracle-advanced-queuing-aq"}},[s._v("#")]),s._v(" Oracle Advanced Queuing (AQ)")]),s._v(" "),a("h2",{attrs:{id:"simple-producer-consumer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#simple-producer-consumer"}},[s._v("#")]),s._v(" Simple Producer/Consumer")]),s._v(" "),a("h3",{attrs:{id:"overview"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[s._v("#")]),s._v(" Overview")]),s._v(" "),a("p",[s._v("Create a queue that we can send a message to.  Oracle will notify our stored procedure that a message has been enqueued and should be worked.  We'll also add some subprograms we can use in an emergency to stop messages from being deqeued, allow dequeuing again, and run a simple batch job to work through all of the messages.")]),s._v(" "),a("p",[s._v("These examples were tested on Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production.")]),s._v(" "),a("h3",{attrs:{id:"create-queue"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-queue"}},[s._v("#")]),s._v(" Create Queue")]),s._v(" "),a("p",[s._v("We will create a message type, a queue table that can hold the messages, and a queue.  Messages in the queue will be dequeued first by priority then be their enqueue time.  If anything goes wrong working the message and the dequeue is rolled-back AQ will make the message available for dequeue 3600 seconds later.  It will do this 48 times before moving it an exception queue.")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" message_t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" object \n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n   sender  varchar2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   message varchar2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- Type MESSAGE_T compiled")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v(" dbms_aqadm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_queue_table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n     queue_table        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'MESSAGE_Q_TBL'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     queue_payload_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'MESSAGE_T'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     sort_list          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PRIORITY,ENQ_TIME'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     multiple_consumers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     compatible         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.0.0'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- PL/SQL procedure successfully completed.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v(" dbms_aqadm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n     queue_name          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'MESSAGE_Q'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     queue_table         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'MESSAGE_Q_TBL'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     queue_type          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     max_retries         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     retry_delay         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     dependency_tracking "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- PL/SQL procedure successfully completed.")]),s._v("\n\n")])])]),a("p",[s._v("Now that we have a place to put the messages lets create a package to manage and work messages in the queue.")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("or")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("replace")]),s._v(" package message_worker_pkg\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),s._v("\n   queue_name_c constant varchar2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'MESSAGE_Q'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   \n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- allows the workers to process messages in the queue")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" enable_dequeue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- prevents messages from being worked but will still allow them to be created and enqueued")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" disable_dequeue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- called only by Oracle Advanced Queueing.  Do not call anywhere else.")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" on_message_enqueued "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("context        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" raw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  reginfo        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aq$_reg_info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  descr          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aq$_descriptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  payload        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" raw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  payloadl       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- allows messages to be worked if we missed the notification (or a retry")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- is pending)")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" work_old_messages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("or")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("replace")]),s._v(" package body message_worker_pkg\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- raised by Oracle when we try to dequeue but no more messages are ready to")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- be dequeued at this moment")]),s._v("\n   no_more_messages_ex          exception"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   pragma exception_init "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("no_more_messages_ex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25228")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- allows the workers to process messages in the queue")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" enable_dequeue\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n      dbms_aqadm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("start_queue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queue_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" queue_name_c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dequeue "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v(" enable_dequeue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- prevents messages from being worked but will still allow them to be created and enqueued")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" disable_dequeue\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n      dbms_aqadm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stop_queue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queue_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" queue_name_c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dequeue "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" enqueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v(" disable_dequeue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" work_message "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message_in "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("out")]),s._v(" nocopy message_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n      dbms_output"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("put_line "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" message_in"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sender "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("' says '")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" message_in"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("message "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v(" work_message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- called only by Oracle Advanced Queueing.  Do not call anywhere else.")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" on_message_enqueued "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("context        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" raw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  reginfo        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aq$_reg_info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  descr          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aq$_descriptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  payload        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" raw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                  payloadl       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v("\n      pragma autonomous_transaction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      dequeue_options_l      dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dequeue_options_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      message_id_l           raw "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      message_l              message_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      message_properties_l   dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("message_properties_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n      dequeue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("msgid         :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" descr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("msg_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      dequeue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("consumer_name :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" descr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("consumer_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      dequeue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("wait          :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("no_wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dequeue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queue_name           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" descr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("queue_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       dequeue_options      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" dequeue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       message_properties   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_properties_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       payload              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       msgid                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_id_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      work_message "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   exception\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" no_more_messages_ex\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- it's possible work_old_messages already dequeued the message")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" others\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- we don't need to have a raise here.  I just wanted to point out that")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- since this will be called by AQ throwing the exception back to it")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- will have it put the message back on the queue and retry later")]),s._v("\n         raise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v(" on_message_enqueued"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- allows messages to be worked if we missed the notification (or a retry")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- is pending)")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("procedure")]),s._v(" work_old_messages\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v("\n      pragma autonomous_transaction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      dequeue_options_l      dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dequeue_options_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      message_id_l           raw "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      message_l              message_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      message_properties_l   dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("message_properties_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n      dequeue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("wait       :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("no_wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      dequeue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("navigation :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("first_message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("loop")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- way out is no_more_messages_ex")]),s._v("\n         dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dequeue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queue_name           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" queue_name_c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          dequeue_options      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" dequeue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          message_properties   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_properties_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          payload              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          msgid                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_id_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n         work_message "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("loop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   exception\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" no_more_messages_ex\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v(" work_old_messages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])])]),a("p",[s._v("Next tell AQ that when a message is enqueued to MESSAGE_Q (and committed) notify our procedure it has work to do.  AQ will start up a job in its own session to handle this.")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n  dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("register "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n     sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aq$_reg_info_list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aq$_reg_info "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" message_worker_pkg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("queue_name_c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("namespace_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'plsql://'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.message_worker_pkg.on_message_enqueued'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                          hextoraw "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'FF'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n\n")])])]),a("h3",{attrs:{id:"start-queue-and-send-a-message"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#start-queue-and-send-a-message"}},[s._v("#")]),s._v(" Start Queue and Send a Message")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("declare")]),s._v("\n   enqueue_options_l      dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("enqueue_options_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   message_properties_l   dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("message_properties_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   message_id_l           raw "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   message_l              message_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- only need to do this next line ONCE")]),s._v("\n   dbms_aqadm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("start_queue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queue_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_worker_pkg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("queue_name_c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" enqueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dequeue "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   \n   message_l :"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" new message_t "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Jon'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Hello, world!'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   dbms_aq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("enqueue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queue_name           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_worker_pkg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("queue_name_c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    enqueue_options      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" enqueue_options_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    message_properties   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_properties_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    payload              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                    msgid                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" message_id_l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])])]),a("h4",{attrs:{id:"remarks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#remarks"}},[s._v("#")]),s._v(" Remarks")]),s._v(" "),a("li",[s._v("\nNever use DDL or DML against tables created by `dbms_aqadm.create_queue_table`.  Only use dbms_aqadm and dbms_aq to work with these tables.  Oracle may make several supporting tables, indexes, etc that you will not be aware of.  Manually running DDL or DML against the table may lead you to a scenario where Oracle Support will need you to drop and recreate the table and queues to resolve the situation.\n")]),s._v(" "),a("li",[s._v("\nIt's strongly recommended you do not use `dbms_aq.forever` for a wait option.  This has caused issues in the past as Oracle may start scheduling an excessive number of worker jobs to work the queues that are unnecessary (see Oracle Doc ID 2001165.1).\n")]),s._v(" "),a("li",[s._v("\nIt's recommended you do not set the AQ_TM_PROCESSES parameter in version 10.1 and later.  Especially avoid setting this to zero since this will disable the QMON background job that is necessary to maintain the queues.  You can reset this value to the Oracle default using the following command and restarting the database. `alter system reset aq_tm_processes scope=spfile sid='*';`\n")])])}),[],!1,null,null,null);t.default=n.exports}}]);