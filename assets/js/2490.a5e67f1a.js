(window.webpackJsonp=window.webpackJsonp||[]).push([[2490],{2898:function(t,e,a){"use strict";a.r(e);var s=a(31),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"performance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#performance"}},[t._v("#")]),t._v(" Performance")]),t._v(" "),a("h2",{attrs:{id:"profiling-with-xdebug"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#profiling-with-xdebug"}},[t._v("#")]),t._v(" Profiling with Xdebug")]),t._v(" "),a("p",[t._v("An extension to PHP called Xdebug is available to assist in "),a("a",{attrs:{href:"https://xdebug.org/docs/profiler",target:"_blank",rel:"noopener noreferrer"}},[t._v("profiling PHP applications"),a("OutboundLink")],1),t._v(', as well as runtime debugging.  When running the profiler, the output is written to a file in a binary format called "cachegrind".  Applications are available on each platform to analyze these files.')]),t._v(" "),a("p",[t._v("To enable profiling, install the extension and adjust php.ini settings.  In our example we will run the profile optionally based on a request parameter.  This allows us to keep settings static and turn on the profiler only as needed.")]),t._v(" "),a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Set to 1 to turn it on for every request")]),t._v("\nxdebug"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("profiler_enable "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Let's use a GET/POST parameter to turn on the profiler")]),t._v("\nxdebug"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("profiler_enable_trigger "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The GET/POST value we will pass; empty for any value")]),t._v("\nxdebug"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("profiler_enable_trigger_value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string double-quoted-string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Output cachegrind files to /tmp so our system cleans them up later")]),t._v("\nxdebug"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("profiler_output_dir "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string double-quoted-string"}},[t._v('"/tmp"')]),t._v("\nxdebug"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("profiler_output_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string double-quoted-string"}},[t._v('"cachegrind.out.%p"')]),t._v("\n\n")])])]),a("p",[t._v("Next use a web client to make a request to your application's URL you wish to profile, e.g.")]),t._v(" "),a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[t._v("http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//example.com/article/1?XDEBUG_PROFILE=1")]),t._v("\n\n")])])]),a("p",[t._v("As the page processes it will write to a file with a name similar to")]),t._v(" "),a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tmp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("cachegrind"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("out"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12345")]),t._v("\n\n")])])]),a("p",[t._v("Note that it will write one file for each PHP request / process that is executed.  So, for example, if you wish to analyze a form post, one profile will be written for the GET request to display the HTML form.  The XDEBUG_PROFILE parameter will need to be passed into the subsequent POST request to analyze the second request which processes the form.  Therefore when profiling it is sometimes easier to run curl to POST a form directly.")]),t._v(" "),a("p",[t._v("Once written the profile cache can be read by an application such as KCachegrind.")]),t._v(" "),a("p",[a("a",{attrs:{href:"http://i.stack.imgur.com/ENtOu.gif",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"http://i.stack.imgur.com/ENtOu.gif",alt:"KCachegrind"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("This will display information including:")]),t._v(" "),a("ul",[a("li",[t._v("Functions executed")]),t._v(" "),a("li",[t._v("Call time, both itself and inclusive of subsequent function calls")]),t._v(" "),a("li",[t._v("Number of times each function is called")]),t._v(" "),a("li",[t._v("Call graphs")]),t._v(" "),a("li",[t._v("Links to source code")])]),t._v(" "),a("p",[t._v("Obviously performance tuning is very specific to each application's use cases.  In general it's good to look for:")]),t._v(" "),a("ul",[a("li",[t._v("Repeated calls to the same function you wouldn't expect to see. For functions that process and query data these could be prime opportunities for your application to cache.")]),t._v(" "),a("li",[t._v("Slow-running functions.  Where is the application spending most of its time? the best payoff in performance tuning is focusing on those parts of the application which consume the most time.")])]),t._v(" "),a("p",[a("strong",[t._v("Note")]),t._v(": Xdebug, and in particular its profiling features, are very resource intensive and slow down PHP execution.  It is recommended to not run these in a production server environment.")]),t._v(" "),a("h2",{attrs:{id:"memory-usage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#memory-usage"}},[t._v("#")]),t._v(" Memory Usage")]),t._v(" "),a("p",[t._v("PHP's runtime memory limit is set through the INI directive "),a("code",[t._v("memory_limit")]),t._v(".  This setting prevents any single execution of PHP from using up too much memory, exhausting it for other scripts and system software.  The memory limit defaults to 128M and can be changed in the "),a("code",[t._v("php.ini")]),t._v(" file or at runtime.  It can be set to have no limit, but this is generally considered bad practice.")]),t._v(" "),a("p",[t._v("The exact memory usage used during runtime can be determined by calling "),a("code",[t._v("memory_get_usage()")]),t._v(".  It returns the number of bytes of memory allocated to the currently running script.  As of PHP 5.2, it has one optional boolean parameter to get the total allocated system memory, as opposed to the memory that's actively being used by PHP.")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('\n<?php\n echo memory_get_usage() . "\\n";\n // Outputs 350688 (or similar, depending on system and PHP version)\n\n // Let\'s use up some RAM\n $array = array_fill(0, 1000, \'abc\');\n\n echo memory_get_usage() . "\\n";\n // Outputs 387704\n\n // Remove the array from memory\n unset($array);\n\n echo memory_get_usage() . "\\n";\n // Outputs 350784\n\n')])])]),a("p",[t._v("Now "),a("code",[t._v("memory_get_usage")]),t._v(" gives you memory usage at the moment it is run.  Between calls to this function you may allocate and deallocate other things in memory.  To get the maximum amount of memory used up to a certain point, call "),a("code",[t._v("memory_get_peak_usage()")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token php language-php"}},[a("span",{pre:!0,attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("memory_get_peak_usage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string double-quoted-string"}},[t._v('"\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 385688")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$array")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("array_fill")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[t._v("'abc'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("memory_get_peak_usage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string double-quoted-string"}},[t._v('"\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 422736")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$array")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("memory_get_peak_usage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string double-quoted-string"}},[t._v('"\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 422776")]),t._v("\n\n")])])])]),a("p",[t._v("Notice the value will only go up or stay constant.")]),t._v(" "),a("h2",{attrs:{id:"profiling-with-xhprof"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#profiling-with-xhprof"}},[t._v("#")]),t._v(" Profiling with XHProf")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/phacility/xhprof",target:"_blank",rel:"noopener noreferrer"}},[t._v("XHProf"),a("OutboundLink")],1),t._v(" is a PHP profiler originally written by Facebook, to provide a more lightweight alternative to XDebug.")]),t._v(" "),a("p",[t._v("After installing the "),a("code",[t._v("xhprof")]),t._v(" PHP module, profiling can be enabled / disabled from PHP code:")]),t._v(" "),a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("xhprof_enable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doSlowOperation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$profile_data")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("xhprof_disable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("p",[t._v("The returned array will contain data about the number of calls, CPU time and memory usage of each function that has been accessed inside "),a("code",[t._v("doSlowOperation()")]),t._v(".")]),t._v(" "),a("p",[a("code",[t._v("xhprof_sample_enable()")]),t._v("/"),a("code",[t._v("xhprof_sample_disable()")]),t._v(" can be used as a more lightweight option that will only log profiling information for a fraction of requests (and in a different format).")]),t._v(" "),a("p",[t._v("XHProf has some (mostly undocumented) helper functions to display the data ("),a("a",{attrs:{href:"https://github.com/phacility/xhprof/blob/master/examples/sample.php",target:"_blank",rel:"noopener noreferrer"}},[t._v("see example"),a("OutboundLink")],1),t._v("), or you can use other tools to visualize it (the platform.sh blog "),a("a",{attrs:{href:"https://platform.sh/2015/07/29/flamegraphs/",target:"_blank",rel:"noopener noreferrer"}},[t._v("has an example"),a("OutboundLink")],1),t._v(").")])])}),[],!1,null,null,null);e.default=n.exports}}]);