(window.webpackJsonp=window.webpackJsonp||[]).push([[1600],{2009:function(t,a,s){"use strict";s.r(a);var e=s(31),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"java-pitfalls-threads-and-concurrency"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#java-pitfalls-threads-and-concurrency"}},[t._v("#")]),t._v(" Java Pitfalls - Threads and Concurrency")]),t._v(" "),s("h2",{attrs:{id:"pitfall-incorrect-use-of-wait-notify"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pitfall-incorrect-use-of-wait-notify"}},[t._v("#")]),t._v(" Pitfall: incorrect use of wait() / notify()")]),t._v(" "),s("p",[t._v("The methods "),s("code",[t._v("object.wait()")]),t._v(", "),s("code",[t._v("object.notify()")]),t._v(" and "),s("code",[t._v("object.notifyAll()")]),t._v(" are meant to be used in a very specific way.  (see "),s("a",{attrs:{href:"http://stackoverflow.com/documentation/java/5409/wait-notify#t=20160811161648303307",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://stackoverflow.com/documentation/java/5409/wait-notify#t=20160811161648303307"),s("OutboundLink")],1),t._v(" )")]),t._v(" "),s("h3",{attrs:{id:"the-lost-notification-problem"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-lost-notification-problem"}},[t._v("#")]),t._v(' The "Lost Notification" problem')]),t._v(" "),s("p",[t._v("One common beginner mistake is to unconditionally call "),s("code",[t._v("object.wait()")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" lock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("myConsumer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("synchronized")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        lock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wait")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// DON'T DO THIS!!")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("doSomething")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("The reason this is wrong is that it depends on some other thread to call "),s("code",[t._v("lock.notify()")]),t._v(" or "),s("code",[t._v("lock.notifyAll()")]),t._v(", but nothing guarantees that the other thread did not make that call "),s("strong",[t._v("before")]),t._v(" the consumer thread called "),s("code",[t._v("lock.wait()")]),t._v(".")]),t._v(" "),s("p",[s("code",[t._v("lock.notify()")]),t._v(" and "),s("code",[t._v("lock.notifyAll()")]),t._v(" do not do anything at all if some other thread is not "),s("strong",[t._v("already")]),t._v(" waiting for the notification.  The thread that calls "),s("code",[t._v("myConsumer()")]),t._v(" in this example will hang forever if it is too late to catch the notification.")]),t._v(" "),s("h3",{attrs:{id:"the-illegal-monitor-state-bug"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-illegal-monitor-state-bug"}},[t._v("#")]),t._v(' The "Illegal Monitor State" bug')]),t._v(" "),s("p",[t._v("If you call "),s("code",[t._v("wait()")]),t._v(" or "),s("code",[t._v("notify()")]),t._v(" on an object without holding the lock, then the JVM will throw "),s("code",[t._v("IllegalMonitorStateException")]),t._v(".")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("myConsumer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    lock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wait")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// throws exception")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("consume")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("myProducer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("produce")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    lock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("notify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// throws exception")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("(The design for "),s("code",[t._v("wait()")]),t._v(" / "),s("code",[t._v("notify()")]),t._v(" requires that the lock is held because this is necessary to avoid systemic race conditions.  If it was possible to call "),s("code",[t._v("wait()")]),t._v(" or "),s("code",[t._v("notify()")]),t._v(" without locking, then it would be impossible to implement the primary use-case for these primitives: waiting for a condition to occur.)")]),t._v(" "),s("h3",{attrs:{id:"wait-notify-is-too-low-level"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#wait-notify-is-too-low-level"}},[t._v("#")]),t._v(" Wait / notify is too low-level")]),t._v(" "),s("p",[t._v("The "),s("strong",[t._v("best")]),t._v(" way to avoid problems with "),s("code",[t._v("wait()")]),t._v(" and "),s("code",[t._v("notify()")]),t._v(" is to not use them.  Most synchronization problems can be solved by using the higher-level synchronization objects (queues, barriers, semaphores, etc.) that are available in the "),s("code",[t._v("java.utils.concurrent")]),t._v(" package.")]),t._v(" "),s("h2",{attrs:{id:"pitfall-extending-java-lang-thread"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pitfall-extending-java-lang-thread"}},[t._v("#")]),t._v(" Pitfall - Extending 'java.lang.Thread'")]),t._v(" "),s("p",[t._v("The javadoc for the "),s("code",[t._v("Thread")]),t._v(" class shows two ways to define and use a thread:")]),t._v(" "),s("p",[t._v("Using a custom thread class:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("\nclass PrimeThread extends Thread {\n     long minPrime;\n     PrimeThread(long minPrime) {\n         this.minPrime = minPrime;\n     }\n\n     public void run() {\n         // compute primes larger than minPrime\n          . . .\n     }\n }\n\n PrimeThread p = new PrimeThread(143);\n p.start();\n\n")])])]),s("p",[t._v("Using a "),s("code",[t._v("Runnable")]),t._v(":")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("\nclass PrimeRun implements Runnable {\n     long minPrime;\n     PrimeRun(long minPrime) {\n         this.minPrime = minPrime;\n     }\n\n     public void run() {\n         // compute primes larger than minPrime\n          . . .\n     }\n }\n\n PrimeRun p = new PrimeRun(143);\n new Thread(p).start();\n\n")])])]),s("p",[t._v("(Source: "),s("a",{attrs:{href:"http://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("java.lang.Thread")]),t._v(" javadoc"),s("OutboundLink")],1),t._v(".)")]),t._v(" "),s("p",[t._v("The custom thread class approach works, but it has a few problems:")]),t._v(" "),s("li",[t._v("\nIt is awkward to use `PrimeThread` in a context that uses a classic thread pool, an executor, or the ForkJoin framework.  (It is not impossible, because `PrimeThread` indirectly implements `Runnable`, but using a custom `Thread` class as a `Runnable` is certainly clumsy, and may not be viable ... depending on other aspects of the class.)\n")]),t._v(" "),s("li",[t._v('\nThere is more opportunity for mistakes in other methods.  For example, if you declared a `PrimeThread.start()` without delegating to `Thread.start()`, you would end up with a "thread" that ran on the current thread.\n')]),t._v(" "),s("p",[t._v("The approach of putting the thread logic into a "),s("code",[t._v("Runnable")]),t._v(" avoids these problems.  Indeed, if you use an anonymous class (Java 1.1 onwards) to implement the "),s("code",[t._v("Runnable")]),t._v(" the result is more succinct, and more readable than the examples above.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("\nfinal long minPrime = ...\n new Thread(new Runnable() {\n     public void run() {\n         // compute primes larger than minPrime\n          . . .\n     }\n }.start();\n\n")])])]),s("p",[t._v("With a lambda expression (Java 8 onwards), the above example would become even more elegant:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("\nfinal long minPrime = ...\n new Thread(() -> {\n    // compute primes larger than minPrime\n     . . .\n }).start();\n\n")])])]),s("h2",{attrs:{id:"pitfall-too-many-threads-makes-an-application-slower"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pitfall-too-many-threads-makes-an-application-slower"}},[t._v("#")]),t._v(" Pitfall - Too many threads makes an application slower.")]),t._v(" "),s("p",[t._v("A lot of people who are new to multi-threading think that using threads automatically make an application go faster. In fact, it is a lot more complicated than that.  But one thing that we can state with certainty is that for any computer there is a limit on the number of threads that can be run at the same time:")]),t._v(" "),s("ul",[s("li",[t._v("A computer has a fixed number of "),s("strong",[t._v("cores")]),t._v(" (or "),s("strong",[t._v("hyperthreads")]),t._v(").")]),t._v(" "),s("li",[t._v("A Java thread has to be "),s("strong",[t._v("scheduled")]),t._v(" to a core or hyperthread in order to run.")]),t._v(" "),s("li",[t._v("If there are more runnable Java threads than (available) cores / hyperthreads, some of them must wait.")])]),t._v(" "),s("p",[t._v("This tells us that simply creating more and more Java threads "),s("strong",[t._v("cannot")]),t._v(" make the application go faster and faster.  But there are other considerations as well:")]),t._v(" "),s("li",[t._v("\nEach thread requires an off-heap memory region for its thread stack.  The typical (default) thread stack size is 512Kbytes or 1Mbytes.  If you have a significant number of threads, the memory usage can be significant.\n")]),t._v(" "),s("li",[t._v("\nEach active thread will refer to a number of objects in the heap.  That increases the working set of **reachable** objects, which impacts on garbage collection and on physical memory usage.\n")]),t._v(" "),s("li",[t._v("\nThe overheads of switching between threads is non-trivial.  It typically entails a switch into the OS kernel space to make a thread scheduling decision.\n")]),t._v(" "),s("li",[t._v("\nThe overheads of thread synchronization and inter-thread signaling (e.g. wait(), notify() / notifyAll) **can be** significant.\n")]),t._v(" "),s("p",[t._v('Depending on the details of your application, these factors generally mean that there is a "sweet spot" for the number of threads.  Beyond that, adding more threads gives minimal performance improvement, and can make performance worse.')]),t._v(" "),s("p",[t._v("If your application create for each new task, then an unexpected increase in the workload (e.g. a high request rate) can lead to catastrophic behavior.")]),t._v(" "),s("p",[t._v("A better way to deal with this is to use bounded thread pool whose size you can control (statically or dynamically).  When there is too much work to do, the application needs to queue the requests.  If you use an "),s("code",[t._v("ExecutorService")]),t._v(", it will take care of the thread pool management and task queuing.")]),t._v(" "),s("h2",{attrs:{id:"pitfall-thread-creation-is-relatively-expensive"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pitfall-thread-creation-is-relatively-expensive"}},[t._v("#")]),t._v(" Pitfall - Thread creation is relatively expensive")]),t._v(" "),s("p",[t._v("Consider these two micro-benchmarks:")]),t._v(" "),s("p",[t._v("The first benchmark simply creates, starts and joins threads.  The thread's "),s("code",[t._v("Runnable")]),t._v(" does no work.")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" start "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nanoTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100_000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Runnable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" end "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nanoTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("end "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100_000.0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n$ java "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("34627.91355")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33596.66021")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33661.19084")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33699.44895")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33603.097")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33759.3928")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33671.5719")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33619.46809")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33679.92508")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33500.32862")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33409.70188")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33475.70541")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33925.87848")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33672.89529")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("C")]),t._v("\n\n")])])]),s("p",[t._v("On a typical modern PC running Linux with 64bit Java 8 u101, this benchmark shows an average time taken to create, start and join thread of between 33.6 and 33.9 microseconds.")]),t._v(" "),s("p",[t._v("The second benchmark does the equivalent to the first but using an "),s("code",[t._v("ExecutorService")]),t._v(" to submit tasks and a "),s("code",[t._v("Future")]),t._v(" to rendezvous with the end of the task.")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("concurrent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExecutorTest")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExecutorService")]),t._v(" exec "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Executors")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("newCachedThreadPool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" start "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nanoTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100_000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Future")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" future "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" exec"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("submit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Runnable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                future"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" end "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nanoTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("end "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100_000.0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n$ java "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExecutorTest")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6714.66053")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5418.24901")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5571.65213")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5307.83651")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5294.44132")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5370.69978")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5291.83493")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5386.23932")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5384.06842")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5293.14126")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5445.17405")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5389.70685")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("C")]),t._v("\n\n")])])]),s("p",[t._v("As you can see, the averages are between 5.3 and 5.6 microseconds.")]),t._v(" "),s("p",[t._v("While the actual times will depend on a variety of factors, the difference between these two results is significant.  It is clearly faster to use a thread pool to recycle threads than it is to create new threads.")]),t._v(" "),s("h2",{attrs:{id:"pitfall-shared-variables-require-proper-synchronization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pitfall-shared-variables-require-proper-synchronization"}},[t._v("#")]),t._v(" Pitfall: Shared variables require proper synchronization")]),t._v(" "),s("p",[t._v("Consider this example:")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Runnable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" stop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" counter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("stop"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            counter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" counter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Counted "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" counter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),t._v(" tt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Create and start child thread")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        tt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Tell child thread to stop.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("The intent of this program is intended to start a thread, let it run for 1000 milliseconds, and then cause it to stop by setting the "),s("code",[t._v("stop")]),t._v(" flag.")]),t._v(" "),s("h3",{attrs:{id:"will-it-work-as-intended"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#will-it-work-as-intended"}},[t._v("#")]),t._v(" Will it work as intended?")]),t._v(" "),s("p",[t._v("Maybe yes, may be no.")]),t._v(" "),s("p",[t._v("An application does not necessarily stop when the "),s("code",[t._v("main")]),t._v(" method returns.  If another thread has been created, and that thread has not been marked as a daemon thread, then the application will continue to run after the main thread has ended.  In this example, that means that the application will keep running until child thread ends.  That should happens when "),s("code",[t._v("tt.stop")]),t._v(" is set to "),s("code",[t._v("true")]),t._v(".")]),t._v(" "),s("p",[t._v("But that is actually not strictly true.  In fact, the child thread will stop after it has "),s("strong",[t._v("observed")]),t._v(" "),s("code",[t._v("stop")]),t._v(" with the value "),s("code",[t._v("true")]),t._v(".   Will that happen?  Maybe yes, maybe no.")]),t._v(" "),s("p",[t._v("The Java Language Specification "),s("strong",[t._v("guarantees")]),t._v(" that memory reads and writes made in a thread are visible to that thread, as per the order of the statements in the source code.  However, in general, this is NOT guaranteed when one thread writes and another thread (subsequently) reads.  To get guaranteed visibility, there needs to be a chain of "),s("strong",[t._v("happens-before")]),t._v(" relations between a write and a subsequent read.  In the example above, there is no such chain for the update to the "),s("code",[t._v("stop")]),t._v(" flag, and therefore it is not guaranteed that the child thread will see "),s("code",[t._v("stop")]),t._v(" change to "),s("code",[t._v("true")]),t._v(".")]),t._v(" "),s("p",[s("strong",[t._v("(Note to authors: There should be a separate Topic on the Java Memory Model to go into the deep technical details.)")])]),t._v(" "),s("h3",{attrs:{id:"how-do-we-fix-the-problem"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#how-do-we-fix-the-problem"}},[t._v("#")]),t._v(" How do we fix the problem?")]),t._v(" "),s("p",[t._v("In this case, there are two simple ways to ensure that the "),s("code",[t._v("stop")]),t._v(" update is visible:")]),t._v(" "),s("li",[t._v("\nDeclare `stop` to be `volatile`; i.e.\n"),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" stop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),s("p",[t._v("For a "),s("code",[t._v("volatile")]),t._v(" variable, the JLS specifies that there is a "),s("strong",[t._v("happens-before")]),t._v(" relation between a write by one thread and a later read by a second thread.\n")])]),t._v(" "),s("li",[t._v("\nUse a mutex to synchronize as follows:\n")]),s("p"),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Runnable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" stop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" counter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            synchronize "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stop"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            counter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" counter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Counted "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" counter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),t._v(" tt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadTest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Create and start child thread")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        synchronize "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            tt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Tell child thread to stop.")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("In addition to ensuring that there is mutual exclusion, the JLS specifies that there is a "),s("strong",[t._v("happens-before")]),t._v(" relation between the releasing a mutex in one thread and gaining the same mutex in a second thread.")]),t._v(" "),s("h3",{attrs:{id:"but-isn-t-assignment-atomic"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#but-isn-t-assignment-atomic"}},[t._v("#")]),t._v(" But isn't assignment atomic?")]),t._v(" "),s("p",[t._v("Yes it is!")]),t._v(" "),s("p",[t._v("However, that fact does not mean that the effects of update will be visible simultaneously to all threads.  Only a proper chain of "),s("strong",[t._v("happens-before")]),t._v(" relations will guarantee that.")]),t._v(" "),s("h3",{attrs:{id:"why-did-they-do-this"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#why-did-they-do-this"}},[t._v("#")]),t._v(" Why did they do this?")]),t._v(" "),s("p",[t._v("Programmers doing multi-threaded programming in Java for the first time find the Memory Model is challenging.  Programs behave in an unintuitive way because the natural expectation is that writes are visible uniformly.  So why the Java designers design the Memory Model this way.")]),t._v(" "),s("p",[t._v("It actually comes down to a compromise between performance and ease of use (for the programmer).")]),t._v(" "),s("p",[t._v("A modern computer architecture consists of multiple processors (cores) with individual register sets.  Main memory is accessible either to all processors or to groups of processors.  Another property of modern computer hardware is that access to registers is typically orders of magnitude faster to access than access to main memory.  As the number of cores scales up, it is easy to see that reading and writing to main memory can become a system's main performance bottleneck.")]),t._v(" "),s("p",[t._v("This mismatch is addressed by implementing one or more levels of memory caching between the processor cores and main memory.  Each core access memory cells via its cache.  Normally, a main memory read only happens when there is a cache miss, and a main memory write only happens when a cache line needs to be flushed.  For an application where each core's working set of memory locations will fit into its cache, the core speed is no longer limited by main memory speed / bandwidth.")]),t._v(" "),s("p",[t._v('But that gives us a new problem when multiple cores are reading and writing shared variables.  The latest version of a variable may sit in one core\'s cache.  Unless the that core flushes the cache line to main memory, AND other cores invalidate their cached copy of older versions, some of them are liable to see stale versions of the variable.  But if the caches were flushed to memory each time there is a cache write ("just in case" there was a read by another core) that would consume main memory bandwidth unnecessarily.')]),t._v(" "),s("p",[t._v("The standard solution used at the hardware instruction set level is to provide instructions for cache invalidation and a cache write-through, and leave it to the compiler to decide when to use them.")]),t._v(" "),s("p",[t._v("Returning to Java. the Memory Model is designed so that the Java compilers are not required to issue cache invalidation and write-through instructions where they are not really needed.  The assumption is that the programmer will use an appropriate synchronization mechanism (e.g. primitive mutexes, "),s("code",[t._v("volatile")]),t._v(", higher-level concurrency classes and so on) to indicate that it needs memory visibility.  In the absence of a "),s("strong",[t._v("happens-before")]),t._v(" relation, the Java compilers are free to "),s("strong",[t._v("assume")]),t._v(" that no cache operations (or similar) are required.")]),t._v(" "),s("p",[t._v("This has significant performance advantages for multi-threaded applications, but the downside is that writing correct multi-threaded applications is not a simple matter.  The programmer "),s("strong",[t._v("does")]),t._v(" have to understand what he or she is doing.")]),t._v(" "),s("h3",{attrs:{id:"why-can-t-i-reproduce-this"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#why-can-t-i-reproduce-this"}},[t._v("#")]),t._v(" Why can't I reproduce this?")]),t._v(" "),s("p",[t._v("There are a number of reasons why problems like this are difficult to reproduce:")]),t._v(" "),s("li",[t._v("\nAs explained above, the consequence of not dealing with memory visibility issues problems properly is **typically** that your compiled application does not handle the memory caches correctly.  However, as we alluded to above, memory caches often get flushed anyway.\n")]),t._v(" "),s("li",[t._v("\nWhen you change the hardware platform, the characteristics of the memory caches may change.  This can lead to different behavior if your application does not synchronize correctly.\n")]),t._v(" "),s("li",[t._v("\nYou may be observing the effects of **serendipitous** synchronization.  For example, if you add traceprints, their is typically some synchronization happening behind the scenes in the I/O streams that causes cache flushes.  So adding traceprints **often** causes the application to behave differently.\n")]),t._v(" "),s("li",[t._v("\nRunning an application under a debugger causes it to be compiled differently by the JIT compiler.  Breakpoints and single stepping exacerbate this.  These effects will often change the way an application behaves.\n")]),t._v(" "),s("p",[t._v("These things make bugs that are due to inadequate synchronization particularly difficult to solve.")])])}),[],!1,null,null,null);a.default=n.exports}}]);