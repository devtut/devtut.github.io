(window.webpackJsonp=window.webpackJsonp||[]).push([[1006],{1352:function(a,t,s){"use strict";s.r(t);var n=s(19),e=Object(n.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"memory-management"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#memory-management"}},[a._v("#")]),a._v(" Memory management")]),a._v(" "),s("h2",{attrs:{id:"use-safehandle-when-wrapping-unmanaged-resources"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#use-safehandle-when-wrapping-unmanaged-resources"}},[a._v("#")]),a._v(" Use SafeHandle when wrapping unmanaged resources")]),a._v(" "),s("p",[a._v("When writing wrappers for unmanaged resources, you should subclass "),s("code",[a._v("SafeHandle")]),a._v(" rather than trying to implement "),s("code",[a._v("IDisposable")]),a._v(" and a finalizer yourself. Your "),s("code",[a._v("SafeHandle")]),a._v(" subclass should be as small and simple as possible to minimize the chance of a handle leak. This likely means that your SafeHandle implementation would an internal implementation detail of a class which wraps it to provide a usable API. This class ensures that, even if a program leaks your "),s("code",[a._v("SafeHandle")]),a._v(" instance, your unmanaged handle is released.")]),a._v(" "),s("div",{staticClass:"language-dotnet extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dotnet"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("using")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("System"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Runtime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("InteropServices")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MyHandle")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token type-list"}},[s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SafeHandle")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("override")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("bool")])]),a._v(" IsInvalid "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=>")]),a._v(" handle "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),a._v(" IntPtr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Zero"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("MyHandle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("base")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("IntPtr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Zero"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("MyHandle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")])]),a._v(" length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("SetHandle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Marshal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("AllocHGlobal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("protected")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("override")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("bool")])]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ReleaseHandle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        Marshal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("FreeHGlobal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("handle"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n")])])]),s("p",[a._v("Disclaimer: This example is an attempt to show how to guard a managed resource with "),s("code",[a._v("SafeHandle")]),a._v(" which implements "),s("code",[a._v("IDisposable")]),a._v(" for you and configures finalizers appropriately. It is very contrived and likely pointless to allocate a chunk of memory in this manner.")]),a._v(" "),s("h2",{attrs:{id:"unmanaged-resources"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#unmanaged-resources"}},[a._v("#")]),a._v(" Unmanaged Resources")]),a._v(" "),s("p",[a._v("When we talk about the GC and the \"heap\", we're really talking about what's called the "),s("strong",[a._v("managed heap")]),a._v(". Objects on the "),s("strong",[a._v("managed heap")]),a._v(" can access resources not on the managed heap, for example, when writing to or reading from a file. Unexpected behavior can occur when, a file is opened for reading and then an exception occurs, preventing the file handle from closing as it normally would. For this reason, .NET requires that unmanaged resources implement the "),s("code",[a._v("IDisposable")]),a._v(" interface. This interface has a single method called "),s("code",[a._v("Dispose")]),a._v(" with no parameters:")]),a._v(" "),s("div",{staticClass:"language-dotnet extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dotnet"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("interface")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("IDisposable")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("Dispose")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" \n\n")])])]),s("p",[a._v("When handling unmanaged resources, you should make sure that they are properly disposed. You can do this by explicitly calling "),s("code",[a._v("Dispose()")]),a._v(" in a "),s("code",[a._v("finally")]),a._v(" block, or with a "),s("code",[a._v("using")]),a._v(" statement.")]),a._v(" "),s("div",{staticClass:"language-dotnet extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dotnet"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("StreamReader")]),a._v(" sr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" \n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("string")])]),a._v(" textFromFile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("string")])]),a._v(" filename "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"SomeFile.txt"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("try")]),a._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    sr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[a._v("StreamReader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    textFromFile "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" sr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ReadToEnd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("finally")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("sr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" sr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("Dispose")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n")])])]),s("p",[a._v("or")]),a._v(" "),s("div",{staticClass:"language-dotnet extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dotnet"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("string")])]),a._v(" textFromFile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("string")])]),a._v(" filename "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"SomeFile.txt"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("using")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("StreamReader")]),a._v(" sr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[a._v("Streamreader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    textFromFile "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" sr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ReadToEnd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n")])])]),s("p",[a._v("The latter is the preferred method, and is automatically expanded to the former during compilation.")]),a._v(" "),s("h4",{attrs:{id:"remarks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#remarks"}},[a._v("#")]),a._v(" Remarks")]),a._v(" "),s("p",[a._v("Performance-critical applications in managed .NET applications can be severely impacted by the GC. When the GC runs, all other threads are suspended until it completes. For this reason, it is recommended to carefully evaluate the GC processes and determine how to minimize when it runs.")])])}),[],!1,null,null,null);t.default=e.exports}}]);