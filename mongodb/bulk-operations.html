<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB - Bulk Operations</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Converting a field to another type and updating the entire collection in Bulk">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="MongoDB - Bulk Operations">
    <meta property="og:description" content="Converting a field to another type and updating the entire collection in Bulk">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/mongodb/bulk-operations.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="MongoDB - Bulk Operations">
    <meta name="twitter:description" content="Converting a field to another type and updating the entire collection in Bulk">
    <meta name="twitter:url" content="/mongodb/bulk-operations.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/1949.700c5b46.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MongoDB</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mongodb/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/mongodb/getting-started-with-mongodb.html" class="sidebar-link">Getting started with MongoDB</a></li><li><a href="/mongodb/crud-operation.html" class="sidebar-link">CRUD Operation</a></li><li><a href="/mongodb/getting-database-information.html" class="sidebar-link">Getting database information</a></li><li><a href="/mongodb/querying-for-data-getting-started.html" class="sidebar-link">Querying for Data ( Getting Started )</a></li><li><a href="/mongodb/update-operators.html" class="sidebar-link">Update Operators</a></li><li><a href="/mongodb/upserts-and-inserts.html" class="sidebar-link">Upserts and Inserts</a></li><li><a href="/mongodb/collections.html" class="sidebar-link">Collections</a></li><li><a href="/mongodb/mongodb-aggregation.html" class="sidebar-link">MongoDB Aggregation</a></li><li><a href="/mongodb/aggregation.html" class="sidebar-link">Aggregation</a></li><li><a href="/mongodb/indexes.html" class="sidebar-link">Indexes</a></li><li><a href="/mongodb/bulk-operations.html" aria-current="page" class="active sidebar-link">Bulk Operations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mongodb/bulk-operations.html#converting-a-field-to-another-type-and-updating-the-entire-collection-in-bulk" class="sidebar-link">Converting a field to another type and updating the entire collection in Bulk</a></li></ul></li><li><a href="/mongodb/2dsphere-index.html" class="sidebar-link">2dsphere Index</a></li><li><a href="/mongodb/pluggable-storage-engines.html" class="sidebar-link">Pluggable Storage Engines</a></li><li><a href="/mongodb/java-driver.html" class="sidebar-link">Java Driver</a></li><li><a href="/mongodb/python-driver.html" class="sidebar-link">Python Driver</a></li><li><a href="/mongodb/mongo-as-shards.html" class="sidebar-link">Mongo as Shards</a></li><li><a href="/mongodb/replication.html" class="sidebar-link">Replication</a></li><li><a href="/mongodb/mongo-as-a-replica-set.html" class="sidebar-link">Mongo as a Replica Set</a></li><li><a href="/mongodb/mongodb-configure-a-replicaset-to-support-tls-ssl.html" class="sidebar-link">MongoDB - Configure a ReplicaSet to support TLS/SSL</a></li><li><a href="/mongodb/authentication-mechanisms-in-mongodb.html" class="sidebar-link">Authentication Mechanisms in MongoDB</a></li><li><a href="/mongodb/mongodb-authorization-model.html" class="sidebar-link">MongoDB Authorization Model</a></li><li><a href="/mongodb/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/mongodb/backing-up-and-restoring-data.html" class="sidebar-link">Backing up and Restoring Data</a></li><li><a href="/mongodb/upgrading-mongodb-version.html" class="sidebar-link">Upgrading MongoDB version</a></li><li><a href="/mongodb/backing-up-and-restoring-data.html" class="sidebar-link">Backing up and Restoring Data</a></li><li><a href="/mongodb/mongo-as-a-replica-set.html" class="sidebar-link">Mongo as a Replica Set</a></li><li><a href="/mongodb/managing-mongodb.html" class="sidebar-link">Managing MongoDB</a></li><li><a href="/mongodb/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="bulk-operations"><a href="#bulk-operations" class="header-anchor">#</a> Bulk Operations</h1> <h2 id="converting-a-field-to-another-type-and-updating-the-entire-collection-in-bulk"><a href="#converting-a-field-to-another-type-and-updating-the-entire-collection-in-bulk" class="header-anchor">#</a> Converting a field to another type and updating the entire collection in Bulk</h2> <p>Usually the case when one wants to change a field type to another, for instance the original collection may have &quot;numerical&quot; or &quot;date&quot; fields saved as strings:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> <span class="token string">&quot;57871&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1986-08-21&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> <span class="token string">&quot;48974&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1990-11-04&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>The objective would be to update a humongous collection like the above to</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> <span class="token number">57871</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">&quot;1986-08-21T00:00:00.000Z&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> <span class="token number">48974</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">&quot;1990-11-04T00:00:00.000Z&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>For relatively small data, one can achieve the above by iterating the collection using a <strong><a href="https://docs.mongodb.com/manual/reference/method/cursor.snapshot/" target="_blank" rel="noopener noreferrer"><code>snapshot</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> with the cursor's <strong><a href="http://**%5B%60forEach()%60%5D%5B2%5D**" target="_blank" rel="noopener noreferrer"><code>forEach()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> method and updating each document as follows:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$exists&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;$type&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$exists&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;$type&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">var</span> newSalary <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        newDob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>dob<span class="token punctuation">)</span><span class="token punctuation">;</span>        
    db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> doc<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;$set&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> newSalary<span class="token punctuation">,</span> <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> newDob <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Whilst this is optimal for small collections, performance with large collections is greatly reduced since looping through a large dataset and sending each update operation per request to the server incurs a computational penalty.</p> <p>The <strong><a href="https://docs.mongodb.com/manual/reference/method/Bulk/" target="_blank" rel="noopener noreferrer"><code>Bulk()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> API comes to the rescue and greatly improves performance since write operations are sent to the server only once in bulk. Efficiency is achieved since the method does not send every write request to the server (as with the current update statement within the <strong><a href="https://docs.mongodb.com/manual/reference/method/cursor.forEach/" target="_blank" rel="noopener noreferrer"><code>forEach()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> loop) but just once in every 1000 requests, thus making updates more efficient and quicker than currently is.</p> <p>Using the same concept above with the <strong><a href="https://docs.mongodb.com/manual/reference/method/cursor.forEach/" target="_blank" rel="noopener noreferrer"><code>forEach()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> loop to create the batches, we can update the collection in bulk as follows. In this demonstration the <strong><a href="https://docs.mongodb.com/manual/reference/method/Bulk/" target="_blank" rel="noopener noreferrer"><code>Bulk()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> API available in MongoDB versions <code>&gt;= 2.6</code> and <code>&lt; 3.2</code> uses the <strong><a href="https://docs.mongodb.com/manual/reference/method/db.collection.initializeUnorderedBulkOp/#db.collection.initializeUnorderedBulkOp" target="_blank" rel="noopener noreferrer"><code>initializeUnorderedBulkOp()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> method to execute in parallel, as well as in a nondeterministic order, the write operations in the batches.</p> <p>It updates all the documents in the clients collection by changing the <code>salary</code> and <code>dob</code> fields to <code>numerical</code> and <code>datetime</code> values respectively:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> bulk <span class="token operator">=</span> db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">initializeUnorderedBulkOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// counter to keep track of the batch update size</span>

db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$exists&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;$type&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$exists&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;$type&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">var</span> newSalary <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        newDob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>dob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulk<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> doc<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        <span class="token string">&quot;$set&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> newSalary<span class="token punctuation">,</span> <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> newDob <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    counter<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// increment counter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bulk<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Execute per 1000 operations and re-initialize every 1000 update statements</span>
        bulk <span class="token operator">=</span> db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">initializeUnorderedBulkOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>The next example applies to the new MongoDB version <code>3.2</code> which has since deprecated the <strong><a href="https://docs.mongodb.com/manual/reference/method/Bulk/" target="_blank" rel="noopener noreferrer"><code>Bulk()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> API and provided a newer set of apis using <strong><a href="https://docs.mongodb.org/v3.2/reference/method/db.collection.bulkWrite/#db.collection.bulkWrite" target="_blank" rel="noopener noreferrer"><code>bulkWrite()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>.</p> <p>It uses the same cursors as above but creates the arrays with the bulk operations using the same <strong><a href="https://docs.mongodb.com/manual/reference/method/cursor.forEach/" target="_blank" rel="noopener noreferrer"><code>forEach()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> cursor method to push each bulk write document to the array. Because write commands can accept no more than 1000 operations, there's need to group operations to have at most 1000 operations and re-intialise the array when the loop hits the 1000 iteration:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> cursor <span class="token operator">=</span> db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$exists&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;$type&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$exists&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;$type&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    bulkUpdateOps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

cursor<span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">var</span> newSalary <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        newDob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>dob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkUpdateOps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        <span class="token string">&quot;updateOne&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> doc<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;update&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$set&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;salary&quot;</span><span class="token operator">:</span> newSalary<span class="token punctuation">,</span> <span class="token string">&quot;dob&quot;</span><span class="token operator">:</span> newDob <span class="token punctuation">}</span> <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bulkUpdateOps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">bulkWrite</span><span class="token punctuation">(</span>bulkUpdateOps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkUpdateOps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         

<span class="token keyword">if</span> <span class="token punctuation">(</span>bulkUpdateOps<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">bulkWrite</span><span class="token punctuation">(</span>bulkUpdateOps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

</code></pre></div><h4 id="remarks"><a href="#remarks" class="header-anchor">#</a> Remarks</h4> <p>Constructing a list of write operations to perform in bulk for a single collection.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/mongodb/bulk-operations.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mongodb/indexes.html" class="prev">
        Indexes
      </a></span> <span class="next"><a href="/mongodb/2dsphere-index.html">
        2dsphere Index
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/1949.700c5b46.js" defer></script>
  </body>
</html>
