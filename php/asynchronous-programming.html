<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PHP - Asynchronous programming</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Advantages of Generators, Using Icicle event loop, Spawning non-blocking processes with proc_open(), Using Amp event loop, Reading serial port with Event and DIO, HTTP Client Based on Event Extension, HTTP Client Based on Ev Extension">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="PHP - Asynchronous programming">
    <meta property="og:description" content="Advantages of Generators, Using Icicle event loop, Spawning non-blocking processes with proc_open(), Using Amp event loop, Reading serial port with Event and DIO, HTTP Client Based on Event Extension, HTTP Client Based on Ev Extension">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/php/asynchronous-programming.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="PHP - Asynchronous programming">
    <meta name="twitter:description" content="Advantages of Generators, Using Icicle event loop, Spawning non-blocking processes with proc_open(), Using Amp event loop, Reading serial port with Event and DIO, HTTP Client Based on Event Extension, HTTP Client Based on Ev Extension">
    <meta name="twitter:url" content="/php/asynchronous-programming.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/2423.26f85034.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>PHP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/php/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/php/installing-a-php-environment-on-windows.html" class="sidebar-link">Installing a PHP environment on Windows</a></li><li><a href="/php/installing-on-linux-unix-environments.html" class="sidebar-link">Installing on Linux/Unix Environments</a></li><li><a href="/php/getting-started-with-php.html" class="sidebar-link">Getting started with PHP</a></li><li><a href="/php/variables.html" class="sidebar-link">Variables</a></li><li><a href="/php/variable-scope.html" class="sidebar-link">Variable Scope</a></li><li><a href="/php/superglobal-variables-php.html" class="sidebar-link">Superglobal Variables PHP</a></li><li><a href="/php/outputting-the-value-of-a-variable.html" class="sidebar-link">Outputting the Value of a Variable</a></li><li><a href="/php/constants.html" class="sidebar-link">Constants</a></li><li><a href="/php/magic-constants.html" class="sidebar-link">Magic Constants</a></li><li><a href="/php/comments.html" class="sidebar-link">Comments</a></li><li><a href="/php/types.html" class="sidebar-link">Types</a></li><li><a href="/php/operators.html" class="sidebar-link">Operators</a></li><li><a href="/php/references.html" class="sidebar-link">References</a></li><li><a href="/php/arrays.html" class="sidebar-link">Arrays</a></li><li><a href="/php/array-iteration.html" class="sidebar-link">Array iteration</a></li><li><a href="/php/executing-upon-an-array.html" class="sidebar-link">Executing Upon an Array</a></li><li><a href="/php/manipulating-an-array.html" class="sidebar-link">Manipulating an Array</a></li><li><a href="/php/processing-multiple-arrays-together.html" class="sidebar-link">Processing Multiple Arrays Together</a></li><li><a href="/php/datetime-class.html" class="sidebar-link">Datetime Class</a></li><li><a href="/php/working-with-dates-and-time.html" class="sidebar-link">Working with Dates and Time</a></li><li><a href="/php/control-structures.html" class="sidebar-link">Control Structures</a></li><li><a href="/php/loops.html" class="sidebar-link">Loops</a></li><li><a href="/php/functions.html" class="sidebar-link">Functions</a></li><li><a href="/php/functional-programming.html" class="sidebar-link">Functional Programming</a></li><li><a href="/php/alternative-syntax-for-control-structures.html" class="sidebar-link">Alternative Syntax for Control Structures</a></li><li><a href="/php/string-formatting.html" class="sidebar-link">String formatting</a></li><li><a href="/php/string-parsing.html" class="sidebar-link">String Parsing</a></li><li><a href="/php/classes-and-objects.html" class="sidebar-link">Classes and Objects</a></li><li><a href="/php/namespaces.html" class="sidebar-link">Namespaces</a></li><li><a href="/php/sessions.html" class="sidebar-link">Sessions</a></li><li><a href="/php/cookies.html" class="sidebar-link">Cookies</a></li><li><a href="/php/output-buffering.html" class="sidebar-link">Output Buffering</a></li><li><a href="/php/json.html" class="sidebar-link">JSON</a></li><li><a href="/php/soap-client.html" class="sidebar-link">SOAP Client</a></li><li><a href="/php/using-curl-in-php.html" class="sidebar-link">Using cURL in PHP</a></li><li><a href="/php/reflection.html" class="sidebar-link">Reflection</a></li><li><a href="/php/dependency-injection.html" class="sidebar-link">Dependency Injection</a></li><li><a href="/php/xml.html" class="sidebar-link">XML</a></li><li><a href="/php/simplexml.html" class="sidebar-link">SimpleXML</a></li><li><a href="/php/parsing-html.html" class="sidebar-link">Parsing HTML</a></li><li><a href="/php/regular-expressions-regexp-pcre.html" class="sidebar-link">Regular Expressions (regexp/PCRE)</a></li><li><a href="/php/traits.html" class="sidebar-link">Traits</a></li><li><a href="/php/composer-dependency-manager.html" class="sidebar-link">Composer Dependency Manager</a></li><li><a href="/php/magic-methods.html" class="sidebar-link">Magic Methods</a></li><li><a href="/php/file-handling.html" class="sidebar-link">File handling</a></li><li><a href="/php/streams.html" class="sidebar-link">Streams</a></li><li><a href="/php/type-hinting.html" class="sidebar-link">Type hinting</a></li><li><a href="/php/filters-filter-functions.html" class="sidebar-link">Filters &amp; Filter Functions</a></li><li><a href="/php/generators.html" class="sidebar-link">Generators</a></li><li><a href="/php/utf-8.html" class="sidebar-link">UTF-8</a></li><li><a href="/php/how-to-break-down-an-url.html" class="sidebar-link">How to break down an URL</a></li><li><a href="/php/object-serialization.html" class="sidebar-link">Object Serialization</a></li><li><a href="/php/serialization.html" class="sidebar-link">Serialization</a></li><li><a href="/php/closure.html" class="sidebar-link">Closure</a></li><li><a href="/php/reading-request-data.html" class="sidebar-link">Reading Request Data</a></li><li><a href="/php/type-juggling-and-non-strict-comparison-issues.html" class="sidebar-link">Type juggling and Non-Strict Comparison Issues</a></li><li><a href="/php/sockets.html" class="sidebar-link">Sockets</a></li><li><a href="/php/pdo.html" class="sidebar-link">PDO</a></li><li><a href="/php/php-mysqli.html" class="sidebar-link">PHP MySQLi</a></li><li><a href="/php/sqlite3.html" class="sidebar-link">SQLite3</a></li><li><a href="/php/using-mongodb.html" class="sidebar-link">Using MongoDB</a></li><li><a href="/php/mongo-php.html" class="sidebar-link">mongo-php</a></li><li><a href="/php/using-redis-with-php.html" class="sidebar-link">Using Redis with PHP</a></li><li><a href="/php/sending-email.html" class="sidebar-link">Sending Email</a></li><li><a href="/php/using-sqlsrv.html" class="sidebar-link">Using SQLSRV</a></li><li><a href="/php/command-line-interface-cli.html" class="sidebar-link">Command Line Interface (CLI)</a></li><li><a href="/php/localization.html" class="sidebar-link">Localization</a></li><li><a href="/php/headers-manipulation.html" class="sidebar-link">Headers Manipulation</a></li><li><a href="/php/coding-conventions.html" class="sidebar-link">Coding Conventions</a></li><li><a href="/php/asynchronous-programming.html" aria-current="page" class="active sidebar-link">Asynchronous programming</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/php/asynchronous-programming.html#advantages-of-generators" class="sidebar-link">Advantages of Generators</a></li><li class="sidebar-sub-header"><a href="/php/asynchronous-programming.html#using-icicle-event-loop" class="sidebar-link">Using Icicle event loop</a></li><li class="sidebar-sub-header"><a href="/php/asynchronous-programming.html#spawning-non-blocking-processes-with-proc-open" class="sidebar-link">Spawning non-blocking processes with proc_open()</a></li><li class="sidebar-sub-header"><a href="/php/asynchronous-programming.html#using-amp-event-loop" class="sidebar-link">Using Amp event loop</a></li><li class="sidebar-sub-header"><a href="/php/asynchronous-programming.html#reading-serial-port-with-event-and-dio" class="sidebar-link">Reading serial port with Event and DIO</a></li><li class="sidebar-sub-header"><a href="/php/asynchronous-programming.html#http-client-based-on-event-extension" class="sidebar-link">HTTP Client Based on Event Extension</a></li><li class="sidebar-sub-header"><a href="/php/asynchronous-programming.html#http-client-based-on-ev-extension" class="sidebar-link">HTTP Client Based on Ev Extension</a></li></ul></li><li><a href="/php/how-to-detect-client-ip-address.html" class="sidebar-link">How to Detect Client IP Address</a></li><li><a href="/php/create-pdf-files-in-php.html" class="sidebar-link">Create PDF files in PHP</a></li><li><a href="/php/yaml-in-php.html" class="sidebar-link">YAML in PHP</a></li><li><a href="/php/image-processing-with-gd.html" class="sidebar-link">Image Processing with GD</a></li><li><a href="/php/imagick.html" class="sidebar-link">Imagick</a></li><li><a href="/php/soap-server.html" class="sidebar-link">SOAP Server</a></li><li><a href="/php/machine-learning.html" class="sidebar-link">Machine learning</a></li><li><a href="/php/cache.html" class="sidebar-link">Cache</a></li><li><a href="/php/autoloading-primer.html" class="sidebar-link">Autoloading Primer</a></li><li><a href="/php/spl-data-structures.html" class="sidebar-link">SPL data structures</a></li><li><a href="/php/imap.html" class="sidebar-link">IMAP</a></li><li><a href="/php/http-authentication.html" class="sidebar-link">HTTP Authentication</a></li><li><a href="/php/websockets.html" class="sidebar-link">WebSockets</a></li><li><a href="/php/bc-math-binary-calculator.html" class="sidebar-link">BC Math (Binary Calculator)</a></li><li><a href="/php/docker-deployment.html" class="sidebar-link">Docker deployment</a></li><li><a href="/php/apcu.html" class="sidebar-link">APCu</a></li><li><a href="/php/php-built-in-server.html" class="sidebar-link">PHP Built in server</a></li><li><a href="/php/psr.html" class="sidebar-link">PSR</a></li><li><a href="/php/phpdoc.html" class="sidebar-link">PHPDoc</a></li><li><a href="/php/design-patterns.html" class="sidebar-link">Design Patterns</a></li><li><a href="/php/compile-php-extensions.html" class="sidebar-link">Compile PHP Extensions</a></li><li><a href="/php/common-errors.html" class="sidebar-link">Common Errors</a></li><li><a href="/php/compilation-of-errors-and-warnings.html" class="sidebar-link">Compilation of Errors and Warnings</a></li><li><a href="/php/exception-handling-and-error-reporting.html" class="sidebar-link">Exception Handling and Error Reporting</a></li><li><a href="/php/debugging.html" class="sidebar-link">Debugging</a></li><li><a href="/php/unit-testing.html" class="sidebar-link">Unit Testing</a></li><li><a href="/php/performance.html" class="sidebar-link">Performance</a></li><li><a href="/php/multiprocessing.html" class="sidebar-link">Multiprocessing</a></li><li><a href="/php/multi-threading-extension.html" class="sidebar-link">Multi Threading Extension</a></li><li><a href="/php/secure-remeber-me.html" class="sidebar-link">Secure Remeber Me</a></li><li><a href="/php/security.html" class="sidebar-link">Security</a></li><li><a href="/php/cryptography.html" class="sidebar-link">Cryptography</a></li><li><a href="/php/password-hashing-functions.html" class="sidebar-link">Password Hashing Functions</a></li><li><a href="/php/urls.html" class="sidebar-link">URLs</a></li><li><a href="/php/unicode-support-in-php.html" class="sidebar-link">Unicode Support in PHP</a></li><li><a href="/php/getting-started-with-php-7.html" class="sidebar-link">Getting started with php-7</a></li><li><a href="/php/null-coalesce-operator.html" class="sidebar-link">Null Coalesce Operator</a></li><li><a href="/php/spaceship-operator.html" class="sidebar-link">Spaceship operator</a></li><li><a href="/php/anonymous-class.html" class="sidebar-link">Anonymous class</a></li><li><a href="/php/contributing-to-the-php-manual.html" class="sidebar-link">Contributing to the PHP Manual</a></li><li><a href="/php/contributing-to-the-php-core.html" class="sidebar-link">Contributing to the PHP Core</a></li><li><a href="/php/getting-started-with-composer-php.html" class="sidebar-link">Getting started with composer-php</a></li><li><a href="/php/auto-loading-with-composer.html" class="sidebar-link">Auto loading with composer</a></li><li><a href="/php/how-to-use-private-repositories-with-composer.html" class="sidebar-link">How to use private repositories with Composer</a></li><li><a href="/php/getting-started-with-phpunit.html" class="sidebar-link">Getting Started with PHPUnit</a></li><li><a href="/php/assertions.html" class="sidebar-link">Assertions</a></li><li><a href="/php/test-doubles-mocks-and-stubs.html" class="sidebar-link">Test Doubles (Mocks and Stubs)</a></li><li><a href="/php/recipes.html" class="sidebar-link">Recipes</a></li><li><a href="/php/php-mysqli-affected-rows-returns-0-when-it-should-return-a-positive-integer.html" class="sidebar-link">php mysqli affected rows returns 0 when it should return a positive integer</a></li><li><a href="/php/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="asynchronous-programming"><a href="#asynchronous-programming" class="header-anchor">#</a> Asynchronous programming</h1> <h2 id="advantages-of-generators"><a href="#advantages-of-generators" class="header-anchor">#</a> Advantages of Generators</h2> <p>PHP 5.5 introduces Generators and the yield keyword, which allows us to write asynchronous code that looks more like synchronous code.</p> <p>The <code>yield</code> expression is responsible for giving control back to the calling code and providing a point of resumption at that place. One can send a value along the <code>yield</code> instruction. The return value of this expression is either <code>null</code> or the value which was passed to <code>Generator::send()</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function-definition function">reverse_range</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the mere presence of the yield keyword in this function makes this a Generator</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// $i is retained between resumptions</span>
        <span class="token keyword">print</span> <span class="token keyword">yield</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span><span class="token variable">$i</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$gen</span> <span class="token operator">=</span> <span class="token function">reverse_range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">print</span> <span class="token variable">$gen</span><span class="token operator">-&gt;</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$gen</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;injected!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// send also resumes the Generator</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$gen</span> <span class="token keyword">as</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// loops over the Generator, resuming it upon each iteration</span>
    <span class="token keyword">echo</span> <span class="token variable">$val</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Output: 5injected!4321</span>

</code></pre></div><p>This mechanism can be used by a coroutine implementation to wait for Awaitables yielded by the Generator (by registering itself as a callback for resolution) and continue execution of the Generator as soon as the Awaitable is resolved.</p> <h2 id="using-icicle-event-loop"><a href="#using-icicle-event-loop" class="header-anchor">#</a> Using Icicle event loop</h2> <p><a href="https://github.com/icicleio/icicle" target="_blank" rel="noopener noreferrer">Icicle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> uses Awaitables and Generators to create Coroutines.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">require</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Icicle<span class="token punctuation">\</span>Awaitable</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Icicle<span class="token punctuation">\</span>Coroutine<span class="token punctuation">\</span>Coroutine</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Icicle<span class="token punctuation">\</span>Loop</span><span class="token punctuation">;</span>

<span class="token variable">$generator</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token keyword type-hint">float</span> <span class="token variable">$time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Sets $start to the value returned by microtime() after approx. $time seconds.</span>
        <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">Awaitable<span class="token punctuation">\</span>resolve</span><span class="token punctuation">(</span><span class="token function">microtime</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token variable">$time</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Sleep time: &quot;</span><span class="token punctuation">,</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token variable">$start</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">&quot;\n&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">// Throws the exception from the rejected awaitable into the coroutine.</span>
        <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">Awaitable<span class="token punctuation">\</span>reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Rejected awaitable'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Catches awaitable rejection reason.</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Caught exception: &quot;</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">&quot;\n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">Awaitable<span class="token punctuation">\</span>resolve</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Coroutine completed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Coroutine sleeps for 1.2 seconds, then will resolve with a string.</span>
<span class="token variable">$coroutine</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Coroutine</span><span class="token punctuation">(</span><span class="token variable">$generator</span><span class="token punctuation">(</span><span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$coroutine</span><span class="token operator">-&gt;</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">&quot;\n&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">Loop<span class="token punctuation">\</span>run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="spawning-non-blocking-processes-with-proc-open"><a href="#spawning-non-blocking-processes-with-proc-open" class="header-anchor">#</a> Spawning non-blocking processes with proc_open()</h2> <p>PHP has no support for running code concurrently unless you install extensions such as <a href="http://stackoverflow.com/documentation/php/1583/multi-threading-extension#t=201609251928593249974" target="_blank" rel="noopener noreferrer"><code>pthread</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. This can be sometimes bypassed by using <a href="http://php.net/manual/en/function.proc-open.php" target="_blank" rel="noopener noreferrer"><code>proc_open()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="http://php.net/manual/en/function.stream-set-blocking.php" target="_blank" rel="noopener noreferrer"><code>stream_set_blocking()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and reading their output asynchronously.</p> <p>If we split code into smaller chunks we can run it as multiple suprocesses. Then using <a href="http://php.net/manual/en/function.stream-set-blocking.php" target="_blank" rel="noopener noreferrer"><code>stream_set_blocking()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function we can make each subprocess also non-blocking. This means we can spawn multiple subprocesses and then check for their output in a loop (similarly to an even loop) and wait until all of them finish.</p> <p>As an example we can have a small subprocess that just runs a loop and in each iteration sleeps randomly for 100 - 1000ms (note, the delay is always the same for one subprocess).</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// subprocess.php</span>
<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$argv</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$delay</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$name</span></span> delay: ${delay}ms\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token variable">$delay</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$name</span></span>: <span class="token interpolation"><span class="token variable">$i</span></span>\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</span></code></pre></div><p>Then the main process will spawn subprocesses and read their output. We can split it into smaller blocks:</p> <ul><li>Spawn subprocesses with <a href="http://php.net/manual/en/function.proc-open.php" target="_blank" rel="noopener noreferrer">proc_open()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> .</li> <li>Make each subprocess non-blocking with <a href="http://php.net/manual/en/function.stream-set-blocking.php" target="_blank" rel="noopener noreferrer"><code>stream_set_blocking()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Run a loop until all subprocesses finish using <a href="http://php.net/manual/en/function.proc-get-status.php" target="_blank" rel="noopener noreferrer"><code>proc_get_status()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Properly close file handles with the output pipe for each subprocess using <a href="http://php.net/manual/en/function.fclose.php" target="_blank" rel="noopener noreferrer"><code>fclose()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and close process handles with <a href="http://php.net/manual/en/function.proc-close.php" target="_blank" rel="noopener noreferrer"><code>proc_close()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// non-blocking-proc_open.php</span>
<span class="token comment">// File descriptors for each subprocess.</span>
<span class="token variable">$descriptors</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'pipe'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'r'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// stdin</span>
    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'pipe'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'w'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// stdout</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token variable">$pipes</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$processes</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Spawn a subprocess.</span>
    <span class="token variable">$proc</span> <span class="token operator">=</span> <span class="token function">proc_open</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php subprocess.php proc'</span> <span class="token operator">.</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token variable">$descriptors</span><span class="token punctuation">,</span> <span class="token variable">$procPipes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$processes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$proc</span><span class="token punctuation">;</span>
    <span class="token comment">// Make the subprocess non-blocking (only output pipe).</span>
    <span class="token function">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$procPipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$procPipes</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Run in a loop until all subprocesses finish.</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">array_filter</span><span class="token punctuation">(</span><span class="token variable">$processes</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$proc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">proc_get_status</span><span class="token punctuation">(</span><span class="token variable">$proc</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'running'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100ms</span>
        <span class="token comment">// Read all available output (unread output is buffered).</span>
        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Close all pipes and processes.</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">proc_close</span><span class="token punctuation">(</span><span class="token variable">$processes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</span></code></pre></div><p>The output then contains mixture from all three subprocesses as they we're read by <a href="http://php.net/manual/en/function.fread.php" target="_blank" rel="noopener noreferrer">fread()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (note, that in this case <code>proc1</code> ended much earlier than the other two):</p> <div class="language-php extra-class"><pre class="language-php"><code>$ php non<span class="token operator">-</span>blocking<span class="token operator">-</span>proc_open<span class="token operator">.</span>php 
proc1 delay<span class="token punctuation">:</span> <span class="token number">200</span>ms
proc2 delay<span class="token punctuation">:</span> <span class="token number">1000</span>ms
proc3 delay<span class="token punctuation">:</span> <span class="token number">800</span>ms
proc1<span class="token punctuation">:</span> <span class="token number">0</span>
proc1<span class="token punctuation">:</span> <span class="token number">1</span>
proc1<span class="token punctuation">:</span> <span class="token number">2</span>
proc1<span class="token punctuation">:</span> <span class="token number">3</span>
proc3<span class="token punctuation">:</span> <span class="token number">0</span>
proc1<span class="token punctuation">:</span> <span class="token number">4</span>
proc2<span class="token punctuation">:</span> <span class="token number">0</span>
proc3<span class="token punctuation">:</span> <span class="token number">1</span>
proc2<span class="token punctuation">:</span> <span class="token number">1</span>
proc3<span class="token punctuation">:</span> <span class="token number">2</span>
proc2<span class="token punctuation">:</span> <span class="token number">2</span>
proc3<span class="token punctuation">:</span> <span class="token number">3</span>
proc2<span class="token punctuation">:</span> <span class="token number">3</span>
proc3<span class="token punctuation">:</span> <span class="token number">4</span>
proc2<span class="token punctuation">:</span> <span class="token number">4</span>

</code></pre></div><h2 id="using-amp-event-loop"><a href="#using-amp-event-loop" class="header-anchor">#</a> Using Amp event loop</h2> <p><a href="https://github.com/amphp/amp/tree/v1.x" target="_blank" rel="noopener noreferrer">Amp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> harnesses Promises [another name for Awaitables] and Generators for coroutine creation.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">require</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Amp<span class="token punctuation">\</span>Dns</span><span class="token punctuation">;</span>

<span class="token comment">// Try our system defined resolver or googles, whichever is fastest</span>
<span class="token keyword">function</span> <span class="token function-definition function">queryStackOverflow</span><span class="token punctuation">(</span><span class="token variable">$recordtype</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$requests</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token function">Dns<span class="token punctuation">\</span>query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;stackoverflow.com&quot;</span><span class="token punctuation">,</span> <span class="token variable">$recordtype</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">Dns<span class="token punctuation">\</span>query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;stackoverflow.com&quot;</span><span class="token punctuation">,</span> <span class="token variable">$recordtype</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;server&quot;</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;8.8.8.8&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// returns a Promise resolving when the first one of the requests resolves</span>
    <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">Amp<span class="token punctuation">\</span>first</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function"><span class="token punctuation">\</span>Amp<span class="token punctuation">\</span>run</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// main loop, implicitly a coroutine</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// convert to coroutine with Amp\resolve()</span>
        <span class="token variable">$promise</span> <span class="token operator">=</span> <span class="token function">Amp<span class="token punctuation">\</span>resolve</span><span class="token punctuation">(</span><span class="token function">queryStackOverflow</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context">Dns<span class="token punctuation">\</span>Record</span><span class="token operator">::</span><span class="token constant">NS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$ns</span><span class="token punctuation">,</span> <span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token variable">$ttl</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token comment">// we need only one NS result, not all</span>
            <span class="token function">current</span><span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token function">Amp<span class="token punctuation">\</span>timeout</span><span class="token punctuation">(</span><span class="token variable">$promise</span><span class="token punctuation">,</span> <span class="token number">2000</span> <span class="token comment">/* milliseconds */</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;The result of the fastest server to reply to our query was <span class="token interpolation"><span class="token variable">$ns</span></span>&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified">Amp<span class="token punctuation">\</span>TimeoutException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;We've heard no answer for 2 seconds! Bye!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified">Dns<span class="token punctuation">\</span>NoRecordException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;No NS records there? Stupid DNS nameserver!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="reading-serial-port-with-event-and-dio"><a href="#reading-serial-port-with-event-and-dio" class="header-anchor">#</a> Reading serial port with Event and DIO</h2> <p><a href="http://php.net/manual/en/book.dio.php" target="_blank" rel="noopener noreferrer"><strong>DIO</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> streams are currently not recognized by the <a href="http://php.net/manual/en/book.event.php" target="_blank" rel="noopener noreferrer"><strong>Event</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> extension. There is no clean way to obtain the file descriptor encapsulated into the DIO resource. But there is a workaround:</p> <ul><li>open stream for the port with <code>fopen()</code>;</li> <li>make the stream non-blocking with <a href="http://php.net/manual/en/function.stream-set-blocking.php" target="_blank" rel="noopener noreferrer"><code>stream_set_blocking()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>;</li> <li>obtain numeric file descriptor from the stream with <a href="http://php.net/manual/en/function.stream-set-blocking.php" target="_blank" rel="noopener noreferrer"><code>EventUtil::getSocketFd()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>;</li> <li>pass the numeric file descriptor to <code>dio_fdopen()</code> (currently undocumented) and get the DIO resource;</li> <li>add an <code>Event</code> with a callback for listening to the read events on the file descriptor;</li> <li>in the callback drain the available data and process it according to the logic of your application.</li></ul> <p><strong>dio.php</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Scanner</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token variable">$port</span><span class="token punctuation">;</span> <span class="token comment">// port path, e.g. /dev/pts/5</span>
  <span class="token keyword">protected</span> <span class="token variable">$fd</span><span class="token punctuation">;</span> <span class="token comment">// numeric file descriptor</span>
  <span class="token keyword">protected</span> <span class="token variable">$base</span><span class="token punctuation">;</span> <span class="token comment">// EventBase</span>
  <span class="token keyword">protected</span> <span class="token variable">$dio</span><span class="token punctuation">;</span> <span class="token comment">// dio resource</span>
  <span class="token keyword">protected</span> <span class="token variable">$e_open</span><span class="token punctuation">;</span> <span class="token comment">// Event</span>
  <span class="token keyword">protected</span> <span class="token variable">$e_read</span><span class="token punctuation">;</span> <span class="token comment">// Event</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span> <span class="token punctuation">(</span><span class="token variable">$port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">port</span> <span class="token operator">=</span> <span class="token variable">$port</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span><span class="token operator">-&gt;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_open</span><span class="token punctuation">)</span>
      <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_open</span><span class="token operator">-&gt;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_read</span><span class="token punctuation">)</span>
      <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_read</span><span class="token operator">-&gt;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dio</span><span class="token punctuation">)</span>
      <span class="token function">dio_close</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dio</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$stream</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">port</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$stream</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fd</span> <span class="token operator">=</span> <span class="token class-name static-context">EventUtil</span><span class="token operator">::</span><span class="token function">getSocketFd</span><span class="token punctuation">(</span><span class="token variable">$stream</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fd</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">STDERR</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">&quot;Failed attach to port, events: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token variable">$events</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_open</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fd</span><span class="token punctuation">,</span> <span class="token class-name static-context">Event</span><span class="token operator">::</span><span class="token constant">WRITE</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_onOpen'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_open</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span><span class="token operator">-&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$stream</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_onOpen</span><span class="token punctuation">(</span><span class="token variable">$fd</span><span class="token punctuation">,</span> <span class="token variable">$events</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_open</span><span class="token operator">-&gt;</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dio</span> <span class="token operator">=</span> <span class="token function">dio_fdopen</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Call other dio functions here, e.g.</span>
    <span class="token function">dio_tcsetattr</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dio</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token string single-quoted-string">'baud'</span> <span class="token operator">=&gt;</span> <span class="token number">9600</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'bits'</span> <span class="token operator">=&gt;</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'stop'</span>  <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'parity'</span> <span class="token operator">=&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_read</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fd</span><span class="token punctuation">,</span> <span class="token class-name static-context">Event</span><span class="token operator">::</span><span class="token class-name">READ</span> <span class="token operator">|</span> <span class="token class-name">Event</span><span class="token operator">::</span><span class="token constant">PERSIST</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_onRead'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">e_read</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_onRead</span><span class="token punctuation">(</span><span class="token variable">$fd</span><span class="token punctuation">,</span> <span class="token variable">$events</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">dio_read</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">dio</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Change the port argument</span>
<span class="token variable">$scanner</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/dev/pts/5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$scanner</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre></div><h3 id="testing"><a href="#testing" class="header-anchor">#</a> Testing</h3> <p>Run the following command in terminal A:</p> <div class="language-php extra-class"><pre class="language-php"><code>$ socat <span class="token operator">-</span>d <span class="token operator">-</span>d pty<span class="token punctuation">,</span>raw<span class="token punctuation">,</span><span class="token keyword">echo</span><span class="token operator">=</span><span class="token number">0</span> pty<span class="token punctuation">,</span>raw<span class="token punctuation">,</span><span class="token keyword">echo</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token number">2016</span><span class="token operator">/</span><span class="token number">12</span><span class="token operator">/</span><span class="token number">01</span> <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">04</span><span class="token punctuation">:</span><span class="token number">06</span> socat<span class="token punctuation">[</span><span class="token number">16750</span><span class="token punctuation">]</span> <span class="token constant">N</span> <span class="token constant">PTY</span> is <span class="token operator">/</span>dev<span class="token operator">/</span>pts<span class="token operator">/</span><span class="token number">5</span>
<span class="token number">2016</span><span class="token operator">/</span><span class="token number">12</span><span class="token operator">/</span><span class="token number">01</span> <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">04</span><span class="token punctuation">:</span><span class="token number">06</span> socat<span class="token punctuation">[</span><span class="token number">16750</span><span class="token punctuation">]</span> <span class="token constant">N</span> <span class="token constant">PTY</span> is <span class="token operator">/</span>dev<span class="token operator">/</span>pts<span class="token operator">/</span><span class="token number">8</span>
<span class="token number">2016</span><span class="token operator">/</span><span class="token number">12</span><span class="token operator">/</span><span class="token number">01</span> <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">04</span><span class="token punctuation">:</span><span class="token number">06</span> socat<span class="token punctuation">[</span><span class="token number">16750</span><span class="token punctuation">]</span> <span class="token constant">N</span> starting data transfer loop with FDs <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span>

</code></pre></div><p>The output may be different. Use the PTYs from the first couple of rows (<code>/dev/pts/5</code> and <code>/dev/pts/8</code>, in particular).</p> <p>In terminal B run the above-mentioned script. You may need root privileges:</p> <div class="language-php extra-class"><pre class="language-php"><code>$ sudo php dio<span class="token operator">.</span>php

</code></pre></div><p>In terminal C send a string to the first PTY:</p> <div class="language-php extra-class"><pre class="language-php"><code>$ <span class="token keyword">echo</span> test <span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>pts<span class="token operator">/</span><span class="token number">8</span>

</code></pre></div><p><strong>Output</strong></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">&quot;t&quot;</span>
<span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">&quot;e&quot;</span>
<span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">&quot;s&quot;</span>
<span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">&quot;t&quot;</span>
<span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string double-quoted-string">&quot;
&quot;</span>

</code></pre></div><h2 id="http-client-based-on-event-extension"><a href="#http-client-based-on-event-extension" class="header-anchor">#</a> HTTP Client Based on Event Extension</h2> <p>This is a sample HTTP client class based on <a href="https://pecl.php.net/package/event" target="_blank" rel="noopener noreferrer">Event<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> extension.</p> <p>The class allows to schedule a number of HTTP requests, then run them asynchronously.</p> <h3 id="http-client-php"><a href="#http-client-php" class="header-anchor">#</a> http-client.php</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">MyHttpClient</span> <span class="token punctuation">{</span>
  <span class="token comment">/// @var EventBase</span>
  <span class="token keyword">protected</span> <span class="token variable">$base</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var array Instances of EventHttpConnection</span>
  <span class="token keyword">protected</span> <span class="token variable">$connections</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Dispatches all pending requests (events)
   *
   * @return void
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span><span class="token operator">-&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Destroy connection objects explicitly, don't wait for GC.</span>
    <span class="token comment">// Otherwise, EventBase may be free'd earlier.</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">connections</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @brief Adds a pending HTTP request
   *
   * @param string $address Hostname, or IP
   * @param int $port Port number
   * @param array $headers Extra HTTP headers
   * @param int $cmd A EventHttpRequest::CMD_* constant
   * @param string $resource HTTP request resource, e.g. '/page?a=b&amp;c=d'
   *
   * @return EventHttpRequest|false
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">addRequest</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$headers</span><span class="token punctuation">,</span>
    <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token class-name static-context">EventHttpRequest</span><span class="token operator">::</span><span class="token constant">CMD_GET</span><span class="token punctuation">,</span> <span class="token variable">$resource</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token variable">$conn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventHttpConnection</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span><span class="token punctuation">,</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$req</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_requestHandler'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">base</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$headers</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$req</span><span class="token operator">-&gt;</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token class-name static-context">EventHttpRequest</span><span class="token operator">::</span><span class="token constant">OUTPUT_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$req</span><span class="token operator">-&gt;</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Host'</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token class-name static-context">EventHttpRequest</span><span class="token operator">::</span><span class="token constant">OUTPUT_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$req</span><span class="token operator">-&gt;</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Connection'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'close'</span><span class="token punctuation">,</span> <span class="token class-name static-context">EventHttpRequest</span><span class="token operator">::</span><span class="token constant">OUTPUT_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">,</span> <span class="token variable">$cmd</span><span class="token punctuation">,</span> <span class="token variable">$resource</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">connections</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token variable">$conn</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token variable">$req</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/**
   * @brief Handles an HTTP request
   *
   * @param EventHttpRequest $req
   * @param mixed $unused
   *
   * @return void
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_requestHandler</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">,</span> <span class="token variable">$unused</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$req</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Timed out\n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token variable">$response_code</span> <span class="token operator">=</span> <span class="token variable">$req</span><span class="token operator">-&gt;</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response_code</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Connection refused\n&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$response_code</span> <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Unexpected response: <span class="token interpolation"><span class="token variable">$response_code</span></span>\n&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Success: <span class="token interpolation"><span class="token variable">$response_code</span></span>\n&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$buf</span> <span class="token operator">=</span> <span class="token variable">$req</span><span class="token operator">-&gt;</span><span class="token function">getInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Body:\n&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">=</span> <span class="token variable">$buf</span><span class="token operator">-&gt;</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token class-name static-context">EventBuffer</span><span class="token operator">::</span><span class="token constant">EOL_ANY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">echo</span> <span class="token variable">$s</span><span class="token punctuation">,</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token variable">$address</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;my-host.local&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$port</span> <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
<span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string single-quoted-string">'User-Agent'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'My-User-Agent/1.0'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add pending requests</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">addRequest</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token variable">$headers</span><span class="token punctuation">,</span>
    <span class="token class-name static-context">EventHttpRequest</span><span class="token operator">::</span><span class="token constant">CMD_GET</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/test.php?a='</span> <span class="token operator">.</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Dispatch pending requests</span>
<span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre></div><h3 id="test-php"><a href="#test-php" class="header-anchor">#</a> test.php</h3> <p>This is a sample script on the server side.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'GET: '</span><span class="token punctuation">,</span> <span class="token function">var_export</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'User-Agent: '</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_USER_AGENT'</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string single-quoted-string">'(none)'</span><span class="token punctuation">,</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>

</span></code></pre></div><h3 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h3> <div class="language-php extra-class"><pre class="language-php"><code>php http<span class="token operator">-</span>client<span class="token operator">.</span>php

</code></pre></div><p><strong>Sample Output</strong></p> <div class="language-php extra-class"><pre class="language-php"><code>Success<span class="token punctuation">:</span> <span class="token number">200</span>
Body<span class="token punctuation">:</span>
<span class="token constant">GET</span><span class="token punctuation">:</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'a'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'1'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
User<span class="token operator">-</span>Agent<span class="token punctuation">:</span> My<span class="token operator">-</span>User<span class="token operator">-</span>Agent<span class="token operator">/</span><span class="token number">1.0</span>
Success<span class="token punctuation">:</span> <span class="token number">200</span>
Body<span class="token punctuation">:</span>
<span class="token constant">GET</span><span class="token punctuation">:</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'a'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
User<span class="token operator">-</span>Agent<span class="token punctuation">:</span> My<span class="token operator">-</span>User<span class="token operator">-</span>Agent<span class="token operator">/</span><span class="token number">1.0</span>
Success<span class="token punctuation">:</span> <span class="token number">200</span>
Body<span class="token punctuation">:</span>
<span class="token constant">GET</span><span class="token punctuation">:</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'a'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'3'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token operator">...</span>

</code></pre></div><p><strong>(Trimmed.)</strong></p> <p>Note, the code is designed for long-term processing in the <a href="http://php.net/manual/en/features.commandline.introduction.php" target="_blank" rel="noopener noreferrer">CLI SAPI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="http-client-based-on-ev-extension"><a href="#http-client-based-on-ev-extension" class="header-anchor">#</a> HTTP Client Based on Ev Extension</h2> <p>This is a sample HTTP client based on <a href="https://pecl.php.net/package/ev" target="_blank" rel="noopener noreferrer">Ev<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> extension.</p> <p>Ev extension implements a simple yet powerful general purpose event loop. It doesn't provide network-specific watchers, but its <a href="http://docs.php.net/manual/en/class.evio.php" target="_blank" rel="noopener noreferrer">I/O watcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> can be used for asynchronous processing of <a href="http://docs.php.net/manual/en/book.sockets.php" target="_blank" rel="noopener noreferrer">sockets<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>The following code shows how HTTP requests can be scheduled for parallel processing.</p> <h3 id="http-client-php-2"><a href="#http-client-php-2" class="header-anchor">#</a> http-client.php</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">MyHttpRequest</span> <span class="token punctuation">{</span>
  <span class="token comment">/// @var MyHttpClient</span>
  <span class="token keyword">private</span> <span class="token variable">$http_client</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var string</span>
  <span class="token keyword">private</span> <span class="token variable">$address</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var string HTTP resource such as /page?get=param</span>
  <span class="token keyword">private</span> <span class="token variable">$resource</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var string HTTP method such as GET, POST etc.</span>
  <span class="token keyword">private</span> <span class="token variable">$method</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var int</span>
  <span class="token keyword">private</span> <span class="token variable">$service_port</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var resource Socket</span>
  <span class="token keyword">private</span> <span class="token variable">$socket</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var double Connection timeout in seconds.</span>
  <span class="token keyword">private</span> <span class="token variable">$timeout</span> <span class="token operator">=</span> <span class="token number">10.</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var int Chunk size in bytes for socket_recv()</span>
  <span class="token keyword">private</span> <span class="token variable">$chunk_size</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var EvTimer</span>
  <span class="token keyword">private</span> <span class="token variable">$timeout_watcher</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var EvIo</span>
  <span class="token keyword">private</span> <span class="token variable">$write_watcher</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var EvIo</span>
  <span class="token keyword">private</span> <span class="token variable">$read_watcher</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var EvTimer</span>
  <span class="token keyword">private</span> <span class="token variable">$conn_watcher</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var string buffer for incoming data</span>
  <span class="token keyword">private</span> <span class="token variable">$buffer</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var array errors reported by sockets extension in non-blocking mode.</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token variable">$e_nonblocking</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">11</span><span class="token punctuation">,</span> <span class="token comment">// EAGAIN or EWOULDBLOCK</span>
    <span class="token number">115</span><span class="token punctuation">,</span> <span class="token comment">// EINPROGRESS</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * @param MyHttpClient $client
   * @param string $host Hostname, e.g. google.co.uk
   * @param string $resource HTTP resource, e.g. /page?a=b&amp;c=d
   * @param string $method HTTP method: GET, HEAD, POST, PUT etc.
   * @throws RuntimeException
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">MyHttpClient</span> <span class="token variable">$client</span><span class="token punctuation">,</span> <span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$resource</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">http_client</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">host</span>        <span class="token operator">=</span> <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">resource</span>    <span class="token operator">=</span> <span class="token variable">$resource</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">method</span>      <span class="token operator">=</span> <span class="token variable">$method</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the port for the WWW service</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">service_port</span> <span class="token operator">=</span> <span class="token function">getservbyname</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'www'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'tcp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the IP address for the target host</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">address</span> <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">host</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a TCP/IP socket</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span> <span class="token operator">=</span> <span class="token function">socket_create</span><span class="token punctuation">(</span><span class="token constant">AF_INET</span><span class="token punctuation">,</span> <span class="token constant">SOCK_STREAM</span><span class="token punctuation">,</span> <span class="token constant">SOL_TCP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;socket_create() failed: reason: &quot;</span> <span class="token operator">.</span>
        <span class="token function">socket_strerror</span><span class="token punctuation">(</span><span class="token function">socket_last_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Set O_NONBLOCK flag</span>
    <span class="token function">socket_set_nonblock</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">conn_watcher</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">http_client</span><span class="token operator">-&gt;</span><span class="token function">getLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">-&gt;</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'connect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">freeWatcher</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$w</span><span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$w</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Deallocates all resources of the request
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">socket_close</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">freeWatcher</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timeout_watcher</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">freeWatcher</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">read_watcher</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">freeWatcher</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">write_watcher</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">freeWatcher</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">conn_watcher</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Initializes a connection on socket
   * @return bool
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$loop</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">http_client</span><span class="token operator">-&gt;</span><span class="token function">getLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timeout_watcher</span> <span class="token operator">=</span> <span class="token variable">$loop</span><span class="token operator">-&gt;</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timeout</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_onTimeout'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">write_watcher</span> <span class="token operator">=</span> <span class="token variable">$loop</span><span class="token operator">-&gt;</span><span class="token function">io</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">,</span> <span class="token class-name static-context">Ev</span><span class="token operator">::</span><span class="token constant">WRITE</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_onWritable'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">socket_connect</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">address</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">service_port</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback for timeout (EvTimer) watcher
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_onTimeout</span><span class="token punctuation">(</span><span class="token class-name type-declaration">EvTimer</span> <span class="token variable">$w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$w</span><span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback which is called when the socket becomes wriable
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_onWritable</span><span class="token punctuation">(</span><span class="token class-name type-declaration">EvIo</span> <span class="token variable">$w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timeout_watcher</span><span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$w</span><span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$in</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;\r\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">method</span><span class="token punctuation">}</span></span> <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">resource</span><span class="token punctuation">}</span></span> HTTP/1.1&quot;</span><span class="token punctuation">,</span>
      <span class="token string double-quoted-string">&quot;Host: <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">host</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'Connection: Close'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot;\r\n\r\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">socket_write</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">,</span> <span class="token variable">$in</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$in</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Failed writing <span class="token interpolation"><span class="token variable">$in</span></span> to socket&quot;</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$loop</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">http_client</span><span class="token operator">-&gt;</span><span class="token function">getLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">read_watcher</span> <span class="token operator">=</span> <span class="token variable">$loop</span><span class="token operator">-&gt;</span><span class="token function">io</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">,</span>
      <span class="token class-name static-context">Ev</span><span class="token operator">::</span><span class="token constant">READ</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_onReadable'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Continue running the loop</span>
    <span class="token variable">$loop</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback which is called when the socket becomes readable
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_onReadable</span><span class="token punctuation">(</span><span class="token class-name type-declaration">EvIo</span> <span class="token variable">$w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// recv() 20 bytes in non-blocking mode</span>
    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token function">socket_recv</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">socket</span><span class="token punctuation">,</span> <span class="token variable">$out</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token constant">MSG_DONTWAIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Still have data to read. Append the read chunk to the buffer.</span>
      <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">buffer</span> <span class="token operator">.=</span> <span class="token variable">$out</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$ret</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// All is read</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;\n&lt;&lt;&lt;&lt;\n%s\n&gt;&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> <span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">buffer</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">STDOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$w</span><span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Caught EINPROGRESS, EAGAIN, or EWOULDBLOCK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token function">socket_last_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token variable">$e_nonblocking</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$w</span><span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/////////////////////////////////////</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">MyHttpClient</span> <span class="token punctuation">{</span>
  <span class="token comment">/// @var array Instances of MyHttpRequest</span>
  <span class="token keyword">private</span> <span class="token variable">$requests</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/// @var EvLoop</span>
  <span class="token keyword">private</span> <span class="token variable">$loop</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Each HTTP client runs its own event loop</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">loop</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">loop</span><span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @return EvLoop
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">loop</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Adds a pending request
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">addRequest</span><span class="token punctuation">(</span><span class="token class-name type-declaration">MyHttpRequest</span> <span class="token variable">$r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">requests</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token variable">$r</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Dispatches all pending requests
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">loop</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/////////////////////////////////////</span>
<span class="token comment">// Usage</span>
<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">addRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyHttpRequest</span><span class="token punctuation">(</span><span class="token variable">$client</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'my-host.local'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/test.php?a='</span> <span class="token operator">.</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre></div><h3 id="testing-2"><a href="#testing-2" class="header-anchor">#</a> Testing</h3> <p>Suppose <code>http://my-host.local/test.php</code> script is printing the dump of <code>$_GET</code>:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'GET: '</span><span class="token punctuation">,</span> <span class="token function">var_export</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>

</span></code></pre></div><p>Then the output of <code>php http-client.php</code> command will be similar to the following:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&lt;&lt;</span><span class="token operator">&lt;&lt;</span>
<span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> <span class="token constant">OK</span>
Server<span class="token punctuation">:</span> nginx<span class="token operator">/</span><span class="token number">1.10</span><span class="token number">.1</span>
Date<span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> <span class="token number">02</span> Dec <span class="token number">2016</span> <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">54</span> <span class="token constant">GMT</span>
Content<span class="token operator">-</span>Type<span class="token punctuation">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span>
Transfer<span class="token operator">-</span>Encoding<span class="token punctuation">:</span> chunked
Connection<span class="token punctuation">:</span> close
<span class="token constant">X</span><span class="token operator">-</span>Powered<span class="token operator">-</span>By<span class="token punctuation">:</span> <span class="token constant">PHP</span><span class="token operator">/</span><span class="token number">7.0</span><span class="token number">.13</span><span class="token operator">-</span>pl0<span class="token operator">-</span>gentoo

<span class="token number">1</span>d
<span class="token constant">GET</span><span class="token punctuation">:</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'a'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'3'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token number">0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;&gt;</span>
<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;&lt;</span>
<span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> <span class="token constant">OK</span>
Server<span class="token punctuation">:</span> nginx<span class="token operator">/</span><span class="token number">1.10</span><span class="token number">.1</span>
Date<span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> <span class="token number">02</span> Dec <span class="token number">2016</span> <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">54</span> <span class="token constant">GMT</span>
Content<span class="token operator">-</span>Type<span class="token punctuation">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span>
Transfer<span class="token operator">-</span>Encoding<span class="token punctuation">:</span> chunked
Connection<span class="token punctuation">:</span> close
<span class="token constant">X</span><span class="token operator">-</span>Powered<span class="token operator">-</span>By<span class="token punctuation">:</span> <span class="token constant">PHP</span><span class="token operator">/</span><span class="token number">7.0</span><span class="token number">.13</span><span class="token operator">-</span>pl0<span class="token operator">-</span>gentoo

<span class="token number">1</span>d
<span class="token constant">GET</span><span class="token punctuation">:</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'a'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'2'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token number">0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;&gt;</span>
<span class="token operator">...</span>

</code></pre></div><p><strong>(trimmed)</strong></p> <p>Note, in PHP 5 the <strong>sockets</strong> extension may log warnings for <code>EINPROGRESS</code>, <code>EAGAIN</code>, and <code>EWOULDBLOCK</code> <code>errno</code> values. It is possible to turn off the logs with</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token constant">E_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/php/asynchronous-programming.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/php/coding-conventions.html" class="prev">
        Coding Conventions
      </a></span> <span class="next"><a href="/php/how-to-detect-client-ip-address.html">
        How to Detect Client IP Address
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/2423.26f85034.js" defer></script>
  </body>
</html>
