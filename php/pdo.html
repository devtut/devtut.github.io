<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PHP - PDO</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Preventing SQL injection with Parameterized Queries, Basic PDO Connection and Retrieval, Database Transactions with PDO, PDO: connecting to MySQL/MariaDB server, PDO: Get number of affected rows by a query, PDO::lastInsertId()">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="PHP - PDO">
    <meta property="og:description" content="Preventing SQL injection with Parameterized Queries, Basic PDO Connection and Retrieval, Database Transactions with PDO, PDO: connecting to MySQL/MariaDB server, PDO: Get number of affected rows by a query, PDO::lastInsertId()">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/php/pdo.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="PHP - PDO">
    <meta name="twitter:description" content="Preventing SQL injection with Parameterized Queries, Basic PDO Connection and Retrieval, Database Transactions with PDO, PDO: connecting to MySQL/MariaDB server, PDO: Get number of affected rows by a query, PDO::lastInsertId()">
    <meta name="twitter:url" content="/php/pdo.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/2489.6834e688.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>PHP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/php/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/php/installing-a-php-environment-on-windows.html" class="sidebar-link">Installing a PHP environment on Windows</a></li><li><a href="/php/installing-on-linux-unix-environments.html" class="sidebar-link">Installing on Linux/Unix Environments</a></li><li><a href="/php/getting-started-with-php.html" class="sidebar-link">Getting started with PHP</a></li><li><a href="/php/variables.html" class="sidebar-link">Variables</a></li><li><a href="/php/variable-scope.html" class="sidebar-link">Variable Scope</a></li><li><a href="/php/superglobal-variables-php.html" class="sidebar-link">Superglobal Variables PHP</a></li><li><a href="/php/outputting-the-value-of-a-variable.html" class="sidebar-link">Outputting the Value of a Variable</a></li><li><a href="/php/constants.html" class="sidebar-link">Constants</a></li><li><a href="/php/magic-constants.html" class="sidebar-link">Magic Constants</a></li><li><a href="/php/comments.html" class="sidebar-link">Comments</a></li><li><a href="/php/types.html" class="sidebar-link">Types</a></li><li><a href="/php/operators.html" class="sidebar-link">Operators</a></li><li><a href="/php/references.html" class="sidebar-link">References</a></li><li><a href="/php/arrays.html" class="sidebar-link">Arrays</a></li><li><a href="/php/array-iteration.html" class="sidebar-link">Array iteration</a></li><li><a href="/php/executing-upon-an-array.html" class="sidebar-link">Executing Upon an Array</a></li><li><a href="/php/manipulating-an-array.html" class="sidebar-link">Manipulating an Array</a></li><li><a href="/php/processing-multiple-arrays-together.html" class="sidebar-link">Processing Multiple Arrays Together</a></li><li><a href="/php/datetime-class.html" class="sidebar-link">Datetime Class</a></li><li><a href="/php/working-with-dates-and-time.html" class="sidebar-link">Working with Dates and Time</a></li><li><a href="/php/control-structures.html" class="sidebar-link">Control Structures</a></li><li><a href="/php/loops.html" class="sidebar-link">Loops</a></li><li><a href="/php/functions.html" class="sidebar-link">Functions</a></li><li><a href="/php/functional-programming.html" class="sidebar-link">Functional Programming</a></li><li><a href="/php/alternative-syntax-for-control-structures.html" class="sidebar-link">Alternative Syntax for Control Structures</a></li><li><a href="/php/string-formatting.html" class="sidebar-link">String formatting</a></li><li><a href="/php/string-parsing.html" class="sidebar-link">String Parsing</a></li><li><a href="/php/classes-and-objects.html" class="sidebar-link">Classes and Objects</a></li><li><a href="/php/namespaces.html" class="sidebar-link">Namespaces</a></li><li><a href="/php/sessions.html" class="sidebar-link">Sessions</a></li><li><a href="/php/cookies.html" class="sidebar-link">Cookies</a></li><li><a href="/php/output-buffering.html" class="sidebar-link">Output Buffering</a></li><li><a href="/php/json.html" class="sidebar-link">JSON</a></li><li><a href="/php/soap-client.html" class="sidebar-link">SOAP Client</a></li><li><a href="/php/using-curl-in-php.html" class="sidebar-link">Using cURL in PHP</a></li><li><a href="/php/reflection.html" class="sidebar-link">Reflection</a></li><li><a href="/php/dependency-injection.html" class="sidebar-link">Dependency Injection</a></li><li><a href="/php/xml.html" class="sidebar-link">XML</a></li><li><a href="/php/simplexml.html" class="sidebar-link">SimpleXML</a></li><li><a href="/php/parsing-html.html" class="sidebar-link">Parsing HTML</a></li><li><a href="/php/regular-expressions-regexp-pcre.html" class="sidebar-link">Regular Expressions (regexp/PCRE)</a></li><li><a href="/php/traits.html" class="sidebar-link">Traits</a></li><li><a href="/php/composer-dependency-manager.html" class="sidebar-link">Composer Dependency Manager</a></li><li><a href="/php/magic-methods.html" class="sidebar-link">Magic Methods</a></li><li><a href="/php/file-handling.html" class="sidebar-link">File handling</a></li><li><a href="/php/streams.html" class="sidebar-link">Streams</a></li><li><a href="/php/type-hinting.html" class="sidebar-link">Type hinting</a></li><li><a href="/php/filters-filter-functions.html" class="sidebar-link">Filters &amp; Filter Functions</a></li><li><a href="/php/generators.html" class="sidebar-link">Generators</a></li><li><a href="/php/utf-8.html" class="sidebar-link">UTF-8</a></li><li><a href="/php/how-to-break-down-an-url.html" class="sidebar-link">How to break down an URL</a></li><li><a href="/php/object-serialization.html" class="sidebar-link">Object Serialization</a></li><li><a href="/php/serialization.html" class="sidebar-link">Serialization</a></li><li><a href="/php/closure.html" class="sidebar-link">Closure</a></li><li><a href="/php/reading-request-data.html" class="sidebar-link">Reading Request Data</a></li><li><a href="/php/type-juggling-and-non-strict-comparison-issues.html" class="sidebar-link">Type juggling and Non-Strict Comparison Issues</a></li><li><a href="/php/sockets.html" class="sidebar-link">Sockets</a></li><li><a href="/php/pdo.html" aria-current="page" class="active sidebar-link">PDO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/php/pdo.html#preventing-sql-injection-with-parameterized-queries" class="sidebar-link">Preventing SQL injection with Parameterized Queries</a></li><li class="sidebar-sub-header"><a href="/php/pdo.html#basic-pdo-connection-and-retrieval" class="sidebar-link">Basic PDO Connection and Retrieval</a></li><li class="sidebar-sub-header"><a href="/php/pdo.html#database-transactions-with-pdo" class="sidebar-link">Database Transactions with PDO</a></li><li class="sidebar-sub-header"><a href="/php/pdo.html#pdo-connecting-to-mysql-mariadb-server" class="sidebar-link">PDO: connecting to MySQL/MariaDB server</a></li><li class="sidebar-sub-header"><a href="/php/pdo.html#pdo-get-number-of-affected-rows-by-a-query" class="sidebar-link">PDO: Get number of affected rows by a query</a></li><li class="sidebar-sub-header"><a href="/php/pdo.html#pdo-lastinsertid" class="sidebar-link">PDO::lastInsertId()</a></li></ul></li><li><a href="/php/php-mysqli.html" class="sidebar-link">PHP MySQLi</a></li><li><a href="/php/sqlite3.html" class="sidebar-link">SQLite3</a></li><li><a href="/php/using-mongodb.html" class="sidebar-link">Using MongoDB</a></li><li><a href="/php/mongo-php.html" class="sidebar-link">mongo-php</a></li><li><a href="/php/using-redis-with-php.html" class="sidebar-link">Using Redis with PHP</a></li><li><a href="/php/sending-email.html" class="sidebar-link">Sending Email</a></li><li><a href="/php/using-sqlsrv.html" class="sidebar-link">Using SQLSRV</a></li><li><a href="/php/command-line-interface-cli.html" class="sidebar-link">Command Line Interface (CLI)</a></li><li><a href="/php/localization.html" class="sidebar-link">Localization</a></li><li><a href="/php/headers-manipulation.html" class="sidebar-link">Headers Manipulation</a></li><li><a href="/php/coding-conventions.html" class="sidebar-link">Coding Conventions</a></li><li><a href="/php/asynchronous-programming.html" class="sidebar-link">Asynchronous programming</a></li><li><a href="/php/how-to-detect-client-ip-address.html" class="sidebar-link">How to Detect Client IP Address</a></li><li><a href="/php/create-pdf-files-in-php.html" class="sidebar-link">Create PDF files in PHP</a></li><li><a href="/php/yaml-in-php.html" class="sidebar-link">YAML in PHP</a></li><li><a href="/php/image-processing-with-gd.html" class="sidebar-link">Image Processing with GD</a></li><li><a href="/php/imagick.html" class="sidebar-link">Imagick</a></li><li><a href="/php/soap-server.html" class="sidebar-link">SOAP Server</a></li><li><a href="/php/machine-learning.html" class="sidebar-link">Machine learning</a></li><li><a href="/php/cache.html" class="sidebar-link">Cache</a></li><li><a href="/php/autoloading-primer.html" class="sidebar-link">Autoloading Primer</a></li><li><a href="/php/spl-data-structures.html" class="sidebar-link">SPL data structures</a></li><li><a href="/php/imap.html" class="sidebar-link">IMAP</a></li><li><a href="/php/http-authentication.html" class="sidebar-link">HTTP Authentication</a></li><li><a href="/php/websockets.html" class="sidebar-link">WebSockets</a></li><li><a href="/php/bc-math-binary-calculator.html" class="sidebar-link">BC Math (Binary Calculator)</a></li><li><a href="/php/docker-deployment.html" class="sidebar-link">Docker deployment</a></li><li><a href="/php/apcu.html" class="sidebar-link">APCu</a></li><li><a href="/php/php-built-in-server.html" class="sidebar-link">PHP Built in server</a></li><li><a href="/php/psr.html" class="sidebar-link">PSR</a></li><li><a href="/php/phpdoc.html" class="sidebar-link">PHPDoc</a></li><li><a href="/php/design-patterns.html" class="sidebar-link">Design Patterns</a></li><li><a href="/php/compile-php-extensions.html" class="sidebar-link">Compile PHP Extensions</a></li><li><a href="/php/common-errors.html" class="sidebar-link">Common Errors</a></li><li><a href="/php/compilation-of-errors-and-warnings.html" class="sidebar-link">Compilation of Errors and Warnings</a></li><li><a href="/php/exception-handling-and-error-reporting.html" class="sidebar-link">Exception Handling and Error Reporting</a></li><li><a href="/php/debugging.html" class="sidebar-link">Debugging</a></li><li><a href="/php/unit-testing.html" class="sidebar-link">Unit Testing</a></li><li><a href="/php/performance.html" class="sidebar-link">Performance</a></li><li><a href="/php/multiprocessing.html" class="sidebar-link">Multiprocessing</a></li><li><a href="/php/multi-threading-extension.html" class="sidebar-link">Multi Threading Extension</a></li><li><a href="/php/secure-remeber-me.html" class="sidebar-link">Secure Remeber Me</a></li><li><a href="/php/security.html" class="sidebar-link">Security</a></li><li><a href="/php/cryptography.html" class="sidebar-link">Cryptography</a></li><li><a href="/php/password-hashing-functions.html" class="sidebar-link">Password Hashing Functions</a></li><li><a href="/php/urls.html" class="sidebar-link">URLs</a></li><li><a href="/php/unicode-support-in-php.html" class="sidebar-link">Unicode Support in PHP</a></li><li><a href="/php/getting-started-with-php-7.html" class="sidebar-link">Getting started with php-7</a></li><li><a href="/php/null-coalesce-operator.html" class="sidebar-link">Null Coalesce Operator</a></li><li><a href="/php/spaceship-operator.html" class="sidebar-link">Spaceship operator</a></li><li><a href="/php/anonymous-class.html" class="sidebar-link">Anonymous class</a></li><li><a href="/php/contributing-to-the-php-manual.html" class="sidebar-link">Contributing to the PHP Manual</a></li><li><a href="/php/contributing-to-the-php-core.html" class="sidebar-link">Contributing to the PHP Core</a></li><li><a href="/php/getting-started-with-composer-php.html" class="sidebar-link">Getting started with composer-php</a></li><li><a href="/php/auto-loading-with-composer.html" class="sidebar-link">Auto loading with composer</a></li><li><a href="/php/how-to-use-private-repositories-with-composer.html" class="sidebar-link">How to use private repositories with Composer</a></li><li><a href="/php/getting-started-with-phpunit.html" class="sidebar-link">Getting Started with PHPUnit</a></li><li><a href="/php/assertions.html" class="sidebar-link">Assertions</a></li><li><a href="/php/test-doubles-mocks-and-stubs.html" class="sidebar-link">Test Doubles (Mocks and Stubs)</a></li><li><a href="/php/recipes.html" class="sidebar-link">Recipes</a></li><li><a href="/php/php-mysqli-affected-rows-returns-0-when-it-should-return-a-positive-integer.html" class="sidebar-link">php mysqli affected rows returns 0 when it should return a positive integer</a></li><li><a href="/php/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="pdo"><a href="#pdo" class="header-anchor">#</a> PDO</h1> <p>The <a href="http://php.net/manual/en/book.pdo.php" target="_blank" rel="noopener noreferrer">PDO<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (PHP Data Objects) extension allows developers to connect to numerous different types of databases and execute queries against them in a uniform, object oriented manner.</p> <h2 id="preventing-sql-injection-with-parameterized-queries"><a href="#preventing-sql-injection-with-parameterized-queries" class="header-anchor">#</a> Preventing SQL injection with Parameterized Queries</h2> <p>SQL injection is a kind of attack that allows a malicious user to modify the SQL query, adding unwanted commands to it. For example, the following code is <strong>vulnerable</strong>:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Do not use this vulnerable code!</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'SELECT name, email, user_level FROM users WHERE userID = '</span> <span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>This allows any user of this script to modify our database basically at will. For example consider the following query string:</p> <div class="language-php extra-class"><pre class="language-php"><code>page<span class="token operator">.</span>php<span class="token operator">?</span>user<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token operator">%</span><span class="token number">20</span>TRUNCATE<span class="token operator">%</span><span class="token number">20</span>TABLE<span class="token operator">%</span><span class="token number">20</span>users<span class="token punctuation">;</span>

</code></pre></div><p>This makes our example query look like this</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token constant">SELECT</span> name<span class="token punctuation">,</span> email<span class="token punctuation">,</span> user_level <span class="token constant">FROM</span> users <span class="token constant">WHERE</span> userID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token constant">TRUNCATE</span> <span class="token constant">TABLE</span> users<span class="token punctuation">;</span>

</code></pre></div><p>While this is an extreme example (most SQL injection attacks do not aim to delete data, nor do most PHP query execution functions support multi-query), this is an example of how a SQL injection attack can be made possible by the careless assembly of the query. Unfortunately, attacks like this are very common, and are highly effective due to coders who fail to take proper precautions to protect their data.</p> <p>To prevent SQL injection from occurring, <strong>prepared statements</strong> are the recommended solution. Instead of concatenating user data directly to the query, a <strong>placeholder</strong> is used instead. The data is then sent separately, which means there is no chance of the SQL engine confusing user data for a set of instructions.</p> <blockquote></blockquote> <p>While the topic here is PDO, please note that the PHP MySQLi extension also <a href="http://stackoverflow.com/documentation/php/2784/php-mysqli/11958/prepared-statements-in-mysqli" target="_blank" rel="noopener noreferrer">supports prepared statements<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>PDO supports two kinds of placeholders (placeholders cannot be used for column or table names, only values):</p> <li>
Named placeholders. A colon(`:`), followed by a distinct name (eg. `:user`)
<div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// using named placeholders</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'SELECT name, email, user_level FROM users WHERE userID = :user'</span><span class="token punctuation">;</span>
<span class="token variable">$prep</span> <span class="token operator">=</span> <span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$prep</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span> <span class="token operator">=&gt;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// associative array</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$prep</span><span class="token operator">-&gt;</span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div></li> <li>
Traditional SQL positional placeholders, represented as `?`:
<div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// using question-mark placeholders</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'SELECT name, user_level FROM users WHERE userID = ? AND user_level = ?'</span><span class="token punctuation">;</span>
<span class="token variable">$prep</span> <span class="token operator">=</span> <span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$prep</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user_level'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// indexed array</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$prep</span><span class="token operator">-&gt;</span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div></li> <p>If ever you need to dynamically change table or column names, know that this is at your own security risks and a bad practice. Though, it can be done by string concatenation. One way to improve security of such queries is to set a table of allowed values and compare the value you want to concatenate to this table.</p> <p>Be aware that it is important to set connection charset through DSN only, otherwise your application could be prone to an <a href="https://stackoverflow.com/questions/134099/are-pdo-prepared-statements-sufficient-to-prevent-sql-injection/12202218#12202218" target="_blank" rel="noopener noreferrer">obscure vulnerability<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> if some odd encoding is used. For PDO versions prior to 5.3.6 setting charset through DSN is not available and thus the only option is to set <code>PDO::ATTR_EMULATE_PREPARES</code> attribute  to <code>false</code> on the connection right after it’s created.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_EMULATE_PREPARES</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>This causes PDO to use the underlying DBMS’s native prepared statements instead of just emulating it.</p> <p>However, be aware that PDO will <a href="https://github.com/php/php-src/blob/master/ext/pdo_mysql/mysql_driver.c#L210" target="_blank" rel="noopener noreferrer">silently fallback<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to emulating statements that MySQL cannot prepare natively: those that it can are <a href="http://dev.mysql.com/doc/en/sql-syntax-prepared-statements.html" target="_blank" rel="noopener noreferrer">listed in the manual<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (<a href="https://stackoverflow.com/questions/134099/are-pdo-prepared-statements-sufficient-to-prevent-sql-injection/12202218#12202218" target="_blank" rel="noopener noreferrer">source<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p> <h2 id="basic-pdo-connection-and-retrieval"><a href="#basic-pdo-connection-and-retrieval" class="header-anchor">#</a> Basic PDO Connection and Retrieval</h2> <p>Since PHP 5.0, <a href="http://php.net/manual/en/intro.pdo.php" target="_blank" rel="noopener noreferrer">PDO<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> has been available as a database access layer. It is database agnostic, and so the following connection example code should work for any <a href="http://php.net/manual/en/pdo.drivers.php" target="_blank" rel="noopener noreferrer">of its supported databases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> simply by changing the DSN.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// First, create the database handle</span>

<span class="token comment">//Using MySQL (connection via local socket):</span>
<span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;mysql:host=localhost;dbname=testdb;charset=utf8&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//Using MySQL (connection via network, optionally you can specify the port too):</span>
<span class="token comment">//$dsn = &quot;mysql:host=127.0.0.1;port=3306;dbname=testdb;charset=utf8&quot;;</span>

<span class="token comment">//Or Postgres</span>
<span class="token comment">//$dsn = &quot;pgsql:host=localhost;port=5432;dbname=testdb;&quot;;</span>

<span class="token comment">//Or even SQLite</span>
<span class="token comment">//$dsn = &quot;sqlite:/path/to/database&quot;</span>

<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;user&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;pass&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// setup PDO to throw an exception if an invalid query is provided</span>
<span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Next, let's prepare a statement for execution, with a single placeholder</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;SELECT * FROM users WHERE class = ?&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create some parameters to fill the placeholders, and execute the statement</span>
<span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string double-quoted-string">&quot;221B&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$statement</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token variable">$parameters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Now, loop through each record as an associative array</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$statement</span><span class="token operator">-&gt;</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">FETCH_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">do_stuff</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>The <a href="http://php.net/manual/en/pdo.prepare.php" target="_blank" rel="noopener noreferrer"><code>prepare</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function creates a <code>PDOStatement</code> object from the query string. The execution of the query and retrieval of the results are performed on this returned object. In case of a failure, the function either returns <code>false</code> or throws an <code>exception</code> (depending upon how the PDO connection was configured).</p> <h2 id="database-transactions-with-pdo"><a href="#database-transactions-with-pdo" class="header-anchor">#</a> Database Transactions with PDO</h2> <p>Database transactions ensure that a set of data changes will only be made permanent if every statement is successful.  Any query or code failure during a transaction can be caught and you then have the option to roll back the attempted changes.</p> <p>PDO provides simple methods for beginning, committing, and rollbacking back transactions.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span>
    <span class="token variable">$dsn</span><span class="token punctuation">,</span> 
    <span class="token variable">$username</span><span class="token punctuation">,</span> 
    <span class="token variable">$password</span><span class="token punctuation">,</span> 
    <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span> <span class="token operator">=&gt;</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;UPDATE user SET name = :name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$statement</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;name&quot;</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'Bob'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$statement</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;name&quot;</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'Joe'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">inTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If we got here our two data updates are not in the database</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token variable">$e</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>During a transaction any data changes made are only visible to the active connection.  <code>SELECT</code> statements will return the altered changes even if they are not yet committed to the database.</p> <p><strong>Note</strong>: See database vendor documentation for details about transaction support.  Some systems do not support transactions at all.  Some support nested transactions while others do not.</p> <p><strong>Practical Example Using Transactions with PDO</strong></p> <p>In the following section is demonstrated a practical real world example where the use of transactions ensures the consistency of database.</p> <p>Imagine the following scenario, let's say you are building a shopping cart for an e-commerce website and you decided to keep the orders in two database tables. One named <code>orders</code> with the fields <code>order_id</code>, <code>name</code>, <code>address</code>, <code>telephone</code> and <code>created_at</code>. And a second one named <code>orders_products</code> with the fields <code>order_id</code>, <code>product_id</code> and <code>quantity</code>. The first table contains the <strong>metadata</strong> of the order while the second one the actual <strong>products</strong> that have been ordered.</p> <p><strong>Inserting a new order to the database</strong></p> <p>To insert a new order into the database you need to do two things. First you need to <code>INSERT</code> a new record inside the <code>orders</code> table that will contain the <strong>metadata</strong> of the order (<code>name</code>, <code>address</code>, etc). And then you need to <code>INSERT</code> one record into the <code>orders_products</code> table, for each one of the products that are included in the order.</p> <p>You could do this by doing something similar to the following:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Insert the metadata of the order into the database</span>
<span class="token variable">$preparedStatement</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'INSERT INTO `orders` (`name`, `address`, `telephone`, `created_at`)
     VALUES (:name, :address, :telephone, :created_at)'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$preparedStatement</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token variable">$name</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'address'</span> <span class="token operator">=&gt;</span> <span class="token variable">$address</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'telephone'</span> <span class="token operator">=&gt;</span> <span class="token variable">$telephone</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'created_at'</span> <span class="token operator">=&gt;</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get the generated `order_id`</span>
<span class="token variable">$orderId</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">lastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Construct the query for inserting the products of the order</span>
<span class="token variable">$insertProductsQuery</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'INSERT INTO `orders_products` (`order_id`, `product_id`, `quantity`) VALUES'</span><span class="token punctuation">;</span>

<span class="token variable">$count</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span> <span class="token variable">$products</span> <span class="token keyword">as</span> <span class="token variable">$productId</span> <span class="token operator">=&gt;</span> <span class="token variable">$quantity</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$insertProductsQuery</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">' (:order_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span> <span class="token operator">.</span> <span class="token string single-quoted-string">', :product_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span> <span class="token operator">.</span> <span class="token string single-quoted-string">', :quantity'</span> <span class="token operator">.</span> <span class="token variable">$count</span> <span class="token operator">.</span> <span class="token string single-quoted-string">')'</span><span class="token punctuation">;</span>
    
    <span class="token variable">$insertProductsParams</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'order_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$orderId</span><span class="token punctuation">;</span>
    <span class="token variable">$insertProductsParams</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'product_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$productId</span><span class="token punctuation">;</span>
    <span class="token variable">$insertProductsParams</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'quantity'</span> <span class="token operator">.</span> <span class="token variable">$count</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$quantity</span><span class="token punctuation">;</span>
    
    <span class="token operator">++</span><span class="token variable">$count</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Insert the products included in the order into the database</span>
<span class="token variable">$preparedStatement</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$insertProductsQuery</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$preparedStatement</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token variable">$insertProductsParams</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>This will work great for inserting a new order into the database, until something unexpected happens and for some reason the second <code>INSERT</code> query fails. If that happens you will end up with a new order inside the <code>orders</code> table, which will have no products associated to it. Fortunately, the fix is very simple, all you have to do is to make the queries in the form of a single database transaction.</p> <p><strong>Inserting a new order into the database with a transaction</strong></p> <p>To start a transaction using <code>PDO</code> all you have to do is to call the <code>beginTransaction</code> method before you execute any queries to your database. Then you make any changes you want to your data by executing <code>INSERT</code> and / or <code>UPDATE</code> queries. And finally you call the <code>commit</code> method of the <code>PDO</code> object to make the changes permanent. Until you call the <code>commit</code> method every change you have done to your data up to this point is not yet permanent, and can be easily reverted by simply calling the <code>rollback</code> method of the <code>PDO</code> object.</p> <p>On the following example is demonstrated the use of transactions for inserting a new order into the database, while ensuring the same time the consistency of the data. If one of the two queries fails all the changes will be reverted.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// In this example we are using MySQL but this applies to any database that has support for transactions</span>
<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'mysql:host='</span> <span class="token operator">.</span> <span class="token variable">$host</span> <span class="token operator">.</span> <span class="token string single-quoted-string">';dbname='</span> <span class="token operator">.</span> <span class="token variable">$dbname</span> <span class="token operator">.</span> <span class="token string single-quoted-string">';charset=utf8'</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

<span class="token comment">// Make sure that PDO will throw an exception in case of error to make error handling easier</span>
<span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// From this point and until the transaction is being committed every change to the database can be reverted</span>
    <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    
    <span class="token comment">// Insert the metadata of the order into the database</span>
    <span class="token variable">$preparedStatement</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span>
        <span class="token string single-quoted-string">'INSERT INTO `orders` (`order_id`, `name`, `address`, `created_at`)
         VALUES (:name, :address, :telephone, :created_at)'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token variable">$preparedStatement</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token variable">$name</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'address'</span> <span class="token operator">=&gt;</span> <span class="token variable">$address</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'telephone'</span> <span class="token operator">=&gt;</span> <span class="token variable">$telephone</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'created_at'</span> <span class="token operator">=&gt;</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Get the generated `order_id`</span>
    <span class="token variable">$orderId</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">lastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Construct the query for inserting the products of the order</span>
    <span class="token variable">$insertProductsQuery</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'INSERT INTO `orders_products` (`order_id`, `product_id`, `quantity`) VALUES'</span><span class="token punctuation">;</span>
    
    <span class="token variable">$count</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span> <span class="token variable">$products</span> <span class="token keyword">as</span> <span class="token variable">$productId</span> <span class="token operator">=&gt;</span> <span class="token variable">$quantity</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$insertProductsQuery</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">' (:order_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span> <span class="token operator">.</span> <span class="token string single-quoted-string">', :product_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span> <span class="token operator">.</span> <span class="token string single-quoted-string">', :quantity'</span> <span class="token operator">.</span> <span class="token variable">$count</span> <span class="token operator">.</span> <span class="token string single-quoted-string">')'</span><span class="token punctuation">;</span>
        
        <span class="token variable">$insertProductsParams</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'order_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$orderId</span><span class="token punctuation">;</span>
        <span class="token variable">$insertProductsParams</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'product_id'</span> <span class="token operator">.</span> <span class="token variable">$count</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$productId</span><span class="token punctuation">;</span>
        <span class="token variable">$insertProductsParams</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'quantity'</span> <span class="token operator">.</span> <span class="token variable">$count</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$quantity</span><span class="token punctuation">;</span>
        
        <span class="token operator">++</span><span class="token variable">$count</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Insert the products included in the order into the database</span>
    <span class="token variable">$preparedStatement</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$insertProductsQuery</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$preparedStatement</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token variable">$insertProductsParams</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Make the changes to the database permanent</span>
    <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span> <span class="token class-name type-declaration">PDOException</span> <span class="token variable">$e</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// Failed to insert the order into the database so we rollback any changes</span>
    <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token variable">$e</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="pdo-connecting-to-mysql-mariadb-server"><a href="#pdo-connecting-to-mysql-mariadb-server" class="header-anchor">#</a> PDO: connecting to MySQL/MariaDB server</h2> <p>There are two ways to connect to a MySQL/MariaDB server, depending on your infrastructure.</p> <h3 id="standard-tcp-ip-connection"><a href="#standard-tcp-ip-connection" class="header-anchor">#</a> Standard (TCP/IP) connection</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'mysql:dbname=demo;host=server;port=3306;charset=utf8'</span><span class="token punctuation">;</span>
<span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>PDO</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// throw exceptions, when SQL error is caused</span>
<span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>PDO</span><span class="token operator">::</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prevent emulation of prepared statements</span>
<span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>PDO</span><span class="token operator">::</span><span class="token constant">ATTR_EMULATE_PREPARES</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Since PDO was designed to be compatible with older MySQL server versions (which did not have support for prepared statements), you have to explicitly disable the emulation. Otherwise, you will lose the added <strong>injection prevention</strong> benefits, that are usually granted by using prepared statements.</p> <p>Another design compromise, that you have to keep in mind, is the default error handling behavior. If not otherwise configured, PDO will not show any indications of SQL errors.</p> <p>It is strongly recommended setting it to &quot;exception mode&quot;, because that gains you additional functionality, when writing persistence abstractions (for example: having an exception, when violating <code>UNIQUE</code> constraint).</p> <h3 id="socket-connection"><a href="#socket-connection" class="header-anchor">#</a> Socket connection</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'mysql:unix_socket=/tmp/mysql.sock;dbname=demo;charset=utf8'</span><span class="token punctuation">;</span>
<span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>PDO</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// throw exceptions, when SQL error is caused</span>
<span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>PDO</span><span class="token operator">::</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>PDO</span><span class="token operator">::</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prevent emulation of prepared statements</span>
<span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>PDO</span><span class="token operator">::</span><span class="token constant">ATTR_EMULATE_PREPARES</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>On unix-like systems, if host name is <code>'localhost'</code>, then the connection to the server is made through a domain socket.</p> <h2 id="pdo-get-number-of-affected-rows-by-a-query"><a href="#pdo-get-number-of-affected-rows-by-a-query" class="header-anchor">#</a> PDO: Get number of affected rows by a query</h2> <p>We start off with <code>$db</code>, an instance of the PDO class. After executing a query we often want to determine the number of rows that have been affected by it. The <code>rowCount()</code> method of the <code>PDOStatement</code> will work nicely:</p> <p>NOTE: This method should only be used to determine the number of rows affected by INSERT, DELETE, and UPDATE statements. Although this method may work for SELECT statements as well, it is not consistent across all databases.</p> <h2 id="pdo-lastinsertid"><a href="#pdo-lastinsertid" class="header-anchor">#</a> PDO::lastInsertId()</h2> <p>You may often find the need to get the auto incremented ID value for a row that you have just inserted into your database table.  You can achieve this with the lastInsertId() method.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// 1. Basic connection opening (for MySQL)</span>
<span class="token variable">$host</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">;</span>
<span class="token variable">$database</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'foo'</span><span class="token punctuation">;</span>
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'root'</span>
<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
<span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;mysql:host=<span class="token interpolation"><span class="token variable">$host</span></span>;dbname=<span class="token interpolation"><span class="token variable">$database</span></span>;charset=utf8&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. Inserting an entry in the hypothetical table 'foo_user'</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;INSERT INTO foo_user(pseudo, email) VALUES ('anonymous', 'anonymous@example.com')&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$query_success</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. Retrieving the last inserted id</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">lastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// return value is an integer</span>

</code></pre></div><p>In postgresql and oracle, there is the RETURNING Keyword, which returns the specified columns of the currently inserted / modified rows.
Here example for inserting one entry:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// 1. Basic connection opening (for PGSQL)</span>
<span class="token variable">$host</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">;</span>
<span class="token variable">$database</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'foo'</span><span class="token punctuation">;</span>
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'root'</span>
<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
<span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;pgsql:host=<span class="token interpolation"><span class="token variable">$host</span></span>;dbname=<span class="token interpolation"><span class="token variable">$database</span></span>;charset=utf8&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$pdo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. Inserting an entry in the hypothetical table 'foo_user'</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;INSERT INTO foo_user(pseudo, email) VALUES ('anonymous', 'anonymous@example.com') RETURNING id&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. Retrieving the last inserted id</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$statement</span><span class="token operator">-&gt;</span><span class="token function">fetchColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// return the value of the id column of the new row in foo_user</span>

</code></pre></div><h4 id="syntax"><a href="#syntax" class="header-anchor">#</a> Syntax</h4> <ul><li><a href="http://php.net/manual/fr/pdo.lastinsertid.php" target="_blank" rel="noopener noreferrer"><code>PDO::LastInsertId()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://php.net/manual/fr/pdo.lastinsertid.php" target="_blank" rel="noopener noreferrer"><code>PDO::LastInsertId($columnName)</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> // some drivers need the column name</li></ul> <h4 id="remarks"><a href="#remarks" class="header-anchor">#</a> Remarks</h4> <p><strong>Warning</strong>
Do not miss to check for exceptions while using <a href="http://php.net/manual/fr/pdo.lastinsertid.php" target="_blank" rel="noopener noreferrer"><code>lastInsertId()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It can throw the following error:</p> <blockquote></blockquote> <p>SQLSTATE IM001 : Driver does not support this function</p> <p>Here is how you should properly check for exceptions using this method :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Retrieving the last inserted id</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$pdo</span><span class="token operator">-&gt;</span><span class="token function">lastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// return value is an integer    </span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span> <span class="token class-name type-declaration">PDOException</span> <span class="token variable">$e</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/php/pdo.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/php/sockets.html" class="prev">
        Sockets
      </a></span> <span class="next"><a href="/php/php-mysqli.html">
        PHP MySQLi
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/2489.6834e688.js" defer></script>
  </body>
</html>
