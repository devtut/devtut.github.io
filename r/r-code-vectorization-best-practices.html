<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>R - R code vectorization best practices</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="By row operations">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="R - R code vectorization best practices">
    <meta property="og:description" content="By row operations">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/r/r-code-vectorization-best-practices.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="R - R code vectorization best practices">
    <meta name="twitter:description" content="By row operations">
    <meta name="twitter:url" content="/r/r-code-vectorization-best-practices.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    <link rel="preload" href="/assets/css/0.styles.8b877eb8.css" as="style"><link rel="preload" href="/assets/js/app.ced448ab.js" as="script"><link rel="preload" href="/assets/js/3.f1d73125.js" as="script"><link rel="preload" href="/assets/js/2929.01678933.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8b877eb8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>R</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/r/" class="sidebar-link">Disclaimer</a></li><li><a href="/r/getting-started-with-r-language.html" class="sidebar-link">Getting started with R Language</a></li><li><a href="/r/variables.html" class="sidebar-link">Variables</a></li><li><a href="/r/arithmetic-operators.html" class="sidebar-link">Arithmetic Operators</a></li><li><a href="/r/matrices.html" class="sidebar-link">Matrices</a></li><li><a href="/r/formula.html" class="sidebar-link">Formula</a></li><li><a href="/r/reading-and-writing-strings.html" class="sidebar-link">Reading and writing strings</a></li><li><a href="/r/string-manipulation-with-stringi-package.html" class="sidebar-link">String manipulation with stringi package</a></li><li><a href="/r/classes.html" class="sidebar-link">Classes</a></li><li><a href="/r/lists.html" class="sidebar-link">Lists</a></li><li><a href="/r/hashmaps.html" class="sidebar-link">Hashmaps</a></li><li><a href="/r/creating-vectors.html" class="sidebar-link">Creating vectors</a></li><li><a href="/r/date-and-time.html" class="sidebar-link">Date and Time</a></li><li><a href="/r/the-date-class.html" class="sidebar-link">The Date class</a></li><li><a href="/r/date-time-classes-posixct-and-posixlt.html" class="sidebar-link">Date-time classes (POSIXct and POSIXlt)</a></li><li><a href="/r/the-character-class.html" class="sidebar-link">The character class</a></li><li><a href="/r/numeric-classes-and-storage-modes.html" class="sidebar-link">Numeric classes and storage modes</a></li><li><a href="/r/the-logical-class.html" class="sidebar-link">The logical class</a></li><li><a href="/r/data-frames.html" class="sidebar-link">Data frames</a></li><li><a href="/r/split-function.html" class="sidebar-link">Split function</a></li><li><a href="/r/reading-and-writing-tabular-data-in-plain-text-files-csv-tsv-etc.html" class="sidebar-link">Reading and writing tabular data in plain-text files (CSV, TSV, etc.)</a></li><li><a href="/r/pipe-operators-and-others.html" class="sidebar-link">Pipe operators (%&gt;% and others)</a></li><li><a href="/r/linear-models-regression.html" class="sidebar-link">Linear Models (Regression)</a></li><li><a href="/r/data-table.html" class="sidebar-link">data.table</a></li><li><a href="/r/pivot-and-unpivot-with-data-table.html" class="sidebar-link">Pivot and unpivot with data.table</a></li><li><a href="/r/bar-chart.html" class="sidebar-link">Bar Chart</a></li><li><a href="/r/base-plotting.html" class="sidebar-link">Base Plotting</a></li><li><a href="/r/boxplot.html" class="sidebar-link">boxplot</a></li><li><a href="/r/ggplot2.html" class="sidebar-link">ggplot2</a></li><li><a href="/r/factors.html" class="sidebar-link">Factors</a></li><li><a href="/r/pattern-matching-and-replacement.html" class="sidebar-link">Pattern Matching and Replacement</a></li><li><a href="/r/run-length-encoding.html" class="sidebar-link">Run-length encoding</a></li><li><a href="/r/speeding-up-tough-to-vectorize-code.html" class="sidebar-link">Speeding up tough-to-vectorize code</a></li><li><a href="/r/introduction-to-geographical-maps.html" class="sidebar-link">Introduction to Geographical Maps</a></li><li><a href="/r/set-operations.html" class="sidebar-link">Set operations</a></li><li><a href="/r/tidyverse.html" class="sidebar-link">tidyverse</a></li><li><a href="/r/rcpp.html" class="sidebar-link">Rcpp</a></li><li><a href="/r/random-numbers-generator.html" class="sidebar-link">Random Numbers Generator</a></li><li><a href="/r/parallel-processing.html" class="sidebar-link">Parallel processing</a></li><li><a href="/r/subsetting.html" class="sidebar-link">Subsetting</a></li><li><a href="/r/debugging.html" class="sidebar-link">Debugging</a></li><li><a href="/r/installing-packages.html" class="sidebar-link">Installing packages</a></li><li><a href="/r/updating-r-and-the-package-library.html" class="sidebar-link">Updating R and the package library</a></li><li><a href="/r/inspecting-packages.html" class="sidebar-link">Inspecting packages</a></li><li><a href="/r/creating-packages-with-devtools.html" class="sidebar-link">Creating packages with devtools</a></li><li><a href="/r/using-pipe-assignment-in-your-own-package-how-to.html" class="sidebar-link">Using pipe assignment in your own package %%: How to ?</a></li><li><a href="/r/arima-models.html" class="sidebar-link">Arima Models</a></li><li><a href="/r/distribution-functions.html" class="sidebar-link">Distribution Functions</a></li><li><a href="/r/shiny.html" class="sidebar-link">Shiny</a></li><li><a href="/r/spatial-analysis.html" class="sidebar-link">spatial analysis</a></li><li><a href="/r/sqldf.html" class="sidebar-link">sqldf</a></li><li><a href="/r/code-profiling.html" class="sidebar-link">Code profiling</a></li><li><a href="/r/control-flow-structures.html" class="sidebar-link">Control flow structures</a></li><li><a href="/r/column-wise-operation.html" class="sidebar-link">Column wise operation</a></li><li><a href="/r/json.html" class="sidebar-link">JSON</a></li><li><a href="/r/rodbc.html" class="sidebar-link">RODBC</a></li><li><a href="/r/lubridate.html" class="sidebar-link">lubridate</a></li><li><a href="/r/time-series-and-forecasting.html" class="sidebar-link">Time Series and Forecasting</a></li><li><a href="/r/strsplit-function.html" class="sidebar-link">strsplit function</a></li><li><a href="/r/web-scraping-and-parsing.html" class="sidebar-link">Web scraping and parsing</a></li><li><a href="/r/generalized-linear-models.html" class="sidebar-link">Generalized linear models</a></li><li><a href="/r/reshaping-data-between-long-and-wide-forms.html" class="sidebar-link">Reshaping data between long and wide forms</a></li><li><a href="/r/rmarkdown-and-knitr-presentation.html" class="sidebar-link">RMarkdown and knitr presentation</a></li><li><a href="/r/scope-of-variables.html" class="sidebar-link">Scope of variables</a></li><li><a href="/r/performing-a-permutation-test.html" class="sidebar-link">Performing a Permutation Test</a></li><li><a href="/r/xgboost.html" class="sidebar-link">xgboost</a></li><li><a href="/r/r-code-vectorization-best-practices.html" class="active sidebar-link">R code vectorization best practices</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/r/r-code-vectorization-best-practices.html#by-row-operations" class="sidebar-link">By row operations</a></li></ul></li><li><a href="/r/missing-values.html" class="sidebar-link">Missing values</a></li><li><a href="/r/hierarchical-linear-modeling.html" class="sidebar-link">Hierarchical Linear Modeling</a></li><li><a href="/r/apply-family-of-functions-functionals.html" class="sidebar-link">*apply family of functions (functionals)</a></li><li><a href="/r/text-mining.html" class="sidebar-link">Text mining</a></li><li><a href="/r/anova.html" class="sidebar-link">ANOVA</a></li><li><a href="/r/raster-and-image-analysis.html" class="sidebar-link">Raster and Image Analysis</a></li><li><a href="/r/survival-analysis.html" class="sidebar-link">Survival analysis</a></li><li><a href="/r/fault-tolerant-resilient-code.html" class="sidebar-link">Fault-tolerant/resilient code</a></li><li><a href="/r/reproducible-r.html" class="sidebar-link">Reproducible R</a></li><li><a href="/r/fourier-series-and-transformations.html" class="sidebar-link">Fourier Series and Transformations</a></li><li><a href="/r/rprofile.html" class="sidebar-link">.Rprofile</a></li><li><a href="/r/dplyr.html" class="sidebar-link">dplyr</a></li><li><a href="/r/caret.html" class="sidebar-link">caret</a></li><li><a href="/r/extracting-and-listing-files-in-compressed-archives.html" class="sidebar-link">Extracting and Listing Files in Compressed Archives</a></li><li><a href="/r/probability-distributions-with-r.html" class="sidebar-link">Probability Distributions with R</a></li><li><a href="/r/r-in-latex-with-knitr.html" class="sidebar-link">R in LaTeX with knitr</a></li><li><a href="/r/web-crawling-in-r.html" class="sidebar-link">Web Crawling in R</a></li><li><a href="/r/creating-reports-with-rmarkdown.html" class="sidebar-link">Creating reports with RMarkdown</a></li><li><a href="/r/gpu-accelerated-computing.html" class="sidebar-link">GPU-accelerated computing</a></li><li><a href="/r/heatmap-and-heatmap-2.html" class="sidebar-link">heatmap and heatmap.2</a></li><li><a href="/r/network-analysis-with-the-igraph-package.html" class="sidebar-link">Network analysis with the igraph package</a></li><li><a href="/r/functional-programming.html" class="sidebar-link">Functional programming</a></li><li><a href="/r/get-user-input.html" class="sidebar-link">Get user input</a></li><li><a href="/r/spark-api-sparkr.html" class="sidebar-link">Spark API (SparkR)</a></li><li><a href="/r/meta-documentation-guidelines.html" class="sidebar-link">Meta: Documentation Guidelines</a></li><li><a href="/r/input-and-output.html" class="sidebar-link">Input and output</a></li><li><a href="/r/i-o-for-foreign-tables-excel-sas-spss-stata.html" class="sidebar-link">I/O for foreign tables (Excel, SAS, SPSS, Stata)</a></li><li><a href="/r/i-o-for-database-tables.html" class="sidebar-link">I/O for database tables</a></li><li><a href="/r/i-o-for-geographic-data-shapefiles-etc.html" class="sidebar-link">I/O for geographic data (shapefiles, etc.)</a></li><li><a href="/r/i-o-for-raster-images.html" class="sidebar-link">I/O for raster images</a></li><li><a href="/r/i-o-for-r-s-binary-format.html" class="sidebar-link">I/O for R's binary format</a></li><li><a href="/r/recycling.html" class="sidebar-link">Recycling</a></li><li><a href="/r/expression-parse-eval.html" class="sidebar-link">Expression: parse + eval</a></li><li><a href="/r/regular-expression-syntax-in-r.html" class="sidebar-link">Regular Expression Syntax in R</a></li><li><a href="/r/regular-expressions-regex.html" class="sidebar-link">Regular Expressions (regex)</a></li><li><a href="/r/combinatorics.html" class="sidebar-link">Combinatorics</a></li><li><a href="/r/solving-odes-in-r.html" class="sidebar-link">Solving ODEs in R</a></li><li><a href="/r/feature-selection-in-r-removing-extraneous-features.html" class="sidebar-link">Feature Selection in R -- Removing Extraneous Features</a></li><li><a href="/r/bibliography-in-rmd.html" class="sidebar-link">Bibliography in RMD</a></li><li><a href="/r/writing-functions-in-r.html" class="sidebar-link">Writing functions in R</a></li><li><a href="/r/color-schemes-for-graphics.html" class="sidebar-link">Color schemes for graphics</a></li><li><a href="/r/hierarchical-clustering-with-hclust.html" class="sidebar-link">Hierarchical clustering with hclust</a></li><li><a href="/r/random-forest-algorithm.html" class="sidebar-link">Random Forest Algorithm</a></li><li><a href="/r/restful-r-services.html" class="sidebar-link">RESTful R Services</a></li><li><a href="/r/machine-learning.html" class="sidebar-link">Machine learning</a></li><li><a href="/r/using-texreg-to-export-models-in-a-paper-ready-way.html" class="sidebar-link">Using texreg to export models in a paper-ready way</a></li><li><a href="/r/publishing.html" class="sidebar-link">Publishing</a></li><li><a href="/r/implement-state-machine-pattern-using-s4-class.html" class="sidebar-link">Implement State Machine Pattern using S4 Class</a></li><li><a href="/r/reshape-using-tidyr.html" class="sidebar-link">Reshape using tidyr</a></li><li><a href="/r/modifying-strings-by-substitution.html" class="sidebar-link">Modifying strings by substitution</a></li><li><a href="/r/non-standard-evaluation-and-standard-evaluation.html" class="sidebar-link">Non-standard evaluation and standard evaluation</a></li><li><a href="/r/randomization.html" class="sidebar-link">Randomization</a></li><li><a href="/r/object-oriented-programming-in-r.html" class="sidebar-link">Object-Oriented Programming in R</a></li><li><a href="/r/coercion.html" class="sidebar-link">Coercion</a></li><li><a href="/r/standardize-analyses-by-writing-standalone-r-scripts.html" class="sidebar-link">Standardize analyses by writing standalone R scripts</a></li><li><a href="/r/analyze-tweets-with-r.html" class="sidebar-link">Analyze tweets with R</a></li><li><a href="/r/natural-language-processing.html" class="sidebar-link">Natural language processing</a></li><li><a href="/r/r-markdown-notebooks-from-rstudio.html" class="sidebar-link">R Markdown Notebooks (from RStudio)</a></li><li><a href="/r/aggregating-data-frames.html" class="sidebar-link">Aggregating data frames</a></li><li><a href="/r/data-acquisition.html" class="sidebar-link">Data acquisition</a></li><li><a href="/r/r-memento-by-examples.html" class="sidebar-link">R memento by examples</a></li><li><a href="/r/updating-r-version.html" class="sidebar-link">Updating R version</a></li><li><a href="/r/introspection.html" class="sidebar-link">Introspection</a></li><li><a href="/r/roxygen2.html" class="sidebar-link">roxygen2</a></li><li><a href="/r/cleaning-data.html" class="sidebar-link">Cleaning data</a></li><li><a href="/r/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="r-code-vectorization-best-practices"><a href="#r-code-vectorization-best-practices" class="header-anchor">#</a> R code vectorization best practices</h1> <h2 id="by-row-operations"><a href="#by-row-operations" class="header-anchor">#</a> By row operations</h2> <p>The key in vectorizing R code, is to reduce or eliminate &quot;by row operations&quot; or method dispatching of R functions.</p> <p>That means that when approaching a problem that at first glance requires &quot;by row operations&quot;, such as calculating the means of each row, one needs to ask themselves:</p> <ul><li>What are the classes of the data sets I'm dealing with?</li> <li>Is there an existing compiled code that can achieve this without the need of repetitive evaluation of R functions?</li> <li>If not, can I do these operation by columns instead by row?</li> <li>Finally, is it worth spending a lot of time on developing complicated vectorized code instead of just running a simple <code>apply</code> loop? In other words, is the data big/sophisticated enough that R can't handle it efficiently using a simple loop?</li></ul> <p>Putting aside the memory pre-allocation issue and growing object in loops, we will focus in this example on how to possibly avoid <code>apply</code> loops, method dispatching or re-evaluating R functions within loops.</p> <p>A standard/easy way of calculating mean by row would be:</p> <div class="language-r extra-class"><pre class="language-r"><code>apply<span class="token punctuation">(</span>mtcars<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mean<span class="token punctuation">)</span>
          Mazda RX4       Mazda RX4 Wag          Datsun <span class="token number">710</span>      Hornet <span class="token number">4</span> Drive   Hornet Sportabout             Valiant          Duster <span class="token number">360</span> 
           <span class="token number">29.90727</span>            <span class="token number">29.98136</span>            <span class="token number">23.59818</span>            <span class="token number">38.73955</span>            <span class="token number">53.66455</span>            <span class="token number">35.04909</span>            <span class="token number">59.72000</span> 
          Merc <span class="token number">240</span>D            Merc <span class="token number">230</span>            Merc <span class="token number">280</span>           Merc <span class="token number">280</span>C          Merc <span class="token number">450</span>SE          Merc <span class="token number">450</span>SL         Merc <span class="token number">450</span>SLC 
           <span class="token number">24.63455</span>            <span class="token number">27.23364</span>            <span class="token number">31.86000</span>            <span class="token number">31.78727</span>            <span class="token number">46.43091</span>            <span class="token number">46.50000</span>            <span class="token number">46.35000</span> 
 Cadillac Fleetwood Lincoln Continental   Chrysler Imperial            Fiat <span class="token number">128</span>         Honda Civic      Toyota Corolla       Toyota Corona 
           <span class="token number">66.23273</span>            <span class="token number">66.05855</span>            <span class="token number">65.97227</span>            <span class="token number">19.44091</span>            <span class="token number">17.74227</span>            <span class="token number">18.81409</span>            <span class="token number">24.88864</span> 
   Dodge Challenger         AMC Javelin          Camaro Z28    Pontiac Firebird           Fiat X1<span class="token operator">-</span><span class="token number">9</span>       Porsche <span class="token number">914</span><span class="token operator">-</span><span class="token number">2</span>        Lotus Europa 
           <span class="token number">47.24091</span>            <span class="token number">46.00773</span>            <span class="token number">58.75273</span>            <span class="token number">57.37955</span>            <span class="token number">18.92864</span>            <span class="token number">24.77909</span>            <span class="token number">24.88027</span> 
     Ford Pantera L        Ferrari Dino       Maserati Bora          Volvo <span class="token number">142</span>E 
           <span class="token number">60.97182</span>            <span class="token number">34.50818</span>            <span class="token number">63.15545</span>            <span class="token number">26.26273</span> 

</code></pre></div><p>But can we do better? Lets's see what happened here:</p> <ol><li>First, we converted a <code>data.frame</code> to a <code>matrix</code>. (Note that his happens within the <code>apply</code> function.) This is both inefficient and dangerous. a <code>matrix</code> can't hold several column types at a time. Hence, such conversion will probably lead to loss of information and some times to misleading results (compare <code>apply(iris, 2, class)</code> with <code>str(iris)</code> or with <code>sapply(iris, class)</code>).</li> <li>Second of all, we performed an operation repetitively, one time for each row. Meaning, we had to evaluate some R function <code>nrow(mtcars)</code> times. In this specific case, <code>mean</code> is not a computationally expensive function, hence R could likely easily handle it even for a big data set, but what would happen if we need to calculate the standard deviation by row (which involves an expensive square root operation)? Which brings us to the next point:</li> <li>We evaluated the R function many times, but maybe there already is a compiled version of this operation?</li></ol> <p>Indeed we could simply do:</p> <div class="language-r extra-class"><pre class="language-r"><code>rowMeans<span class="token punctuation">(</span>mtcars<span class="token punctuation">)</span>
          Mazda RX4       Mazda RX4 Wag          Datsun <span class="token number">710</span>      Hornet <span class="token number">4</span> Drive   Hornet Sportabout             Valiant          Duster <span class="token number">360</span> 
           <span class="token number">29.90727</span>            <span class="token number">29.98136</span>            <span class="token number">23.59818</span>            <span class="token number">38.73955</span>            <span class="token number">53.66455</span>            <span class="token number">35.04909</span>            <span class="token number">59.72000</span> 
          Merc <span class="token number">240</span>D            Merc <span class="token number">230</span>            Merc <span class="token number">280</span>           Merc <span class="token number">280</span>C          Merc <span class="token number">450</span>SE          Merc <span class="token number">450</span>SL         Merc <span class="token number">450</span>SLC 
           <span class="token number">24.63455</span>            <span class="token number">27.23364</span>            <span class="token number">31.86000</span>            <span class="token number">31.78727</span>            <span class="token number">46.43091</span>            <span class="token number">46.50000</span>            <span class="token number">46.35000</span> 
 Cadillac Fleetwood Lincoln Continental   Chrysler Imperial            Fiat <span class="token number">128</span>         Honda Civic      Toyota Corolla       Toyota Corona 
           <span class="token number">66.23273</span>            <span class="token number">66.05855</span>            <span class="token number">65.97227</span>            <span class="token number">19.44091</span>            <span class="token number">17.74227</span>            <span class="token number">18.81409</span>            <span class="token number">24.88864</span> 
   Dodge Challenger         AMC Javelin          Camaro Z28    Pontiac Firebird           Fiat X1<span class="token operator">-</span><span class="token number">9</span>       Porsche <span class="token number">914</span><span class="token operator">-</span><span class="token number">2</span>        Lotus Europa 
           <span class="token number">47.24091</span>            <span class="token number">46.00773</span>            <span class="token number">58.75273</span>            <span class="token number">57.37955</span>            <span class="token number">18.92864</span>            <span class="token number">24.77909</span>            <span class="token number">24.88027</span> 
     Ford Pantera L        Ferrari Dino       Maserati Bora          Volvo <span class="token number">142</span>E 
           <span class="token number">60.97182</span>            <span class="token number">34.50818</span>            <span class="token number">63.15545</span>            <span class="token number">26.26273</span> 

</code></pre></div><p>This involves no by row operations and therefore no repetitive evaluation of R functions. <strong>However</strong>, we still converted a <code>data.frame</code> to a <code>matrix</code>. Though <code>rowMeans</code> has an error handling mechanism and it won't run on a data set that it can't handle, it's still has an efficiency cost.</p> <div class="language-r extra-class"><pre class="language-r"><code>rowMeans<span class="token punctuation">(</span>iris<span class="token punctuation">)</span>
Error <span class="token keyword">in</span> rowMeans<span class="token punctuation">(</span>iris<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'x'</span> must be numeric

</code></pre></div><p>But still, can we do better? We could try instead of a matrix conversion with error handling, a different method that will allow us to use <code>mtcars</code> as a vector (because a <code>data.frame</code> is essentially a <code>list</code> and a <code>list</code> is a <code>vector</code>).</p> <div class="language-r extra-class"><pre class="language-r"><code>Reduce<span class="token punctuation">(</span>`<span class="token operator">+</span>`<span class="token punctuation">,</span> mtcars<span class="token punctuation">)</span><span class="token operator">/</span>ncol<span class="token punctuation">(</span>mtcars<span class="token punctuation">)</span>
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">29.90727</span> <span class="token number">29.98136</span> <span class="token number">23.59818</span> <span class="token number">38.73955</span> <span class="token number">53.66455</span> <span class="token number">35.04909</span> <span class="token number">59.72000</span> <span class="token number">24.63455</span> <span class="token number">27.23364</span> <span class="token number">31.86000</span> <span class="token number">31.78727</span> <span class="token number">46.43091</span> <span class="token number">46.50000</span> <span class="token number">46.35000</span> <span class="token number">66.23273</span> <span class="token number">66.05855</span>
<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token number">65.97227</span> <span class="token number">19.44091</span> <span class="token number">17.74227</span> <span class="token number">18.81409</span> <span class="token number">24.88864</span> <span class="token number">47.24091</span> <span class="token number">46.00773</span> <span class="token number">58.75273</span> <span class="token number">57.37955</span> <span class="token number">18.92864</span> <span class="token number">24.77909</span> <span class="token number">24.88027</span> <span class="token number">60.97182</span> <span class="token number">34.50818</span> <span class="token number">63.15545</span> <span class="token number">26.26273</span>

</code></pre></div><p>Now for possible speed gain, we lost column names and error handling (including <code>NA</code> handling).</p> <p>Another example would be calculating mean by group, using base R we could try</p> <div class="language-r extra-class"><pre class="language-r"><code>aggregate<span class="token punctuation">(</span>. <span class="token operator">~</span> cyl<span class="token punctuation">,</span> mtcars<span class="token punctuation">,</span> mean<span class="token punctuation">)</span>
cyl      mpg     disp        hp     drat       wt     qsec        vs        am     gear     carb
<span class="token number">1</span>   <span class="token number">4</span> <span class="token number">26.66364</span> <span class="token number">105.1364</span>  <span class="token number">82.63636</span> <span class="token number">4.070909</span> <span class="token number">2.285727</span> <span class="token number">19.13727</span> <span class="token number">0.9090909</span> <span class="token number">0.7272727</span> <span class="token number">4.090909</span> <span class="token number">1.545455</span>
<span class="token number">2</span>   <span class="token number">6</span> <span class="token number">19.74286</span> <span class="token number">183.3143</span> <span class="token number">122.28571</span> <span class="token number">3.585714</span> <span class="token number">3.117143</span> <span class="token number">17.97714</span> <span class="token number">0.5714286</span> <span class="token number">0.4285714</span> <span class="token number">3.857143</span> <span class="token number">3.428571</span>
<span class="token number">3</span>   <span class="token number">8</span> <span class="token number">15.10000</span> <span class="token number">353.1000</span> <span class="token number">209.21429</span> <span class="token number">3.229286</span> <span class="token number">3.999214</span> <span class="token number">16.77214</span> <span class="token number">0.0000000</span> <span class="token number">0.1428571</span> <span class="token number">3.285714</span> <span class="token number">3.500000</span>

</code></pre></div><p>Still, we are basically evaluating an R function in a loop, but the loop is now hidden in an internal C function (it matters little whether it is a C or an R loop).</p> <p>Could we avoid it? Well there is a compiled function in R called <code>rowsum</code>, hence we could do:</p> <div class="language-r extra-class"><pre class="language-r"><code>rowsum<span class="token punctuation">(</span>mtcars<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mtcars<span class="token operator">$</span>cyl<span class="token punctuation">)</span><span class="token operator">/</span>table<span class="token punctuation">(</span>mtcars<span class="token operator">$</span>cyl<span class="token punctuation">)</span>
mpg     disp        hp     drat       wt     qsec        vs        am     gear     carb
<span class="token number">4</span> <span class="token number">26.66364</span> <span class="token number">105.1364</span>  <span class="token number">82.63636</span> <span class="token number">4.070909</span> <span class="token number">2.285727</span> <span class="token number">19.13727</span> <span class="token number">0.9090909</span> <span class="token number">0.7272727</span> <span class="token number">4.090909</span> <span class="token number">1.545455</span>
<span class="token number">6</span> <span class="token number">19.74286</span> <span class="token number">183.3143</span> <span class="token number">122.28571</span> <span class="token number">3.585714</span> <span class="token number">3.117143</span> <span class="token number">17.97714</span> <span class="token number">0.5714286</span> <span class="token number">0.4285714</span> <span class="token number">3.857143</span> <span class="token number">3.428571</span>
<span class="token number">8</span> <span class="token number">15.10000</span> <span class="token number">353.1000</span> <span class="token number">209.21429</span> <span class="token number">3.229286</span> <span class="token number">3.999214</span> <span class="token number">16.77214</span> <span class="token number">0.0000000</span> <span class="token number">0.1428571</span> <span class="token number">3.285714</span> <span class="token number">3.500000</span>

</code></pre></div><p>Though we had to convert to a matrix first too.</p> <p>A this point we may question whether our current data structure is the most appropriate one. Is a <code>data.frame</code> is the best practice? Or should one just switch to a <code>matrix</code> data structure in order to gain efficiency?</p> <p>By row operations will get more and more expensive (even in matrices) as we start to evaluate expensive functions each time. Lets us consider a variance calculation by row example.</p> <p>Lets say we have a matrix <code>m</code>:</p> <div class="language-r extra-class"><pre class="language-r"><code>set.seed<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
m <span class="token operator">&lt;-</span> matrix<span class="token punctuation">(</span>sample<span class="token punctuation">(</span><span class="token number">1e2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
m
      <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">]</span>    <span class="token number">8</span>   <span class="token number">33</span>   <span class="token number">39</span>   <span class="token number">86</span>   <span class="token number">71</span>  <span class="token number">100</span>   <span class="token number">81</span>   <span class="token number">68</span>   <span class="token number">89</span>    <span class="token number">84</span>
 <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">12</span>   <span class="token number">16</span>   <span class="token number">57</span>   <span class="token number">80</span>   <span class="token number">32</span>   <span class="token number">82</span>   <span class="token number">69</span>   <span class="token number">11</span>   <span class="token number">41</span>    <span class="token number">92</span>
 <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">62</span>   <span class="token number">91</span>   <span class="token number">53</span>   <span class="token number">13</span>   <span class="token number">42</span>   <span class="token number">31</span>   <span class="token number">60</span>   <span class="token number">70</span>   <span class="token number">98</span>    <span class="token number">79</span>
 <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">66</span>   <span class="token number">94</span>   <span class="token number">29</span>   <span class="token number">67</span>   <span class="token number">45</span>   <span class="token number">59</span>   <span class="token number">20</span>   <span class="token number">96</span>   <span class="token number">64</span>     <span class="token number">1</span>
 <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">36</span>   <span class="token number">63</span>   <span class="token number">76</span>    <span class="token number">6</span>   <span class="token number">10</span>   <span class="token number">48</span>   <span class="token number">85</span>   <span class="token number">75</span>   <span class="token number">99</span>     <span class="token number">2</span>
 <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">18</span>    <span class="token number">4</span>   <span class="token number">27</span>   <span class="token number">19</span>   <span class="token number">44</span>   <span class="token number">56</span>   <span class="token number">37</span>   <span class="token number">95</span>   <span class="token number">26</span>    <span class="token number">40</span>
 <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token punctuation">]</span>    <span class="token number">3</span>   <span class="token number">24</span>   <span class="token number">21</span>   <span class="token number">25</span>   <span class="token number">52</span>   <span class="token number">51</span>   <span class="token number">83</span>   <span class="token number">28</span>   <span class="token number">49</span>    <span class="token number">17</span>
 <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">46</span>    <span class="token number">5</span>   <span class="token number">22</span>   <span class="token number">43</span>   <span class="token number">47</span>   <span class="token number">74</span>   <span class="token number">35</span>   <span class="token number">97</span>   <span class="token number">77</span>    <span class="token number">65</span>
 <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">55</span>   <span class="token number">54</span>   <span class="token number">78</span>   <span class="token number">34</span>   <span class="token number">50</span>   <span class="token number">90</span>   <span class="token number">30</span>   <span class="token number">61</span>   <span class="token number">14</span>    <span class="token number">58</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">]</span>   <span class="token number">88</span>   <span class="token number">73</span>   <span class="token number">38</span>   <span class="token number">15</span>    <span class="token number">9</span>   <span class="token number">72</span>    <span class="token number">7</span>   <span class="token number">93</span>   <span class="token number">23</span>    <span class="token number">87</span>

</code></pre></div><p>One could simply do:</p> <div class="language-r extra-class"><pre class="language-r"><code>apply<span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> var<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token number">871.6556</span>  <span class="token number">957.5111</span>  <span class="token number">699.2111</span>  <span class="token number">941.4333</span> <span class="token number">1237.3333</span>  <span class="token number">641.8222</span>  <span class="token number">539.7889</span>  <span class="token number">759.4333</span>  <span class="token number">500.4889</span> <span class="token number">1255.6111</span>

</code></pre></div><p>On the other hand, one could also completely vectorize this operation by following the formula of variance</p> <div class="language-r extra-class"><pre class="language-r"><code>RowVar <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rowSums<span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> rowMeans<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>dim<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
RowVar<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token number">871.6556</span>  <span class="token number">957.5111</span>  <span class="token number">699.2111</span>  <span class="token number">941.4333</span> <span class="token number">1237.3333</span>  <span class="token number">641.8222</span>  <span class="token number">539.7889</span>  <span class="token number">759.4333</span>  <span class="token number">500.4889</span> <span class="token number">1255.6111</span>

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/r/r-code-vectorization-best-practices.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/r/xgboost.html" class="prev">
        xgboost
      </a></span> <span class="next"><a href="/r/missing-values.html">
        Missing values
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ced448ab.js" defer></script><script src="/assets/js/3.f1d73125.js" defer></script><script src="/assets/js/2929.01678933.js" defer></script>
  </body>
</html>
