<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VBA - Error Handling</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Avoiding error conditions, Custom Errors, Resume keyword, On Error statement">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="VBA - Error Handling">
    <meta property="og:description" content="Avoiding error conditions, Custom Errors, Resume keyword, On Error statement">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/vba/error-handling.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="VBA - Error Handling">
    <meta name="twitter:description" content="Avoiding error conditions, Custom Errors, Resume keyword, On Error statement">
    <meta name="twitter:url" content="/vba/error-handling.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/3422.bce51915.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>VBA</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vba/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/vba/getting-started-with-vba.html" class="sidebar-link">Getting started with VBA</a></li><li><a href="/vba/comments.html" class="sidebar-link">Comments</a></li><li><a href="/vba/string-literals-escaping-non-printable-characters-and-line-continuations.html" class="sidebar-link">String Literals - Escaping, non-printable characters and line-continuations</a></li><li><a href="/vba/vba-option-keyword.html" class="sidebar-link">VBA Option Keyword</a></li><li><a href="/vba/declaring-variables.html" class="sidebar-link">Declaring Variables</a></li><li><a href="/vba/declaring-and-assigning-strings.html" class="sidebar-link">Declaring and assigning strings</a></li><li><a href="/vba/concatenating-strings.html" class="sidebar-link">Concatenating strings</a></li><li><a href="/vba/frequently-used-string-manipulation.html" class="sidebar-link">Frequently used string manipulation</a></li><li><a href="/vba/substrings.html" class="sidebar-link">Substrings</a></li><li><a href="/vba/searching-within-strings-for-the-presence-of-substrings.html" class="sidebar-link">Searching within strings for the presence of substrings</a></li><li><a href="/vba/assigning-strings-with-repeated-characters.html" class="sidebar-link">Assigning strings with repeated characters</a></li><li><a href="/vba/measuring-the-length-of-strings.html" class="sidebar-link">Measuring the length of strings</a></li><li><a href="/vba/converting-other-types-to-strings.html" class="sidebar-link">Converting other types to strings</a></li><li><a href="/vba/date-time-manipulation.html" class="sidebar-link">Date Time Manipulation</a></li><li><a href="/vba/data-types-and-limits.html" class="sidebar-link">Data Types and Limits</a></li><li><a href="/vba/naming-conventions.html" class="sidebar-link">Naming Conventions</a></li><li><a href="/vba/data-structures.html" class="sidebar-link">Data Structures</a></li><li><a href="/vba/arrays.html" class="sidebar-link">Arrays</a></li><li><a href="/vba/copying-returning-and-passing-arrays.html" class="sidebar-link">Copying, returning and passing arrays</a></li><li><a href="/vba/collections.html" class="sidebar-link">Collections</a></li><li><a href="/vba/operators.html" class="sidebar-link">Operators</a></li><li><a href="/vba/sorting.html" class="sidebar-link">Sorting</a></li><li><a href="/vba/flow-control-structures.html" class="sidebar-link">Flow control structures</a></li><li><a href="/vba/passing-arguments-byref-or-byval.html" class="sidebar-link">Passing Arguments ByRef or ByVal</a></li><li><a href="/vba/scripting-filesystemobject.html" class="sidebar-link">Scripting.FileSystemObject</a></li><li><a href="/vba/working-with-files-and-directories-without-using-filesystemobject.html" class="sidebar-link">Working With Files and Directories Without Using FileSystemObject</a></li><li><a href="/vba/reading-2gb-files-in-binary-in-vba-and-file-hashes.html" class="sidebar-link">Reading 2GB+ files in binary in VBA and File Hashes</a></li><li><a href="/vba/creating-a-procedure.html" class="sidebar-link">Creating a procedure</a></li><li><a href="/vba/procedure-calls.html" class="sidebar-link">Procedure Calls</a></li><li><a href="/vba/conditional-compilation.html" class="sidebar-link">Conditional Compilation</a></li><li><a href="/vba/object-oriented-vba.html" class="sidebar-link">Object-Oriented VBA</a></li><li><a href="/vba/creating-a-custom-class.html" class="sidebar-link">Creating a Custom Class</a></li><li><a href="/vba/interfaces.html" class="sidebar-link">Interfaces</a></li><li><a href="/vba/recursion.html" class="sidebar-link">Recursion</a></li><li><a href="/vba/events.html" class="sidebar-link">Events</a></li><li><a href="/vba/scripting-dictionary-object.html" class="sidebar-link">Scripting.Dictionary object</a></li><li><a href="/vba/working-with-ado.html" class="sidebar-link">Working with ADO</a></li><li><a href="/vba/attributes.html" class="sidebar-link">Attributes</a></li><li><a href="/vba/user-forms.html" class="sidebar-link">User Forms</a></li><li><a href="/vba/createobject-vs-getobject.html" class="sidebar-link">CreateObject vs. GetObject</a></li><li><a href="/vba/non-latin-characters.html" class="sidebar-link">Non-Latin Characters</a></li><li><a href="/vba/api-calls.html" class="sidebar-link">API Calls</a></li><li><a href="/vba/automation-or-using-other-applications-libraries.html" class="sidebar-link">Automation or Using other applications Libraries</a></li><li><a href="/vba/macro-security-and-signing-of-vba-projects-modules.html" class="sidebar-link">Macro security and signing of VBA-projects/-modules</a></li><li><a href="/vba/vba-run-time-errors.html" class="sidebar-link">VBA Run-Time Errors</a></li><li><a href="/vba/error-handling.html" aria-current="page" class="active sidebar-link">Error Handling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vba/error-handling.html#avoiding-error-conditions" class="sidebar-link">Avoiding error conditions</a></li><li class="sidebar-sub-header"><a href="/vba/error-handling.html#custom-errors" class="sidebar-link">Custom Errors</a></li><li class="sidebar-sub-header"><a href="/vba/error-handling.html#resume-keyword" class="sidebar-link">Resume keyword</a></li><li class="sidebar-sub-header"><a href="/vba/error-handling.html#on-error-statement" class="sidebar-link">On Error statement</a></li></ul></li><li><a href="/vba/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="error-handling"><a href="#error-handling" class="header-anchor">#</a> Error Handling</h1> <h2 id="avoiding-error-conditions"><a href="#avoiding-error-conditions" class="header-anchor">#</a> Avoiding error conditions</h2> <p>When a runtime error occurs, good code should handle it. The best error handling strategy is to write code that checks for error conditions and simply avoids executing code that results in a runtime error.</p> <p>One key element in reducing runtime errors, is writing small procedures that <strong>do one thing</strong>. The fewer reasons procedures have to fail, the easier the code as a whole is to debug.</p> <p><strong>Avoiding runtime error 91 - Object or With block variable not set:</strong></p> <p>This error will be raised when an object is used before its reference is assigned. One might have a procedure that receives an object parameter:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token keyword">ByVal</span> target <span class="token keyword">As</span> Worksheet<span class="token punctuation">)</span>
    Debug<span class="token punctuation">.</span>Print target<span class="token punctuation">.</span>Name
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>If <code>target</code> isn't assigned a reference, the above code will raise an error that is easily avoided by checking if the object contains an actual object reference:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token keyword">ByVal</span> target <span class="token keyword">As</span> Worksheet<span class="token punctuation">)</span>
    <span class="token keyword">If</span> target <span class="token keyword">Is</span> <span class="token boolean">Nothing</span> <span class="token keyword">Then</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    Debug<span class="token punctuation">.</span>Print target<span class="token punctuation">.</span>Name
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>If <code>target</code> isn't assigned a reference, then the unassigned reference is never used, and no error occurs.</p> <p>This way of early-exiting a procedure when one or more parameter isn't valid, is called a <strong>guard clause</strong>.</p> <p><strong>Avoiding runtime error 9 - Subscript out of range:</strong></p> <p>This error is raised when an array is accessed outside of its boundaries.</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token keyword">ByVal</span> index <span class="token keyword">As</span> <span class="token keyword">Integer</span><span class="token punctuation">)</span>
    Debug<span class="token punctuation">.</span>Print ActiveWorkbook<span class="token punctuation">.</span>Worksheets<span class="token punctuation">(</span>index<span class="token punctuation">)</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>Given an index greater than the number of worksheets in the <code>ActiveWorkbook</code>, the above code will raise a runtime error. A simple guard clause can avoid that:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token keyword">ByVal</span> index <span class="token keyword">As</span> <span class="token keyword">Integer</span><span class="token punctuation">)</span>
    <span class="token keyword">If</span> index <span class="token operator">&gt;</span> ActiveWorkbook<span class="token punctuation">.</span>Worksheets<span class="token punctuation">.</span>Count <span class="token keyword">Or</span> index <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
    Debug<span class="token punctuation">.</span>Print ActiveWorkbook<span class="token punctuation">.</span>Worksheets<span class="token punctuation">(</span>index<span class="token punctuation">)</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>Most runtime errors can be avoided by carefully verifying the values we're using <strong>before</strong> we use them, and branching on another execution path accordingly using a simple <code>If</code> statement - in guard clauses that makes no assumptions and validates a procedure's parameters, or even in the body of larger procedures.</p> <h2 id="custom-errors"><a href="#custom-errors" class="header-anchor">#</a> Custom Errors</h2> <p>Often when writing a specialized class, you'll want it to raise its own specific errors, and you'll want a clean way for user/calling code to handle these custom errors. A neat way to achieve this is by defining a dedicated <code>Enum</code> type:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Option</span> Explicit
<span class="token keyword">Public</span> <span class="token keyword">Enum</span> FoobarError
    Err_FooWasNotBarred <span class="token operator">=</span> vbObjectError <span class="token operator">+</span> <span class="token number">1024</span>
    Err_BarNotInitialized
    Err_SomethingElseHappened
<span class="token keyword">End</span> <span class="token keyword">Enum</span>

</code></pre></div><p>Using the <code>vbObjectError</code> built-in constant ensures the custom error codes don't overlap with reserved/existing error codes. Only the first enum value needs to be explicitly specified, for the underlying value of each <code>Enum</code> member is <code>1</code> greater than the previous member, so the underlying value of <code>Err_BarNotInitialized</code> is implicitly <code>vbObjectError + 1025</code>.</p> <h3 id="raising-your-own-runtime-errors"><a href="#raising-your-own-runtime-errors" class="header-anchor">#</a> Raising your own runtime errors</h3> <p>A runtime error can be raised using the <code>Err.Raise</code> statement, so the custom <code>Err_FooWasNotBarred</code> error can be raised as follows:</p> <div class="language-vb extra-class"><pre class="language-vb"><code>Err<span class="token punctuation">.</span>Raise Err_FooWasNotBarred

</code></pre></div><p>The <code>Err.Raise</code> method can also take custom <code>Description</code> and <code>Source</code> parameters - for this reason it's a good idea to also define constants to hold each custom error's description:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Const</span> Msg_FooWasNotBarred <span class="token keyword">As</span> <span class="token keyword">String</span> <span class="token operator">=</span> <span class="token string">&quot;The foo was not barred.&quot;</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> Msg_BarNotInitialized <span class="token keyword">As</span> <span class="token keyword">String</span> <span class="token operator">=</span> <span class="token string">&quot;The bar was not initialized.&quot;</span>

</code></pre></div><p>And then create a dedicated private method to raise each error:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> OnFooWasNotBarredError<span class="token punctuation">(</span><span class="token keyword">ByVal</span> source <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span>
    Err<span class="token punctuation">.</span>Raise Err_FooWasNotBarred<span class="token punctuation">,</span> source<span class="token punctuation">,</span> Msg_FooWasNotBarred
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token keyword">Private</span> <span class="token keyword">Sub</span> OnBarNotInitializedError<span class="token punctuation">(</span><span class="token keyword">ByVal</span> source <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span>
    Err<span class="token punctuation">.</span>Raise Err_BarNotInitialized<span class="token punctuation">,</span> source<span class="token punctuation">,</span> Msg_BarNotInitialized
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>The class' implementation can then simply call these specialized procedures to raise the error:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Public</span> <span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">'raises the custom 'BarNotInitialized' error with &quot;DoSomething&quot; as the source:</span>
    <span class="token keyword">If</span> <span class="token keyword">Me</span><span class="token punctuation">.</span>Bar <span class="token keyword">Is</span> <span class="token boolean">Nothing</span> <span class="token keyword">Then</span> OnBarNotInitializedError <span class="token string">&quot;DoSomething&quot;</span>
    <span class="token comment">'...</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>The client code can then handle <code>Err_BarNotInitialized</code> as it would any other error, inside its own error-handling subroutine.</p> <p>Note: the legacy <code>Error</code> keyword can also be used in place of <code>Err.Raise</code>, but it's obsolete/deprecated.</p> <h2 id="resume-keyword"><a href="#resume-keyword" class="header-anchor">#</a> Resume keyword</h2> <p>An error-handling subroutine will either:</p> <ul><li>run to the end of the procedure, in which case execution resumes in the calling procedure.</li> <li>or, use the <code>Resume</code> keyword to <strong>resume</strong> execution inside the same procedure.</li></ul> <p>The <code>Resume</code> keyword should only ever be used inside an error handling subroutine, because if VBA encounters <code>Resume</code> without being in an error state, runtime error 20 &quot;Resume without error&quot; is raised.</p> <p>There are several ways an error-handling subroutine may use the <code>Resume</code> keyword:</p> <ul><li><code>Resume</code> used alone, execution continues <strong>on the statement that caused the error</strong>. If the error isn't <strong>actually</strong> handled before doing that, then the same error will be raised again, and execution might enter an infinite loop.</li> <li><code>Resume Next</code> continues execution <strong>on the statement immediately following</strong> the statement that caused the error. If the error isn't <strong>actually</strong> handled before doing that, then execution is permitted to continue with potentially invalid data, which may result in logical errors and unexpected behavior.</li> <li><code>Resume [line label]</code> continues execution <strong>at the specified line label</strong> (or line number, if you're using legacy-style line numbers). This would typically allow executing some cleanup code before cleanly exiting the procedure, such as ensuring a database connection is closed before returning to the caller.</li></ul> <h3 id="on-error-resume-next"><a href="#on-error-resume-next" class="header-anchor">#</a> On Error Resume Next</h3> <p>The <code>On Error</code> statement itself can use the <code>Resume</code> keyword to instruct the VBA runtime to effectively <strong>ignore all errors</strong>.</p> <blockquote></blockquote> <p><strong>If the error isn't <strong>actually handled</strong> before doing that, then execution is permitted to continue with potentially invalid data, which may result in <strong>logical errors and unexpected behavior</strong>.</strong></p> <p>The emphasis above cannot be emphasized enough. <strong><strong>On Error Resume Next</strong> effectively ignores all errors and shoves them under the carpet</strong>. A program that blows up with a runtime error given invalid input is a better program than one that keeps running with unknown/unintended data - be it only because the bug is much more easily identifiable. <code>On Error Resume Next</code> can easily <strong>hide bugs</strong>.</p> <p>The <code>On Error</code> statement is procedure-scoped - that's why there should <strong>normally</strong> be only <strong>one</strong>, single such <code>On Error</code> statement in a given procedure.</p> <p>However <strong>sometimes</strong> an error condition can't quite be avoided, and jumping to an error-handling subroutine only to <code>Resume Next</code> just doesn't feel right. In this specific case, the known-to-possibly-fail statement can be <strong>wrapped</strong> between two <code>On Error</code> statements:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
[possibly<span class="token operator">-</span>failing statement]
Err<span class="token punctuation">.</span>Clear <span class="token comment">'resets current error</span>
<span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>

</code></pre></div><p>The <code>On Error GoTo 0</code> instruction resets error handling in the current procedure, such that any further instruction causing a runtime error <strong>would be unhandled within that procedure</strong> and instead passed up the call stack until it is caught by an active error handler. If there is no active error handler in the call stack, it will be treated as an unhandled exception.</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Public</span> <span class="token keyword">Sub</span> Caller<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> Handler
    
    Callee
    
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
Handler<span class="token punctuation">:</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">&quot;Error &quot;</span> <span class="token operator">&amp;</span> Err<span class="token punctuation">.</span>Number <span class="token operator">&amp;</span> <span class="token string">&quot; in Caller.&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token keyword">Public</span> <span class="token keyword">Sub</span> Callee<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> Handler
    
    Err<span class="token punctuation">.</span>Raise <span class="token number">1</span>     <span class="token comment">'This will be handled by the Callee handler.</span>
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span> <span class="token comment">'After this statement, errors are passed up the stack.</span>
    Err<span class="token punctuation">.</span>Raise <span class="token number">2</span>     <span class="token comment">'This will be handled by the Caller handler.    </span>
    
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
Handler<span class="token punctuation">:</span>
    Debug<span class="token punctuation">.</span>Print <span class="token string">&quot;Error &quot;</span> <span class="token operator">&amp;</span> Err<span class="token punctuation">.</span>Number <span class="token operator">&amp;</span> <span class="token string">&quot; in Callee.&quot;</span>
    <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><h2 id="on-error-statement"><a href="#on-error-statement" class="header-anchor">#</a> On Error statement</h2> <p>Even with <strong>guard clauses</strong>, one cannot realistically <strong>always</strong> account for all possible error conditions that could be raised in the body of a procedure. The <code>On Error GoTo</code> statement instructs VBA to jump to a <strong>line label</strong> and enter &quot;error handling mode&quot; whenever an unexpected error occurs at runtime. After handling an error, code can <strong>resume</strong> back into &quot;normal&quot; execution using the <code>Resume</code> keyword.</p> <p><strong>Line labels</strong> denote <strong>subroutines</strong>: because subroutines originate from legacy BASIC code and uses <code>GoTo</code> and <code>GoSub</code> jumps and <code>Return</code> statements to jump back to the &quot;main&quot; routine, it's fairly easy to write hard-to-follow <strong>spaghetti code</strong> if things aren't rigorously structured. For this reason, it's best that:</p> <ul><li>a procedure has <strong>one and only one</strong> error-handling subroutine</li> <li>the error-handling subroutine <strong>only ever runs in an error state</strong></li></ul> <p>This means a procedure that handles its errors, should be structured like this:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> CleanFail

    <span class="token comment">'procedure code here</span>

CleanExit<span class="token punctuation">:</span>
    <span class="token comment">'cleanup code here</span>
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>

CleanFail<span class="token punctuation">:</span>
    <span class="token comment">'error-handling code here</span>
    <span class="token keyword">Resume</span> CleanExit
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><h3 id="error-handling-strategies"><a href="#error-handling-strategies" class="header-anchor">#</a> Error Handling Strategies</h3> <p>Sometimes you want to handle different errors with different actions. In that case you will inspect the global <code>Err</code> object, which will contain information about the error that was raised - and act accordingly:</p> <div class="language-vb extra-class"><pre class="language-vb"><code>CleanExit<span class="token punctuation">:</span>
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>

CleanFail<span class="token punctuation">:</span>
    <span class="token keyword">Select</span> <span class="token keyword">Case</span> Err<span class="token punctuation">.</span>Number
        <span class="token keyword">Case</span> <span class="token number">9</span>
            MsgBox <span class="token string">&quot;Specified number doesn't exist. Please try again.&quot;</span><span class="token punctuation">,</span> vbExclamation
            <span class="token keyword">Resume</span>
        <span class="token keyword">Case</span> <span class="token number">91</span>
            <span class="token comment">'woah there, this shouldn't be happening.</span>
            <span class="token keyword">Stop</span> <span class="token comment">'execution will break here</span>
            <span class="token keyword">Resume</span> <span class="token comment">'hit F8 to jump to the line that raised the error</span>
        <span class="token keyword">Case</span> <span class="token keyword">Else</span>
            MsgBox <span class="token string">&quot;An unexpected error has occurred:&quot;</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> Err<span class="token punctuation">.</span>Description<span class="token punctuation">,</span> vbCritical
            <span class="token keyword">Resume</span> CleanExit
    <span class="token keyword">End</span> <span class="token keyword">Select</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>As a general guideline, consider turning on the error handling for entire subroutine or function, and handle all the errors that may occur within its scope. If you need to only handle errors in the small section section of the code -- turn error handling on and off a the same level:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span>CheckValue <span class="token keyword">as</span> <span class="token keyword">Long</span><span class="token punctuation">)</span>

    <span class="token keyword">If</span> CheckValue <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span>
        <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> ErrorHandler   <span class="token comment">' turn error handling on</span>
        <span class="token comment">' code that may result in error</span>
        <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">0</span>              <span class="token comment">' turn error handling off - same level</span>
    <span class="token keyword">End</span> <span class="token keyword">If</span>

CleanExit<span class="token punctuation">:</span>
    <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>

ErrorHandler<span class="token punctuation">:</span>
    <span class="token comment">' error handling code here</span>
    <span class="token comment">' do not turn off error handling here</span>
    <span class="token keyword">Resume</span>

<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><h3 id="line-numbers"><a href="#line-numbers" class="header-anchor">#</a> Line numbers</h3> <p>VBA supports legacy-style (e.g. QBASIC) line numbers. The <code>Erl</code> hidden property can be used to identify the line number that raised the last error. If you're not using line numbers, <code>Erl</code> will only ever return 0.</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">10</span> <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">50</span>
<span class="token number">20</span> Debug<span class="token punctuation">.</span>Print <span class="token number">42</span> <span class="token operator">/</span> <span class="token number">0</span>
<span class="token number">30</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
<span class="token number">40</span>
<span class="token number">50</span> Debug<span class="token punctuation">.</span>Print <span class="token string">&quot;Error raised on line &quot;</span> <span class="token operator">&amp;</span> Erl <span class="token comment">' returns 20</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>If you <strong>are</strong> using line numbers, but not consistently, then <code>Erl</code> will return <strong>the last line number before the instruction that raised the error</strong>.</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">10</span> <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">50</span>
   Debug<span class="token punctuation">.</span>Print <span class="token number">42</span> <span class="token operator">/</span> <span class="token number">0</span>
<span class="token number">30</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>

<span class="token number">50</span> Debug<span class="token punctuation">.</span>Print <span class="token string">&quot;Error raised on line &quot;</span> <span class="token operator">&amp;</span> Erl <span class="token comment">'returns 10</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>Keep in mind that <code>Erl</code> also only has <code>Integer</code> precision, and will silently overflow. This means that line numbers outside of the <a href="http://stackoverflow.com/documentation/vba/3418/data-types-and-limits/11777/integer#t=201612061853023563097" target="_blank" rel="noopener noreferrer">integer range<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will give incorrect results:</p> <div class="language-vb extra-class"><pre class="language-vb"><code><span class="token keyword">Sub</span> DoSomething<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">99997</span> <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">GoTo</span> <span class="token number">99999</span>
<span class="token number">99998</span> Debug<span class="token punctuation">.</span>Print <span class="token number">42</span> <span class="token operator">/</span> <span class="token number">0</span>
<span class="token number">99999</span>
      Debug<span class="token punctuation">.</span>Print Erl   <span class="token comment">'Prints 34462</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

</code></pre></div><p>The line number isn't quite as relevant as the statement that caused the error, and numbering lines quickly becomes tedious and not quite maintenance-friendly.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/vba/error-handling.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vba/vba-run-time-errors.html" class="prev">
        VBA Run-Time Errors
      </a></span> <span class="next"><a href="/vba/contributors.html">
        The Contributors
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/3422.bce51915.js" defer></script>
  </body>
</html>
