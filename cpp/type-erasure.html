<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C++ | Type Erasure</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="A move-only `std::function`, Erasing down to a Regular type with manual vtable, Basic mechanism, Erasing down to a contiguous buffer of T, Type erasing type erasure with std::any">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="C++ | Type Erasure">
    <meta property="og:description" content="A move-only `std::function`, Erasing down to a Regular type with manual vtable, Basic mechanism, Erasing down to a contiguous buffer of T, Type erasing type erasure with std::any">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/cpp/type-erasure.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="C++ | Type Erasure">
    <meta name="twitter:description" content="A move-only `std::function`, Erasing down to a Regular type with manual vtable, Basic mechanism, Erasing down to a contiguous buffer of T, Type erasing type erasure with std::any">
    <meta name="twitter:url" content="/cpp/type-erasure.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    
    <link rel="preload" href="/assets/css/0.styles.60619e34.css" as="style"><link rel="preload" href="/assets/js/app.1779e102.js" as="script"><link rel="preload" href="/assets/js/3.2cfa8016.js" as="script"><link rel="preload" href="/assets/js/741.849ce07c.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.60619e34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>C++</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cpp/" aria-current="page" class="sidebar-link">Disclaimer</a></li><li><a href="/cpp/getting-started-with-cpp.html" class="sidebar-link">Getting started with C++</a></li><li><a href="/cpp/literals.html" class="sidebar-link">Literals</a></li><li><a href="/cpp/operator-precedence.html" class="sidebar-link">operator precedence</a></li><li><a href="/cpp/floating-point-arithmetic.html" class="sidebar-link">Floating Point Arithmetic</a></li><li><a href="/cpp/bit-operators.html" class="sidebar-link">Bit Operators</a></li><li><a href="/cpp/bit-manipulation.html" class="sidebar-link">Bit Manipulation</a></li><li><a href="/cpp/bit-fields.html" class="sidebar-link">Bit fields</a></li><li><a href="/cpp/arrays.html" class="sidebar-link">Arrays</a></li><li><a href="/cpp/iterators.html" class="sidebar-link">Iterators</a></li><li><a href="/cpp/basic-input-output-in-c.html" class="sidebar-link">Basic input/output in c++</a></li><li><a href="/cpp/loops.html" class="sidebar-link">Loops</a></li><li><a href="/cpp/file-i-o.html" class="sidebar-link">File I/O</a></li><li><a href="/cpp/cpp-streams.html" class="sidebar-link">C++ Streams</a></li><li><a href="/cpp/stream-manipulators.html" class="sidebar-link">Stream manipulators</a></li><li><a href="/cpp/flow-control.html" class="sidebar-link">Flow Control</a></li><li><a href="/cpp/metaprogramming.html" class="sidebar-link">Metaprogramming</a></li><li><a href="/cpp/const-keyword.html" class="sidebar-link">const keyword</a></li><li><a href="/cpp/mutable-keyword.html" class="sidebar-link">mutable keyword</a></li><li><a href="/cpp/friend-keyword.html" class="sidebar-link">Friend keyword</a></li><li><a href="/cpp/type-keywords.html" class="sidebar-link">Type Keywords</a></li><li><a href="/cpp/basic-type-keywords.html" class="sidebar-link">Basic Type Keywords</a></li><li><a href="/cpp/variable-declaration-keywords.html" class="sidebar-link">Variable Declaration Keywords</a></li><li><a href="/cpp/keywords.html" class="sidebar-link">Keywords</a></li><li><a href="/cpp/returning-several-values-from-a-function.html" class="sidebar-link">Returning several values from a function</a></li><li><a href="/cpp/polymorphism.html" class="sidebar-link">Polymorphism</a></li><li><a href="/cpp/references.html" class="sidebar-link">References</a></li><li><a href="/cpp/value-and-reference-semantics.html" class="sidebar-link">Value and Reference Semantics</a></li><li><a href="/cpp/c-function-call-by-value-vs-call-by-reference.html" class="sidebar-link">C++ function &quot;call by value&quot; vs. &quot;call by reference&quot;</a></li><li><a href="/cpp/copying-vs-assignment.html" class="sidebar-link">Copying vs Assignment</a></li><li><a href="/cpp/pointers.html" class="sidebar-link">Pointers</a></li><li><a href="/cpp/pointers-to-members.html" class="sidebar-link">Pointers to members</a></li><li><a href="/cpp/the-this-pointer.html" class="sidebar-link">The This Pointer</a></li><li><a href="/cpp/smart-pointers.html" class="sidebar-link">Smart Pointers</a></li><li><a href="/cpp/classes-structures.html" class="sidebar-link">Classes/Structures</a></li><li><a href="/cpp/function-overloading.html" class="sidebar-link">Function Overloading</a></li><li><a href="/cpp/operator-overloading.html" class="sidebar-link">Operator Overloading</a></li><li><a href="/cpp/function-template-overloading.html" class="sidebar-link">Function Template Overloading</a></li><li><a href="/cpp/virtual-member-functions.html" class="sidebar-link">Virtual Member Functions</a></li><li><a href="/cpp/inline-functions.html" class="sidebar-link">Inline functions</a></li><li><a href="/cpp/special-member-functions.html" class="sidebar-link">Special Member Functions</a></li><li><a href="/cpp/non-static-member-functions.html" class="sidebar-link">Non-Static Member Functions</a></li><li><a href="/cpp/constant-class-member-functions.html" class="sidebar-link">Constant class member functions</a></li><li><a href="/cpp/c-containers.html" class="sidebar-link">C++ Containers</a></li><li><a href="/cpp/namespaces.html" class="sidebar-link">Namespaces</a></li><li><a href="/cpp/header-files.html" class="sidebar-link">Header Files</a></li><li><a href="/cpp/using-declaration.html" class="sidebar-link">Using declaration</a></li><li><a href="/cpp/std-string.html" class="sidebar-link">std::string</a></li><li><a href="/cpp/std-array.html" class="sidebar-link">std::array</a></li><li><a href="/cpp/std-vector.html" class="sidebar-link">std::vector</a></li><li><a href="/cpp/std-map.html" class="sidebar-link">std::map</a></li><li><a href="/cpp/std-optional.html" class="sidebar-link">std::optional</a></li><li><a href="/cpp/std-function-to-wrap-any-element-that-is-callable.html" class="sidebar-link">std::function: To wrap any element that is callable</a></li><li><a href="/cpp/std-forward-list.html" class="sidebar-link">std::forward_list</a></li><li><a href="/cpp/std-pair.html" class="sidebar-link">std::pair</a></li><li><a href="/cpp/std-atomics.html" class="sidebar-link">std::atomics</a></li><li><a href="/cpp/std-variant.html" class="sidebar-link">std::variant</a></li><li><a href="/cpp/std-iomanip.html" class="sidebar-link">std::iomanip</a></li><li><a href="/cpp/std-any.html" class="sidebar-link">std::any</a></li><li><a href="/cpp/std-set-and-std-multiset.html" class="sidebar-link">std::set and std::multiset</a></li><li><a href="/cpp/std-integer-sequence.html" class="sidebar-link">std::integer_sequence</a></li><li><a href="/cpp/using-std-unordered-map.html" class="sidebar-link">Using std::unordered_map</a></li><li><a href="/cpp/standard-library-algorithms.html" class="sidebar-link">Standard Library Algorithms</a></li><li><a href="/cpp/the-iso-c-standard.html" class="sidebar-link">The ISO C++ Standard</a></li><li><a href="/cpp/inline-variables.html" class="sidebar-link">Inline variables</a></li><li><a href="/cpp/random-number-generation.html" class="sidebar-link">Random number generation</a></li><li><a href="/cpp/date-and-time-using-chrono-header.html" class="sidebar-link">Date and time using  header</a></li><li><a href="/cpp/sorting.html" class="sidebar-link">Sorting</a></li><li><a href="/cpp/enumeration.html" class="sidebar-link">Enumeration</a></li><li><a href="/cpp/iteration.html" class="sidebar-link">Iteration</a></li><li><a href="/cpp/regular-expressions.html" class="sidebar-link">Regular expressions</a></li><li><a href="/cpp/implementation-defined-behavior.html" class="sidebar-link">Implementation-defined behavior</a></li><li><a href="/cpp/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/cpp/lambdas.html" class="sidebar-link">Lambdas</a></li><li><a href="/cpp/value-categories.html" class="sidebar-link">Value Categories</a></li><li><a href="/cpp/preprocessor.html" class="sidebar-link">Preprocessor</a></li><li><a href="/cpp/data-structures-in-c.html" class="sidebar-link">Data Structures in C++</a></li><li><a href="/cpp/templates.html" class="sidebar-link">Templates</a></li><li><a href="/cpp/expression-templates.html" class="sidebar-link">Expression templates</a></li><li><a href="/cpp/curiously-recurring-template-pattern-crtp.html" class="sidebar-link">Curiously Recurring Template Pattern (CRTP)</a></li><li><a href="/cpp/threading.html" class="sidebar-link">Threading</a></li><li><a href="/cpp/thread-synchronization-structures.html" class="sidebar-link">Thread synchronization structures</a></li><li><a href="/cpp/the-rule-of-three-five-and-zero.html" class="sidebar-link">The Rule of Three, Five, And Zero</a></li><li><a href="/cpp/raii-resource-acquisition-is-initialization.html" class="sidebar-link">RAII: Resource Acquisition Is Initialization</a></li><li><a href="/cpp/rtti-run-time-type-information.html" class="sidebar-link">RTTI: Run-Time Type Information</a></li><li><a href="/cpp/mutexes.html" class="sidebar-link">Mutexes</a></li><li><a href="/cpp/recursive-mutex.html" class="sidebar-link">Recursive Mutex</a></li><li><a href="/cpp/semaphore.html" class="sidebar-link">Semaphore</a></li><li><a href="/cpp/futures-and-promises.html" class="sidebar-link">Futures and Promises</a></li><li><a href="/cpp/atomic-types.html" class="sidebar-link">Atomic Types</a></li><li><a href="/cpp/type-erasure.html" aria-current="page" class="active sidebar-link">Type Erasure</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cpp/type-erasure.html#a-move-only-std-function" class="sidebar-link">A move-only std::function</a></li><li class="sidebar-sub-header"><a href="/cpp/type-erasure.html#erasing-down-to-a-regular-type-with-manual-vtable" class="sidebar-link">Erasing down to a Regular type with manual vtable</a></li><li class="sidebar-sub-header"><a href="/cpp/type-erasure.html#basic-mechanism" class="sidebar-link">Basic mechanism</a></li><li class="sidebar-sub-header"><a href="/cpp/type-erasure.html#erasing-down-to-a-contiguous-buffer-of-t" class="sidebar-link">Erasing down to a contiguous buffer of T</a></li><li class="sidebar-sub-header"><a href="/cpp/type-erasure.html#type-erasing-type-erasure-with-std-any" class="sidebar-link">Type erasing type erasure with std::any</a></li></ul></li><li><a href="/cpp/explicit-type-conversions.html" class="sidebar-link">Explicit type conversions</a></li><li><a href="/cpp/unnamed-types.html" class="sidebar-link">Unnamed types</a></li><li><a href="/cpp/type-traits.html" class="sidebar-link">Type Traits</a></li><li><a href="/cpp/return-type-covariance.html" class="sidebar-link">Return Type Covariance</a></li><li><a href="/cpp/layout-of-object-types.html" class="sidebar-link">Layout of object types</a></li><li><a href="/cpp/type-inference.html" class="sidebar-link">Type Inference</a></li><li><a href="/cpp/typedef-and-type-aliases.html" class="sidebar-link">Typedef and type aliases</a></li><li><a href="/cpp/type-deduction.html" class="sidebar-link">type deduction</a></li><li><a href="/cpp/trailing-return-type.html" class="sidebar-link">Trailing return type</a></li><li><a href="/cpp/alignment.html" class="sidebar-link">Alignment</a></li><li><a href="/cpp/perfect-forwarding.html" class="sidebar-link">Perfect Forwarding</a></li><li><a href="/cpp/decltype.html" class="sidebar-link">decltype</a></li><li><a href="/cpp/sfinae-substitution-failure-is-not-an-error.html" class="sidebar-link">SFINAE (Substitution Failure Is Not An Error)</a></li><li><a href="/cpp/undefined-behavior.html" class="sidebar-link">Undefined Behavior</a></li><li><a href="/cpp/overload-resolution.html" class="sidebar-link">Overload resolution</a></li><li><a href="/cpp/move-semantics.html" class="sidebar-link">Move Semantics</a></li><li><a href="/cpp/pimpl-idiom.html" class="sidebar-link">Pimpl Idiom</a></li><li><a href="/cpp/auto.html" class="sidebar-link">auto</a></li><li><a href="/cpp/copy-elision.html" class="sidebar-link">Copy Elision</a></li><li><a href="/cpp/fold-expressions.html" class="sidebar-link">Fold Expressions</a></li><li><a href="/cpp/unions.html" class="sidebar-link">Unions</a></li><li><a href="/cpp/design-pattern-implementation-in-c.html" class="sidebar-link">Design pattern implementation in C++</a></li><li><a href="/cpp/singleton-design-pattern.html" class="sidebar-link">Singleton Design Pattern</a></li><li><a href="/cpp/user-defined-literals.html" class="sidebar-link">User-Defined Literals</a></li><li><a href="/cpp/memory-management.html" class="sidebar-link">Memory management</a></li><li><a href="/cpp/c-11-memory-model.html" class="sidebar-link">C++11 Memory Model</a></li><li><a href="/cpp/scopes.html" class="sidebar-link">Scopes</a></li><li><a href="/cpp/static-assert.html" class="sidebar-link">static_assert</a></li><li><a href="/cpp/constexpr.html" class="sidebar-link">constexpr</a></li><li><a href="/cpp/one-definition-rule-odr.html" class="sidebar-link">One Definition Rule (ODR)</a></li><li><a href="/cpp/unspecified-behavior.html" class="sidebar-link">Unspecified behavior</a></li><li><a href="/cpp/argument-dependent-name-lookup.html" class="sidebar-link">Argument Dependent Name Lookup</a></li><li><a href="/cpp/attributes.html" class="sidebar-link">Attributes</a></li><li><a href="/cpp/recursion-in-c.html" class="sidebar-link">Recursion in C++</a></li><li><a href="/cpp/arithmitic-metaprogramming.html" class="sidebar-link">Arithmitic Metaprogramming</a></li><li><a href="/cpp/callable-objects.html" class="sidebar-link">Callable Objects</a></li><li><a href="/cpp/client-server-examples.html" class="sidebar-link">Client server examples</a></li><li><a href="/cpp/const-correctness.html" class="sidebar-link">Const Correctness</a></li><li><a href="/cpp/parameter-packs.html" class="sidebar-link">Parameter packs</a></li><li><a href="/cpp/build-systems.html" class="sidebar-link">Build Systems</a></li><li><a href="/cpp/concurrency-with-openmp.html" class="sidebar-link">Concurrency With OpenMP</a></li><li><a href="/cpp/resource-management.html" class="sidebar-link">Resource Management</a></li><li><a href="/cpp/storage-class-specifiers.html" class="sidebar-link">Storage class specifiers</a></li><li><a href="/cpp/linkage-specifications.html" class="sidebar-link">Linkage specifications</a></li><li><a href="/cpp/digit-separators.html" class="sidebar-link">Digit separators</a></li><li><a href="/cpp/c-incompatibilities.html" class="sidebar-link">C incompatibilities</a></li><li><a href="/cpp/side-by-side-comparisons-of-classic-c-examples-solved-via-c-vs-c-11-vs-c-14-vs-c-17.html" class="sidebar-link">Side by Side Comparisons of classic C++ examples solved via C++ vs C++11 vs C++14 vs C++17</a></li><li><a href="/cpp/compiling-and-building.html" class="sidebar-link">Compiling and Building</a></li><li><a href="/cpp/common-compile-linker-errors-gcc.html" class="sidebar-link">Common compile/linker errors (GCC)</a></li><li><a href="/cpp/more-undefined-behaviors-in-c.html" class="sidebar-link">More undefined behaviors in C++</a></li><li><a href="/cpp/unit-testing-in-c.html" class="sidebar-link">Unit Testing in C++</a></li><li><a href="/cpp/c-debugging-and-debug-prevention-tools-techniques.html" class="sidebar-link">C++ Debugging and Debug-prevention Tools &amp; Techniques</a></li><li><a href="/cpp/optimization-in-c.html" class="sidebar-link">Optimization in C++</a></li><li><a href="/cpp/optimization.html" class="sidebar-link">Optimization</a></li><li><a href="/cpp/profiling.html" class="sidebar-link">Profiling</a></li><li><a href="/cpp/refactoring-techniques.html" class="sidebar-link">Refactoring Techniques</a></li><li><a href="/cpp/internationalization-in-c.html" class="sidebar-link">Internationalization in C++</a></li><li><a href="/cpp/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="type-erasure"><a href="#type-erasure" class="header-anchor">#</a> Type Erasure</h1> <p>Type erasure is a set of techniques for creating a type that can provide a uniform interface to various underlying types, while hiding the underlying type information from the client. <code>std::function&lt;R(A...)&gt;</code>, which has the ability to hold callable objects of various types, is perhaps the best known example of type erasure in C++.</p> <h2 id="a-move-only-std-function"><a href="#a-move-only-std-function" class="header-anchor">#</a> A move-only <code>std::function</code></h2> <p><code>std::function</code> type erases down to a few operations.  One of the things it requires is that the stored value be copyable.</p> <p>This causes problems in a few contexts, like lambdas storing unique ptrs.  If you are using the <code>std::function</code> in a context where copying doesn't matter, like a thread pool where you dispatch tasks to threads, this requirement can add overhead.</p> <p>In particular, <code>std::packaged_task&lt;Sig&gt;</code> is a callable object that is move-only.  You can store a <code>std::packaged_task&lt;R(Args...)&gt;</code> in a <code>std::packaged_task&lt;void(Args...)&gt;</code>, but that is a pretty heavy-weight and obscure way to create a move-only callable type-erasure class.</p> <p>Thus the <code>task</code>.  This demonstrates how you could write a simple <code>std::function</code> type.  I omitted the copy constructor (which would involve adding a <code>clone</code> method to <code>details::task_pimpl&lt;...&gt;</code> as well).</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Sig</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">task</span><span class="token punctuation">;</span>

<span class="token comment">// putting it in a namespace allows us to specialize it nicely for void return value:</span>
<span class="token keyword">namespace</span> details <span class="token punctuation">{</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
  <span class="token keyword">struct</span> <span class="token class-name">task_pimpl</span> <span class="token punctuation">{</span>
    <span class="token keyword">virtual</span> R <span class="token function">invoke</span><span class="token punctuation">(</span>Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">task_pimpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>type_info<span class="token operator">&amp;</span> <span class="token function">target_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// store an F.  invoke(Args&amp;&amp;...) calls the f</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
  <span class="token keyword">struct</span> <span class="token class-name">task_pimpl_impl</span><span class="token operator">:</span><span class="token base-clause"><span class="token class-name">task_pimpl</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span><span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    F f<span class="token punctuation">;</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Fin</span><span class="token operator">&gt;</span>
    <span class="token function">task_pimpl_impl</span><span class="token punctuation">(</span> Fin<span class="token operator">&amp;&amp;</span> fin <span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Fin<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> R <span class="token function">invoke</span><span class="token punctuation">(</span>Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>type_info<span class="token operator">&amp;</span> <span class="token function">target_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">typeid</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// the void version discards the return value of f:</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
  <span class="token keyword">struct</span> <span class="token class-name">task_pimpl_impl</span><span class="token operator">&lt;</span>F<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token punctuation">,</span>Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token operator">:</span>task_pimpl<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">,</span>Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    F f<span class="token punctuation">;</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Fin</span><span class="token operator">&gt;</span>
    <span class="token function">task_pimpl_impl</span><span class="token punctuation">(</span> Fin<span class="token operator">&amp;&amp;</span> fin <span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Fin<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
      <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>type_info<span class="token operator">&amp;</span> <span class="token function">target_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">typeid</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">task</span><span class="token operator">&lt;</span><span class="token function">R</span><span class="token punctuation">(</span>Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// semi-regular:</span>
  <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token function">task</span><span class="token punctuation">(</span>task<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token comment">// no copy</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// aliases to make some SFINAE code below less ugly:</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
  <span class="token keyword">using</span> call_r <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>result_of_t<span class="token operator">&lt;</span>F <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
  <span class="token keyword">using</span> is_task <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>F<span class="token operator">&gt;</span><span class="token punctuation">,</span> task<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// can be constructed from a callable F</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token punctuation">,</span>
    <span class="token comment">// that can be invoked with Args... and converted-to-R:</span>
    <span class="token keyword">class</span><span class="token operator">=</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>R<span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>call_r<span class="token operator">&lt;</span>F<span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// and is not this same type:</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span><span class="token operator">!</span>is_task<span class="token operator">&lt;</span>F<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span>
  <span class="token operator">&gt;</span>
  <span class="token function">task</span><span class="token punctuation">(</span>F<span class="token operator">&amp;&amp;</span> f<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">m_pImpl</span><span class="token punctuation">(</span> <span class="token function">make_pimpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// the meat: the call operator        </span>
  R <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_pImpl<span class="token operator">-&gt;</span><span class="token function">invoke</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">explicit</span> <span class="token keyword">operator</span> <span class="token keyword">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token punctuation">)</span>m_pImpl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span> task<span class="token operator">&amp;</span> o <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span> m_pImpl<span class="token punctuation">,</span> o<span class="token punctuation">.</span>m_pImpl <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
  <span class="token keyword">void</span> <span class="token function">assign</span><span class="token punctuation">(</span> F<span class="token operator">&amp;&amp;</span> f <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_pImpl <span class="token operator">=</span> <span class="token function">make_pimpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span>
  <span class="token comment">// Part of the std::function interface:</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>type_info<span class="token operator">&amp;</span> <span class="token function">target_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">typeid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> m_pImpl<span class="token operator">-&gt;</span><span class="token function">target_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token operator">&gt;</span>
  T<span class="token operator">*</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">target_impl</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token operator">&gt;</span>
  <span class="token keyword">const</span> T<span class="token operator">*</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">target_impl</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// compare with nullptr    :    </span>
  <span class="token keyword">friend</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span>nullptr_t<span class="token punctuation">,</span> task <span class="token keyword">const</span><span class="token operator">&amp;</span> self <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span>self<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">friend</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span> task <span class="token keyword">const</span><span class="token operator">&amp;</span> self<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nullptr_t <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span>self<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">friend</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">!=</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span>nullptr_t<span class="token punctuation">,</span> task <span class="token keyword">const</span><span class="token operator">&amp;</span> self <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>self<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">friend</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">!=</span><span class="token punctuation">(</span> task <span class="token keyword">const</span><span class="token operator">&amp;</span> self<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nullptr_t <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>self<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  <span class="token keyword">using</span> pimpl_t <span class="token operator">=</span> details<span class="token double-colon punctuation">::</span>task_pimpl_impl<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> R<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
  <span class="token keyword">static</span> <span class="token keyword">auto</span> <span class="token function">make_pimpl</span><span class="token punctuation">(</span> F<span class="token operator">&amp;&amp;</span> f <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">using</span> dF<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>F<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> pImpl_t <span class="token operator">=</span> pimpl_t<span class="token operator">&lt;</span>dF<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>pImpl_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>details<span class="token double-colon punctuation">::</span>task_pimpl<span class="token operator">&lt;</span>R<span class="token punctuation">,</span>Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;&gt;</span> m_pImpl<span class="token punctuation">;</span>

  <span class="token keyword">template</span><span class="token operator">&lt;</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token operator">&gt;</span>
  T<span class="token operator">*</span> <span class="token function">target_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>pimpl_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>m_pImpl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>To make this library-worthy, you'd want to add in a small buffer optimization, so it does not store every callable on the heap.</p> <p>Adding SBO would require a non-default <code>task(task&amp;&amp;)</code>, some <code>std::aligned_storage_t</code> within the class, a <code>m_pImpl</code> <code>unique_ptr</code> with a deleter that can be set to destroy-only (and not return the memory to the heap), and a <code>emplace_move_to( void* ) = 0</code> in the <code>task_pimpl</code>.</p> <p><a href="http://coliru.stacked-crooked.com/a/6e6811e8626a37d1" target="_blank" rel="noopener noreferrer">live example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of the above code (with no SBO).</p> <h2 id="erasing-down-to-a-regular-type-with-manual-vtable"><a href="#erasing-down-to-a-regular-type-with-manual-vtable" class="header-anchor">#</a> Erasing down to a Regular type with manual vtable</h2> <p>C++ thrives on what is known as a Regular type (or at least Pseudo-Regular).</p> <p>A Regular type is a type that can be constructed and assigned-to and assigned-from via copy or move, can be destroyed, and can be compared equal-to.  It can also be constructed from no arguments.  Finally, it also has support for a few other operations that are highly useful in various <code>std</code> algorithms and containers.</p> <p><a href="http://www.stepanovpapers.com/DeSt98.pdf" target="_blank" rel="noopener noreferrer">This is the root paper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, but in C++11 would want to add <code>std::hash</code> support.</p> <p>I will use the manual vtable approach to type erasure here.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">using</span> dtor_unique_ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
dtor_unique_ptr <span class="token function">make_dtor_unique_ptr</span><span class="token punctuation">(</span> Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token function">T</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">delete</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">regular_vtable</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>copy_assign<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// T&amp;=(T const&amp;)</span>
  <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>move_assign<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// T&amp;=(T&amp;&amp;)</span>
  <span class="token keyword">bool</span><span class="token punctuation">(</span><span class="token operator">*</span>equals<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> lhs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// T const&amp;==T const&amp;</span>
  <span class="token keyword">bool</span><span class="token punctuation">(</span><span class="token operator">*</span>order<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> lhs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// std::less&lt;T&gt;{}(T const&amp;, T const&amp;)</span>
  std<span class="token double-colon punctuation">::</span><span class="token function">size_t</span><span class="token punctuation">(</span><span class="token operator">*</span>hash<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// std::hash&lt;T&gt;{}(T const&amp;)</span>
  std<span class="token double-colon punctuation">::</span>type_info <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// typeid(T)</span>
  <span class="token function">dtor_unique_ptr</span><span class="token punctuation">(</span><span class="token operator">*</span>clone<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// T(T const&amp;)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
regular_vtable <span class="token function">make_regular_vtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span> <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> lhs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> rhs<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>lhs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> lhs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>less<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>lhs<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rhs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>hash<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">typeid</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">make_dtor_unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
regular_vtable <span class="token keyword">const</span><span class="token operator">*</span> <span class="token function">get_regular_vtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> regular_vtable vtable<span class="token operator">=</span><span class="token generic-function"><span class="token function">make_regular_vtable</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>vtable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">regular_type</span> <span class="token punctuation">{</span>
  <span class="token keyword">using</span> self<span class="token operator">=</span>regular_type<span class="token punctuation">;</span>
  regular_vtable <span class="token keyword">const</span><span class="token operator">*</span> vtable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  dtor_unique_ptr ptr<span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span>vtable<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
  <span class="token keyword">void</span> <span class="token function">emplace</span><span class="token punctuation">(</span> Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ptr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_dtor_unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
      vtable <span class="token operator">=</span> <span class="token generic-function"><span class="token function">get_regular_vtable</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      vtable <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">friend</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span>regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span> regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>vtable <span class="token operator">!=</span> rhs<span class="token punctuation">.</span>vtable<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> lhs<span class="token punctuation">.</span>vtable<span class="token operator">-&gt;</span><span class="token function">equals</span><span class="token punctuation">(</span> lhs<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rhs<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">bool</span> <span class="token function">before</span><span class="token punctuation">(</span>regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> <span class="token keyword">const</span><span class="token operator">&amp;</span> lhs <span class="token operator">=</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lhs<span class="token punctuation">.</span>vtable <span class="token operator">||</span> <span class="token operator">!</span>rhs<span class="token punctuation">.</span>vtable<span class="token punctuation">)</span>
      <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>less<span class="token operator">&lt;</span>regular_vtable <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>vtable<span class="token punctuation">,</span>rhs<span class="token punctuation">.</span>vtable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>vtable <span class="token operator">!=</span> rhs<span class="token punctuation">.</span>vtable<span class="token punctuation">)</span>
      <span class="token keyword">return</span> lhs<span class="token punctuation">.</span>vtable<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>vtable<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> lhs<span class="token punctuation">.</span>vtable<span class="token operator">-&gt;</span><span class="token function">order</span><span class="token punctuation">(</span> lhs<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rhs<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// technically friend bool operator&lt; that calls before is also required</span>

  std<span class="token double-colon punctuation">::</span>type_info <span class="token keyword">const</span><span class="token operator">*</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vtable<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>vtable<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">regular_type</span><span class="token punctuation">(</span>regular_type<span class="token operator">&amp;&amp;</span> o<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">vtable</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>vtable<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ptr</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    o<span class="token punctuation">.</span>vtable <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">friend</span> <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>regular_type<span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span> regular_type<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> rhs<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>vtable<span class="token punctuation">,</span> rhs<span class="token punctuation">.</span>vtable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  regular_type<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>regular_type<span class="token operator">&amp;&amp;</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>vtable <span class="token operator">==</span> vtable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vtable<span class="token operator">-&gt;</span><span class="token function">move_assign</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> tmp <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">regular_type</span><span class="token punctuation">(</span>regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">vtable</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>vtable<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ptr</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>vtable<span class="token operator">?</span>o<span class="token punctuation">.</span>vtable<span class="token operator">-&gt;</span><span class="token function">clone</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>dtor_unique_ptr<span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptr <span class="token operator">&amp;&amp;</span> vtable<span class="token punctuation">)</span> vtable <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  regular_type<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>vtable <span class="token operator">==</span> vtable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vtable<span class="token operator">-&gt;</span><span class="token function">copy_assign</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> tmp <span class="token operator">=</span> o<span class="token punctuation">;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  std<span class="token double-colon punctuation">::</span>size_t <span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vtable<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> vtable<span class="token operator">-&gt;</span><span class="token function">hash</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> <span class="token operator">!</span>std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> regular_type<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">=</span><span class="token keyword">nullptr</span>
  <span class="token operator">&gt;</span>
  <span class="token function">regular_type</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token generic-function"><span class="token function">emplace</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">namespace</span> std <span class="token punctuation">{</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span>
  <span class="token keyword">struct</span> <span class="token class-name">hash</span><span class="token operator">&lt;</span>regular_type<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>size_t <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span> regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> r <span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> r<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span>
  <span class="token keyword">struct</span> <span class="token class-name">less</span><span class="token operator">&lt;</span>regular_type<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span> regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span> regular_type <span class="token keyword">const</span><span class="token operator">&amp;</span> rhs <span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> lhs<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    

</code></pre></div><p><a href="http://coliru.stacked-crooked.com/a/28ef6be761012a81" target="_blank" rel="noopener noreferrer">live example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Such a regular type can be used as a key for a <code>std::map</code> or a <code>std::unordered_map</code> that accepts <strong>anything regular</strong> for a key, like:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>regular_type<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>any<span class="token operator">&gt;</span>

</code></pre></div><p>would be basically a map from anothing regular, to anything copyable.</p> <p>Unlike <code>any</code>, my <code>regular_type</code> does no small object optimization nor does it support getting the original data back.  Getting the original type back isn't hard.</p> <p>Small object optimization requires that we store an aligned storage buffer within the <code>regular_type</code>, and carefully tweak the deleter of the <code>ptr</code> to only destroy the object and not delete it.</p> <p>I would start at <code>make_dtor_unique_ptr</code> and teach it how to sometimes store the data in a buffer, and then in the heap if no room in the buffer.  That may be sufficient.</p> <h2 id="basic-mechanism"><a href="#basic-mechanism" class="header-anchor">#</a> Basic mechanism</h2> <p>Type erasure is a way to hide the type of an object from code using it, even though it is not derived from a common base class. In doing so, it provides a bridge between the worlds of static polymorphism (templates; at the place of use, the exact type must be known at compile time, but it need not be declared to conform to an interface at definition) and dynamic polymorphism (inheritance and virtual functions; at the place of use, the exact type need not be known at compile time, but must be declared to conform to an interface at definition).</p> <p>The following code shows the basic mechanism of type erasure.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ostream&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Printable</span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  <span class="token function">Printable</span><span class="token punctuation">(</span>T value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">pValue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token generic-function"><span class="token function">Value</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">Printable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">delete</span> pValue<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>os<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> pValue<span class="token operator">-&gt;</span><span class="token function">print</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token function">Printable</span><span class="token punctuation">(</span>Printable <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span>        <span class="token comment">/* in C++1x: =delete */</span><span class="token punctuation">;</span> <span class="token comment">// not implemented</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>Printable <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token comment">/* in C++1x: =delete */</span><span class="token punctuation">;</span> <span class="token comment">// not implemented</span>
  <span class="token keyword">struct</span> <span class="token class-name">ValueBase</span>
  <span class="token punctuation">{</span>
      <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">ValueBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
      <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  <span class="token keyword">struct</span> <span class="token class-name">Value</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">ValueBase</span></span>
  <span class="token punctuation">{</span>
      <span class="token function">Value</span><span class="token punctuation">(</span>T <span class="token keyword">const</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">v</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream <span class="token operator">&amp;</span>os<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> os <span class="token operator">&lt;&lt;</span> v<span class="token punctuation">;</span> <span class="token punctuation">}</span>
      T v<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ValueBase <span class="token operator">*</span>pValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>At the use site, only the above definition need to be visible, just as with base classes with virtual functions. For example:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">print_value</span><span class="token punctuation">(</span>Printable <span class="token keyword">const</span> <span class="token operator">&amp;</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    p<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Note that this is <strong>not</strong> a template, but a normal function that only needs to be declared in a header file, and can be defined in an implementation file (unlike templates, whose definition must be visible at the place of use).</p> <p>At the definition of the concrete type, nothing needs to be known about <code>Printable</code>, it just needs to conform to an interface, as with templates:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">MyType</span> <span class="token punctuation">{</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>ostream <span class="token operator">&amp;</span>os<span class="token punctuation">,</span> MyType <span class="token keyword">const</span> <span class="token operator">&amp;</span>mc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> os <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;MyType {&quot;</span> <span class="token operator">&lt;&lt;</span> mc<span class="token punctuation">.</span>i <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>We can now pass an object of this class to the function defined above:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>MyType foo <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">print_value</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="erasing-down-to-a-contiguous-buffer-of-t"><a href="#erasing-down-to-a-contiguous-buffer-of-t" class="header-anchor">#</a> Erasing down to a contiguous buffer of T</h2> <p>Not all type erasure involves virtual inheritance, allocations, placement new, or even function pointers.</p> <p>What makes type erasure type erasure is that it describes a (set of) behavior(s), and takes any type that supports that behavior and wraps it up.  All information that isn't in that set of behaviors is &quot;forgotten&quot; or &quot;erased&quot;.</p> <p>An <code>array_view</code> takes its incoming range or container type and erases everything except the fact it is a contiguous buffer of <code>T</code>.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// helper traits for SFINAE:</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">using</span> data_t <span class="token operator">=</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Src</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">using</span> compatible_data <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>integral_constant<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span> data_t<span class="token operator">&lt;</span>Src<span class="token operator">&gt;</span><span class="token punctuation">,</span> T<span class="token operator">*</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">||</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span> data_t<span class="token operator">&lt;</span>Src<span class="token operator">&gt;</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>remove_const_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">array_view</span> <span class="token punctuation">{</span>
  <span class="token comment">// the core of the class:</span>
  T<span class="token operator">*</span> b<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  T<span class="token operator">*</span> e<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  T<span class="token operator">*</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> b<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  T<span class="token operator">*</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> e<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// provide the expected methods of a good contiguous range:</span>
  T<span class="token operator">*</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  std<span class="token double-colon punctuation">::</span>size_t <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>size_t i<span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  T<span class="token operator">&amp;</span> <span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  T<span class="token operator">&amp;</span> <span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// useful helpers that let you generate other ranges from this one</span>
  <span class="token comment">// quickly and safely:</span>
  array_view <span class="token function">without_front</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span>size_t i<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    i <span class="token operator">=</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>min<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">,</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  array_view <span class="token function">without_back</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span>size_t i<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    i <span class="token operator">=</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>min<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>i<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// array_view is plain old data, so default copy:</span>
  <span class="token function">array_view</span><span class="token punctuation">(</span>array_view <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token comment">// generates a null, empty range:</span>
  <span class="token function">array_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token comment">// final constructor:</span>
  <span class="token function">array_view</span><span class="token punctuation">(</span>T<span class="token operator">*</span> s<span class="token punctuation">,</span> T<span class="token operator">*</span> f<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">b</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">e</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// start and length is useful in my experience:</span>
  <span class="token function">array_view</span><span class="token punctuation">(</span>T<span class="token operator">*</span> s<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>size_t length<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">array_view</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> s<span class="token operator">+</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// SFINAE constructor that takes any .data() supporting container</span>
  <span class="token comment">// or other range in one fell swoop:</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Src</span><span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> compatible_data<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>remove_reference_t<span class="token operator">&lt;</span>Src<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> T <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> <span class="token operator">!</span>std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>Src<span class="token operator">&gt;</span><span class="token punctuation">,</span> array_view <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">=</span><span class="token keyword">nullptr</span>
  <span class="token operator">&gt;</span>
  <span class="token function">array_view</span><span class="token punctuation">(</span> Src<span class="token operator">&amp;&amp;</span> src <span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">array_view</span><span class="token punctuation">(</span> src<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// array constructor:</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>size_t N<span class="token operator">&gt;</span>
  <span class="token function">array_view</span><span class="token punctuation">(</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arr<span class="token punctuation">)</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">array_view</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// initializer list, allowing {} based:</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">U</span><span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span><span class="token keyword">const</span> U<span class="token punctuation">,</span> T<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">=</span><span class="token keyword">nullptr</span>
  <span class="token operator">&gt;</span>
  <span class="token function">array_view</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span>initializer_list<span class="token operator">&lt;</span>U<span class="token operator">&gt;</span> il <span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">array_view</span><span class="token punctuation">(</span>il<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> il<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>an <code>array_view</code> takes any container that supports <code>.data()</code> returning a pointer to <code>T</code> and a <code>.size()</code> method, or an array, and erases it down to being a random-access range over contiguous <code>T</code>s.</p> <p>It can take a <code>std::vector&lt;T&gt;</code>, a <code>std::string&lt;T&gt;</code> a <code>std::array&lt;T, N&gt;</code> a <code>T[37]</code>, an initializer list (including <code>{}</code> based ones), or something else you make up that supports it (via <code>T* x.data()</code> and <code>size_t x.size()</code>).</p> <p>In this case, the data we can extract from the thing we are erasing, together with our &quot;view&quot; non-owning state, means we don't have to allocate memory or write custom type-dependent functions.</p> <p><a href="http://coliru.stacked-crooked.com/a/c9f8e013a309ca66" target="_blank" rel="noopener noreferrer">Live example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>An improvement would be to use a non-member <code>data</code> and a non-member <code>size</code> in an ADL-enabled context.</p> <h2 id="type-erasing-type-erasure-with-std-any"><a href="#type-erasing-type-erasure-with-std-any" class="header-anchor">#</a> Type erasing type erasure with std::any</h2> <p>This example uses C++14 and <code>boost::any</code>.  In C++17 you can swap in <code>std::any</code> instead.</p> <p>The syntax we end up with is:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">const</span> <span class="token keyword">auto</span> print <span class="token operator">=</span>
  <span class="token generic-function"><span class="token function">make_any_method</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> p<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span> t <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

super_any<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span>a<span class="token operator">-&gt;</span><span class="token operator">*</span>print<span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>which is almost optimal.</p> <p>This example is based off of work by <a href="http://coliru.stacked-crooked.com/a/2ab8d7e41d24e616" target="_blank" rel="noopener noreferrer">@dyp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="http://stackoverflow.com/a/38865269/1774667" target="_blank" rel="noopener noreferrer">@cpplearner<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as well as my own.</p> <p>First we use a tag to pass around types:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token keyword">struct</span> <span class="token class-name">tag_t</span><span class="token punctuation">{</span><span class="token keyword">constexpr</span> <span class="token function">tag_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token keyword">constexpr</span> tag_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> tag<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>This trait class gets the signature stored with an <code>any_method</code>:</p> <p>This creates a function pointer type, and a factory for said function pointers, given an <code>any_method</code>:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">any_method</span><span class="token operator">&gt;</span>
<span class="token keyword">using</span> any_sig_from_method <span class="token operator">=</span> <span class="token keyword">typename</span> <span class="token class-name">any_method</span><span class="token double-colon punctuation">::</span>signature<span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">any_method</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">Sig</span><span class="token operator">=</span>any_sig_from_method<span class="token operator">&lt;</span>any_method<span class="token operator">&gt;&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">any_method_function</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">any_method</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">any_method_function</span><span class="token operator">&lt;</span>any_method<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  <span class="token keyword">using</span> decorate <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>conditional_t<span class="token operator">&lt;</span> any_method<span class="token double-colon punctuation">::</span>is_const<span class="token punctuation">,</span> T <span class="token keyword">const</span><span class="token punctuation">,</span> T <span class="token operator">&gt;</span><span class="token punctuation">;</span>
  
  <span class="token keyword">using</span> any <span class="token operator">=</span> decorate<span class="token operator">&lt;</span>boost<span class="token double-colon punctuation">::</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  
  <span class="token keyword">using</span> type <span class="token operator">=</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>any<span class="token operator">&amp;</span><span class="token punctuation">,</span> any_method <span class="token keyword">const</span><span class="token operator">*</span><span class="token punctuation">,</span> Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  type <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span> tag_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token keyword">const</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>any<span class="token operator">&amp;</span> self<span class="token punctuation">,</span> any_method <span class="token keyword">const</span><span class="token operator">*</span> method<span class="token punctuation">,</span> Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>method<span class="token punctuation">)</span><span class="token punctuation">(</span> boost<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">any_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>decorate<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><code>any_method_function::type</code> is the type of a function pointer we will store alongside the instance.  <code>any_method_function::operator()</code> takes a <code>tag_t&lt;T&gt;</code> and writes a custom instance of the <code>any_method_function::type</code> that assumes the <code>any&amp;</code> is going to be a <code>T</code>.</p> <p>We want to be able to type-erase more than one method at a time.  So we bundle them up in a tuple, and write a helper wrapper to stick the tuple into static storage on a per-type basis and maintain a pointer to them.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>any_methods<span class="token operator">&gt;</span>
<span class="token keyword">using</span> any_method_tuple <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>tuple<span class="token operator">&lt;</span> <span class="token keyword">typename</span> <span class="token class-name">any_method_function</span><span class="token operator">&lt;</span>any_methods<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>any_methods<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
any_method_tuple<span class="token operator">&lt;</span>any_methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span> <span class="token function">make_vtable</span><span class="token punctuation">(</span> tag_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_tuple</span><span class="token punctuation">(</span>
    any_method_function<span class="token operator">&lt;</span>any_methods<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">(</span>tag<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>methods<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">any_methods</span> <span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  any_method_tuple<span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span> <span class="token keyword">const</span><span class="token operator">*</span> vtable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  <span class="token keyword">static</span> any_method_tuple<span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token function">get_vtable</span><span class="token punctuation">(</span> tag_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">auto</span> table <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_vtable</span><span class="token generic class-name"><span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>tag<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>table<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">any_methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  <span class="token function">any_methods</span><span class="token punctuation">(</span> tag_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">vtable</span><span class="token punctuation">(</span><span class="token function">get_vtable</span><span class="token punctuation">(</span>tag<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  any_methods<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>any_methods <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  <span class="token keyword">void</span> <span class="token function">change_type</span><span class="token punctuation">(</span> tag_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> vtable <span class="token operator">=</span> <span class="token function">get_vtable</span><span class="token punctuation">(</span>tag<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">any_method</span><span class="token operator">&gt;</span>
  <span class="token keyword">auto</span> <span class="token function">get_invoker</span><span class="token punctuation">(</span> tag_t<span class="token operator">&lt;</span>any_method<span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>get<span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">any_method_function</span><span class="token operator">&lt;</span>any_method<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type<span class="token operator">&gt;</span><span class="token punctuation">(</span> <span class="token operator">*</span>vtable <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>We could specialize this for a cases where the vtable is small (for example, 1 item), and use direct pointers stored in-class in those cases for efficiency.</p> <p>Now we start the <code>super_any</code>.  I use <code>super_any_t</code> to make the declaration of <code>super_any</code> a bit easier.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>methods<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">super_any_t</span><span class="token punctuation">;</span>

</code></pre></div><p>This searches the methods that the super any supports for SFINAE and better error messages:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">super_any</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">method</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">super_method_applies_helper</span> <span class="token operator">:</span> <span class="token base-clause">std<span class="token double-colon punctuation">::</span><span class="token class-name">false_type</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">M0</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Methods<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">method</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">super_method_applies_helper</span><span class="token operator">&lt;</span>super_any_t<span class="token operator">&lt;</span>M0<span class="token punctuation">,</span> Methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> method<span class="token operator">&gt;</span> <span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>integral_constant<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span>M0<span class="token punctuation">,</span> method<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token operator">||</span> super_method_applies_helper<span class="token operator">&lt;</span>super_any_t<span class="token operator">&lt;</span>Methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> method<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>methods<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">method</span><span class="token operator">&gt;</span>
<span class="token keyword">auto</span> <span class="token function">super_method_test</span><span class="token punctuation">(</span> super_any_t<span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span> <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> tag_t<span class="token operator">&lt;</span>method<span class="token operator">&gt;</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>integral_constant<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> super_method_applies_helper<span class="token operator">&lt;</span> super_any_t<span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> method <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">&amp;&amp;</span> method<span class="token double-colon punctuation">::</span>is_const <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>methods<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">method</span><span class="token operator">&gt;</span>
<span class="token keyword">auto</span> <span class="token function">super_method_test</span><span class="token punctuation">(</span> super_any_t<span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> tag_t<span class="token operator">&lt;</span>method<span class="token operator">&gt;</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>integral_constant<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> super_method_applies_helper<span class="token operator">&lt;</span> super_any_t<span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> method <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">super_any</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">method</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">super_method_applies</span><span class="token operator">:</span>
    <span class="token base-clause"><span class="token keyword">decltype</span><span class="token punctuation">(</span> <span class="token function">super_method_test</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>super_any<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">tag</span><span class="token operator">&lt;</span><span class="token class-name">method</span><span class="token operator">&gt;</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></span>
<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>Next we create the <code>any_method</code> type.  An <code>any_method</code> is a pseudo-method-pointer.  We create it globally and <code>const</code>ly using syntax like:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">const</span> <span class="token keyword">auto</span> print<span class="token operator">=</span><span class="token function">make_any_method</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span>self<span class="token punctuation">,</span> <span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span>os<span class="token punctuation">)</span><span class="token punctuation">{</span> os <span class="token operator">&lt;&lt;</span> self<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>or in C++17:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">const</span> any_method print<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span>self<span class="token punctuation">,</span> <span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span>os<span class="token punctuation">)</span><span class="token punctuation">{</span> os <span class="token operator">&lt;&lt;</span> self<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>Note that using a non-lambda can make things hairy, as we use the type for a lookup step.  This can be fixed, but would make this example longer than it already is.  So always initialize an any method from a lambda, or from a type parametarized on a lambda.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Sig</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> const_method<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">any_method</span> <span class="token punctuation">{</span>
  <span class="token keyword">using</span> signature<span class="token operator">=</span>Sig<span class="token punctuation">;</span>
  <span class="token keyword">enum</span><span class="token punctuation">{</span>is_const<span class="token operator">=</span>const_method<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  F f<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>

  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Any</span><span class="token punctuation">,</span>
    <span class="token comment">// SFINAE testing that one of the Anys's matches this type:</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> super_method_applies<span class="token operator">&lt;</span> Any<span class="token operator">&amp;&amp;</span><span class="token punctuation">,</span> any_method <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">=</span><span class="token keyword">nullptr</span>
  <span class="token operator">&gt;</span>
  <span class="token keyword">friend</span> <span class="token keyword">auto</span> <span class="token keyword">operator</span><span class="token operator">-&gt;</span><span class="token operator">*</span><span class="token punctuation">(</span> Any<span class="token operator">&amp;&amp;</span> self<span class="token punctuation">,</span> any_method <span class="token keyword">const</span><span class="token operator">&amp;</span> m <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// we don't use the value of the any_method, because each any_method has</span>
    <span class="token comment">// a unique type (!) and we check that one of the auto*'s in the super_any</span>
    <span class="token comment">// already has a pointer to us.  We then dispatch to the corresponding</span>
    <span class="token comment">// any_method_data...</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>self<span class="token punctuation">,</span> invoke <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">get_invoker</span><span class="token punctuation">(</span>tag<span class="token operator">&lt;</span>any_method<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">invoke</span><span class="token punctuation">(</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">any_method</span><span class="token punctuation">(</span> F fin <span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
  <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token punctuation">)</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>A factory method, not needed in C++17 I believe:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Sig</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> is_const<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
any_method<span class="token operator">&lt;</span>Sig<span class="token punctuation">,</span> is_const<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>F<span class="token operator">&gt;&gt;</span>
<span class="token function">make_any_method</span><span class="token punctuation">(</span> F<span class="token operator">&amp;&amp;</span> f <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>This is the augmented <code>any</code>.  It is both an <code>any</code>, and it carries around a bundle of type-erasure function pointers that change whenever the contained <code>any</code> does:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> methods<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">super_any_t</span><span class="token operator">:</span><span class="token base-clause">boost<span class="token double-colon punctuation">::</span><span class="token class-name">any</span><span class="token punctuation">,</span> <span class="token class-name">any_methods</span><span class="token operator">&lt;</span><span class="token class-name">methods</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">using</span> vtable<span class="token operator">=</span>any_methods<span class="token operator">&lt;</span>methods<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> <span class="token operator">!</span>std<span class="token double-colon punctuation">::</span>is_base_of<span class="token operator">&lt;</span>super_any_t<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token number">0</span>
  <span class="token operator">&gt;</span>
  <span class="token function">super_any_t</span><span class="token punctuation">(</span> T<span class="token operator">&amp;&amp;</span> t <span class="token punctuation">)</span><span class="token operator">:</span>
    boost<span class="token double-colon punctuation">::</span><span class="token function">any</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">using</span> dT<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">change_type</span><span class="token punctuation">(</span> tag<span class="token operator">&lt;</span>dT<span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  boost<span class="token double-colon punctuation">::</span>any<span class="token operator">&amp;</span> <span class="token function">as_any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
  boost<span class="token double-colon punctuation">::</span>any<span class="token operator">&amp;&amp;</span> <span class="token function">as_any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">{</span><span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
  boost<span class="token double-colon punctuation">::</span>any <span class="token keyword">const</span><span class="token operator">&amp;</span> <span class="token function">as_any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
  <span class="token function">super_any_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token function">super_any_t</span><span class="token punctuation">(</span>super_any_t<span class="token operator">&amp;&amp;</span> o<span class="token punctuation">)</span><span class="token operator">:</span>
    boost<span class="token double-colon punctuation">::</span><span class="token function">any</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span> o<span class="token punctuation">.</span><span class="token function">as_any</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">vtable</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">super_any_t</span><span class="token punctuation">(</span>super_any_t <span class="token keyword">const</span><span class="token operator">&amp;</span> o<span class="token punctuation">)</span><span class="token operator">:</span>
    boost<span class="token double-colon punctuation">::</span><span class="token function">any</span><span class="token punctuation">(</span> o<span class="token punctuation">.</span><span class="token function">as_any</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">vtable</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">S</span><span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>S<span class="token operator">&gt;</span><span class="token punctuation">,</span> super_any_t<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token number">0</span>
  <span class="token operator">&gt;</span>
  <span class="token function">super_any_t</span><span class="token punctuation">(</span> S<span class="token operator">&amp;&amp;</span> o <span class="token punctuation">)</span><span class="token operator">:</span>
    boost<span class="token double-colon punctuation">::</span><span class="token function">any</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>S<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_any</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">vtable</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>
  super_any_t<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>super_any_t<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>
  super_any_t<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>super_any_t <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">;</span>
  
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>enable_if_t<span class="token operator">&lt;</span> <span class="token operator">!</span>std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> super_any_t<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> <span class="token operator">=</span><span class="token keyword">nullptr</span>
  <span class="token operator">&gt;</span>
  super_any_t<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span> T<span class="token operator">&amp;&amp;</span> t <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>boost<span class="token double-colon punctuation">::</span>any<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> dT<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">change_type</span><span class="token punctuation">(</span> tag<span class="token operator">&lt;</span>dT<span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>Because we store the <code>any_method</code>s as <code>const</code> objects, this makes making a <code>super_any</code> a bit easier:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Ts<span class="token operator">&gt;</span>
<span class="token keyword">using</span> super_any <span class="token operator">=</span> super_any_t<span class="token operator">&lt;</span> std<span class="token double-colon punctuation">::</span>remove_cv_t<span class="token operator">&lt;</span>Ts<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">&gt;</span><span class="token punctuation">;</span>

</code></pre></div><p>Test code:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">const</span> <span class="token keyword">auto</span> print <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_any_method</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> p<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span> t <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">auto</span> wprint <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_any_method</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>wostream<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> p<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>wostream<span class="token operator">&amp;</span> os <span class="token punctuation">)</span><span class="token punctuation">{</span> os <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> L<span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  super_any<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>wprint<span class="token punctuation">)</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
  super_any<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>wprint<span class="token punctuation">)</span><span class="token operator">&gt;</span> a2 <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>

  <span class="token punctuation">(</span>a<span class="token operator">-&gt;</span><span class="token operator">*</span>print<span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span>a<span class="token operator">-&gt;</span><span class="token operator">*</span>wprint<span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>wcout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><a href="http://coliru.stacked-crooked.com/a/fbd10edb3336cce1" target="_blank" rel="noopener noreferrer">live example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Originally posted <a href="http://stackoverflow.com/a/38837687/1774667" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in a SO self question &amp; answer (and people noted above helped with the implementation).</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/cpp/type-erasure.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/cpp/atomic-types.html" class="prev">
        Atomic Types
      </a></span> <span class="next"><a href="/cpp/explicit-type-conversions.html">
        Explicit type conversions
      </a>
      
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1779e102.js" defer></script><script src="/assets/js/3.2cfa8016.js" defer></script><script src="/assets/js/741.849ce07c.js" defer></script>
  </body>
</html>
