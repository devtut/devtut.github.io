<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C# | Cryptography (System.Security.Cryptography)</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="Modern Examples of Symmetric Authenticated Encryption of a string, Introduction to Symmetric and Asymmetric Encryption, Password Hashing, Simple Symmetric File Encryption, Cryptographically Secure Random Data, Fast Asymmetric File Encryption">
    <meta property="og:site_name" content="DevTut">
    <meta property="og:title" content="C# | Cryptography (System.Security.Cryptography)">
    <meta property="og:description" content="Modern Examples of Symmetric Authenticated Encryption of a string, Introduction to Symmetric and Asymmetric Encryption, Password Hashing, Simple Symmetric File Encryption, Cryptographically Secure Random Data, Fast Asymmetric File Encryption">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/csharp/cryptography-system-security-cryptography.html">
    <meta property="og:image" content="/logo.png">
    <meta name="twitter:title" content="C# | Cryptography (System.Security.Cryptography)">
    <meta name="twitter:description" content="Modern Examples of Symmetric Authenticated Encryption of a string, Introduction to Symmetric and Asymmetric Encryption, Password Hashing, Simple Symmetric File Encryption, Cryptographically Secure Random Data, Fast Asymmetric File Encryption">
    <meta name="twitter:url" content="/csharp/cryptography-system-security-cryptography.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/logo.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="google-site-verification" content="76_rKXgwMVIjd-axJC_1zPV9OS4mEjvtgjYOWVkAdnQ">
    <link rel="preload" href="/assets/css/0.styles.8b877eb8.css" as="style"><link rel="preload" href="/assets/js/app.ced448ab.js" as="script"><link rel="preload" href="/assets/js/3.f1d73125.js" as="script"><link rel="preload" href="/assets/js/798.ea6c6bf2.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8b877eb8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DevTut</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/devtut/generate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>C#</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/csharp/" class="sidebar-link">Disclaimer</a></li><li><a href="/csharp/getting-started-with-c-language.html" class="sidebar-link">Getting started with C# Language</a></li><li><a href="/csharp/literals.html" class="sidebar-link">Literals</a></li><li><a href="/csharp/operators.html" class="sidebar-link">Operators</a></li><li><a href="/csharp/conditional-statements.html" class="sidebar-link">Conditional Statements</a></li><li><a href="/csharp/equality-operator.html" class="sidebar-link">Equality Operator</a></li><li><a href="/csharp/equals-and-gethashcode.html" class="sidebar-link">Equals and GetHashCode</a></li><li><a href="/csharp/null-coalescing-operator.html" class="sidebar-link">Null-Coalescing Operator</a></li><li><a href="/csharp/null-conditional-operators.html" class="sidebar-link">Null-conditional Operators</a></li><li><a href="/csharp/nameof-operator.html" class="sidebar-link">nameof Operator</a></li><li><a href="/csharp/verbatim-strings.html" class="sidebar-link">Verbatim Strings</a></li><li><a href="/csharp/common-string-operations.html" class="sidebar-link">Common String Operations</a></li><li><a href="/csharp/string-format.html" class="sidebar-link">String.Format</a></li><li><a href="/csharp/string-concatenate.html" class="sidebar-link">String Concatenate</a></li><li><a href="/csharp/string-manipulation.html" class="sidebar-link">String Manipulation</a></li><li><a href="/csharp/string-interpolation.html" class="sidebar-link">String Interpolation</a></li><li><a href="/csharp/string-escape-sequences.html" class="sidebar-link">String Escape Sequences</a></li><li><a href="/csharp/stringbuilder.html" class="sidebar-link">StringBuilder</a></li><li><a href="/csharp/regex-parsing.html" class="sidebar-link">Regex Parsing</a></li><li><a href="/csharp/datetime-methods.html" class="sidebar-link">DateTime Methods</a></li><li><a href="/csharp/arrays.html" class="sidebar-link">Arrays</a></li><li><a href="/csharp/o-n-algorithm-for-circular-rotation-of-an-array.html" class="sidebar-link">O(n) Algorithm for circular rotation of an array</a></li><li><a href="/csharp/enum.html" class="sidebar-link">Enum</a></li><li><a href="/csharp/tuples.html" class="sidebar-link">Tuples</a></li><li><a href="/csharp/guid.html" class="sidebar-link">Guid</a></li><li><a href="/csharp/biginteger.html" class="sidebar-link">BigInteger</a></li><li><a href="/csharp/collection-initializers.html" class="sidebar-link">Collection Initializers</a></li><li><a href="/csharp/an-overview-of-c-collections.html" class="sidebar-link">An overview of c# collections</a></li><li><a href="/csharp/looping.html" class="sidebar-link">Looping</a></li><li><a href="/csharp/iterators.html" class="sidebar-link">Iterators</a></li><li><a href="/csharp/ienumerable.html" class="sidebar-link">IEnumerable</a></li><li><a href="/csharp/value-type-vs-reference-type.html" class="sidebar-link">Value type vs Reference type</a></li><li><a href="/csharp/built-in-types.html" class="sidebar-link">Built-in Types</a></li><li><a href="/csharp/aliases-of-built-in-types.html" class="sidebar-link">Aliases of built-in types</a></li><li><a href="/csharp/anonymous-types.html" class="sidebar-link">Anonymous types</a></li><li><a href="/csharp/dynamic-type.html" class="sidebar-link">Dynamic type</a></li><li><a href="/csharp/type-conversion.html" class="sidebar-link">Type Conversion</a></li><li><a href="/csharp/casting.html" class="sidebar-link">Casting</a></li><li><a href="/csharp/nullable-types.html" class="sidebar-link">Nullable types</a></li><li><a href="/csharp/constructors-and-finalizers.html" class="sidebar-link">Constructors and Finalizers</a></li><li><a href="/csharp/access-modifiers.html" class="sidebar-link">Access Modifiers</a></li><li><a href="/csharp/interfaces.html" class="sidebar-link">Interfaces</a></li><li><a href="/csharp/static-classes.html" class="sidebar-link">Static Classes</a></li><li><a href="/csharp/singleton-implementation.html" class="sidebar-link">Singleton Implementation</a></li><li><a href="/csharp/dependency-injection.html" class="sidebar-link">Dependency Injection</a></li><li><a href="/csharp/partial-class-and-methods.html" class="sidebar-link">Partial class and methods</a></li><li><a href="/csharp/object-initializers.html" class="sidebar-link">Object initializers</a></li><li><a href="/csharp/methods.html" class="sidebar-link">Methods</a></li><li><a href="/csharp/extension-methods.html" class="sidebar-link">Extension Methods</a></li><li><a href="/csharp/named-arguments.html" class="sidebar-link">Named Arguments</a></li><li><a href="/csharp/named-and-optional-arguments.html" class="sidebar-link">Named and Optional Arguments</a></li><li><a href="/csharp/data-annotation.html" class="sidebar-link">Data Annotation</a></li><li><a href="/csharp/keywords.html" class="sidebar-link">Keywords</a></li><li><a href="/csharp/object-oriented-programming-in-c.html" class="sidebar-link">Object Oriented Programming In C#</a></li><li><a href="/csharp/recursion.html" class="sidebar-link">Recursion</a></li><li><a href="/csharp/naming-conventions.html" class="sidebar-link">Naming Conventions</a></li><li><a href="/csharp/xml-documentation-comments.html" class="sidebar-link">XML Documentation Comments</a></li><li><a href="/csharp/comments-and-regions.html" class="sidebar-link">Comments and regions</a></li><li><a href="/csharp/inheritance.html" class="sidebar-link">Inheritance</a></li><li><a href="/csharp/generics.html" class="sidebar-link">Generics</a></li><li><a href="/csharp/using-statement.html" class="sidebar-link">Using Statement</a></li><li><a href="/csharp/using-directive.html" class="sidebar-link">Using Directive</a></li><li><a href="/csharp/idisposable-interface.html" class="sidebar-link">IDisposable interface</a></li><li><a href="/csharp/reflection.html" class="sidebar-link">Reflection</a></li><li><a href="/csharp/iqueryable-interface.html" class="sidebar-link">IQueryable interface</a></li><li><a href="/csharp/linq-to-objects.html" class="sidebar-link">Linq to Objects</a></li><li><a href="/csharp/linq-queries.html" class="sidebar-link">LINQ Queries</a></li><li><a href="/csharp/linq-to-xml.html" class="sidebar-link">LINQ to XML</a></li><li><a href="/csharp/parallel-linq-plinq.html" class="sidebar-link">Parallel LINQ (PLINQ)</a></li><li><a href="/csharp/xmldocument-and-the-system-xml-namespace.html" class="sidebar-link">XmlDocument and the System.Xml namespace</a></li><li><a href="/csharp/xdocument-and-the-system-xml-linq-namespace.html" class="sidebar-link">XDocument and the System.Xml.Linq namespace</a></li><li><a href="/csharp/c-7-0-features.html" class="sidebar-link">C# 7.0 Features</a></li><li><a href="/csharp/c-6-0-features.html" class="sidebar-link">C# 6.0 Features</a></li><li><a href="/csharp/c-5-0-features.html" class="sidebar-link">C# 5.0 Features</a></li><li><a href="/csharp/c-4-0-features.html" class="sidebar-link">C# 4.0 Features</a></li><li><a href="/csharp/c-3-0-features.html" class="sidebar-link">C# 3.0 Features</a></li><li><a href="/csharp/exception-handling.html" class="sidebar-link">Exception Handling</a></li><li><a href="/csharp/nullreferenceexception.html" class="sidebar-link">NullReferenceException</a></li><li><a href="/csharp/handling-formatexception-when-converting-string-to-other-types.html" class="sidebar-link">Handling FormatException when converting string to other types</a></li><li><a href="/csharp/read-understand-stacktraces.html" class="sidebar-link">Read &amp; Understand Stacktraces</a></li><li><a href="/csharp/diagnostics.html" class="sidebar-link">Diagnostics</a></li><li><a href="/csharp/overflow.html" class="sidebar-link">Overflow</a></li><li><a href="/csharp/getting-started-json-with-c.html" class="sidebar-link">Getting Started: Json with C#</a></li><li><a href="/csharp/using-json-net.html" class="sidebar-link">Using json.net</a></li><li><a href="/csharp/lambda-expressions.html" class="sidebar-link">Lambda Expressions</a></li><li><a href="/csharp/generic-lambda-query-builder.html" class="sidebar-link">Generic Lambda Query Builder</a></li><li><a href="/csharp/properties.html" class="sidebar-link">Properties</a></li><li><a href="/csharp/initializing-properties.html" class="sidebar-link">Initializing Properties</a></li><li><a href="/csharp/inotifypropertychanged-interface.html" class="sidebar-link">INotifyPropertyChanged interface</a></li><li><a href="/csharp/events.html" class="sidebar-link">Events</a></li><li><a href="/csharp/expression-trees.html" class="sidebar-link">Expression Trees</a></li><li><a href="/csharp/overload-resolution.html" class="sidebar-link">Overload Resolution</a></li><li><a href="/csharp/bindinglist-t.html" class="sidebar-link">BindingList</a></li><li><a href="/csharp/preprocessor-directives.html" class="sidebar-link">Preprocessor directives</a></li><li><a href="/csharp/structs.html" class="sidebar-link">Structs</a></li><li><a href="/csharp/attributes.html" class="sidebar-link">Attributes</a></li><li><a href="/csharp/delegates.html" class="sidebar-link">Delegates</a></li><li><a href="/csharp/file-and-stream-i-o.html" class="sidebar-link">File and Stream I/O</a></li><li><a href="/csharp/networking.html" class="sidebar-link">Networking</a></li><li><a href="/csharp/performing-http-requests.html" class="sidebar-link">Performing HTTP requests</a></li><li><a href="/csharp/reading-and-writing-zip-files.html" class="sidebar-link">Reading and writing .zip files</a></li><li><a href="/csharp/filesystemwatcher.html" class="sidebar-link">FileSystemWatcher</a></li><li><a href="/csharp/access-network-shared-folder-with-username-and-password.html" class="sidebar-link">Access network shared folder with username and password</a></li><li><a href="/csharp/asynchronous-socket.html" class="sidebar-link">Asynchronous Socket</a></li><li><a href="/csharp/action-filters.html" class="sidebar-link">Action Filters</a></li><li><a href="/csharp/polymorphism.html" class="sidebar-link">Polymorphism</a></li><li><a href="/csharp/immutability.html" class="sidebar-link">Immutability</a></li><li><a href="/csharp/indexer.html" class="sidebar-link">Indexer</a></li><li><a href="/csharp/checked-and-unchecked.html" class="sidebar-link">Checked and Unchecked</a></li><li><a href="/csharp/stream.html" class="sidebar-link">Stream</a></li><li><a href="/csharp/timers.html" class="sidebar-link">Timers</a></li><li><a href="/csharp/stopwatches.html" class="sidebar-link">Stopwatches</a></li><li><a href="/csharp/threading.html" class="sidebar-link">Threading</a></li><li><a href="/csharp/async-await-backgroundworker-task-and-thread-examples.html" class="sidebar-link">Async/await, Backgroundworker, Task and Thread Examples</a></li><li><a href="/csharp/async-await.html" class="sidebar-link">Async-Await</a></li><li><a href="/csharp/synchronization-context-in-async-await.html" class="sidebar-link">Synchronization Context in Async-Await</a></li><li><a href="/csharp/backgroundworker.html" class="sidebar-link">BackgroundWorker</a></li><li><a href="/csharp/task-parallel-library.html" class="sidebar-link">Task Parallel Library</a></li><li><a href="/csharp/making-a-variable-thread-safe.html" class="sidebar-link">Making a variable thread safe</a></li><li><a href="/csharp/lock-statement.html" class="sidebar-link">Lock Statement</a></li><li><a href="/csharp/yield-keyword.html" class="sidebar-link">Yield Keyword</a></li><li><a href="/csharp/task-parallel-library-tpl-dataflow-constructs.html" class="sidebar-link">Task Parallel Library (TPL) Dataflow Constructs</a></li><li><a href="/csharp/functional-programming.html" class="sidebar-link">Functional Programming</a></li><li><a href="/csharp/func-delegates.html" class="sidebar-link">Func delegates</a></li><li><a href="/csharp/function-with-multiple-return-values.html" class="sidebar-link">Function with multiple return values</a></li><li><a href="/csharp/binary-serialization.html" class="sidebar-link">Binary Serialization</a></li><li><a href="/csharp/icloneable.html" class="sidebar-link">ICloneable</a></li><li><a href="/csharp/icomparable.html" class="sidebar-link">IComparable</a></li><li><a href="/csharp/accessing-databases.html" class="sidebar-link">Accessing Databases</a></li><li><a href="/csharp/using-sqlite-in-c.html" class="sidebar-link">Using SQLite in C#</a></li><li><a href="/csharp/caching.html" class="sidebar-link">Caching</a></li><li><a href="/csharp/code-contracts.html" class="sidebar-link">Code Contracts</a></li><li><a href="/csharp/code-contracts-and-assertions.html" class="sidebar-link">Code Contracts and Assertions</a></li><li><a href="/csharp/structural-design-patterns.html" class="sidebar-link">Structural Design Patterns</a></li><li><a href="/csharp/creational-design-patterns.html" class="sidebar-link">Creational Design Patterns</a></li><li><a href="/csharp/implementing-decorator-design-pattern.html" class="sidebar-link">Implementing Decorator Design Pattern</a></li><li><a href="/csharp/implementing-flyweight-design-pattern.html" class="sidebar-link">Implementing Flyweight Design Pattern</a></li><li><a href="/csharp/system-management-automation.html" class="sidebar-link">System.Management.Automation</a></li><li><a href="/csharp/system-directoryservices-protocols-ldapconnection.html" class="sidebar-link">System.DirectoryServices.Protocols.LdapConnection</a></li><li><a href="/csharp/c-authentication-handler.html" class="sidebar-link">C# Authentication handler</a></li><li><a href="/csharp/pointers.html" class="sidebar-link">Pointers</a></li><li><a href="/csharp/pointers-unsafe-code.html" class="sidebar-link">Pointers &amp; Unsafe Code</a></li><li><a href="/csharp/how-to-use-c-structs-to-create-a-union-type-similar-to-c-unions.html" class="sidebar-link">How to use C# Structs to create a Union type  (Similar to C Unions)</a></li><li><a href="/csharp/reactive-extensions-rx.html" class="sidebar-link">Reactive Extensions (Rx)</a></li><li><a href="/csharp/assemblyinfo-cs-examples.html" class="sidebar-link">AssemblyInfo.cs Examples</a></li><li><a href="/csharp/creating-a-console-application-using-a-plain-text-editor-and-the-c-compiler-csc-exe.html" class="sidebar-link">Creating a Console Application using a Plain-Text Editor and the C# Compiler (csc.exe)</a></li><li><a href="/csharp/clscompliantattribute.html" class="sidebar-link">CLSCompliantAttribute</a></li><li><a href="/csharp/observablecollection-t.html" class="sidebar-link">ObservableCollection</a></li><li><a href="/csharp/hash-functions.html" class="sidebar-link">Hash Functions</a></li><li><a href="/csharp/generating-random-numbers-in-c.html" class="sidebar-link">Generating Random Numbers in C#</a></li><li><a href="/csharp/cryptography-system-security-cryptography.html" class="active sidebar-link">Cryptography (System.Security.Cryptography)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/csharp/cryptography-system-security-cryptography.html#modern-examples-of-symmetric-authenticated-encryption-of-a-string" class="sidebar-link">Modern Examples of Symmetric Authenticated Encryption of a string</a></li><li class="sidebar-sub-header"><a href="/csharp/cryptography-system-security-cryptography.html#introduction-to-symmetric-and-asymmetric-encryption" class="sidebar-link">Introduction to Symmetric and Asymmetric Encryption</a></li><li class="sidebar-sub-header"><a href="/csharp/cryptography-system-security-cryptography.html#password-hashing" class="sidebar-link">Password Hashing</a></li><li class="sidebar-sub-header"><a href="/csharp/cryptography-system-security-cryptography.html#simple-symmetric-file-encryption" class="sidebar-link">Simple Symmetric File Encryption</a></li><li class="sidebar-sub-header"><a href="/csharp/cryptography-system-security-cryptography.html#cryptographically-secure-random-data" class="sidebar-link">Cryptographically Secure Random Data</a></li><li class="sidebar-sub-header"><a href="/csharp/cryptography-system-security-cryptography.html#fast-asymmetric-file-encryption" class="sidebar-link">Fast Asymmetric File Encryption</a></li></ul></li><li><a href="/csharp/asp-net-identity.html" class="sidebar-link">ASP.NET Identity</a></li><li><a href="/csharp/unsafe-code-in-net.html" class="sidebar-link">Unsafe Code in .NET</a></li><li><a href="/csharp/c-script.html" class="sidebar-link">C# Script</a></li><li><a href="/csharp/runtime-compile.html" class="sidebar-link">Runtime Compile</a></li><li><a href="/csharp/interoperability.html" class="sidebar-link">Interoperability</a></li><li><a href="/csharp/net-compiler-platform-roslyn.html" class="sidebar-link">.NET Compiler Platform (Roslyn)</a></li><li><a href="/csharp/ilgenerator.html" class="sidebar-link">ILGenerator</a></li><li><a href="/csharp/t4-code-generation.html" class="sidebar-link">T4 Code Generation</a></li><li><a href="/csharp/creating-own-messagebox-in-windows-form-application.html" class="sidebar-link">Creating Own MessageBox in Windows Form Application</a></li><li><a href="/csharp/including-font-resources.html" class="sidebar-link">Including Font Resources</a></li><li><a href="/csharp/import-google-contacts.html" class="sidebar-link">Import Google Contacts</a></li><li><a href="/csharp/garbage-collector-in-net.html" class="sidebar-link">Garbage Collector in .Net</a></li><li><a href="/csharp/microsoft-exchange-webservices.html" class="sidebar-link">Microsoft.Exchange.WebServices</a></li><li><a href="/csharp/windows-communication-foundation.html" class="sidebar-link">Windows Communication Foundation</a></li><li><a href="/csharp/contributors.html" class="sidebar-link">The Contributors</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cryptography-system-security-cryptography"><a href="#cryptography-system-security-cryptography" class="header-anchor">#</a> Cryptography (System.Security.Cryptography)</h1> <h2 id="modern-examples-of-symmetric-authenticated-encryption-of-a-string"><a href="#modern-examples-of-symmetric-authenticated-encryption-of-a-string" class="header-anchor">#</a> Modern Examples of Symmetric Authenticated Encryption of a string</h2> <p>Cryptography is something very hard and after spending a lot of time reading different examples and seeing how easy it is to introduce some form of vulnerability I found an answer originally written by @jbtule that I think is very good. Enjoy reading:</p> <p>&quot;The general best practice for symmetric encryption is to use Authenticated Encryption with Associated Data (AEAD), however this isn't a part of the standard .net crypto libraries. So the first example uses <a href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard" target="_blank" rel="noopener noreferrer">AES256<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and then <a href="http://en.wikipedia.org/wiki/HMAC" target="_blank" rel="noopener noreferrer">HMAC256<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, a two step <a href="http://crypto.stackexchange.com/a/205/1934" target="_blank" rel="noopener noreferrer">Encrypt then MAC<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which requires more overhead and more keys.</p> <p>The second example uses the simpler practice of AES256-<a href="http://en.wikipedia.org/wiki/Galois/Counter_Mode" target="_blank" rel="noopener noreferrer">GCM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> using the open source Bouncy Castle (via nuget).</p> <p>Both examples have a main function that takes secret message string, key(s) and an optional non-secret payload and return and authenticated encrypted string optionally prepended with the non-secret data. Ideally you would use these with 256bit key(s) randomly generated see <code>NewKey()</code>.</p> <p>Both examples also have a helper methods that use a string password to generate the keys. These helper methods are provided as a convenience to match up with other examples, however they are <strong>far less secure</strong> because the strength of the password is going to be <strong>far weaker than a 256 bit key</strong>.</p> <p><strong>Update:</strong>
Added <code>byte[]</code> overloads, and only the <a href="https://gist.github.com/4336842" target="_blank" rel="noopener noreferrer">Gist<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> has the full formatting with 4 spaces indent and api docs due to StackOverflow answer limits.&quot;</p> <p><strong>.NET Built-in Encrypt(AES)-Then-MAC(HMAC) <a href="https://gist.github.com/jbtule/4336842#file-aesthenhmac-cs" target="_blank" rel="noopener noreferrer">[Gist]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token comment">/*
 * This work (Modern Encryption of a String C#, by James Tuley), 
 * identified by James Tuley, is free of known copyright restrictions.
 * https://gist.github.com/4336842
 * http://creativecommons.org/publicdomain/mark/1.0/ 
 */</span>

<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Encryption</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AESThenHMAC</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">RandomNumberGenerator</span> Random <span class="token operator">=</span> RandomNumberGenerator<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Preconfigured Encryption Parameters</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> BlockBitSize <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> KeyBitSize <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>

    <span class="token comment">//Preconfigured Password Key Derivation Parameters</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> SaltBitSize <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> Iterations <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> MinPasswordLength <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Helper that generates a random key on each call.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">NewKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Random<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Encryption (AES) then Authentication (HMAC) for a UTF8 Message.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;secretMessage&quot;&gt;The secret message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;cryptKey&quot;&gt;The crypt key.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;authKey&quot;&gt;The auth key.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayload&quot;&gt;(Optional) Non-Secret Payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;</span>
    <span class="token comment">/// Encrypted Message</span>
    <span class="token comment">/// &lt;/returns&gt;</span>
    <span class="token comment">/// &lt;exception cref=&quot;System.ArgumentException&quot;&gt;Secret Message Required!;secretMessage&lt;/exception&gt;</span>
    <span class="token comment">/// &lt;remarks&gt;</span>
    <span class="token comment">/// Adds overhead of (Optional-Payload + BlockSize(16) + Message-Padded-To-Blocksize +  HMac-Tag(32)) * 1.33 Base64</span>
    <span class="token comment">/// &lt;/remarks&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cryptKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> authKey<span class="token punctuation">,</span>
                       <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> cryptKey<span class="token punctuation">,</span> authKey<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Authentication (HMAC) then Decryption (AES) for a secrets UTF8 Message.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;encryptedMessage&quot;&gt;The encrypted message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;cryptKey&quot;&gt;The crypt key.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;authKey&quot;&gt;The auth key.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayloadLength&quot;&gt;Length of the non secret payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;</span>
    <span class="token comment">/// Decrypted Message</span>
    <span class="token comment">/// &lt;/returns&gt;</span>
    <span class="token comment">/// &lt;exception cref=&quot;System.ArgumentException&quot;&gt;Encrypted Message Required!;encryptedMessage&lt;/exception&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cryptKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> authKey<span class="token punctuation">,</span>
                       <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">,</span> cryptKey<span class="token punctuation">,</span> authKey<span class="token punctuation">,</span> nonSecretPayloadLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> plainText <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Encryption (AES) then Authentication (HMAC) of a UTF8 message</span>
    <span class="token comment">/// using Keys derived from a Password (PBKDF2).</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;secretMessage&quot;&gt;The secret message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayload&quot;&gt;The non secret payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;</span>
    <span class="token comment">/// Encrypted Message</span>
    <span class="token comment">/// &lt;/returns&gt;</span>
    <span class="token comment">/// &lt;exception cref=&quot;System.ArgumentException&quot;&gt;password&lt;/exception&gt;</span>
    <span class="token comment">/// &lt;remarks&gt;</span>
    <span class="token comment">/// Significantly less secure than using random binary keys.</span>
    <span class="token comment">/// Adds additional non secret payload for key generation parameters.</span>
    <span class="token comment">/// &lt;/remarks&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleEncryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span>
                             <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> <span class="token function">SimpleEncryptWithPassword</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> password<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Authentication (HMAC) and then Descryption (AES) of a UTF8 Message</span>
    <span class="token comment">/// using keys derived from a password (PBKDF2). </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;encryptedMessage&quot;&gt;The encrypted message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayloadLength&quot;&gt;Length of the non secret payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;</span>
    <span class="token comment">/// Decrypted Message</span>
    <span class="token comment">/// &lt;/returns&gt;</span>
    <span class="token comment">/// &lt;exception cref=&quot;System.ArgumentException&quot;&gt;Encrypted Message Required!;encryptedMessage&lt;/exception&gt;</span>
    <span class="token comment">/// &lt;remarks&gt;</span>
    <span class="token comment">/// Significantly less secure than using random binary keys.</span>
    <span class="token comment">/// &lt;/remarks&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleDecryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span>
                             <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> <span class="token function">SimpleDecryptWithPassword</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">,</span> password<span class="token punctuation">,</span> nonSecretPayloadLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> plainText <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cryptKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> authKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//User Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cryptKey <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> cryptKey<span class="token punctuation">.</span>Length <span class="token operator">!=</span> KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Key needs to be {0} bit!&quot;</span><span class="token punctuation">,</span> KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;cryptKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>authKey <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> authKey<span class="token punctuation">.</span>Length <span class="token operator">!=</span> KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Key needs to be {0} bit!&quot;</span><span class="token punctuation">,</span> KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;authKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>secretMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> secretMessage<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//non-secret payload optional</span>
      nonSecretPayload <span class="token operator">=</span> nonSecretPayload <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cipherText<span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> iv<span class="token punctuation">;</span>

      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> aes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesManaged</span>
      <span class="token punctuation">{</span>
        KeySize <span class="token operator">=</span> KeyBitSize<span class="token punctuation">,</span>
        BlockSize <span class="token operator">=</span> BlockBitSize<span class="token punctuation">,</span>
        Mode <span class="token operator">=</span> CipherMode<span class="token punctuation">.</span>CBC<span class="token punctuation">,</span>
        Padding <span class="token operator">=</span> PaddingMode<span class="token punctuation">.</span>PKCS7
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>

        <span class="token comment">//Use random IV</span>
        aes<span class="token punctuation">.</span><span class="token function">GenerateIV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iv <span class="token operator">=</span> aes<span class="token punctuation">.</span>IV<span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> encrypter <span class="token operator">=</span> aes<span class="token punctuation">.</span><span class="token function">CreateEncryptor</span><span class="token punctuation">(</span>cryptKey<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cipherStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cryptoStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>cipherStream<span class="token punctuation">,</span> encrypter<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> binaryWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BinaryWriter</span><span class="token punctuation">(</span>cryptoStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            <span class="token comment">//Encrypt Data</span>
            binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          cipherText <span class="token operator">=</span> cipherStream<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>

      <span class="token comment">//Assemble encrypted message and add authentication</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> hmac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HMACSHA256</span><span class="token punctuation">(</span>authKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> encryptedStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> binaryWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BinaryWriter</span><span class="token punctuation">(</span>encryptedStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token comment">//Prepend non-secret payload if any</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//Prepend IV</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//Write Ciphertext</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">//Authenticate all data</span>
          <span class="token class-name"><span class="token keyword">var</span></span> tag <span class="token operator">=</span> hmac<span class="token punctuation">.</span><span class="token function">ComputeHash</span><span class="token punctuation">(</span>encryptedStream<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//Postpend tag</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> encryptedStream<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cryptKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> authKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

      <span class="token comment">//Basic Usage Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cryptKey <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> cryptKey<span class="token punctuation">.</span>Length <span class="token operator">!=</span> KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;CryptKey needs to be {0} bit!&quot;</span><span class="token punctuation">,</span> KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;cryptKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>authKey <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> authKey<span class="token punctuation">.</span>Length <span class="token operator">!=</span> KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;AuthKey needs to be {0} bit!&quot;</span><span class="token punctuation">,</span> KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;authKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>encryptedMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> hmac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HMACSHA256</span><span class="token punctuation">(</span>authKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> sentTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>hmac<span class="token punctuation">.</span>HashSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//Calculate Tag</span>
        <span class="token class-name"><span class="token keyword">var</span></span> calcTag <span class="token operator">=</span> hmac<span class="token punctuation">.</span><span class="token function">ComputeHash</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">-</span> sentTag<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> ivLength <span class="token operator">=</span> <span class="token punctuation">(</span>BlockBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//if message length is to small just return null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> sentTag<span class="token punctuation">.</span>Length <span class="token operator">+</span> nonSecretPayloadLength <span class="token operator">+</span> ivLength<span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">//Grab Sent Tag</span>
        Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">-</span> sentTag<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> sentTag<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sentTag<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Compare Tag with constant time comparison</span>
        <span class="token class-name"><span class="token keyword">var</span></span> compare <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sentTag<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
          compare <span class="token operator">|=</span> sentTag<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> calcTag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 

        <span class="token comment">//if message doesn't authenticate return null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>compare <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> aes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesManaged</span>
        <span class="token punctuation">{</span>
          KeySize <span class="token operator">=</span> KeyBitSize<span class="token punctuation">,</span>
          BlockSize <span class="token operator">=</span> BlockBitSize<span class="token punctuation">,</span>
          Mode <span class="token operator">=</span> CipherMode<span class="token punctuation">.</span>CBC<span class="token punctuation">,</span>
          Padding <span class="token operator">=</span> PaddingMode<span class="token punctuation">.</span>PKCS7
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>

          <span class="token comment">//Grab IV from message</span>
          <span class="token class-name"><span class="token keyword">var</span></span> iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>ivLength<span class="token punctuation">]</span><span class="token punctuation">;</span>
          Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> nonSecretPayloadLength<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iv<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> decrypter <span class="token operator">=</span> aes<span class="token punctuation">.</span><span class="token function">CreateDecryptor</span><span class="token punctuation">(</span>cryptKey<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> plainTextStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> decrypterStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>plainTextStream<span class="token punctuation">,</span> decrypter<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> binaryWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BinaryWriter</span><span class="token punctuation">(</span>decrypterStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              <span class="token comment">//Decrypt Cipher Text from Message</span>
              binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>
                encryptedMessage<span class="token punctuation">,</span>
                nonSecretPayloadLength <span class="token operator">+</span> iv<span class="token punctuation">.</span>Length<span class="token punctuation">,</span>
                encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">-</span> nonSecretPayloadLength <span class="token operator">-</span> iv<span class="token punctuation">.</span>Length <span class="token operator">-</span> sentTag<span class="token punctuation">.</span>Length
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//Return Plain Text</span>
            <span class="token keyword">return</span> plainTextStream<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleEncryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      nonSecretPayload <span class="token operator">=</span> nonSecretPayload <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">//User Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> MinPasswordLength<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Must have a password of at least {0} characters!&quot;</span><span class="token punctuation">,</span> MinPasswordLength<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>secretMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> secretMessage<span class="token punctuation">.</span>Length <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SaltBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> nonSecretPayload<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span>

      Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>nonSecretPayload<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">int</span></span> payloadIndex <span class="token operator">=</span> nonSecretPayload<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cryptKey<span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> authKey<span class="token punctuation">;</span>
      <span class="token comment">//Use Random Salt to prevent pre-generated weak password attacks.</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> SaltBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> Iterations<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> salt <span class="token operator">=</span> generator<span class="token punctuation">.</span>Salt<span class="token punctuation">;</span>

        <span class="token comment">//Generate Keys</span>
        cryptKey <span class="token operator">=</span> generator<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Create Non Secret Payload</span>
        Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> payloadIndex<span class="token punctuation">,</span> salt<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        payloadIndex <span class="token operator">+=</span> salt<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//Deriving separate key, might be less efficient than using HKDF, </span>
      <span class="token comment">//but now compatible with RNEncryptor which had a very similar wireformat and requires less code than HKDF.</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> SaltBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> Iterations<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> salt <span class="token operator">=</span> generator<span class="token punctuation">.</span>Salt<span class="token punctuation">;</span>

        <span class="token comment">//Generate Keys</span>
        authKey <span class="token operator">=</span> generator<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Create Rest of Non Secret Payload</span>
        Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> payloadIndex<span class="token punctuation">,</span> salt<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">,</span> cryptKey<span class="token punctuation">,</span> authKey<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleDecryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//User Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> MinPasswordLength<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Must have a password of at least {0} characters!&quot;</span><span class="token punctuation">,</span> MinPasswordLength<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>encryptedMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> cryptSalt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>SaltBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> authSalt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>SaltBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">//Grab Salt from Non-Secret Payload</span>
      Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> nonSecretPayloadLength<span class="token punctuation">,</span> cryptSalt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cryptSalt<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> nonSecretPayloadLength <span class="token operator">+</span> cryptSalt<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> authSalt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> authSalt<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cryptKey<span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> authKey<span class="token punctuation">;</span>

      <span class="token comment">//Generate crypt key</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> cryptSalt<span class="token punctuation">,</span> Iterations<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        cryptKey <span class="token operator">=</span> generator<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//Generate auth key</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> authSalt<span class="token punctuation">,</span> Iterations<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        authKey <span class="token operator">=</span> generator<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> cryptKey<span class="token punctuation">,</span> authKey<span class="token punctuation">,</span> cryptSalt<span class="token punctuation">.</span>Length <span class="token operator">+</span> authSalt<span class="token punctuation">.</span>Length <span class="token operator">+</span> nonSecretPayloadLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>Bouncy Castle AES-GCM <a href="https://gist.github.com/jbtule/4336842#file-aesgcm-cs" target="_blank" rel="noopener noreferrer">[Gist]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token comment">/*
 * This work (Modern Encryption of a String C#, by James Tuley), 
 * identified by James Tuley, is free of known copyright restrictions.
 * https://gist.github.com/4336842
 * http://creativecommons.org/publicdomain/mark/1.0/ 
 */</span>

<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Org<span class="token punctuation">.</span>BouncyCastle<span class="token punctuation">.</span>Crypto</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Org<span class="token punctuation">.</span>BouncyCastle<span class="token punctuation">.</span>Crypto<span class="token punctuation">.</span>Engines</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Org<span class="token punctuation">.</span>BouncyCastle<span class="token punctuation">.</span>Crypto<span class="token punctuation">.</span>Generators</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Org<span class="token punctuation">.</span>BouncyCastle<span class="token punctuation">.</span>Crypto<span class="token punctuation">.</span>Modes</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Org<span class="token punctuation">.</span>BouncyCastle<span class="token punctuation">.</span>Crypto<span class="token punctuation">.</span>Parameters</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Org<span class="token punctuation">.</span>BouncyCastle<span class="token punctuation">.</span>Security</span><span class="token punctuation">;</span>
<span class="token keyword">namespace</span> <span class="token namespace">Encryption</span>
<span class="token punctuation">{</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AESGCM</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">SecureRandom</span> Random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//Preconfigured Encryption Parameters</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> NonceBitSize <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> MacBitSize <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> KeyBitSize <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>

    <span class="token comment">//Preconfigured Password Key Derivation Parameters</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> SaltBitSize <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> Iterations <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> MinPasswordLength <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>


    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Helper that generates a random new key on each call.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">NewKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Random<span class="token punctuation">.</span><span class="token function">NextBytes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Encryption And Authentication (AES-GCM) of a UTF8 string.</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;secretMessage&quot;&gt;The secret message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayload&quot;&gt;Optional non-secret payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;</span>
    <span class="token comment">/// Encrypted Message</span>
    <span class="token comment">/// &lt;/returns&gt;</span>
    <span class="token comment">/// &lt;exception cref=&quot;System.ArgumentException&quot;&gt;Secret Message Required!;secretMessage&lt;/exception&gt;</span>
    <span class="token comment">/// &lt;remarks&gt;</span>
    <span class="token comment">/// Adds overhead of (Optional-Payload + BlockSize(16) + Message +  HMac-Tag(16)) * 1.33 Base64</span>
    <span class="token comment">/// &lt;/remarks&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> key<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> key<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Decryption &amp; Authentication (AES-GCM) of a UTF8 Message</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;encryptedMessage&quot;&gt;The encrypted message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayloadLength&quot;&gt;Length of the optional non-secret payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;Decrypted Message&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> key<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">,</span> key<span class="token punctuation">,</span> nonSecretPayloadLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> plainText <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Encryption And Authentication (AES-GCM) of a UTF8 String</span>
    <span class="token comment">/// using key derived from a password (PBKDF2).</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;secretMessage&quot;&gt;The secret message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayload&quot;&gt;The non secret payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;</span>
    <span class="token comment">/// Encrypted Message</span>
    <span class="token comment">/// &lt;/returns&gt;</span>
    <span class="token comment">/// &lt;remarks&gt;</span>
    <span class="token comment">/// Significantly less secure than using random binary keys.</span>
    <span class="token comment">/// Adds additional non secret payload for key generation parameters.</span>
    <span class="token comment">/// &lt;/remarks&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleEncryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span>
                             <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> <span class="token function">SimpleEncryptWithPassword</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> password<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Simple Decryption and Authentication (AES-GCM) of a UTF8 message</span>
    <span class="token comment">/// using a key derived from a password (PBKDF2)</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;encryptedMessage&quot;&gt;The encrypted message.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;nonSecretPayloadLength&quot;&gt;Length of the non secret payload.&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;</span>
    <span class="token comment">/// Decrypted Message</span>
    <span class="token comment">/// &lt;/returns&gt;</span>
    <span class="token comment">/// &lt;exception cref=&quot;System.ArgumentException&quot;&gt;Encrypted Message Required!;encryptedMessage&lt;/exception&gt;</span>
    <span class="token comment">/// &lt;remarks&gt;</span>
    <span class="token comment">/// Significantly less secure than using random binary keys.</span>
    <span class="token comment">/// &lt;/remarks&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">SimpleDecryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span>
                             <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> <span class="token function">SimpleDecryptWithPassword</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">,</span> password<span class="token punctuation">,</span> nonSecretPayloadLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> plainText <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> key<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//User Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key<span class="token punctuation">.</span>Length <span class="token operator">!=</span> KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Key needs to be {0} bit!&quot;</span><span class="token punctuation">,</span> KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>secretMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> secretMessage<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Non-secret Payload Optional</span>
      nonSecretPayload <span class="token operator">=</span> nonSecretPayload <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">//Using random nonce large enough not to repeat</span>
      <span class="token class-name"><span class="token keyword">var</span></span> nonce <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>NonceBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Random<span class="token punctuation">.</span><span class="token function">NextBytes</span><span class="token punctuation">(</span>nonce<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nonce<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> cipher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GcmBlockCipher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesFastEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AeadParameters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyParameter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> MacBitSize<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cipher<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Generate Cipher Text With Auth Tag</span>
      <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>cipher<span class="token punctuation">.</span><span class="token function">GetOutputSize</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token class-name"><span class="token keyword">var</span></span> len <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">ProcessBytes</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> secretMessage<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> cipherText<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cipher<span class="token punctuation">.</span><span class="token function">DoFinal</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Assemble Message</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> combinedStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> binaryWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BinaryWriter</span><span class="token punctuation">(</span>combinedStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token comment">//Prepend Authenticated Payload</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//Prepend Nonce</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//Write Cipher Text</span>
          binaryWriter<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> combinedStream<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> key<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//User Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key<span class="token punctuation">.</span>Length <span class="token operator">!=</span> KeyBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Key needs to be {0} bit!&quot;</span><span class="token punctuation">,</span> KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>encryptedMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cipherStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cipherReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BinaryReader</span><span class="token punctuation">(</span>cipherStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token comment">//Grab Payload</span>
        <span class="token class-name"><span class="token keyword">var</span></span> nonSecretPayload <span class="token operator">=</span> cipherReader<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span>nonSecretPayloadLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Grab Nonce</span>
        <span class="token class-name"><span class="token keyword">var</span></span> nonce <span class="token operator">=</span> cipherReader<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span>NonceBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token class-name"><span class="token keyword">var</span></span> cipher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GcmBlockCipher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesFastEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AeadParameters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyParameter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> MacBitSize<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Decrypt Cipher Text</span>
        <span class="token class-name"><span class="token keyword">var</span></span> cipherText <span class="token operator">=</span> cipherReader<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">-</span> nonSecretPayloadLength <span class="token operator">-</span> nonce<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> plainText <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>cipher<span class="token punctuation">.</span><span class="token function">GetOutputSize</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  

        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
          <span class="token class-name"><span class="token keyword">var</span></span> len <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">ProcessBytes</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cipherText<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> plainText<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          cipher<span class="token punctuation">.</span><span class="token function">DoFinal</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidCipherTextException</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token comment">//Return null if it doesn't authenticate</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> plainText<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleEncryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> secretMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> nonSecretPayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      nonSecretPayload <span class="token operator">=</span> nonSecretPayload <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">//User Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> MinPasswordLength<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Must have a password of at least {0} characters!&quot;</span><span class="token punctuation">,</span> MinPasswordLength<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>secretMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> secretMessage<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Secret Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;secretMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Pkcs5S2ParametersGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Use Random Salt to minimize pre-generated weak password attacks.</span>
      <span class="token class-name"><span class="token keyword">var</span></span> salt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>SaltBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Random<span class="token punctuation">.</span><span class="token function">NextBytes</span><span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">;</span>

      generator<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>
        PbeParametersGenerator<span class="token punctuation">.</span><span class="token function">Pkcs5PasswordToBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">ToCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        salt<span class="token punctuation">,</span>
        Iterations<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Generate Key</span>
      <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> <span class="token punctuation">(</span>KeyParameter<span class="token punctuation">)</span>generator<span class="token punctuation">.</span><span class="token function">GenerateDerivedMacParameters</span><span class="token punctuation">(</span>KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Create Full Non Secret Payload</span>
      <span class="token class-name"><span class="token keyword">var</span></span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>salt<span class="token punctuation">.</span>Length <span class="token operator">+</span> nonSecretPayload<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span>
      Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>nonSecretPayload<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> nonSecretPayload<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span>nonSecretPayload<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> salt<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token function">SimpleEncrypt</span><span class="token punctuation">(</span>secretMessage<span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">SimpleDecryptWithPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> encryptedMessage<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> nonSecretPayloadLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//User Error Checks</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> MinPasswordLength<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Must have a password of at least {0} characters!&quot;</span><span class="token punctuation">,</span> MinPasswordLength<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>encryptedMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> encryptedMessage<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted Message Required!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;encryptedMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name"><span class="token keyword">var</span></span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Pkcs5S2ParametersGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Grab Salt from Payload</span>
      <span class="token class-name"><span class="token keyword">var</span></span> salt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>SaltBitSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> nonSecretPayloadLength<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> salt<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      generator<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>
        PbeParametersGenerator<span class="token punctuation">.</span><span class="token function">Pkcs5PasswordToBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">ToCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        salt<span class="token punctuation">,</span>
        Iterations<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//Generate Key</span>
      <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> <span class="token punctuation">(</span>KeyParameter<span class="token punctuation">)</span>generator<span class="token punctuation">.</span><span class="token function">GenerateDerivedMacParameters</span><span class="token punctuation">(</span>KeyBitSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token function">SimpleDecrypt</span><span class="token punctuation">(</span>encryptedMessage<span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">.</span>Length <span class="token operator">+</span> nonSecretPayloadLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="introduction-to-symmetric-and-asymmetric-encryption"><a href="#introduction-to-symmetric-and-asymmetric-encryption" class="header-anchor">#</a> Introduction to Symmetric and Asymmetric Encryption</h2> <p>You can improve the security for data transit or storing by implementing encrypting techniques. Basically there are two approaches when using <strong>System.Security.Cryptography</strong>: <strong>symmetric</strong> and <strong>asymmetric.</strong></p> <h3 id="symmetric-encryption"><a href="#symmetric-encryption" class="header-anchor">#</a> <a href="https://en.wikipedia.org/wiki/Symmetric-key_algorithm" target="_blank" rel="noopener noreferrer"><strong>Symmetric Encryption</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <p>This method uses a private key in order to perform the data transformation.</p> <p>Pros:</p> <ul><li>Symmetric algorithms consume less resources and are faster than asymmetric ones.</li> <li>The amount of data you can encrypt is unlimited.</li></ul> <p>Cons:</p> <ul><li>Encryption and decryption use the same key. Someone will be able to decrypt your data if the key is compromised.</li> <li>You could end up with many different secret keys to manage if you choose to use a different secret key for different data.</li></ul> <p>Under System.Security.Cryptography you have different classes that perform symmetric encryption, they are known as <a href="https://en.wikipedia.org/wiki/Block_cipher" target="_blank" rel="noopener noreferrer">block ciphers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <ul><li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.aesmanaged" target="_blank" rel="noopener noreferrer">AesManaged<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" target="_blank" rel="noopener noreferrer">AES<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm).</li> <li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.aescryptoserviceprovider" target="_blank" rel="noopener noreferrer">AesCryptoServiceProvider<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" target="_blank" rel="noopener noreferrer">AES<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm <a href="https://blogs.msdn.microsoft.com/winsdk/2010/05/28/behaviour-of-aescryptoserviceprovider-class-with-fips-policy-set-unset/" target="_blank" rel="noopener noreferrer">FIPS 140-2 complaint<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</li> <li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.descryptoserviceprovider" target="_blank" rel="noopener noreferrer">DESCryptoServiceProvider<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/Data_Encryption_Standard" target="_blank" rel="noopener noreferrer">DES<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm).</li> <li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.rc2cryptoserviceprovider" target="_blank" rel="noopener noreferrer">RC2CryptoServiceProvider<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/RC2" target="_blank" rel="noopener noreferrer">Rivest Cipher 2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm).</li> <li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.rijndaelmanaged" target="_blank" rel="noopener noreferrer">RijndaelManaged<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" target="_blank" rel="noopener noreferrer">AES<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm). <strong>Note</strong>: RijndaelManaged is <strong>not</strong> <a href="https://blogs.msdn.microsoft.com/shawnfa/2006/10/09/the-differences-between-rijndael-and-aes/" target="_blank" rel="noopener noreferrer">FIPS-197<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> complaint.</li> <li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.tripledes" target="_blank" rel="noopener noreferrer">TripleDES<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/Triple_DES" target="_blank" rel="noopener noreferrer">TripleDES<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm).</li></ul> <h3 id="asymmetric-encryption"><a href="#asymmetric-encryption" class="header-anchor">#</a> <a href="https://en.wikipedia.org/wiki/Public-key_cryptography" target="_blank" rel="noopener noreferrer"><strong>Asymmetric Encryption</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <p>This method uses a combination of public and private keys in order to perform the data transformation.</p> <p>Pros:</p> <ul><li>It uses larger keys than symmetric algorithms, thus they are less susceptible to being cracked by using brute force.</li> <li>It is easier to guarantee who is able to encrypt and decrypt the data because it relies on two keys (public and private).</li></ul> <p>Cons:</p> <ul><li>There is a limit on the amount of data that you can encrypt. The limit is different for each algorithm and is typically proportional with the key size of the algorithm. For example, an RSACryptoServiceProvider object with a key length of 1,024 bits can only encrypt a message that is smaller than 128 bytes.</li> <li>Asymmetric algorithms are very slow in comparison to symmetric algorithms.</li></ul> <p>Under System.Security.Cryptography you have access to different classes that perform asymmetric encryption:</p> <ul><li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.dsacryptoserviceprovider.aspx" target="_blank" rel="noopener noreferrer">DSACryptoServiceProvider<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/Digital_Signature_Algorithm" target="_blank" rel="noopener noreferrer">Digital Signature Algorithm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm)</li> <li><a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.rsacryptoserviceprovider.aspx" target="_blank" rel="noopener noreferrer">RSACryptoServiceProvider<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (<a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)" target="_blank" rel="noopener noreferrer">RSA Algorithm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithm)</li></ul> <h2 id="password-hashing"><a href="#password-hashing" class="header-anchor">#</a> Password Hashing</h2> <p>Passwords should never be stored as plain text! They should be hashed with a randomly generated salt (to defend against rainbow table attacks) using a slow password hashing algorithm. A high number of iterations (&gt; 10k) can be used to slow down brute force attacks. A delay of ~100ms is acceptable to a user logging in, but makes breaking a long password difficult. When choosing a number of iterations you should use the maximum tolerable value for your application and increase it as computer performance improves. You will also need to consider stopping repeated requests which could be used as a DoS attack.</p> <p>When hashing for the first time a salt can be generated for you, the resulting hash and salt can then be stored to a file.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">firstHash</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userPassword<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> numberOfItterations<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Rfc2898DeriveBytes</span> PBKDF2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>userPassword<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> numberOfItterations<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Hash the password with a 8 byte salt</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> hashedPassword <span class="token operator">=</span> PBKDF2<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Returns a 20 byte hash</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> salt <span class="token operator">=</span> PBKDF2<span class="token punctuation">.</span>Salt<span class="token punctuation">;</span>
    <span class="token function">writeHashToFile</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> numberOfItterations<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Store the hashed password with the salt and number of itterations to check against future password entries</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Checking an existing users password, read their hash and salt from a file and compare to the hash of the entered password</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">checkPassword</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userPassword<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> numberOfItterations<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> usersHash <span class="token operator">=</span> <span class="token function">getUserHashFromFile</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> userSalt <span class="token operator">=</span> <span class="token function">getUserSaltFromFile</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Rfc2898DeriveBytes</span> PBKDF2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>userPassword<span class="token punctuation">,</span> userSalt<span class="token punctuation">,</span> numberOfItterations<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Hash the password with the users salt</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> hashedPassword <span class="token operator">=</span> PBKDF2<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Returns a 20 byte hash            </span>
    <span class="token class-name"><span class="token keyword">bool</span></span> passwordsMach <span class="token operator">=</span> <span class="token function">comparePasswords</span><span class="token punctuation">(</span>usersHash<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Compares byte arrays</span>
    <span class="token keyword">return</span> passwordsMach<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="simple-symmetric-file-encryption"><a href="#simple-symmetric-file-encryption" class="header-anchor">#</a> Simple Symmetric File Encryption</h2> <p>The following code sample demonstrates a quick and easy means of encrypting and decrypting files using the AES symmetric encryption algorithm.</p> <p>The code randomly generates the Salt and Initialization Vectors each time a file is encrypted, meaning that encrypting the same file with the same password will always lead to different output. The salt and IV are written to the output file so that only the password is required to decrypt it.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ProcessFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> inputPath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> encryptMode<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> outputPath<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cypher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesManaged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fsIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fsOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> saltLength <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> salt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>saltLength<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>cypher<span class="token punctuation">.</span>BlockSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>encryptMode<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Generate random salt and IV, then write them to file</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RNGCryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            fsOut<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> salt<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fsOut<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iv<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Read the salt and IV from the file</span>
            fsIn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> saltLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fsIn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iv<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Generate a secure password, based on the password and salt provided</span>
        <span class="token class-name"><span class="token keyword">var</span></span> pdb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> pdb<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>cypher<span class="token punctuation">.</span>KeySize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Encrypt or decrypt the file</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cryptoTransform <span class="token operator">=</span> <span class="token return-type class-name">encryptMode
            <span class="token punctuation">?</span></span> cypher<span class="token punctuation">.</span><span class="token function">CreateEncryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> cypher<span class="token punctuation">.</span><span class="token function">CreateDecryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>fsOut<span class="token punctuation">,</span> cryptoTransform<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            fsIn<span class="token punctuation">.</span><span class="token function">CopyTo</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="cryptographically-secure-random-data"><a href="#cryptographically-secure-random-data" class="header-anchor">#</a> Cryptographically Secure Random Data</h2> <p>There are times when the framework's Random() class may not be considered random enough, given that it is based on a psuedo-random number generator. The framework's Crypto classes do, however, provide something more robust in the form of RNGCryptoServiceProvider.</p> <p>The following code samples demonstrate how to generate Cryptographically Secure byte arrays, strings and numbers.</p> <p><strong>Random Byte Array</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">GenerateRandomData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> length<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> rnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RNGCryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>rnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rnd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>Random Integer</strong> (with even distribution)</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">GenerateRandomInt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> minVal<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> maxVal<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> rnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RNGCryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>rnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>rnd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token punctuation">(</span>maxVal <span class="token operator">-</span> minVal <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> minVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>Random String</strong></p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GenerateRandomString</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> length<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> allowableChars<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>allowableChars<span class="token punctuation">)</span><span class="token punctuation">)</span>
        allowableChars <span class="token operator">=</span> <span class="token string">@&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate random data</span>
    <span class="token class-name"><span class="token keyword">var</span></span> rnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RNGCryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>rnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate the output string</span>
    <span class="token class-name"><span class="token keyword">var</span></span> allowable <span class="token operator">=</span> allowableChars<span class="token punctuation">.</span><span class="token function">ToCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> l <span class="token operator">=</span> allowable<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> chars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">char</span></span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        chars<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> allowable<span class="token punctuation">[</span>rnd<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">%</span> l<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span></span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="fast-asymmetric-file-encryption"><a href="#fast-asymmetric-file-encryption" class="header-anchor">#</a> Fast Asymmetric File Encryption</h2> <p>Asymmetric encryption is often regarded as preferable to Symmetric encryption for transferring messages to other parties. This is mainly because it negates many of the risks related to the exchange of a shared key and ensures that whilst anyone with the public key can encrypt a message for the intended recipient, only that recipient can decrypt it. Unfortunately the major down-side of asymmetric encryption algorithms is that they are significantly slower than their symmetric cousins. As such the asymmetric encryption of files, especially large ones, can often be a very computationally intensive process.</p> <p>In order to provide both security AND performance, a hybrid approach can be taken. This entails the cryptographically random generation of a key and initialization vector for <strong>Symmetric</strong> encryption. These values are then encrypted using an <strong>Asymmetric</strong> algorithm and written to the output file, before being used to encrypt the source data <strong>Symmetrically</strong> and appending it to the output.</p> <p>This approach provides a high degree of both performance and security, in that the data is encrypted using a symmetric algorithm (fast) and the key and iv, both randomly generated (secure) are encrypted by an asymmetric algorithm (secure). It also has the added advantage that the same payload encrypted on different occasions will have very different cyphertext, because the symmetric keys are randomly generated each time.</p> <p>The following class demonstrates asymmetric encryption of strings and byte arrays, as well as hybrid file encryption.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AsymmetricProvider</span>
<span class="token punctuation">{</span>
    <span class="token preprocessor property">#<span class="token directive keyword">region</span> Key Generation</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyPair</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> PublicKey <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> PrivateKey <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">KeyPair</span> <span class="token function">GenerateNewKeyPair</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> keySize <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// KeySize is measured in bits. 1024 is the default, 2048 is better, 4096 is more robust but takes a fair bit longer to generate.</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rsa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RSACryptoServiceProvider</span><span class="token punctuation">(</span>keySize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyPair</span> <span class="token punctuation">{</span>PublicKey <span class="token operator">=</span> rsa<span class="token punctuation">.</span><span class="token function">ToXmlString</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PrivateKey <span class="token operator">=</span> rsa<span class="token punctuation">.</span><span class="token function">ToXmlString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> Asymmetric Data Encryption and Decryption</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">EncryptData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> asymmetricProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RSACryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            asymmetricProvider<span class="token punctuation">.</span><span class="token function">FromXmlString</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> asymmetricProvider<span class="token punctuation">.</span><span class="token function">Encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">DecryptData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> asymmetricProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RSACryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            asymmetricProvider<span class="token punctuation">.</span><span class="token function">FromXmlString</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>asymmetricProvider<span class="token punctuation">.</span>PublicOnly<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;The key provided is a public key and does not contain the private key elements required for decryption&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> asymmetricProvider<span class="token punctuation">.</span><span class="token function">Decrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">EncryptString</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span><span class="token function">EncryptData</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">DecryptString</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> privateKey<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token function">EncryptData</span><span class="token punctuation">(</span>Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> Hybrid File Encryption and Decription</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EncryptFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> inputFilePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> outputFilePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> symmetricCypher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesManaged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Generate random key and IV for symmetric encryption</span>
            <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>symmetricCypher<span class="token punctuation">.</span>KeySize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>symmetricCypher<span class="token punctuation">.</span>BlockSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RNGCryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Encrypt the symmetric key and IV</span>
            <span class="token class-name"><span class="token keyword">var</span></span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>key<span class="token punctuation">.</span>Length <span class="token operator">+</span> iv<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> key<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> key<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> iv<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> <span class="token function">EncryptData</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> bufLen <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Symmetrically encrypt the data and write it to the file, along with the encrypted key and iv</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cypherKey <span class="token operator">=</span> symmetricCypher<span class="token punctuation">.</span><span class="token function">CreateEncryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fsIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>inputFilePath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fsOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>outputFilePath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>fsOut<span class="token punctuation">,</span> cypherKey<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                fsOut<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>bufLen<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> bufLen<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fsOut<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fsIn<span class="token punctuation">.</span><span class="token function">CopyTo</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DecryptFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> inputFilePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> outputFilePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> privateKey<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> symmetricCypher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesManaged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fsIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>inputFilePath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Determine the length of the encrypted key and IV</span>
            <span class="token class-name"><span class="token keyword">var</span></span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">int</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            fsIn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> bufLen <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Read the encrypted key and IV data from the file and decrypt using the asymmetric algorithm</span>
            buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>bufLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
            fsIn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> <span class="token function">DecryptData</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>symmetricCypher<span class="token punctuation">.</span>KeySize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>symmetricCypher<span class="token punctuation">.</span>BlockSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> key<span class="token punctuation">,</span> key<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> key<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iv<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Decript the file data using the symmetric algorithm</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cypherKey <span class="token operator">=</span> symmetricCypher<span class="token punctuation">.</span><span class="token function">CreateDecryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fsOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>outputFilePath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>fsOut<span class="token punctuation">,</span> cypherKey<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                fsIn<span class="token punctuation">.</span><span class="token function">CopyTo</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> Key Storage</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WritePublicKey</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> publicKeyFilePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        File<span class="token punctuation">.</span><span class="token function">WriteAllText</span><span class="token punctuation">(</span>publicKeyFilePath<span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ReadPublicKey</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> publicKeyFilePath<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span>publicKeyFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> SymmetricSalt <span class="token operator">=</span> <span class="token string">&quot;Stack_Overflow!&quot;</span><span class="token punctuation">;</span> <span class="token comment">// Change me!</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ReadPrivateKey</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> privateKeyFilePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> salt <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>SymmetricSalt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> cypherText <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span>privateKeyFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cypher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesManaged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> pdb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> pdb<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>cypher<span class="token punctuation">.</span>KeySize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> iv <span class="token operator">=</span> pdb<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>cypher<span class="token punctuation">.</span>BlockSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> decryptor <span class="token operator">=</span> cypher<span class="token punctuation">.</span><span class="token function">CreateDecryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> msDecrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span>cypherText<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> csDecrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>msDecrypt<span class="token punctuation">,</span> decryptor<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Read<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> srDecrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>csDecrypt<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> srDecrypt<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WritePrivateKey</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> privateKeyFilePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> privateKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> salt <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>SymmetricSalt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cypher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AesManaged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> pdb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rfc2898DeriveBytes</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> pdb<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>cypher<span class="token punctuation">.</span>KeySize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> iv <span class="token operator">=</span> pdb<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>cypher<span class="token punctuation">.</span>BlockSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> encryptor <span class="token operator">=</span> cypher<span class="token punctuation">.</span><span class="token function">CreateEncryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fsEncrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>privateKeyFilePath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> csEncrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>fsEncrypt<span class="token punctuation">,</span> encryptor<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> swEncrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamWriter</span><span class="token punctuation">(</span>csEncrypt<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                swEncrypt<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
<span class="token punctuation">}</span>

</code></pre></div><p>Example of use:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">HybridCryptoTest</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> privateKeyPath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> privateKeyPassword<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> inputPath<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Setup the test</span>
    <span class="token class-name"><span class="token keyword">var</span></span> publicKeyPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">ChangeExtension</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">,</span> <span class="token string">&quot;.public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> outputPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">ChangeExtension</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">,</span> <span class="token string">&quot;.enc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> testPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">ChangeExtension</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">,</span> <span class="token string">&quot;.test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> keys <span class="token operator">=</span> AsymmetricProvider<span class="token punctuation">.</span><span class="token function">GenerateNewKeyPair</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AsymmetricProvider<span class="token punctuation">.</span><span class="token function">WritePublicKey</span><span class="token punctuation">(</span>publicKeyPath<span class="token punctuation">,</span> keys<span class="token punctuation">.</span>PublicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AsymmetricProvider<span class="token punctuation">.</span><span class="token function">WritePrivateKey</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">,</span> keys<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">,</span> privateKeyPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Encrypt the file</span>
    <span class="token class-name"><span class="token keyword">var</span></span> publicKey <span class="token operator">=</span> AsymmetricProvider<span class="token punctuation">.</span><span class="token function">ReadPublicKey</span><span class="token punctuation">(</span>publicKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    AsymmetricProvider<span class="token punctuation">.</span><span class="token function">EncryptFile</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">,</span> outputPath<span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Decrypt it again to compare against the source file</span>
    <span class="token class-name"><span class="token keyword">var</span></span> privateKey <span class="token operator">=</span> AsymmetricProvider<span class="token punctuation">.</span><span class="token function">ReadPrivateKey</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">,</span> privateKeyPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    AsymmetricProvider<span class="token punctuation">.</span><span class="token function">DecryptFile</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> testPath<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check that the two files match</span>
    <span class="token class-name"><span class="token keyword">var</span></span> source <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dest <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span>testPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span>Length <span class="token operator">!=</span> dest<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Length does not match&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> t <span class="token operator">!=</span> dest<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Data mismatch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/devtut/generate/edit/master/docs/csharp/cryptography-system-security-cryptography.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/csharp/generating-random-numbers-in-c.html" class="prev">
        Generating Random Numbers in C#
      </a></span> <span class="next"><a href="/csharp/asp-net-identity.html">
        ASP.NET Identity
      </a>
      
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ced448ab.js" defer></script><script src="/assets/js/3.f1d73125.js" defer></script><script src="/assets/js/798.ea6c6bf2.js" defer></script>
  </body>
</html>
